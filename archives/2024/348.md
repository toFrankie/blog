---
title: é€šè¿‡ä¸¤ä¸ªä¾‹å­å†æ¢ Event Loop
number: '#348'
link: 'https://github.com/toFrankie/blog/issues/348'
created_at: '2024-08-11 16:42:16'
updated_at: '2024-08-18 01:07:53'
labels:
  - å‰ç«¯
  - JS
  - '2024'
---


![é…å›¾æºè‡ª Freepik](https://cdn.jsdelivr.net/gh/toFrankie/blog@main/images/2024/8/1723914079530.jpg)

## æé—®

å‡è®¾æœ‰ç¤ºä¾‹ï¼š

```html
<article>
  <h1>è’¹è‘­</h1>
  <p>è’¹è‘­è‹è‹ï¼Œç™½éœ²ä¸ºéœœã€‚æ‰€è°“ä¼Šäººï¼Œåœ¨æ°´ä¸€æ–¹ã€‚æº¯æ´„ä»ä¹‹ï¼Œé“é˜»ä¸”é•¿ã€‚æº¯æ¸¸ä»ä¹‹ï¼Œå®›åœ¨æ°´ä¸­å¤®ã€‚</p>
  <p>è’¹è‘­è‹è‹ï¼Œç™½éœ²æœªæ™ã€‚æ‰€è°“ä¼Šäººï¼Œåœ¨æ°´ä¹‹æ¹„ã€‚æº¯æ´„ä»ä¹‹ï¼Œé“é˜»ä¸”è·»ã€‚æº¯æ¸¸ä»ä¹‹ï¼Œå®›åœ¨æ°´ä¸­å»ã€‚</p>
  <p>è’¹è‘­é‡‡é‡‡ï¼Œç™½éœ²æœªå·²ã€‚æ‰€è°“ä¼Šäººï¼Œåœ¨æ°´ä¹‹æ¶˜ã€‚æº¯æ´„ä»ä¹‹ï¼Œé“é˜»ä¸”å³ã€‚æº¯æ¸¸ä»ä¹‹ï¼Œå®›åœ¨æ°´ä¸­æ²šã€‚</p>
  <p></p>
</article>

<button onclick="whileLoop()">ç‚¹æˆ‘</button>
<button onclick="timerLoop()">ç‚¹æˆ‘</button>

<script>
  function whileLoop() {
    while (true) {}
  }

  function timerLoop() {
    setTimeout(timerLoop, 0)
  }
</script>
```

è¯·é—®ä¸Šè¿°ä¸¤ä¸ªç‚¹å‡»äº‹ä»¶ä¼šå¯¼è‡´é¡µé¢å¡æ­»å—ï¼Ÿ

## ä»ç®€å•è¯´èµ·

Event Loop æ˜¯æµè§ˆå™¨æœ€é‡è¦çš„æœºåˆ¶ï¼Œå®ƒç¡®ä¿äº†é¡µé¢å¯ä»¥æœ‰åºæ‰§è¡Œã€‚

ç”¨ä¼ªä»£ç è¡¨ç¤ºï¼š

```js
while (true) {
  task = taskQueue.pop()
  execute(task)
}
```

æ²¡é”™ï¼Œå®ƒæ˜¯æ— é™å¾ªç¯çš„ï¼Œ7 Ã— 24 éšæ—¶å¾…å‘½ï¼Œåªè¦ä»»åŠ¡é˜Ÿåˆ—æœ‰ä»»åŠ¡ï¼Œå®ƒå°±ä¸æ–­åœ°ä»é˜Ÿåˆ—ä¸­å–å‡ºä¸€ä¸ªä»»åŠ¡æ‰§è¡Œå®Œï¼Œæ¥ç€ä¸‹ä¸€ä¸ªï¼Œç›´åˆ°æ‰§è¡Œå®Œé˜Ÿåˆ—ä¸­æ‰€æœ‰ä»»åŠ¡ã€‚

### ä»€ä¹ˆæ˜¯ä»»åŠ¡ï¼Ÿ

å‡è®¾æœ‰é¡µé¢ï¼š

```html
<div id="count">0</div>
<button id="btn">+1</button>

<script>
  let count = 0

  document.getElementById('btn').addEventListener('click', () => {
    document.getElementById('count').textContent = ++count
  })
</script>
```

ä¸Šè¿°ç¤ºä¾‹ï¼Œæˆ‘ä»¬ç»™æŒ‰é’®æ³¨å†Œäº†ä¸€ä¸ªç‚¹å‡»ç›‘å¬äº‹ä»¶ã€‚

ç”¨æˆ·æ¯ç‚¹å‡»æŒ‰é’®ä¸€æ¬¡ï¼Œå°±ä¼šäº§ç”Ÿä¸€ä¸ªä»»åŠ¡ï¼Œå¹¶æ·»åŠ åˆ°ä»»åŠ¡é˜Ÿåˆ—ã€‚

é™¤æ­¤ä¹‹å¤–ï¼Œä¸ç”¨æˆ·å‘ç”Ÿäº¤äº’è€Œäº§ç”Ÿçš„æ‰€æœ‰äº‹ä»¶ï¼ˆæ¯”å¦‚åŒå‡»ã€æ–‡æœ¬é€‰æ‹©ã€é¡µé¢æ»šåŠ¨ã€é”®ç›˜è¾“å…¥ç­‰ï¼‰ã€setTimeoutã€setIntervalã€I/O æ“ä½œç­‰éƒ½å±äºä»»åŠ¡ã€‚

> ä»»åŠ¡é‡Œä¹Ÿå¯ä»¥äº§ç”Ÿæ–°ä»»åŠ¡ã€‚

### ä»€ä¹ˆæ˜¯ä»»åŠ¡é˜Ÿåˆ—ï¼Ÿ

é˜Ÿåˆ—æ˜¯ä¸€ç§å…ˆè¿›å…ˆå‡ºï¼ˆfirst in, first outï¼‰çš„æœºåˆ¶ã€‚

ä¹Ÿå°±æ˜¯è¯´ï¼Œæ›´æ—©æ”¾å…¥ä»»åŠ¡é˜Ÿåˆ—çš„ä»»åŠ¡ä¼šä¼˜å…ˆæ‰§è¡Œï¼Œæ’åœ¨åé¢çš„åˆ™å¿…é¡»ç­‰å¾…å‰é¢çš„ä»»åŠ¡æ‰§è¡Œå®Œä¹‹åæ‰ä¼šå¼€å§‹æ‰§è¡Œã€‚

### é¡µé¢æ¸²æŸ“

å®é™…æƒ…å†µè¿˜æœ‰æ›´å¤æ‚ä¸€äº›ã€‚

æœ¬è´¨ä¸Šï¼Œç½‘é¡µå°±æ˜¯ç»™äººçœ‹çš„ï¼Œä¸äººäº¤äº’çš„ï¼Œæ‰€ä»¥ç”¨æˆ·ä½“éªŒéå¸¸é‡è¦ã€‚å‡è®¾ä»»åŠ¡é˜Ÿåˆ—æœ‰æºæºä¸æ–­çš„ä»»åŠ¡äº§ç”Ÿï¼Œå¦‚æœ Event Loop åªä¼šä¸€ç›´å¾ªç¯æ‰§è¡Œé˜Ÿåˆ—é‡Œçš„ä»»åŠ¡ï¼Œè€Œä¸å»æ›´æ–°é¡µé¢ï¼Œç”¨æˆ·ä½“éªŒæ˜¯éå¸¸ç³Ÿç³•çš„ã€‚

å› æ­¤ï¼Œå½“ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œå®Œï¼Œâ€œ**å¯èƒ½**â€ä¼šå…ˆæ›´æ–° DOMï¼Œå®Œäº†ä¹‹åæ‰æ‰§è¡Œä¸‹ä¸€ä¸ªä»»åŠ¡ã€‚

> è‡³æ­¤ï¼Œå¯ä»¥å†æ€è€ƒä¸‹æ–‡ç« å¼€å¤´çš„æé—®ã€‚

æµè§ˆå™¨æ˜¯éå¸¸èªæ˜çš„ï¼Œæ²¡å¿…è¦çš„å·¥ä½œå®ƒä¸ä¼šåšã€‚ä»¥ 60Hz åˆ·æ–°ç‡çš„æ˜¾ç¤ºå™¨ä¸ºä¾‹ï¼Œæ¯ç§’åˆ·æ–° 60 æ¬¡ï¼Œçº¦ 16.7ms åˆ·æ–°ä¸€æ¬¡ã€‚æ»¡è¶³è¿™ä¸ªåˆ·æ–°é¢‘ç‡çš„ï¼Œé‚£ä¹ˆæ˜¾ç¤ºæ•ˆæœç®—æ˜¯æµç•…çš„ï¼Œå¦åˆ™å°±ä¼šæœ‰å¡é¡¿æ„Ÿï¼ˆéšç€æ›´é«˜åˆ·æ–°ç‡çš„æ˜¾ç¤ºè®¾å¤‡è¶Šæ¥è¶Šå¤šï¼Œå¯¹æ¯”ä¹‹ä¸‹ 60Hz åˆ·æ–°ç‡ä¹Ÿä¸ç®—å¾ˆæµç•…ï¼Œå½“ç„¶è¿™æ˜¯é¢˜å¤–è¯ï¼‰ã€‚å‡è®¾ä¸€ä¸ªä»»åŠ¡åªè€—æ—¶ 3 ~ 5msï¼Œè¿œæ²¡åˆ°è¾¾ 16msï¼Œæ­¤æ—¶æ›´æ–° DOM æ˜¯æ²¡æœ‰æ„ä¹‰çš„ï¼Œè¿™æ ·çš„è¯æµè§ˆå™¨å°±ä¸ä¼šæ›´æ–° DOMï¼Œè€Œæ˜¯æ¥ç€æ‰§è¡Œä¸‹ä¸€ä¸ªä»»åŠ¡ã€‚å› æ­¤ï¼Œå‰é¢æ‰ä¼šæåˆ°â€œå¯èƒ½â€äºŒå­—ã€‚

> è§„èŒƒä¸å¼ºåˆ¶è¦æ±‚ä½¿ç”¨ä»»ä½•ç‰¹å®šæ¨¡å‹æ¥é€‰æ‹©æ¸²æŸ“æœºä¼šã€‚ä½†ä¾‹å¦‚ï¼Œå¦‚æœæµè§ˆå™¨å°è¯•å®ç° 60Hz åˆ·æ–°ç‡ï¼Œåˆ™æ¸²æŸ“æœºä¼šæœ€å¤šæ¯ 60 ç§’å‡ºç°ä¸€æ¬¡ï¼ˆçº¦ 16.7msï¼‰ã€‚å¦‚æœæµè§ˆå™¨å‘ç° [navigable](https://html.spec.whatwg.org/multipage/document-sequences.html#navigables) æ— æ³•ç»´æŒæ­¤é€Ÿç‡ï¼Œåˆ™è¯¥ navigable å¯èƒ½ä¼šä¸‹é™åˆ°æ›´å¯æŒç»­çš„æ¯ç§’ 30 ä¸ªæ¸²æŸ“æœºä¼šï¼Œè€Œä¸æ˜¯å¶å°”ä¸¢å¸§ã€‚ç±»ä¼¼åœ°ï¼Œå¦‚æœ navigable ä¸å¯è§ï¼Œç”¨æˆ·ä»£ç†å¯èƒ½ä¼šå†³å®šå°†è¯¥é¡µé¢é™ä½åˆ°æ¯ç§’ 4 ä¸ªæ¸²æŸ“æœºä¼šï¼Œç”šè‡³æ›´å°‘ã€‚

> æ¯”å¦‚ React 16 çš„è°ƒåº¦æœºåˆ¶ï¼Œå¯ä»¥æ§åˆ¶ä¸­æ–­å½“å‰æ‰§è¡Œä¸­çš„ä»»åŠ¡ï¼Œæ‰§è¡Œå®Œä¼˜å…ˆçº§æ›´é«˜çš„ä»»åŠ¡ï¼ˆæ¯”å¦‚æ›´æ–° DOMï¼‰ï¼Œå®Œäº†å†ç»§ç»­æ­¤å‰æœªå®Œæˆçš„ä»»åŠ¡ï¼Œä»¥è§£å†³æŸäº›åœºæ™¯ä¸‹é¡µé¢å¡é¡¿çš„é—®é¢˜ã€‚

Event Loop ç°åœ¨æ˜¯è¿™æ ·çš„ï¼š

```js
while (true) {
  task = taskQueue.pop()
  execute(task)
  
  if (isRepaintTime()) repaint()
}
```

## å¼€å§‹å¤æ‚èµ·æ¥äº†

å®é™…è¿œæ²¡é‚£ä¹ˆç®€å•ã€‚ä»[è§„èŒƒ](https://html.spec.whatwg.org/multipage/webappapis.html#event-loops)å¯ä»¥çœ‹åˆ°ï¼š

> An event loop has one or more task queues.

> Task queues are [sets](https://infra.spec.whatwg.org/#ordered-set), not [queues](https://infra.spec.whatwg.org/#queue), because the [event loop processing model](https://html.spec.whatwg.org/multipage/webappapis.html#event-loop-processing-model) grabs the first [runnable task](https://html.spec.whatwg.org/multipage/webappapis.html#concept-task-runnable) from the chosen queue, instead of [dequeuing](https://infra.spec.whatwg.org/#queue-dequeue) the first task.

> The [microtask queue](https://html.spec.whatwg.org/multipage/webappapis.html#microtask-queue) is not a task queue.

ä»€ä¹ˆï¼Ÿ

- Event Loop æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªä»»åŠ¡é˜Ÿåˆ—ã€‚
- ä»»åŠ¡é˜Ÿåˆ—æ˜¯é›†åˆï¼Œä¸æ˜¯é˜Ÿåˆ—ã€‚
- æ‰§è¡Œæ—¶ï¼Œäº‹ä»¶å¾ªç¯å¤„ç†æ¨¡å‹ä»æ‰€é€‰é˜Ÿåˆ—ä¸­è·å–ç¬¬ä¸€ä¸ªå¯è¿è¡Œçš„ä»»åŠ¡ï¼Œè€Œä¸æ˜¯ä½¿ç¬¬ä¸€ä¸ªä»»åŠ¡å‡ºé˜Ÿã€‚

å®Œäº†ï¼Œæ¨ç¿»äº†å‰é¢çš„ç»“è®ºï¼Œå•ªå•ªæ‰“è„¸ ğŸ¤¦

å…¶å®ä¸ä¸€å®šï¼Œå¦‚æœä½ åªæƒ³äº†è§£ Event Loop ä¸»è¦æ‰§è¡Œé¡ºåºï¼Œä¸æ·±å…¥æµè§ˆå™¨ç©¶ç«Ÿç»´æŠ¤äº†å¤šå°‘ä¸ªä»»åŠ¡é˜Ÿåˆ—ã€æµè§ˆå™¨å¦‚ä½•å†³å®šä¸‹ä¸€ä»»åŠ¡ï¼Œé‚£ä¹ˆç®€å•åœ°ç†è§£ä¸ºè¿™æ ·ä¹Ÿæ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼šEvent Loop åªæœ‰ä¸€ä¸ªä»»åŠ¡é˜Ÿåˆ—ï¼Œé˜Ÿåˆ—ä»æ˜¯æŒ‰ç…§å…ˆè¿›å…ˆå‡ºçš„é¡ºåºæ‰§è¡Œï¼Œåªä¸è¿‡å®ƒå®é™…ç”±æµè§ˆå™¨å†³å®šï¼Œå°†å…¶æŒ‰åºæ”¾å…¥æˆ‘ä»¬æ‰€ç†è§£çš„â€œä»»åŠ¡é˜Ÿåˆ—â€é‡Œé¢è€Œå·²ã€‚

> æƒ³äº†è§£æ›´å¤šè¯·çœ‹ [Processing model](https://html.spec.whatwg.org/multipage/webappapis.html#event-loop-processing-model)ã€‚

Event Loop ç°åœ¨æ˜¯è¿™æ ·çš„ï¼š

```js
while (true) {
  queue = getNextQueue()
  task = queue.getFirstRunnableTask()
  execute(task)
  
  if (isRepaintTime()) repaint()
}
```


## References

- [Event loops spec](https://html.spec.whatwg.org/multipage/webappapis.html#event-loops)
