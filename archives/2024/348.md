---
title: é€šè¿‡ä¸¤ä¸ªä¾‹å­å†æ¢ Event Loop
number: '#348'
link: 'https://github.com/toFrankie/blog/issues/348'
created_at: '2024-08-11 16:42:16'
updated_at: '2024-08-28 22:18:40'
labels:
  - å‰ç«¯
  - JS
  - '2024'
---


![é…å›¾æºè‡ª Freepik](https://cdn.jsdelivr.net/gh/toFrankie/blog@main/images/2024/8/1723914079530.jpg)

## æé—®

â–¼ è¯·é—®ç‚¹å‡»å“ªä¸ªæŒ‰é’®ä¼šå¯¼è‡´é¡µé¢å¡æ­»å—ï¼Ÿ

```html
<article>
  <h1>è’¹è‘­</h1>
  <p>è’¹è‘­è‹è‹ï¼Œç™½éœ²ä¸ºéœœã€‚æ‰€è°“ä¼Šäººï¼Œåœ¨æ°´ä¸€æ–¹ã€‚æº¯æ´„ä»ä¹‹ï¼Œé“é˜»ä¸”é•¿ã€‚æº¯æ¸¸ä»ä¹‹ï¼Œå®›åœ¨æ°´ä¸­å¤®ã€‚</p>
  <p>è’¹è‘­è‹è‹ï¼Œç™½éœ²æœªæ™ã€‚æ‰€è°“ä¼Šäººï¼Œåœ¨æ°´ä¹‹æ¹„ã€‚æº¯æ´„ä»ä¹‹ï¼Œé“é˜»ä¸”è·»ã€‚æº¯æ¸¸ä»ä¹‹ï¼Œå®›åœ¨æ°´ä¸­å»ã€‚</p>
  <p>è’¹è‘­é‡‡é‡‡ï¼Œç™½éœ²æœªå·²ã€‚æ‰€è°“ä¼Šäººï¼Œåœ¨æ°´ä¹‹æ¶˜ã€‚æº¯æ´„ä»ä¹‹ï¼Œé“é˜»ä¸”å³ã€‚æº¯æ¸¸ä»ä¹‹ï¼Œå®›åœ¨æ°´ä¸­æ²šã€‚</p>
  <p></p>
</article>

<button onclick="whileLoop()">ç‚¹æˆ‘</button>
<button onclick="timerLoop()">ç‚¹æˆ‘</button>
<button onclick="promiseLoop()">ç‚¹æˆ‘</button>

<script>
  function whileLoop() {
    while (true) {}
  }

  function timerLoop() {
    setTimeout(timerLoop, 0)
  }
  
  function promiseLoop() {
    Promise.resolve().then(promiseLoop)
  }
</script>
```

â–¼ è¯·é—®ç‚¹å‡»æŒ‰é’®çº¢è‰² div ä¼šé—ªå—ï¼Ÿ

```html
<div id="box" style="width: 100px; height: 100px; background: red"></div>
<button onclick="clickme">ç‚¹æˆ‘</button>

<script>
  const box = document.getElementById('box')

  function clickme() {
    box.style.display = 'none'
    box.style.display = 'block'
    box.style.display = 'none'
    box.style.display = 'block'
    box.style.display = 'none'
    box.style.display = 'block'
  })
</script>
```

é¢˜ç›®æ¯”è¾ƒç®€å•ï¼Œç›¸ä¿¡å¤§å®¶éƒ½æœ‰ç­”æ¡ˆäº†ã€‚

æˆ‘ä»¬ç»§ç»­å¾€ä¸‹ã€‚

## å¼€å§‹ä¹‹å‰

å¯¹äº Event Loopï¼Œç›¸ä¿¡å¤§å®¶éƒ½æœ‰è¿™æ ·ä¸€å¼ å›¾ï¼š

![](https://cdn.jsdelivr.net/gh/toFrankie/blog@main/images/2024/8/1724581708951.png)

æ¥ä¸‹æ¥ï¼Œå°†ä¼šæ›´æ·±å…¥åœ°äº†è§£ Event Loopï¼ŒçœŸçš„å¦‚ä¸Šå›¾æ‰€ç¤ºå—ï¼Ÿ

æ²¡é”™ï¼Œæˆ‘ä¹Ÿæ˜¯ä»ä»¥ä¸‹é“¾æ¥å—ç›Šï¼Œå¹¶ç»“åˆè‡ªå·±çš„ç†è§£ï¼Œå°†å…¶å†™ä¸‹æ¥è€Œå·²ã€‚

- [Philip Roberts: What the heck is the event loop anyway?](https://www.youtube.com/watch?v=8aGhZQkoFbQ)
- [Erin Zimmer: Further Adventures of the Event Loop](https://www.youtube.com/watch?v=u1kqx6AenYw)
- [Jake Archibald: In The Loop](https://www.youtube.com/watch?v=cCOL7MC4Pl0)

## ä¸ºä»€ä¹ˆ JavaScript è®¾è®¡æˆå•çº¿ç¨‹ï¼Ÿ

æœ€åˆ JavaScript æ˜¯ä¸ºæµè§ˆå™¨è€Œè®¾è®¡çš„ï¼Œæ—¨åœ¨å¢å¼ºå¯äº¤äº’æ€§ã€‚

å•çº¿ç¨‹ï¼Œæ„å‘³ç€åŒä¸€æ—¶é—´åªèƒ½åšä¸€ä»¶äº‹æƒ…ã€‚

è®¾æƒ³ä¸€ä¸‹ï¼Œæœ‰ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶ä½œç”¨äºæŸä¸ªå…ƒç´ ï¼Œä¸€ä¸ªæ˜¯ä¿®æ”¹æ ·å¼ï¼Œå¦ä¸€ä¸ªæ˜¯åˆ é™¤å…ƒç´ ï¼Œå¦‚ä½•å“åº”å‘¢ï¼Ÿå¼•å…¥é”æœºåˆ¶ï¼Ÿ

å½“æ—¶ç½‘é¡µä¸å¦‚ç°åœ¨å¤æ‚ï¼Œé€‰æ‹©å•çº¿ç¨‹æ˜¯æ˜æ™ºã€åˆç†ã€å¤Ÿç”¨çš„ï¼Œæ“ä½œå˜å¾—æœ‰åºå¯æ§ï¼Œä¸”å¤§å¤§é™ä½å¤æ‚åº¦ã€‚

éšç€æ—¶ä»£çš„å‘å±•ï¼Œè®¡ç®—è¶Šæ¥è¶Šå¤æ‚ï¼Œå•çº¿ç¨‹æœ‰ç‚¹æ‰è¥Ÿè§è‚˜ï¼Œåæ¥ HTML5 æä¾›äº† Web Worker ç­‰ API å¯ä¸»åŠ¨åˆ›å»ºæ–°çš„çº¿ç¨‹è¿è¡Œä¸€äº›å¤æ‚çš„è¿ç®—ã€‚

## ä»€ä¹ˆæ˜¯ Event Loop?

[è§„èŒƒ](https://html.spec.whatwg.org/multipage/webappapis.html#definitions-3)æ˜¯è¿™æ ·å®šä¹‰çš„ï¼š

> To coordinate events, user interaction, scripts, rendering, networking, and so forth.
> åè°ƒäº‹ä»¶ã€ç”¨æˆ·äº¤äº’ã€è„šæœ¬ã€æ¸²æŸ“ã€ç½‘ç»œç­‰ã€‚

ä¸ªäººç†è§£ï¼šå®ƒæ˜¯è®©å„ç§ä»»åŠ¡æœ‰åºå¯æ§çš„ä¸€ç§æœºåˆ¶ã€‚

ç”¨ä¼ªä»£ç è¡¨ç¤ºï¼š

```js
while (true) {
  task = taskQueue.pop()
  execute(task)
}
```

> å½“ç„¶ï¼Œå®é™…æ²¡æœ‰è¿™ä¹ˆç®€å•ï¼Œåªæ˜¯ä»ç®€å•è¯´èµ·ï¼Œè¯·ç»§ç»­å¾€ä¸‹ã€‚

å®ƒæ˜¯æ— é™å¾ªç¯çš„ï¼Œ7 Ã— 24h éšæ—¶å¾…å‘½ï¼Œç›´è‡³æµè§ˆå™¨ Tab è¢«å…³é—­ã€‚

åªè¦æœ‰ä»»åŠ¡ï¼Œå®ƒå°±ä¼šä¸åœåœ°ä»é˜Ÿåˆ—ä¸­å–å‡ºä»»åŠ¡ï¼Œæ‰§è¡Œä»»åŠ¡ã€‚

> åœ¨æµè§ˆå™¨ä¸­ï¼ŒEvent Loop æœ‰ Window Event Loopã€Worker Event Loopã€Worklet Event Loop ä¸‰ç§ï¼Œç¬¬ä¸€ç§æ˜¯æœ¬æ–‡ä¸»è¦è®¨è®ºçš„å¯¹è±¡ã€‚å½“ç„¶ Node.js ä¹Ÿæœ‰ Event Loop æœºåˆ¶ï¼Œä½†ä¸å¤ªä¸€æ ·ã€‚

## ä»€ä¹ˆæ˜¯ Taskï¼Ÿ

[è§„èŒƒ](https://html.spec.whatwg.org/multipage/webappapis.html#concept-task)æ˜¯è¿™æ ·å®šä¹‰çš„ï¼š

> Formally, a task is a [struct](https://infra.spec.whatwg.org/#struct) which has: [steps](https://html.spec.whatwg.org/multipage/webappapis.html#concept-task-steps), a [source](https://html.spec.whatwg.org/multipage/webappapis.html#concept-task-source), a [document](https://html.spec.whatwg.org/multipage/webappapis.html#concept-task-document), a [script evaluation environment settings object set](https://html.spec.whatwg.org/multipage/webappapis.html#script-evaluation-environment-settings-object-set).
> å½¢å¼ä¸Šï¼Œä»»åŠ¡æ˜¯ä¸€ç§ struct ç»“æ„ä½“ï¼ŒåŒ…å« Stepsã€Sourceã€Documentã€Script evaluation environment settings object setã€‚

ç®€å•æ¥è¯´ï¼Œä»»åŠ¡å°±æ˜¯ä¸€ä¸ªåŒ…å« steps ç­‰å±æ€§çš„å¯¹è±¡ï¼Œé‡Œé¢è®°å½•äº†ä»»åŠ¡çš„æ¥æºã€æ‰€å± Document å¯¹è±¡ã€ä¸Šä¸‹æ–‡ç­‰ï¼Œä»¥ä¾›åç»­è°ƒåº¦ã€‚

å¸¸è§çš„ä»»åŠ¡æœ‰ï¼š

- ä¸ç”¨æˆ·å‘ç”Ÿäº¤äº’è€Œäº§ç”Ÿçš„æ‰€æœ‰äº‹ä»¶å›è°ƒï¼ˆæ¯”å¦‚å•å‡»ã€æ–‡æœ¬é€‰æ‹©ã€é¡µé¢æ»šåŠ¨ã€é”®ç›˜è¾“å…¥ç­‰ï¼‰
- setTimeoutã€setInterval
- æ‰§è¡Œ script å—
- I/O æ“ä½œ

## ä»€ä¹ˆæ˜¯ Task Queueï¼Ÿ

### å¸¸è§„æ„ä¹‰çš„é˜Ÿåˆ—

é˜Ÿåˆ—ï¼ˆ[Queue](https://www.wikiwand.com/en/articles/Queue_(data_structure))ï¼‰æ˜¯ä¸€ç§åŸºæœ¬çš„æ•°æ®ç»“æ„ï¼Œéµå¾ªå…ˆè¿›å…ˆå‡ºï¼ˆFIFO, First In First Outï¼‰çš„åŸåˆ™ã€‚åœ¨é˜Ÿåˆ—ä¸­ï¼Œæœ€å…ˆæ’å…¥çš„å…ƒç´ æœ€å…ˆè¢«ç§»é™¤ï¼Œç±»ä¼¼äºæ’é˜Ÿç­‰å€™çš„åœºæ™¯ã€‚

- å…¥é˜Ÿï¼ˆEnqueueï¼‰ï¼šå°†ä¸€ä¸ªå…ƒç´ æ·»åŠ åˆ°é˜Ÿåˆ—çš„å°¾éƒ¨ã€‚
- å‡ºé˜Ÿï¼ˆDequeueï¼‰ï¼šä»é˜Ÿåˆ—çš„å¤´éƒ¨ç§»é™¤ä¸€ä¸ªå…ƒç´ ï¼Œå¹¶è¿”å›è¯¥å…ƒç´ ã€‚

### Event Loop ä¸­çš„ä»»åŠ¡é˜Ÿåˆ—

[è§„èŒƒ](https://html.spec.whatwg.org/multipage/webappapis.html#task-queue)ä¸­æåˆ°ï¼š

> An event loop has one or more [task queues](https://html.spec.whatwg.org/multipage/webappapis.html#task-queue).
> äº‹ä»¶å¾ªç¯æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªä»»åŠ¡é˜Ÿåˆ—ã€‚

> Task queues are [sets](https://infra.spec.whatwg.org/#ordered-set), not [queues](https://infra.spec.whatwg.org/#queue), because the [event loop processing model](https://html.spec.whatwg.org/multipage/webappapis.html#event-loop-processing-model) grabs the first [runnable task](https://html.spec.whatwg.org/multipage/webappapis.html#concept-task-runnable) from the chosen queue, instead of [dequeuing](https://infra.spec.whatwg.org/#queue-dequeue) the first task.'
> ä»»åŠ¡é˜Ÿåˆ—æ˜¯é›†åˆï¼Œè€Œä¸æ˜¯é˜Ÿåˆ—ï¼Œå› ä¸ºäº‹ä»¶å¾ªç¯å¤„ç†æ¨¡å‹ä»æ‰€é€‰é˜Ÿåˆ—ä¸­è·å–ç¬¬ä¸€ä¸ªå¯è¿è¡Œçš„ä»»åŠ¡ï¼Œè€Œä¸æ˜¯ä½¿ç¬¬ä¸€ä¸ªä»»åŠ¡å‡ºé˜Ÿã€‚

> The [microtask queue](https://html.spec.whatwg.org/multipage/webappapis.html#microtask-queue) is not a task queue.
> å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸æ˜¯ä»»åŠ¡é˜Ÿåˆ—ã€‚



å‰é¢æåˆ°ï¼Œtask æ˜¯æœ‰ source çš„ï¼Œæ¯”å¦‚æ¥è‡ªé¼ æ ‡ç‚¹å‡»ç­‰ã€‚[æ’é˜Ÿ](https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task)æ—¶ï¼ŒåŒ source çš„ task ä¼šè¢«æ”¾å…¥ä¸è¯¥ source ç›¸å…³çš„ task queue é‡Œã€‚å‡è®¾é¼ æ ‡äº‹ä»¶çš„ä»»åŠ¡è¦ä¼˜äºå…¶ä»–ä»»åŠ¡ï¼ŒEvent Loop å°±å¯ä»¥åœ¨å¯¹åº” source çš„ task queue ä¸­å–å‡ºä»»åŠ¡ä¼˜å…ˆæ‰§è¡Œã€‚è§„èŒƒé‡Œ Event Loop æ‰§è¡Œ[æ­¥éª¤](https://html.spec.whatwg.org/multipage/webappapis.html#event-loop-processing-model)å¹¶æ²¡æœ‰æ˜ç¡®å®šä¹‰â€œå‡ºé˜Ÿâ€çš„è§„åˆ™ï¼Œå®ƒå–å†³äºæµè§ˆå™¨çš„å®ç°ã€‚

> Let taskQueue be one such task queue, chosen in an implementation-defined manner.

ç°åœ¨ Event Loop ç”¨ä¼ªä»£ç è¡¨ç¤ºæ˜¯è¿™æ ·çš„ï¼š

```js
while (true) {
  queue = getNextQueue()
  task = queue.getFirstRunnableTask()
  execute(task)
}
```

> ğŸ˜² åœ¨æ­¤ä¹‹å‰ï¼Œæˆ‘çš„è®¤çŸ¥æ˜¯ï¼šä¸€ä¸ª Event Loop é‡Œæœ‰ä¸”åªæœ‰ä¸€ä¸ªä»»åŠ¡é˜Ÿåˆ—ï¼Œä¸”å®ƒæ˜¯ä¸€ä¸ªå¸¸è§„æ„ä¹‰çš„é˜Ÿåˆ—ã€‚è™½è¯´å¦‚æ­¤ï¼Œå¦‚æœåªæƒ³äº†è§£ Event Loop ä¸»è¦æ‰§è¡Œé¡ºåºï¼Œä¸æ·±å…¥æµè§ˆå™¨ç©¶ç«Ÿç»´æŠ¤äº†å¤šå°‘ä¸ªä»»åŠ¡é˜Ÿåˆ—ã€æµè§ˆå™¨å¦‚ä½•å†³å®šä¸‹ä¸€ä»»åŠ¡ï¼ŒæŒ‰åŸæ¥çš„ç†è§£ä¹Ÿé—®é¢˜ä¸å¤§ã€‚

## ä»€ä¹ˆæ—¶å€™é‡ç»˜é¡µé¢ï¼Ÿ

æ€»ä¸èƒ½åªæ‰§è¡Œä»»åŠ¡ï¼Œä¸æ›´æ–° DOM å§ã€‚

æœ¬è´¨ä¸Šï¼Œç½‘é¡µå°±æ˜¯ç»™äººçœ‹çš„ï¼Œä¸äººäº¤äº’çš„ï¼Œæ‰€ä»¥ç”¨æˆ·ä½“éªŒéå¸¸é‡è¦ã€‚å‡è®¾ä»»åŠ¡é˜Ÿåˆ—æœ‰æºæºä¸æ–­çš„ä»»åŠ¡äº§ç”Ÿï¼Œå¦‚æœ Event Loop åªä¼šä¸€ç›´å¾ªç¯æ‰§è¡Œé˜Ÿåˆ—é‡Œçš„ä»»åŠ¡ï¼Œè€Œä¸å»æ›´æ–°é¡µé¢ï¼Œç”¨æˆ·ä½“éªŒæ˜¯éå¸¸ç³Ÿç³•çš„ã€‚

è¯·é—®æµè§ˆå™¨ä»€ä¹ˆæ—¶å€™ä¼šæ›´æ–°é¡µé¢ï¼Ÿ

æµè§ˆå™¨æ˜¯éå¸¸èªæ˜çš„ï¼Œæ²¡å¿…è¦çš„å·¥ä½œå®ƒä¸ä¼šåšã€‚ä»¥ 60Hz å±å¹•ä¸ºä¾‹ï¼Œæ¯ç§’åˆ·æ–° 60 æ¬¡ï¼Œçº¦ 16.7ms åˆ·æ–°ä¸€æ¬¡ã€‚åªè¦æ»¡è¶³è¯¥åˆ·æ–°é¢‘ç‡çš„ï¼Œæ˜¾ç¤ºå°±ç®—æ˜¯æµç•…çš„ï¼Œå› ä¸ºå†å¿«çš„åˆ·æ–°é¢‘ç‡å¯¹è‚‰çœ¼æ¥è¯´ä¹Ÿä¸ä¼šæœ‰æ˜æ˜¾çš„æ„ŸçŸ¥ã€‚ä¹Ÿå°±æ˜¯è¯´æ¯ 16.7ms å¯è·å¾—ä¸€æ¬¡æ¸²æŸ“æœºä¼šï¼ˆ[rendering opportunity](https://html.spec.whatwg.org/multipage/webappapis.html#rendering-opportunity)ï¼‰ï¼Œè¿™æ ·æµè§ˆå™¨å°±çŸ¥é“è¦æ›´æ–° DOM äº†ã€‚


> å‡è®¾ä¸€ä¸ªä»»åŠ¡è€—æ—¶ 3 ~ 5msï¼Œè¿œæ²¡åˆ° 16.7msï¼Œå¯¹äºæµè§ˆå™¨æ¥è¯´ï¼Œæ­¤æ—¶æ›´æ–° DOM æ˜¯æ²¡æœ‰å¿…è¦çš„ï¼Œå› æ­¤ä¹Ÿä¸ä¼šè·å¾—ä¸€ä¸ªæ¸²æŸ“æœºä¼šã€‚ç›¸ååœ°ï¼Œå¦‚æœä¸€ä¸ªä»»åŠ¡æ‰§è¡Œè¶…è¿‡ 16.7msï¼Œå‘ˆç°å‡ºæ¥çš„æ•ˆæœæœ‰å¯èƒ½æ˜¯å¡é¡¿çš„ã€‚

> æ³¨æ„ï¼Œè§„èŒƒä¸­ä¸å¼ºåˆ¶è¦æ±‚ä½¿ç”¨ä»»ä½•ç‰¹å®šæ¨¡å‹æ¥é€‰æ‹©æ¸²æŸ“æœºä¼šã€‚ä½†ä¾‹å¦‚ï¼Œå¦‚æœæµè§ˆå™¨å°è¯•å®ç° 60Hz åˆ·æ–°ç‡ï¼Œåˆ™æ¸²æŸ“æœºä¼šæœ€å¤šæ¯ 60 ç§’å‡ºç°ä¸€æ¬¡ï¼ˆçº¦ 16.7msï¼‰ã€‚å¦‚æœæµè§ˆå™¨å‘ç° [navigable](https://html.spec.whatwg.org/multipage/document-sequences.html#navigables) æ— æ³•ç»´æŒæ­¤é€Ÿç‡ï¼Œåˆ™è¯¥ navigable å¯èƒ½ä¼šä¸‹é™åˆ°æ›´å¯æŒç»­çš„æ¯ç§’ 30 ä¸ªæ¸²æŸ“æœºä¼šï¼Œè€Œä¸æ˜¯å¶å°”ä¸¢å¸§ã€‚ç±»ä¼¼åœ°ï¼Œå¦‚æœ navigable ä¸å¯è§ï¼Œæµè§ˆå™¨å¯èƒ½ä¼šå†³å®šå°†è¯¥é¡µé¢é™ä½åˆ°æ¯ç§’ 4 ä¸ªæ¸²æŸ“æœºä¼šï¼Œç”šè‡³æ›´å°‘ã€‚

> React 16 å¯ä¸­æ–­çš„è°ƒåº¦æœºåˆ¶ï¼Œå°±æ˜¯ä¸ºäº†å¯ä»¥æ‰§è¡Œä¼˜å…ˆçº§æ›´é«˜çš„ä»»åŠ¡ï¼ˆæ¯”å¦‚æ›´æ–° DOMï¼‰ï¼Œä»¥è§£å†³æŸäº›åœºæ™¯ä¸‹é¡µé¢å¡é¡¿çš„é—®é¢˜ã€‚

å› æ­¤ï¼Œä¸€ä¸ªä»»åŠ¡æ‰§è¡Œå®Œï¼Œå¦‚æœæœ‰æ¸²æŸ“æœºä¼šå…ˆæ›´æ–° DOMï¼Œæ¥ç€æ‰æ‰§è¡Œä¸‹ä¸€ä¸ªä»»åŠ¡ã€‚

ç°åœ¨ Event Loop ç”¨ä¼ªä»£ç è¡¨ç¤ºæ˜¯è¿™æ ·çš„ï¼š

```js
while (true) {
  queue = getNextQueue()
  task = queue.getFirstRunnableTask()
  execute(task)
  
  if (hasRendringOpportunity()) repaint()
}
```

## ä»€ä¹ˆæ˜¯ Microtaskï¼Ÿ

è¿˜æ²¡å®Œï¼Œè¿˜æ²¡å®Œ...

[è§„èŒƒ](https://html.spec.whatwg.org/multipage/webappapis.html#microtask-queue)ä¸­æåˆ°ï¼š

> Each event loop has a [microtask queue](https://html.spec.whatwg.org/multipage/webappapis.html#microtask-queue), which is a [queue](https://infra.spec.whatwg.org/#queue) of microtasks, initially empty.

> A [microtask](https://html.spec.whatwg.org/multipage/webappapis.html#microtask) is a colloquial way of referring to a [task](https://html.spec.whatwg.org/multipage/webappapis.html#concept-task) that was created via the [queue a microtask](https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-microtask) algorithm.

> The microtask queue is not a [task queue](https://html.spec.whatwg.org/multipage/webappapis.html#task-queue).

å¥½ï¼Œæˆ‘ä»¬é‡æ–°æ‹ä¸€ä¸‹ï¼š

- ä¸€ä¸ª Event Loop æœ‰ä¸€ä¸ªæˆ–å¤šä¸ª task queueã€‚
- ä¸€ä¸ª Event Loop æœ‰ä¸”ä»…æœ‰ä¸€ä¸ª microtask queueã€‚
- task æ˜¯ä¸€ä¸ªç”±ç‰¹å®šå±æ€§çš„å¯¹è±¡ï¼ˆè§„èŒƒä¸­ç§°ä¸º [struct](https://html.spec.whatwg.org/multipage/webappapis.html#concept-task)ï¼‰ã€‚
- microtask åªæ˜¯ä¸€ç§é€šä¿—çš„è¯´æ³•ï¼Œå®ƒæ˜¯é€šè¿‡[ç‰¹å®šç®—æ³•](https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-microtask)åˆ›å»ºçš„ taskã€‚
- task queue æ˜¯ä¸€ç»„ task çš„[é›†åˆ](https://infra.spec.whatwg.org/#ordered-set)ï¼Œå¹¶ä¸æ˜¯[é˜Ÿåˆ—](https://infra.spec.whatwg.org/#queue)ã€‚
- microtask æ˜¯å¸¸è§„æ„ä¹‰çš„é˜Ÿåˆ—ï¼Œéµå¾ªå…ˆè¿›å…ˆå‡ºã€‚
- microtask queue ä¸æ˜¯ task queueï¼Œå‰è€…æ˜¯é˜Ÿåˆ—ï¼Œåè€…æ˜¯é›†åˆã€‚

ä¸ºä¾¿äºåŒºåˆ†ç†è§£ï¼Œæœ¬æ–‡æš‚ä¸”å°†ä»¥ä¸‹è§„èŒƒæœ¯è¯­å£è¯­åŒ–ï¼ˆ**ä½†æ³¨æ„ï¼Œè¿™ç§è¯´æ³•ä¸ä¸€å®šå‡†ç¡®**ï¼‰ã€‚

* taskï¼šï¼ˆå®ï¼‰ä»»åŠ¡
* task queueï¼šï¼ˆå®ï¼‰ä»»åŠ¡é˜Ÿåˆ—
* microtaskï¼šå¾®ä»»åŠ¡
* microtask queueï¼šå¾®ä»»åŠ¡é˜Ÿåˆ—

### æœ‰å“ªäº›å¾®ä»»åŠ¡ï¼Ÿ

åœ¨ JavaScript é‡Œä¼šäº§ç”Ÿå¾®ä»»åŠ¡çš„å¤§æ¦‚æœ‰ï¼š

- queueMicrotaskï¼ˆWindow æˆ– Web Workerï¼‰
- Promise å›è°ƒ
- MutationObserver å›è°ƒ
- Object.observeï¼ˆDeprecatedï¼‰

### ä»€ä¹ˆæ—¶å€™æ‰§è¡Œå¾®ä»»åŠ¡ï¼Ÿ

ä»è§„èŒƒï¼ˆ[Processing model](https://html.spec.whatwg.org/multipage/webappapis.html#event-loop-processing-model)ï¼‰å¯çŸ¥ï¼Œåªè¦ Event Loop å­˜åœ¨ï¼Œå°±å¿…é¡»ä¸æ–­æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š

1. ä»ï¼ˆå®ï¼‰ä»»åŠ¡é˜Ÿåˆ—å–å‡ºä¸€ä¸ª task
2. æ‰§è¡Œè¯¥ task
3. æ‰§è¡Œå¾®ä»»åŠ¡æ£€æŸ¥ç‚¹ï¼ˆ[microtask checkpoint](https://html.spec.whatwg.org/multipage/webappapis.html#perform-a-microtask-checkpoint)ï¼‰
    1. å¦‚æœæ£€æŸ¥ç‚¹æ ‡å¿—ä¸ºçœŸï¼ˆåˆå§‹å€¼ä¸º falseï¼‰ï¼Œåˆ™è¿”å›ï¼ˆè·³å‡ºå¾®ä»»åŠ¡æ‰§è¡Œï¼‰ã€‚
    2. å°†æ£€æŸ¥ç‚¹æ ‡å¿—è®¾ä¸º true
    3. å¦‚æœå½“å‰ Event Loop é‡Œçš„å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸ä¸ºç©ºï¼Œå°†ä¸€ç›´å¾ªç¯ç›´è‡³å¾®é˜Ÿåˆ—ä¸ºç©ºï¼š
        1. åœ¨å¾®ä»»åŠ¡é˜Ÿåˆ—é‡Œå–å‡ºçš„ç¬¬ä¸€ä¸ªå¾®ä»»åŠ¡
        2. æ‰§è¡Œå¾®ä»»åŠ¡
    4. å°†æ£€æŸ¥ç‚¹æ ‡å¿—è®¾ä¸º false
4. é‡å¤ä¸Šè¿°æ­¥éª¤

> ä»¥ä¸Šä¸ºç®€åŒ–åçš„æ­¥éª¤ã€‚

è‡³æ­¤ï¼Œæ–‡ç« å¼€å¤´çš„æé—®ä¹‹ä¸€å°±æœ‰ç­”æ¡ˆã€‚ç”±äºå®ƒåœ¨æ‰§è¡Œå¾®ä»»åŠ¡çš„è¿‡ç¨‹ä¸­ä¸åœåœ°äº§ç”Ÿæ–°çš„å¾®ä»»åŠ¡ï¼Œå› æ­¤å°†ä¼šåœ¨ 3.iii é™·å…¥æ­»å¾ªç¯ï¼Œè‡ªç„¶é¡µé¢å°±â€œå¡æ­»â€äº†ã€‚

### è·Ÿ task çš„ä¸€äº›åŒºåˆ«

è¯·æ³¨æ„ï¼Œæ— è®ºæ˜¯ï¼ˆå®ï¼‰ä»»åŠ¡ï¼Œè¿˜æ˜¯å¾®ä»»åŠ¡ï¼Œæ‰§è¡Œè¿‡ç¨‹ä¸­éƒ½å¯èƒ½äº§ç”Ÿâ€œæ–°â€çš„ï¼ˆå®ï¼‰ä»»åŠ¡æˆ–å¾®ä»»åŠ¡ã€‚å®ƒä»¬çš„æ‰§è¡Œé¡ºåºæ˜¯æœ‰åŒºåˆ«çš„ï¼š

- ï¼ˆå®ï¼‰ä»»åŠ¡æ‰§è¡Œæ—¶äº§ç”Ÿçš„æ–°çš„ï¼ˆå®ï¼‰ä»»åŠ¡ï¼Œåœ¨ä¸‹ä¸€è½®æˆ–ä»¥åæ‰§è¡Œã€‚
- ï¼ˆå®ï¼‰ä»»åŠ¡æ‰§è¡Œæ—¶äº§ç”Ÿçš„æ–°çš„å¾®ä»»åŠ¡ï¼Œåœ¨å½“å‰ï¼ˆå®ï¼‰ä»»åŠ¡æ‰§è¡Œå®Œä¹‹åã€æ›´æ–° DOM æˆ–ä¸‹ä¸€è½®ï¼ˆå®ï¼‰ä»»åŠ¡ä¹‹å‰æ‰§è¡Œã€‚
- å¾®ä»»åŠ¡æ‰§è¡Œæ—¶äº§ç”Ÿçš„æ–°çš„ï¼ˆå®ï¼‰ä»»åŠ¡ï¼Œåœ¨ä¸‹ä¸€è½®æˆ–ä»¥åæ‰§è¡Œã€‚
- å¾®ä»»åŠ¡æ‰§è¡Œæ—¶äº§ç”Ÿçš„æ–°çš„å¾®ä»»åŠ¡ï¼Œé©¬ä¸Šæ”¾å…¥å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼Œç›´åˆ°æ‰€æœ‰å¾®ä»»åŠ¡é˜Ÿåˆ—æ‰§è¡Œå®Œï¼Œæ‰åˆ°æ›´æ–° DOM æˆ–æ‰§è¡Œä¸‹ä¸€è½®ï¼ˆå®ï¼‰ä»»åŠ¡ã€‚

ç°åœ¨ Event Loop ç”¨ä¼ªä»£ç è¡¨ç¤ºæ˜¯è¿™æ ·çš„ï¼š

```js
while (true) {
  queue = getNextQueue()
  task = queue.getFirstRunnableTask()
  execute(task)
  
  while (microtaskQueue.hasTask() {
    microtask = microtaskQueue.pop()
    excute(microtask)
  }
  
  if (hasRendringOpportunity()) repaint()
}
```

## ä»€ä¹ˆæ˜¯ requestAnimationFrameï¼Ÿ

å™¢ï¼Œè¿˜æ²¡å®Œï¼Œè¿˜æœ‰ä¸€ä¸ª requestAnimationFrameï¼Œå…¶å›è°ƒå‡½æ•°ä¼šåœ¨é¡µé¢é‡ç»˜ä¹‹å‰è°ƒç”¨ã€‚

å½“æµè§ˆå™¨æ£€æµ‹åˆ°æœ‰æ¸²æŸ“æœºä¼šï¼Œä¼šæ›´æ–° DOMï¼Œå…·ä½“æ‰§è¡Œé¡ºåºå¦‚ä¸‹ï¼š

1. æ‰§è¡Œ requestAnimationFrame å›è°ƒ
2. åˆæˆï¼šè®¡ç®—æ ·å¼ï¼Œå°† DOM Tree å’Œ CSSOM Tree åˆæˆä¸€ä¸ª Render Treeï¼ˆAttachmentï¼‰
3. é‡æ’ï¼šä»¥ç¡®å®šæ¯ä¸ªèŠ‚ç‚¹æ‰€å ç©ºé—´ã€æ‰€åœ¨ä½ç½®ç­‰ï¼ˆLayoutï¼‰
4. é‡ç»˜ï¼šä»¥è®¾ç½®é¢œè‰²ç­‰ï¼ˆPaintï¼‰

> æ¯”è¾ƒå‘çš„æ˜¯ï¼ŒEdge å’Œ Safari å°† requestAnimationFrame å›è°ƒæ”¾åˆ° Paint åé¢æ‰§è¡Œï¼Œè¿™æ˜¯éæ ‡å‡†åšæ³•ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœå›è°ƒä¸­æ¶‰åŠæ ·å¼ï¼Œç”¨æˆ·è¦åœ¨ä¸‹ä¸€å¸§æ‰èƒ½çœ‹åˆ°å˜åŒ–ã€‚

> Safari æ˜¯å¦å·²ä¿®å¤ï¼Œå¾…éªŒè¯ã€‚

é™¤äº†æœ‰ task queueï¼ˆé›†åˆï¼‰ã€microtask queueï¼ˆé˜Ÿåˆ—ï¼‰ï¼Œè¿˜æœ‰ä¸€ä¸ª animation frame callbacksï¼Œå®ƒæ˜¯ä¸€ä¸ª ordered mapï¼ˆ[æ˜ å°„](https://infra.spec.whatwg.org/#ordered-map)ï¼‰ã€‚

> å°† animation frame callbacks ç®€å•ç†è§£ä¸ºâ€œé˜Ÿåˆ—â€ä¹Ÿä¸æ˜¯ä¸è¡Œï¼Œå› ä¸ºæ ¹æ® [run the animation frame callbacks](https://html.spec.whatwg.org/multipage/imagebitmap-and-animations.html#run-the-animation-frame-callbacks) å¯ä»¥çœ‹åˆ°ï¼Œä¹Ÿæ˜¯ä»ç¬¬ä¸€ä¸ªå¼€å§‹éå†æ‰§è¡Œã€‚

åŒæ ·åœ°ï¼Œæ‰§è¡Œ callbacks çš„è¿‡ç¨‹ä¸­äº§ç”Ÿæ–°çš„ callbackï¼Œå®ƒä»¬ä¼šæ”¾åˆ°ä¸‹ä¸€æ¬¡ Loop æ‰§è¡Œï¼Œè¿™ç‚¹è·Ÿå¾®ä»»åŠ¡æ˜¯ä¸ä¸€æ ·çš„ã€‚

ç°åœ¨ Event Loop ç”¨ä¼ªä»£ç è¡¨ç¤ºæ˜¯è¿™æ ·çš„ï¼š

```js
while (true) {
  queue = getNextQueue()
  task = queue.getFirstRunnableTask()
  execute(task)
  
  while (microtaskQueue.hasTask() {
    microtask = microtaskQueue.pop()
    excute(microtask)
  }
  
  if (hasRendringOpportunity()) {
    callbacks = animationFrameCallbacks.spliceAll()
    for (callback in callbacks) {
      execute(callback)
    }
    
    repaint()
  }
}
```


## Node.js Event Loop æ˜¯æ€æ ·çš„å‘¢ï¼Ÿ

ç›¸æ¯”ä¹‹ä¸‹ï¼ŒNode.js é‡Œæ²¡æœ‰ä»¥ä¸‹è¿™äº›ï¼š

- æ²¡æœ‰ \<script> è§£æ
- æ²¡æœ‰ç”¨æˆ·äº¤äº’
- æ²¡æœ‰ DOM
- æ²¡æœ‰ requestAnimationFrame

Node.js ç‰¹æœ‰çš„æ˜¯ï¼š

- setImmediate
- process.nextTick

Node.js çš„ Event Loop ç”± libuv å®ç°ï¼ŒåŒ…å«ä»¥ä¸‹é˜¶æ®µï¼š

```
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”Œâ”€>â”‚           timers          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”‚     pending callbacks     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”‚       idle, prepare       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚   incoming:   â”‚
â”‚  â”‚           poll            â”‚<â”€â”€â”€â”€â”€â”¤  connections, â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚   data, etc.  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â”‚           check           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â””â”€â”€â”¤      close callbacks      â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
> [The Node.js Event Loop](https://nodejs.org/en/learn/asynchronous-work/event-loop-timers-and-nexttick)
> 
- timersï¼šæ‰§è¡Œ setTimeoutã€setInterval çš„å›è°ƒã€‚
- pending callbacksï¼šæ‰§è¡Œä¸€äº›ç³»ç»Ÿæ“ä½œçš„å›è°ƒï¼Œæ¯”å¦‚ TCP é”™è¯¯ç­‰ã€‚
- idle, prepareï¼šä»…åœ¨å†…éƒ¨ä½¿ç”¨ã€‚
- pollï¼šå‡ ä¹æ‰€æœ‰å¼‚æ­¥å›è°ƒéƒ½åœ¨è¿™ä¸ªé˜¶æ®µæ‰§è¡Œï¼Œé™¤ setTimeoutã€setInterval å’Œ setImmediate ä¹‹å¤–ã€‚
- checkï¼šæ‰§è¡Œ setImmediate çš„å›è°ƒã€‚
- close callbacksï¼šæ‰§è¡Œå…³é—­äº‹ä»¶ï¼Œæ¯”å¦‚ socket æˆ– handle çªç„¶å…³é—­ï¼Œä¼šå‘å‡º close äº‹ä»¶ã€‚

åœ¨ Node.js ä¸­ï¼Œè¿˜æœ‰ä¸€ä¸ªç‰¹æ®Šçš„ `process.nextTick()` æ–¹æ³•ã€‚æŠ€æœ¯ä¸Šï¼Œå®ƒä¸å±äºäº‹ä»¶å¾ªç¯çš„ä¸€éƒ¨åˆ†ã€‚å½“ä½ åœ¨æŸä¸ªé˜¶æ®µè°ƒç”¨æ—¶ï¼Œä¼ é€’ç»™å®ƒçš„æ‰€æœ‰å›è°ƒå°†åœ¨å½“å‰é˜¶æ®µæ‰§è¡Œå®Œä¹‹åï¼Œä¸‹ä¸€ä¸ªé˜¶æ®µæ‰§è¡Œä¹‹å‰æ‰§è¡Œã€‚å¦‚æœé€’å½’è°ƒç”¨å®ƒï¼Œæ˜¯ä¼šé€ æˆæ­»å¾ªç¯çš„ã€‚

ç”¨ä¼ªä»£ç è¡¨ç¤ºæ˜¯è¿™æ ·çš„ï¼š

```js
while (tasksAreWaiting()) {
  queue = getNextQueue()
  
  while (queue.hasTask()) {
    task = queue.pop()
    execute(task)
    
    while (nextTickQueue.hasTask()) {
      callback = nextTickQueue.pop()
      excute(callback)
    }
    
    while (promiseQueue.hasTask() {
      promise = promiseQueue.pop()
      excute(promise)
    }
  }
}
```

## Worker Event Loop åˆæ˜¯æ€æ ·çš„å‘¢ï¼Ÿ

å®ƒæ›´ç®€å•ï¼š

- æ²¡æœ‰ \<script> è§£æ
- æ²¡æœ‰ç”¨æˆ·äº¤äº’
- æ²¡æœ‰ DOMï¼ˆWorker ä¸èƒ½ç›´æ¥æ“ä½œ DOMï¼‰
- æ²¡æœ‰ requestAnimationFrame
- æ²¡æœ‰ process.nextTick
- æ²¡æœ‰ setImmediate

ä¸”çº¿ç¨‹ä¹‹é—´ç›¸äº’ç‹¬ç«‹ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„ Event Loopï¼Œäº’ä¸å¹²æ‰°ã€‚

ç°åœ¨ Event Loop ç”¨ä¼ªä»£ç è¡¨ç¤ºæ˜¯è¿™æ ·çš„ï¼š

```js
while (true) {
  task = taskQueue.pop()
  execute(task)
  
  while (microtaskQueue.hasTask() {
    microtask = microtaskQueue.pop()
    excute(microtask)
  }
}
```

ä½†æ³¨æ„ï¼Œå¦‚æœåœ¨ Web Worker çš„çº¿ç¨‹å‘ä¸»çº¿ç¨‹ä¼ é€’æ¶ˆæ¯ï¼Œè¿™ä¸ªæ¶ˆæ¯å¯¹äº Window Event Loop æ¥è¯´å±äºä¸€ä¸ª taskï¼Œå®ƒä»å—ä¸»çº¿ç¨‹çš„ Event Loop æ§åˆ¶ï¼Œè¯¥æ’é˜Ÿè¿˜å¾—æ’é˜Ÿã€‚

## æ€è€ƒé¢˜

å…ˆå›åˆ°æ–‡ç« å¼€å¤´çš„é¢˜ç›®ã€‚

### ç‚¹å‡»å“ªä¸ªæŒ‰é’®ä¼šå¯¼è‡´é¡µé¢å¡æ­»ï¼Ÿ

```html
<article>
  <h1>è’¹è‘­</h1>
  <p>è’¹è‘­è‹è‹ï¼Œç™½éœ²ä¸ºéœœã€‚æ‰€è°“ä¼Šäººï¼Œåœ¨æ°´ä¸€æ–¹ã€‚æº¯æ´„ä»ä¹‹ï¼Œé“é˜»ä¸”é•¿ã€‚æº¯æ¸¸ä»ä¹‹ï¼Œå®›åœ¨æ°´ä¸­å¤®ã€‚</p>
  <p>è’¹è‘­è‹è‹ï¼Œç™½éœ²æœªæ™ã€‚æ‰€è°“ä¼Šäººï¼Œåœ¨æ°´ä¹‹æ¹„ã€‚æº¯æ´„ä»ä¹‹ï¼Œé“é˜»ä¸”è·»ã€‚æº¯æ¸¸ä»ä¹‹ï¼Œå®›åœ¨æ°´ä¸­å»ã€‚</p>
  <p>è’¹è‘­é‡‡é‡‡ï¼Œç™½éœ²æœªå·²ã€‚æ‰€è°“ä¼Šäººï¼Œåœ¨æ°´ä¹‹æ¶˜ã€‚æº¯æ´„ä»ä¹‹ï¼Œé“é˜»ä¸”å³ã€‚æº¯æ¸¸ä»ä¹‹ï¼Œå®›åœ¨æ°´ä¸­æ²šã€‚</p>
  <p></p>
</article>

<button onclick="whileLoop()">ç‚¹æˆ‘</button>
<button onclick="timerLoop()">ç‚¹æˆ‘</button>
<button onclick="promiseLoop()">ç‚¹æˆ‘</button>

<script>
  function whileLoop() {
    while (true) {}
  }

  function timerLoop() {
    setTimeout(timerLoop, 0)
  }
  
  function promiseLoop() {
    Promise.resolve().then(promiseLoop)
  }
</script>
```

ç­”æ¡ˆï¼šwhileLoopã€promiseLoop ä¼šå¯¼è‡´é¡µé¢å¡æ­»ï¼ŒtimerLoop åˆ™ä¸ä¼šã€‚

whileLoop åˆ†æï¼šç‚¹å‡»æŒ‰é’®ï¼Œäº§ç”Ÿä¸€ä¸ª taskï¼Œè¿›å…¥ task queue æ’é˜Ÿã€‚è½®åˆ°å®ƒçš„æ—¶å€™ï¼Œæ‰§è¡Œ whileLoop() æ–¹æ³•ï¼Œé‡Œé¢æ˜¯ä¸€ä¸ªæ— çº¿å¾ªç¯çš„ while è¯­å¥ï¼Œå› æ­¤è¿™ä¸ª task ä¼šä¸€ç›´æ‰§è¡Œä¸‹å»ï¼Œä¸”è‡´ä½¿åé¢çš„ taskã€æ›´æ–° DOM ç­‰æ°¸è¿œæ— æ³•æ‰§è¡Œã€‚é¡µé¢å°±å¡æ­»äº†ã€‚

timerLoop åˆ†æï¼šç‚¹å‡»æŒ‰é’®ï¼Œäº§ç”Ÿä¸€ä¸ª taskï¼Œè¿›å…¥ task queue æ’é˜Ÿã€‚è½®åˆ°å®ƒçš„æ—¶å€™ï¼Œæ‰§è¡Œ timerLoop() æ–¹æ³•ï¼Œåˆäº§ç”Ÿä¸€ä¸ª task å¹¶æ”¾å…¥ task queueã€‚æ‰§è¡Œå®Œä¹‹åï¼Œå¦‚æœæœ‰ rendering opportunity ä¼šå…ˆæ›´æ–° DOMï¼Œå®Œäº†æ‰§è¡Œè¿›è¡Œä¸‹ä¸€è½®ã€‚å°½ç®¡ timerLoop é‡Œä¸åœåœ°äº§ç”Ÿæ–°çš„ taskï¼Œä½†ç”¨æˆ·ä»ç„¶é€šè¿‡æ–‡æœ¬é€‰æ‹©ã€é¡µé¢æ»šåŠ¨ç­‰äº§ç”Ÿå…¶ä»– task è¿›å…¥åˆ° task queue è¿›è¡Œæ’é˜Ÿã€‚å› æ­¤é¡µé¢æ˜¯ä¸ä¼šå‘ˆç°å¡æ­»çŠ¶æ€çš„ã€‚

promiseLoop åˆ†æï¼šç‚¹å‡»æŒ‰é’®ï¼Œäº§ç”Ÿä¸€ä¸ª taskï¼Œè¿›å…¥ task queue æ’é˜Ÿã€‚è½®åˆ°å®ƒçš„æ—¶å€™ï¼Œæ‰§è¡Œ promiseLoop() æ–¹æ³•ï¼Œå…¶ä¸­ Promise.resolve() äº§ç”Ÿä¸€ä¸ª microtask å¹¶æ”¾å…¥ microtask queueã€‚å½“ task æ‰§è¡Œå®Œï¼Œæ¥ç€ä» microtask queue é‡Œå–å‡º microtask æ‰§è¡Œï¼Œå³æ‰§è¡Œ then(promiseLoop)ï¼Œå®ƒæœ‰åˆäº§ç”Ÿæ–°çš„ microtaskï¼Œæ‰€ä»¥ microtask queue å°±ä¸€ç›´æœ‰ä»»åŠ¡å­˜åœ¨ï¼Œå› æ­¤ä¼šé™·å…¥æ­»å¾ªç¯ï¼Œè‡´ä½¿åé¢çš„ taskã€æ›´æ–° DOM ç­‰æ°¸è¿œæ— æ³•æ‰§è¡Œã€‚

### å®ƒä»¬ä¼šé—ªçƒå—ï¼Ÿ

ä½ æœ‰æ²¡æœ‰æ‹…å¿ƒè¿‡è¿™äº›ä»£ç ä¼šâ€œé—ªâ€ä¸€ä¸‹ï¼Ÿ

```js
document.body.appendChild(element)
element.style.display = 'none'
```
> å½“ç„¶ï¼Œå®é™…ä¸­æ›´å¤šæ˜¯å…ˆè®¾ç½®æ ·å¼å† appendChildï¼Œä½†æ•ˆæœæ˜¯ä¸€æ ·çš„ã€‚

è¯·é—®ç‚¹å‡»æŒ‰é’®çº¢è‰²å—ä¼šé—ªçƒå—ï¼Ÿ

```html
<div id="box" style="width: 100px; height: 100px; background: red"></div>
<button id="btn">Click me</button>

<script>
  const btn = document.getElementById('btn')
  const box = document.getElementById('box')

  btn.addEventListener('click', () => {
    box.style.display = 'none'
    box.style.display = 'block'
    box.style.display = 'none'
    box.style.display = 'block'
    box.style.display = 'none'
    box.style.display = 'block'
    // ...
  })
</script>
```

[CodePen](https://codepen.io/tofrankie/pen/vYqdGKK)

> ç­”æ¡ˆï¼šéƒ½ä¸ä¼šã€‚

åˆ†æï¼šä¸Šè¿°ç‚¹å‡»äº‹ä»¶äº§ç”Ÿä¸€ä¸ª taskï¼ˆäº‹ä»¶å›è°ƒï¼‰ï¼Œåªæœ‰æ‰§è¡Œå®Œ task é‡Œé¢çš„ä»£ç ï¼Œæ‰ä¼šæ‰§è¡Œåé¢çš„å¾®ä»»åŠ¡æˆ–æ›´æ–° DOMã€‚ä¹Ÿå°±æ˜¯è¯´æ¸²æŸ“ä¹‹å‰ï¼Œå®é™…åªæœ‰æœ€åä¸€è¡Œçš„æ ·å¼è®¾ç½®æ˜¯èµ·ä½œç”¨çš„ï¼Œä¸ç®¡ä¸­é—´è®¾äº†å¤šå°‘éï¼Œæµè§ˆå™¨åªå…³å¿ƒæœ€åçš„æ ·å¼å¦‚ä½•ã€‚

### å®ƒä»¬çš„æ‰§è¡Œé¡ºåºæ˜¯ï¼Ÿ

ä»¥ä¸‹ç¤ºä¾‹ï¼Œä¸€ä¸ªæŒ‰é’®ç»‘å®šäº†ä¸¤ä¸ª click äº‹ä»¶ï¼š

```js
<button id="btn">Click me</button>

<script>
  const btn = document.getElementById('btn')

  btn.addEventListener('click', () => {
    Promise.resolve().then(() => console.log('microtask 1'))
    console.log('listener 1')
  })

  btn.addEventListener('click', () => {
    Promise.resolve().then(() => console.log('microtask 2'))
    console.log('listener 2')
  })
  
  // btn.click()
</script>
```

ç°è§¦å‘ click äº‹ä»¶çš„æ–¹å¼æœ‰ä¸¤ç§ï¼šä¸€ä¸ªæ˜¯é€šè¿‡é¼ æ ‡ç‚¹å‡»è§¦å‘ï¼Œå¦ä¸€ä¸ªæ˜¯é€šè¿‡ `btn.click()` è§¦å‘ã€‚è¿™ä¸¤ç§æ–¹å¼çš„æ‰§è¡Œé¡ºåºä¸€æ ·å—ï¼Ÿ

é€šè¿‡é¼ æ ‡ç‚¹å‡»çš„ç»“æœæ˜¯ï¼š

```txt
listener 1
microtask 1
listener 2
microtask 2
```

é€šè¿‡ `btn.click()` çš„ç»“æœæ˜¯ï¼š

```txt
listener 1
listener 2
microtask 1
microtask 2
```

åŸå› åˆ†æï¼šé€šè¿‡ä¸ç”¨æˆ·äº¤äº’è€Œè§¦å‘çš„äº‹ä»¶ï¼Œå…¶ç›‘å¬å™¨æ˜¯å¼‚æ­¥è°ƒç”¨çš„ï¼Œè€Œé€šè¿‡ `btn.click()` è§¦å‘ï¼Œä¼šåŒæ­¥æ´¾å‘äº‹ä»¶ï¼Œå¹¶ä»¥åˆé€‚çš„é¡ºåºåŒæ­¥åœ°è°ƒç”¨ç›‘å¬å™¨ã€‚

å¯¹äºâ€œé¼ æ ‡â€ç‚¹å‡»ï¼šç”±äº btn æ³¨å†Œäº†ä¸¤ä¸ª click ç›‘å¬å™¨ï¼Œé¼ æ ‡ç‚¹å‡»ä¸€æ¬¡ï¼Œäº§ç”Ÿä¸¤ä¸ª task è¿›å…¥ task queueï¼Œå…ˆåæ‰§è¡Œï¼Œå› æ­¤å¾—åˆ°å‰é¢çš„ç»“æœã€‚

å¯¹äº `btn.click()` æ¨¡æ‹Ÿç‚¹å‡»ï¼šå½“æ‰§è¡Œåˆ° `btn.click()` æ—¶ï¼ŒæŒ‰é¡ºåºåŒæ­¥æ‰§è¡Œä¸¤ä¸ªç›‘å¬å™¨ã€‚

> The `dispatchEvent()` method of the EventTarget sends an Event to the object, (synchronously) invoking the affected event listeners in the appropriate order. The normal event processing rules (including the capturing and optional bubbling phase) also apply to events dispatched manually with `dispatchEvent()`.

1. æ‰§è¡Œåˆ°ç¬¬ä¸€ä¸ªç›‘å¬å™¨ Promise.resolve() æ—¶äº§ç”Ÿä¸€ä¸ª microtask å…¥é˜Ÿåˆ° microtask queueã€‚
2. æ¥ç€æ‰“å° listener 1ã€‚
3. æ³¨æ„ï¼Œæ­¤æ—¶è°ƒç”¨æ ˆé‡Œè¿˜æ²¡æ‰§è¡Œå®Œï¼Œæ‰€ä»¥æ¥ç€å¹¶ä¸æ˜¯ç«‹é©¬æ‰§è¡Œ microtask queue é‡Œçš„ä»»åŠ¡ã€‚è€Œæ˜¯æ¥ç€æ‰§è¡Œç¬¬äºŒä¸ªç›‘å¬å™¨ã€‚åŒæ ·åœ°ï¼Œå®ƒåˆäº§ç”Ÿä¸€ä¸ª microtask å…¥é˜Ÿåˆ° microtask queueã€‚
4. æ¥ç€æ‰“å° listener 2ã€‚
5. æ­¤æ—¶è°ƒç”¨æ ˆç©ºäº†ï¼Œæ¥ç€ä» microtask queue å–å‡ºä»»åŠ¡ï¼Œé€ä¸ªæ‰§è¡Œï¼Œå› æ­¤å…ˆåæ‰“å° microtask 1ã€microtask 2ã€‚

> å¯ä»¥é€šè¿‡ `event.isTrusted` æ¥åŒºåˆ†ä¸¤ç§è§¦å‘æ–¹å¼ï¼Œç”¨æˆ·ä¸æµè§ˆå™¨äº¤äº’è€Œäº§ç”Ÿçš„äº‹ä»¶ `isTrusted` ä¸º `true`ï¼Œä½¿ç”¨ JavaScript æ¥æ¨¡æ‹Ÿç‚¹å‡»ç­‰äº‹ä»¶è§¦å‘çš„ `isTrusted` ä¸º `false`ã€‚

## References

- [Event Loop Standard](https://html.spec.whatwg.org/multipage/webappapis.html#event-loops)
- [The Node.js Event Loop](https://nodejs.org/en/learn/asynchronous-work/event-loop-timers-and-nexttick)
- [Philip Roberts: What the heck is the event loop anyway?](https://www.youtube.com/watch?v=8aGhZQkoFbQ)
- [Erin Zimmer: Further Adventures of the Event Loop](https://www.youtube.com/watch?v=u1kqx6AenYw)
- [Jake Archibald: In The Loop](https://www.youtube.com/watch?v=cCOL7MC4Pl0)
- [Tasks, microtasks, queues and schedules](https://jakearchibald.com/2015/tasks-microtasks-queues-and-schedules/)
