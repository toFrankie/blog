---
title: é€šè¿‡ä¸¤ä¸ªä¾‹å­å†æ¢ Event Loop
number: '#348'
link: 'https://github.com/toFrankie/blog/issues/348'
created_at: '2024-08-11 16:42:16'
updated_at: '2024-08-18 18:37:50'
labels:
  - å‰ç«¯
  - JS
  - '2024'
---


![é…å›¾æºè‡ª Freepik](https://cdn.jsdelivr.net/gh/toFrankie/blog@main/images/2024/8/1723914079530.jpg)

## æé—®

å‡è®¾æœ‰ç¤ºä¾‹ï¼š

```html
<article>
  <h1>è’¹è‘­</h1>
  <p>è’¹è‘­è‹è‹ï¼Œç™½éœ²ä¸ºéœœã€‚æ‰€è°“ä¼Šäººï¼Œåœ¨æ°´ä¸€æ–¹ã€‚æº¯æ´„ä»ä¹‹ï¼Œé“é˜»ä¸”é•¿ã€‚æº¯æ¸¸ä»ä¹‹ï¼Œå®›åœ¨æ°´ä¸­å¤®ã€‚</p>
  <p>è’¹è‘­è‹è‹ï¼Œç™½éœ²æœªæ™ã€‚æ‰€è°“ä¼Šäººï¼Œåœ¨æ°´ä¹‹æ¹„ã€‚æº¯æ´„ä»ä¹‹ï¼Œé“é˜»ä¸”è·»ã€‚æº¯æ¸¸ä»ä¹‹ï¼Œå®›åœ¨æ°´ä¸­å»ã€‚</p>
  <p>è’¹è‘­é‡‡é‡‡ï¼Œç™½éœ²æœªå·²ã€‚æ‰€è°“ä¼Šäººï¼Œåœ¨æ°´ä¹‹æ¶˜ã€‚æº¯æ´„ä»ä¹‹ï¼Œé“é˜»ä¸”å³ã€‚æº¯æ¸¸ä»ä¹‹ï¼Œå®›åœ¨æ°´ä¸­æ²šã€‚</p>
  <p></p>
</article>

<button onclick="whileLoop()">ç‚¹æˆ‘</button>
<button onclick="timerLoop()">ç‚¹æˆ‘</button>

<script>
  function whileLoop() {
    while (true) {}
  }

  function timerLoop() {
    setTimeout(timerLoop, 0)
  }
</script>
```

è¯·é—®ä¸Šè¿°ä¸¤ä¸ªç‚¹å‡»äº‹ä»¶ä¼šå¯¼è‡´é¡µé¢å¡æ­»å—ï¼Ÿ

## ä»ç®€å•è¯´èµ·

Event Loop æ˜¯æµè§ˆå™¨æœ€é‡è¦çš„æœºåˆ¶ï¼Œå®ƒç¡®ä¿äº†é¡µé¢å¯ä»¥æœ‰åºæ‰§è¡Œã€‚

ç”¨ä¼ªä»£ç è¡¨ç¤ºï¼š

```js
while (true) {
  task = taskQueue.pop()
  execute(task)
}
```

æ²¡é”™ï¼Œå®ƒæ˜¯æ— é™å¾ªç¯çš„ï¼Œ7 Ã— 24h éšæ—¶å¾…å‘½ï¼Œåªè¦ä»»åŠ¡é˜Ÿåˆ—æœ‰ä»»åŠ¡ï¼Œå®ƒå°±ä¸æ–­åœ°ä»é˜Ÿåˆ—ä¸­å–å‡ºä¸€ä¸ªä»»åŠ¡æ‰§è¡Œå®Œï¼Œæ¥ç€ä¸‹ä¸€ä¸ªï¼Œç›´åˆ°æ‰§è¡Œå®Œé˜Ÿåˆ—ä¸­æ‰€æœ‰ä»»åŠ¡ã€‚

### ä»€ä¹ˆæ˜¯ä»»åŠ¡ï¼Ÿ

å‡è®¾æœ‰é¡µé¢ï¼š

```html
<div id="count">0</div>
<button id="btn">+1</button>

<script>
  let count = 0

  document.getElementById('btn').addEventListener('click', () => {
    document.getElementById('count').textContent = ++count
  })
</script>
```

ä¸Šè¿°ç¤ºä¾‹ï¼Œæˆ‘ä»¬ç»™æŒ‰é’®æ³¨å†Œäº†ä¸€ä¸ªç‚¹å‡»ç›‘å¬äº‹ä»¶ã€‚

ç”¨æˆ·æ¯ç‚¹å‡»æŒ‰é’®ä¸€æ¬¡ï¼Œå°±ä¼šäº§ç”Ÿä¸€ä¸ªä»»åŠ¡ï¼Œå¹¶æ·»åŠ åˆ°ä»»åŠ¡é˜Ÿåˆ—ã€‚

é™¤æ­¤ä¹‹å¤–ï¼Œä¸ç”¨æˆ·å‘ç”Ÿäº¤äº’è€Œäº§ç”Ÿçš„æ‰€æœ‰äº‹ä»¶å›è°ƒï¼ˆæ¯”å¦‚åŒå‡»ã€æ–‡æœ¬é€‰æ‹©ã€é¡µé¢æ»šåŠ¨ã€é”®ç›˜è¾“å…¥ç­‰ï¼‰ã€setTimeoutã€setIntervalã€\<script> å—ã€I/O æ“ä½œç­‰éƒ½å±äºä»»åŠ¡ã€‚

> ä»»åŠ¡é‡Œä¹Ÿå¯ä»¥äº§ç”Ÿæ–°ä»»åŠ¡ã€‚

### ä»€ä¹ˆæ˜¯ä»»åŠ¡é˜Ÿåˆ—ï¼Ÿ

é˜Ÿåˆ—æ˜¯ä¸€ç§å…ˆè¿›å…ˆå‡ºï¼ˆfirst in, first outï¼‰çš„æœºåˆ¶ã€‚

ä¹Ÿå°±æ˜¯è¯´ï¼Œæ›´æ—©æ”¾å…¥ä»»åŠ¡é˜Ÿåˆ—çš„ä»»åŠ¡ä¼šä¼˜å…ˆæ‰§è¡Œï¼Œæ’åœ¨åé¢çš„åˆ™å¿…é¡»ç­‰å¾…å‰é¢çš„ä»»åŠ¡æ‰§è¡Œå®Œä¹‹åæ‰ä¼šå¼€å§‹æ‰§è¡Œã€‚

### é¡µé¢æ¸²æŸ“

å®é™…æƒ…å†µè¿˜æœ‰æ›´å¤æ‚ä¸€äº›ã€‚

æœ¬è´¨ä¸Šï¼Œç½‘é¡µå°±æ˜¯ç»™äººçœ‹çš„ï¼Œä¸äººäº¤äº’çš„ï¼Œæ‰€ä»¥ç”¨æˆ·ä½“éªŒéå¸¸é‡è¦ã€‚å‡è®¾ä»»åŠ¡é˜Ÿåˆ—æœ‰æºæºä¸æ–­çš„ä»»åŠ¡äº§ç”Ÿï¼Œå¦‚æœ Event Loop åªä¼šä¸€ç›´å¾ªç¯æ‰§è¡Œé˜Ÿåˆ—é‡Œçš„ä»»åŠ¡ï¼Œè€Œä¸å»æ›´æ–°é¡µé¢ï¼Œç”¨æˆ·ä½“éªŒæ˜¯éå¸¸ç³Ÿç³•çš„ã€‚

å› æ­¤ï¼Œå½“ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œå®Œï¼Œâ€œ**å¯èƒ½**â€ä¼šå…ˆæ›´æ–° DOMï¼Œå®Œäº†ä¹‹åæ‰æ‰§è¡Œä¸‹ä¸€ä¸ªä»»åŠ¡ã€‚

> è‡³æ­¤ï¼Œå¯ä»¥å†æ€è€ƒä¸‹æ–‡ç« å¼€å¤´çš„æé—®ã€‚

æµè§ˆå™¨æ˜¯éå¸¸èªæ˜çš„ï¼Œæ²¡å¿…è¦çš„å·¥ä½œå®ƒä¸ä¼šåšã€‚ä»¥ 60Hz åˆ·æ–°ç‡çš„æ˜¾ç¤ºå™¨ä¸ºä¾‹ï¼Œæ¯ç§’åˆ·æ–° 60 æ¬¡ï¼Œçº¦ 16.7ms åˆ·æ–°ä¸€æ¬¡ã€‚æ»¡è¶³è¿™ä¸ªåˆ·æ–°é¢‘ç‡çš„ï¼Œé‚£ä¹ˆæ˜¾ç¤ºæ•ˆæœç®—æ˜¯æµç•…çš„ï¼Œå¦åˆ™å°±ä¼šæœ‰å¡é¡¿æ„Ÿï¼ˆéšç€æ›´é«˜åˆ·æ–°ç‡çš„æ˜¾ç¤ºè®¾å¤‡è¶Šæ¥è¶Šå¤šï¼Œå¯¹æ¯”ä¹‹ä¸‹ 60Hz åˆ·æ–°ç‡ä¹Ÿä¸ç®—å¾ˆæµç•…ï¼Œå½“ç„¶è¿™æ˜¯é¢˜å¤–è¯ï¼‰ã€‚å‡è®¾ä¸€ä¸ªä»»åŠ¡åªè€—æ—¶ 3 ~ 5msï¼Œè¿œæ²¡åˆ°è¾¾ 16msï¼Œæ­¤æ—¶æ›´æ–° DOM æ˜¯æ²¡æœ‰æ„ä¹‰çš„ï¼Œè¿™æ ·çš„è¯æµè§ˆå™¨å°±ä¸ä¼šæ›´æ–° DOMï¼Œè€Œæ˜¯æ¥ç€æ‰§è¡Œä¸‹ä¸€ä¸ªä»»åŠ¡ã€‚å› æ­¤ï¼Œå‰é¢æ‰ä¼šæåˆ°â€œå¯èƒ½â€äºŒå­—ã€‚

> è§„èŒƒä¸å¼ºåˆ¶è¦æ±‚ä½¿ç”¨ä»»ä½•ç‰¹å®šæ¨¡å‹æ¥é€‰æ‹©æ¸²æŸ“æœºä¼šã€‚ä½†ä¾‹å¦‚ï¼Œå¦‚æœæµè§ˆå™¨å°è¯•å®ç° 60Hz åˆ·æ–°ç‡ï¼Œåˆ™æ¸²æŸ“æœºä¼šæœ€å¤šæ¯ 60 ç§’å‡ºç°ä¸€æ¬¡ï¼ˆçº¦ 16.7msï¼‰ã€‚å¦‚æœæµè§ˆå™¨å‘ç° [navigable](https://html.spec.whatwg.org/multipage/document-sequences.html#navigables) æ— æ³•ç»´æŒæ­¤é€Ÿç‡ï¼Œåˆ™è¯¥ navigable å¯èƒ½ä¼šä¸‹é™åˆ°æ›´å¯æŒç»­çš„æ¯ç§’ 30 ä¸ªæ¸²æŸ“æœºä¼šï¼Œè€Œä¸æ˜¯å¶å°”ä¸¢å¸§ã€‚ç±»ä¼¼åœ°ï¼Œå¦‚æœ navigable ä¸å¯è§ï¼Œç”¨æˆ·ä»£ç†å¯èƒ½ä¼šå†³å®šå°†è¯¥é¡µé¢é™ä½åˆ°æ¯ç§’ 4 ä¸ªæ¸²æŸ“æœºä¼šï¼Œç”šè‡³æ›´å°‘ã€‚

> æ¯”å¦‚ React 16 çš„è°ƒåº¦æœºåˆ¶ï¼Œå¯ä»¥æ§åˆ¶ä¸­æ–­å½“å‰æ‰§è¡Œä¸­çš„ä»»åŠ¡ï¼Œæ‰§è¡Œå®Œä¼˜å…ˆçº§æ›´é«˜çš„ä»»åŠ¡ï¼ˆæ¯”å¦‚æ›´æ–° DOMï¼‰ï¼Œå®Œäº†å†ç»§ç»­æ­¤å‰æœªå®Œæˆçš„ä»»åŠ¡ï¼Œä»¥è§£å†³æŸäº›åœºæ™¯ä¸‹é¡µé¢å¡é¡¿çš„é—®é¢˜ã€‚

Event Loop ç°åœ¨æ˜¯è¿™æ ·çš„ï¼š

```js
while (true) {
  task = taskQueue.pop()
  execute(task)
  
  if (isRepaintTime()) repaint()
}
```

## å¼€å§‹å¤æ‚èµ·æ¥äº†

å®é™…è¿œæ²¡é‚£ä¹ˆç®€å•ã€‚ä»[è§„èŒƒ](https://html.spec.whatwg.org/multipage/webappapis.html#event-loops)å¯ä»¥çœ‹åˆ°ï¼š

> An event loop has one or more task queues.

> Task queues are [sets](https://infra.spec.whatwg.org/#ordered-set), not [queues](https://infra.spec.whatwg.org/#queue), because the [event loop processing model](https://html.spec.whatwg.org/multipage/webappapis.html#event-loop-processing-model) grabs the first [runnable task](https://html.spec.whatwg.org/multipage/webappapis.html#concept-task-runnable) from the chosen queue, instead of [dequeuing](https://infra.spec.whatwg.org/#queue-dequeue) the first task.

> The [microtask queue](https://html.spec.whatwg.org/multipage/webappapis.html#microtask-queue) is not a task queue.

ä»€ä¹ˆï¼Ÿ

- Event Loop æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªä»»åŠ¡é˜Ÿåˆ—ã€‚
- ä»»åŠ¡é˜Ÿåˆ—æ˜¯é›†åˆï¼Œä¸æ˜¯é˜Ÿåˆ—ã€‚
- æ‰§è¡Œæ—¶ï¼Œäº‹ä»¶å¾ªç¯å¤„ç†æ¨¡å‹ä»æ‰€é€‰é˜Ÿåˆ—ä¸­è·å–ç¬¬ä¸€ä¸ªå¯è¿è¡Œçš„ä»»åŠ¡ï¼Œè€Œä¸æ˜¯ä½¿ç¬¬ä¸€ä¸ªä»»åŠ¡å‡ºé˜Ÿã€‚

å®Œäº†ï¼Œæ¨ç¿»äº†å‰é¢çš„ç»“è®ºï¼Œå•ªå•ªæ‰“è„¸ ğŸ¤¦

å…¶å®ä¸ä¸€å®šï¼Œå¦‚æœä½ åªæƒ³äº†è§£ Event Loop ä¸»è¦æ‰§è¡Œé¡ºåºï¼Œä¸æ·±å…¥æµè§ˆå™¨ç©¶ç«Ÿç»´æŠ¤äº†å¤šå°‘ä¸ªä»»åŠ¡é˜Ÿåˆ—ã€æµè§ˆå™¨å¦‚ä½•å†³å®šä¸‹ä¸€ä»»åŠ¡ï¼Œé‚£ä¹ˆç®€å•åœ°ç†è§£ä¸ºè¿™æ ·ä¹Ÿæ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼šEvent Loop åªæœ‰ä¸€ä¸ªä»»åŠ¡é˜Ÿåˆ—ï¼Œé˜Ÿåˆ—ä»æ˜¯æŒ‰ç…§å…ˆè¿›å…ˆå‡ºçš„é¡ºåºæ‰§è¡Œï¼Œåªä¸è¿‡å®ƒå®é™…ç”±æµè§ˆå™¨å†³å®šï¼Œå°†å…¶æŒ‰åºæ”¾å…¥æˆ‘ä»¬æ‰€ç†è§£çš„â€œä»»åŠ¡é˜Ÿåˆ—â€é‡Œé¢è€Œå·²ã€‚

> æƒ³äº†è§£æ›´å¤šè¯·çœ‹ [Processing model](https://html.spec.whatwg.org/multipage/webappapis.html#event-loop-processing-model)ã€‚

Event Loop ç°åœ¨æ˜¯è¿™æ ·çš„ï¼š

```js
while (true) {
  queue = getNextQueue()
  task = queue.getFirstRunnableTask()
  execute(task)
  
  if (isRepaintTime()) repaint()
}
```

## è¿˜æ²¡å®Œï¼Œè¿˜æœ‰å¾®ä»»åŠ¡

è¿˜æ²¡å®Œï¼Œè¿˜æ²¡å®Œï¼Œè¿˜æœ‰å¾®ä»»åŠ¡é˜Ÿåˆ—ã€‚

ä»[è§„èŒƒ](https://html.spec.whatwg.org/multipage/webappapis.html#microtask-queue)å¯ä»¥çœ‹åˆ°ï¼š

> Each event loop has a [microtask queue](https://html.spec.whatwg.org/multipage/webappapis.html#microtask-queue), which is a [queue](https://infra.spec.whatwg.org/#queue) of microtasks, initially empty.

> A [microtask](https://html.spec.whatwg.org/multipage/webappapis.html#microtask) is a colloquial way of referring to a [task](https://html.spec.whatwg.org/multipage/webappapis.html#concept-task) that was created via the [queue a microtask](https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-microtask) algorithm.

> The microtask queue is not a [task queue](https://html.spec.whatwg.org/multipage/webappapis.html#task-queue).

å¥½ï¼Œæˆ‘ä»¬é‡æ–°æ‹ä¸€ä¸‹ï¼š

- ä¸€ä¸ª Event Loop æœ‰ä¸€ä¸ªæˆ–å¤šä¸ª task queueã€‚
- ä¸€ä¸ª Event Loop æœ‰ä¸”ä»…æœ‰ä¸€ä¸ª microtask queueã€‚
- task æ˜¯ä¸€ä¸ªç”±ç‰¹å®šå±æ€§çš„å¯¹è±¡ï¼ˆè§„èŒƒä¸­ç§°ä¸º [struct](https://html.spec.whatwg.org/multipage/webappapis.html#concept-task)ï¼‰ã€‚
- microtask åªæ˜¯ä¸€ç§é€šä¿—çš„è¯´æ³•ï¼Œå®ƒæ˜¯é€šè¿‡[ç‰¹å®šç®—æ³•](https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-microtask)åˆ›å»ºçš„ taskã€‚
- task queue æ˜¯ä¸€ç»„ task çš„[é›†åˆ](https://infra.spec.whatwg.org/#ordered-set)ï¼Œå¹¶ä¸æ˜¯[é˜Ÿåˆ—](https://infra.spec.whatwg.org/#queue)ã€‚
- microtask æ˜¯é˜Ÿåˆ—ï¼Œå‡ºé˜Ÿæ—¶æŒ‰å…ˆè¿›å…ˆå‡ºçš„é¡ºåºã€‚
- microtask queue ä¸æ˜¯ task queueï¼Œå‰è€…æ˜¯é˜Ÿåˆ—ï¼Œåè€…æ˜¯é›†åˆã€‚

ä¸ºä¾¿äºåŒºåˆ†ç†è§£ï¼Œæœ¬æ–‡æš‚ä¸”å°†ä»¥ä¸‹è§„èŒƒæœ¯è¯­å£è¯­åŒ–ï¼ˆ**ä½†æ³¨æ„è¿™ç§è¯´æ³•ä¸ä¸€å®šå‡†ç¡®**ï¼‰ã€‚

* taskï¼šï¼ˆå®ï¼‰ä»»åŠ¡
* task queueï¼šï¼ˆå®ï¼‰ä»»åŠ¡é˜Ÿåˆ—
* microtaskï¼šå¾®ä»»åŠ¡
* microtask queueï¼šå¾®ä»»åŠ¡é˜Ÿåˆ—

### ä½•æ—¶æ‰§è¡Œï¼Ÿ

ä»è§„èŒƒï¼ˆ[Processing model](https://html.spec.whatwg.org/multipage/webappapis.html#event-loop-processing-model)ï¼‰å¯çŸ¥ï¼Œåªæœ‰ Event Loop å­˜åœ¨ï¼Œå°±å¿…é¡»ä¸æ–­æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š

1. ä»ï¼ˆå®ï¼‰ä»»åŠ¡é˜Ÿåˆ—å–å‡ºä¸€ä¸ª task
2. æ‰§è¡Œè¯¥ task
3. æ‰§è¡Œå¾®ä»»åŠ¡æ£€æŸ¥ç‚¹ï¼ˆ[microtask checkpoint](https://html.spec.whatwg.org/multipage/webappapis.html#perform-a-microtask-checkpoint)ï¼‰
    1. å¦‚æœæ£€æŸ¥ç‚¹æ ‡å¿—ä¸ºçœŸï¼ˆåˆå§‹å€¼ä¸º falseï¼‰ï¼Œåˆ™è¿”å›ï¼ˆè·³å‡ºå¾®ä»»åŠ¡æ‰§è¡Œï¼‰ã€‚
    2. å°†æ£€æŸ¥ç‚¹æ ‡å¿—è®¾ä¸º true
    3. å¦‚æœå½“å‰ Event Loop é‡Œçš„å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸ä¸ºç©ºï¼Œå°†ä¸€ç›´å¾ªç¯ç›´è‡³å¾®é˜Ÿåˆ—ä¸ºç©ºï¼š
        1. åœ¨å¾®ä»»åŠ¡é˜Ÿåˆ—é‡Œå–å‡ºçš„ç¬¬ä¸€ä¸ªå¾®ä»»åŠ¡ï¼ˆæ­¤å¤„çš„å‡ºé˜Ÿï¼Œå°±æ˜¯å…ˆè¿›å…ˆå‡ºçš„å‡ºé˜Ÿï¼‰
        2. æ‰§è¡Œè¯¥ microtask
    4. å°†æ£€æŸ¥ç‚¹æ ‡å¿—è®¾ä¸º false
4. é‡å¤ä¸Šè¿°æ­¥éª¤

> ä»¥ä¸Šä¸ºç®€åŒ–åçš„æ­¥éª¤ï¼Œä¸ºäº†æ›´ç®€å•åœ°ä»‹ç» task å’Œ microtask æ‰§è¡Œé¡ºåºã€‚

è¯·æ³¨æ„ï¼Œå¦‚æœåœ¨æ‰§è¡Œå¾®é˜Ÿåˆ—ä»»åŠ¡çš„è¿‡ç¨‹ä¸­ï¼Œäº§ç”Ÿæ›´å¤šæ–°çš„å¾®ä»»åŠ¡ï¼Œå®ƒä»¬å°†ä¼šåœ¨ä¸‹ä¸€ä¸ªï¼ˆå®ï¼‰ä»»åŠ¡ä¹‹å‰æ‰§è¡Œã€‚

è‡³æ­¤ï¼Œæ–‡ç« å¼€å¤´çš„æé—®ä¹‹ä¸€å°±æœ‰ç­”æ¡ˆã€‚

Event Loop çš„ä¸æ–­å¾ªç¯æ‰§è¡Œæ˜¯åœ¨ä¸»çº¿ç¨‹å®Œæˆçš„ï¼Œè€Œä¸”æ˜¯å•çº¿ç¨‹çš„ï¼Œé‚£ä¹ˆå®ƒå°±ä¼šä¸€ç›´é‡å¤ä¸Šè¿° 3.iii çš„è¿‡ç¨‹ï¼Œå®ƒå°†æ— ä¼‘æ­¢ä¸‹å»ï¼Œè‡ªç„¶æ— æ³•æ›´æ–° DOMã€æ‰§è¡Œåé¢çš„ï¼ˆå®ï¼‰ä»»åŠ¡ï¼Œå› æ­¤é¡µé¢å°±â€œå¡æ­»â€äº†ã€‚

### æœ‰å“ªäº›å¾®ä»»åŠ¡ï¼Ÿ

åœ¨ JavaScript é‡Œä¼šäº§ç”Ÿå¾®ä»»åŠ¡çš„å¤§æ¦‚æœ‰ï¼š

- queueMicrotaskï¼ˆWindow æˆ– Web Workerï¼‰
- Promise å›è°ƒ
- MutationObserver å›è°ƒ
- Object.observeï¼ˆDeprecatedï¼‰

Event Loop ç°åœ¨æ˜¯è¿™æ ·çš„ï¼š

```js
while (true) {
  queue = getNextQueue()
  task = queue.getFirstRunnableTask()
  execute(task)
  
  while (microtaskQueue.hasTask() {
    microtask = microtaskQueue.pop()
    excute(microtask)
  }
  
  if (isRepaintTime()) repaint()
}
```

## å™¢ï¼Œè¿˜æœ‰ requestAnimationFrame

æ˜¯çš„ï¼Œè¿˜æ²¡å®Œï¼Œè¿˜æœ‰ä¸€ä¸ª requestAnimationFrameï¼Œå…¶å›è°ƒå‡½æ•°ä¼šåœ¨é¡µé¢é‡ç»˜ä¹‹å‰è°ƒç”¨ã€‚

å½“æµè§ˆå™¨æ£€æµ‹åˆ°è¯¥æ›´æ–°å±å¹•äº†ï¼Œä¼šæ‰§è¡Œä»¥ä¸‹æµç¨‹ï¼š

1. æ‰§è¡Œ requestAnimationFrame å›è°ƒ
2. åˆæˆï¼šè®¡ç®—æ ·å¼ï¼Œå°† DOM Tree å’Œ CSSOM Tree åˆæˆä¸€ä¸ª Render Treeï¼ˆAttachmentï¼‰
3. é‡æ’ï¼šä»¥ç¡®å®šæ¯ä¸ªèŠ‚ç‚¹æ‰€å ç©ºé—´ã€æ‰€åœ¨ä½ç½®ç­‰ï¼ˆLayoutï¼‰
4. é‡ç»˜ï¼šä»¥è®¾ç½®é¢œè‰²ç­‰ï¼ˆPaintï¼‰

> å®é™…æƒ…å†µï¼ŒEdge å’Œ Safari æµè§ˆå™¨å°† requestAnimationFrame å›è°ƒæ”¾åˆ° Paint åé¢æ‰§è¡Œï¼Œè¿™æ˜¯éæ ‡å‡†åšæ³•ã€‚å¦‚æœå›è°ƒä¸­æ¶‰åŠæ ·å¼ï¼Œä¹Ÿå°±æ˜¯è¯´ç”¨æˆ·è¦åœ¨ä¸‹ä¸€å¸§æ‰èƒ½çœ‹åˆ°å˜åŒ–ã€‚

> æ˜¯å¦å·²ä¿®å¤ï¼Œå¾…éªŒè¯ã€‚

å¥½äº†ï¼Œç°åœ¨ Event Loop é‡Œè¿˜æœ‰ä¸€ä¸ª animation frame callbacksï¼Œå®ƒæ˜¯ä¸€ä¸ªæ˜ å°„ï¼ˆ[ordered map](https://infra.spec.whatwg.org/#ordered-map)ï¼‰ã€‚å°†å®ƒç®€å•ç†è§£ä¸ºâ€œé˜Ÿåˆ—â€ä¹Ÿä¸æ˜¯ä¸è¡Œï¼Œå› ä¸ºæ ¹æ® [run the animation frame callbacks](https://html.spec.whatwg.org/multipage/imagebitmap-and-animations.html#run-the-animation-frame-callbacks) å¯ä»¥çœ‹åˆ°ï¼Œä¹Ÿæ˜¯ä»ç¬¬ä¸€ä¸ªå¼€å§‹éå†æ‰§è¡Œã€‚

è¿˜è¦æ³¨æ„ï¼Œå¦‚æœéå†æ‰§è¡Œ callbacks çš„è¿‡ç¨‹ä¸­äº§ç”Ÿæ–°çš„ callbackï¼Œå®ƒä»¬ä¼šæ”¾åˆ°ä¸‹ä¸€æ¬¡ Loop æ‰§è¡Œï¼Œè¿™ç‚¹è·Ÿå¾®ä»»åŠ¡æ˜¯ä¸ä¸€æ ·çš„ã€‚

Event Loop ç°åœ¨æ˜¯è¿™æ ·çš„ï¼š

```js
while (true) {
  queue = getNextQueue()
  task = queue.getFirstRunnableTask()
  execute(task)
  
  while (microtaskQueue.hasTask() {
    microtask = microtaskQueue.pop()
    excute(microtask)
  }
  
  if (isRepaintTime()) {
    callbacks = animationFrameCallbacks.splice(0, animationFrameCallbacks.length)
    for (callback of callbacks) {
      execute(callback)
    }
    
    repaint()
  }
}
```

### æ€è€ƒé¢˜

ä½ æœ‰æ²¡æœ‰æ‹…å¿ƒè¿‡ï¼Œä»¥ä¸‹ä»£ç ä¼šâ€œé—ªä¸€ä¸‹â€ï¼Ÿ

```js
document.body.appendChild(someElement)
someElement.style.display = 'none'
```

å†æ¯”å¦‚ï¼š

```js
<div id="box" style="width: 100px; height: 100px; background: red"></div>
<button id="btn">Click me</button>

<script>
  const btn = document.getElementById('btn')
  const box = document.getElementById('box')

  btn.addEventListener('click', () => {
    box.style.display = 'none'
    box.style.display = 'block'
    box.style.display = 'none'
    box.style.display = 'block'
    box.style.display = 'none'
    box.style.display = 'block'
    // ...
  })
</script>
```

[CodePen](https://codepen.io/tofrankie/pen/vYqdGKK)

è¯·é—®ç‚¹å‡»æŒ‰é’®çº¢è‰²å—ä¼šé—ªçƒå—ï¼Ÿ

> ç­”æ¡ˆï¼šä¸ä¼šã€‚

åŸå› ï¼šä¸Šè¿°ç‚¹å‡»äº‹ä»¶äº§ç”Ÿä¸€ä¸ª taskï¼ˆäº‹ä»¶å›è°ƒï¼‰ï¼Œåªæœ‰æ‰§è¡Œå®Œ task é‡Œé¢çš„ä»£ç ï¼Œæ‰æœ‰å¯èƒ½è¿›å…¥æ¸²æŸ“æµç¨‹ã€‚ä¹Ÿå°±æ˜¯è¯´æ¸²æŸ“ä¹‹å‰ï¼Œå®é™…åªæœ‰æœ€åä¸€è¡Œçš„æ ·å¼è®¾ç½®æ˜¯èµ·ä½œç”¨çš„ï¼Œä¸ç®¡ä½ ä¸­é—´è®¾äº†å¤šå°‘éï¼Œæµè§ˆå™¨åªå…³å¿ƒæœ€åçš„æ ·å¼å¦‚ä½•ã€‚

## References

- [Event loops spec](https://html.spec.whatwg.org/multipage/webappapis.html#event-loops)
