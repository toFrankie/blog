---
title: å¼€å‘ä¸€ä¸ªç®€å•çš„ Chrome Extension
number: '#340'
link: 'https://github.com/toFrankie/blog/issues/340'
created_at: '2024-06-16 14:32:09'
updated_at: '2024-07-01 09:41:37'
labels:
  - ç”Ÿæ´»éšç¬”
  - å‰ç«¯
  - '2024'
---

![é…å›¾æºè‡ª Freepik](https://cdn.jsdelivr.net/gh/toFrankie/blog@main/images/2024/6/1718543919632.jpg)

> åœ¨æ­¤ä½œä¸€ä¸ªè®°å½•ï¼Œç¬¬ä¸€æ¬¡å¼€å‘ Chrome Extension çš„åŒå­¦ä¹Ÿå¯ä»¥çœ‹çœ‹ã€‚

## èƒŒæ™¯

æˆ‘ç°åœ¨ä½¿ç”¨ [GitHub Blogger](https://github.com/toFrankie/github-blogger) ä½œä¸ºä¸ªäººåšå®¢å·¥å…·ï¼Œåœ¨ç¿»é˜…æ–‡ç« æ—¶ï¼Œæœ‰ä¸ªä½“éªŒç—›ç‚¹ï¼šæ— æ³•å¿«é€Ÿå®šä½åˆ°æŸä¸ªç« èŠ‚ã€‚ 

æ¯”å¦‚ï¼Œè¿™ç¯‡[æ–‡ç« ](https://github.com/toFrankie/blog/issues/317)æ¶‰åŠçš„äºŒçº§ã€ä¸‰çº§æ ‡é¢˜å¤šè¾¾ 25+ï¼Œç¯‡å¹…ä¹Ÿå¾ˆé•¿ã€‚


ç›®å‰ GitHub åªæœ‰ä»“åº“ Markdown æ–‡ä»¶æ”¯æŒç›®å½•èƒ½åŠ›ï¼Œä½†æ˜¯ Issue è¿˜ä¸æ”¯æŒï¼Œæ‰€ä»¥å¼€å‘ä¸€ä¸ª Chrome æ‰©å±•ç¨‹åºæ¥è§£å†³ã€‚

> [github-issue-toc](https://github.com/toFrankie/github-issue-toc)

* æ”¯æŒ h1 ~ h6 æ ‡é¢˜ã€‚
* æ”¯æŒæ»šåŠ¨é«˜äº®ã€‚
* æ”¯æŒç²˜æ€§å¸ƒå±€ï¼Œæ»šåŠ¨æ—¶å§‹ç»ˆåœ¨å¯è§†åŒºåŸŸå†…ã€‚
* æ ·å¼é£æ ¼ä¸ GitHub å¥‘åˆï¼Œæ”¯æŒæ·±è‰²æ¨¡å¼ã€‚

![](https://cdn.jsdelivr.net/gh/toFrankie/blog@main/images/2024/6/1718520988032.png)

## å¼€å§‹ä¹‹å‰

é¡¹ç›®æ²¡å¿…è¦ä¸€æ­¥ä¸€æ­¥å»æ­ï¼Œé€‰æ‹©ç¤¾åŒºæµè¡Œæ–¹æ¡ˆå³å¯ï¼Œæˆ‘é€‰ [Plasmo](https://www.plasmo.com/)ï¼Œå¼€å‘ä½“éªŒè¿˜ä¸é”™ã€‚ç›®å½•æ ·å¼å‚è€ƒäº† [Github](https://github.blog/changelog/2021-04-13-table-of-contents-support-in-markdown-files/)ã€[ByteMD](https://github.com/bytedance/bytemd)ã€‚

å¯ç²—ç•¥çœ‹çœ‹ï¼Œäº†è§£ä¸€äº›åŸºç¡€æ¦‚å¿µï¼š

* [ä¸€ç¯‡æ–‡ç« æ•™ä½ é¡ºåˆ©å…¥é—¨å’Œå¼€å‘ chrome æ‰©å±•ç¨‹åºï¼ˆæ’ä»¶ï¼‰](https://github.com/pekonchan/Blog/issues/8)
* [Chrome æµè§ˆå™¨æ’ä»¶ä» Manifest V2 å‡çº§åˆ° V3 ç‰ˆæœ¬æ‰€éœ€è¦ä¿®æ”¹çš„ç‚¹](https://segmentfault.com/a/1190000044555740)
* [Manifest V3 migration checklist ](https://developer.chrome.com/docs/extensions/develop/migrate/checklist)
* [Chrome Extensions](https://developer.chrome.com/docs/extensions)
* [Plasmo Documentation](https://docs.plasmo.com/)

> ç¬¬ä¸€ç¯‡ä½œè€…æ€»ç»“å¾—æŒºå¥½ï¼Œä½†é‡Œé¢ä¸€äº›ä¸œè¥¿åœ¨ Manifest V3 å‘ç”Ÿäº†å˜åŒ–ï¼Œå¯ä»¥çœ‹çœ‹ç¬¬äºŒç¯‡æ–‡ç« ã€‚

## åŸºç¡€æ¦‚å¿µ

* [manifest.json](https://developer.chrome.com/docs/extensions/reference/manifest?hl=zh-cn)ï¼ˆæ¸…å•æ–‡ä»¶ï¼‰
* [Actions](https://developer.chrome.com/docs/extensions/develop/ui?hl=zh-cn#actions)ï¼ˆåŠ¨ä½œï¼‰
* [Content Scripts](https://developer.chrome.com/docs/extensions/develop/concepts/content-scripts?hl=zh-cn)ï¼ˆå†…å®¹è„šæœ¬ï¼‰
* [Extension Service Worker](https://developer.chrome.com/docs/extensions/develop/concepts/service-workers?hl=zh-cn)ï¼ˆåŸ V2 çš„ Background Scriptsï¼‰

æ¸…å•æ–‡ä»¶æ˜¯æ¯ä¸ªæ‰©å±•ç¨‹åºå¿…é¡»çš„ï¼Œå®ƒä¼šåˆ—å‡ºæ‰©å±•ç¨‹åºçš„ç»“æ„å’Œè¡Œä¸ºç­‰ä¿¡æ¯ã€‚

Actions æ˜¯ç‚¹å‡»æ‰©å±•ç¨‹åºå›¾æ ‡æ—¶å‘ç”Ÿçš„åŠ¨ä½œï¼Œå¯ä»¥æ˜¯æ‰“å¼€ä¸€ä¸ªå¼¹å‡ºå¼çª—å£ã€æ‰“å¼€ä¾§è¾¹æ é¢æ¿ã€å³é”®èœå•ç­‰ã€‚

å†…å®¹è„šæœ¬ä¸»è¦ç”¨äºä¿®æ”¹ç½‘é¡µå†…å®¹ã€‚

Extension Service Worker æ˜¯è¿è¡Œåœ¨æµè§ˆå™¨é‡Œçš„åå°è„šæœ¬ã€‚

å®ƒä»¬ä¹‹é—´å¯ä»¥ç›¸äº’ä¼ é€’æ¶ˆæ¯ï¼Œè¯¦è§[æ¶ˆæ¯ä¼ é€’](https://developer.chrome.com/docs/extensions/develop/concepts/messaging?hl=zh-cn)ã€‚

## å¼€å‘

åˆ›å»ºé¡¹ç›®ï¼š

```shell
$ pnpm create plasmo --with-src --entry=contents/inline,popup,background
```

> ä¼¼ä¹ [`--entry`](https://docs.plasmo.com/framework/workflows/new#with-specific-entry-files) æŒ‡å®šå…¥å£ç›®å½•æœ‰ç‚¹é—®é¢˜ï¼Œæˆ‘åªç”¨åˆ°å¼¹å‡ºå¼çª—å£ã€å†…å®¹è„šæœ¬ä»¥åŠ Service Workerï¼Œä½†ç”Ÿæˆçš„æ¨¡æ¿åŒ…æ‹¬äº† `newtab`ï¼Œéœ€æ‰‹åŠ¨åˆ æ‰ã€‚

### Content Scripts

å‰é¢æåˆ°ï¼Œå†…å®¹è„šæœ¬æ˜¯ç”¨æ¥ä¿®æ”¹ç½‘é¡µå†…å®¹çš„ï¼Œä½†å®ƒè·Ÿç½‘é¡µçš„ JavaScript ç¯å¢ƒæ˜¯éš”ç¦»çš„ã€‚

#### åˆ†ç±»

åœ¨ Plasmo é‡Œï¼Œå†…å®¹è„šæœ¬åˆ†ä¸ºä¸¤ç±»ï¼š

* content.ts
* content.tsx

`.ts` è¡¨ç¤ºæ²¡æœ‰ UI ç•Œé¢çš„çº¯è„šæœ¬ï¼Œåè€…åˆ™æ˜¯å¸¦ UI çš„ç»„ä»¶ï¼Œæ‰€ä»¥å®ƒè¦é»˜è®¤å¯¼å‡º Componentã€‚

> æ­¤å¤„ `.tsx` æ˜¯ä»¥ React ä¸ºä¾‹ï¼Œå…¶ä»–æ¡†æ¶åˆ™æ˜¯ `.vue`ã€`.svelte` æ‰©å±•åã€‚

> ç”±äº Plasmo çš„ TypeScript é…ç½®å°†æ‰€æœ‰æ–‡ä»¶è§†ä¸ºæ¨¡å—ï¼Œå¦‚æœä½ çš„çº¯å†…å®¹è„šæœ¬æ²¡æœ‰ä»»ä½•å¯¼å‡ºï¼Œåˆ™å¿…é¡»è¦åŠ ä¸Š `export {}`ã€‚

> å¦‚æœæœ‰å¤šä¸ªå†…å®¹è„šæœ¬ï¼Œåˆ™ç”¨ `contents` ç›®å½•ï¼Œæ¯”å¦‚ `contents/foo.tsx`ã€`contents/bar.tsx`ã€‚


#### å¯¼å‡ºé…ç½®

ä¸»è¦ç”¨äºå®šä¹‰è„šæœ¬ä½œç”¨çš„ç½‘é¡µåœ°å€ã€æ‰§è¡Œæ—¶æœºç­‰ã€‚

```tsx
// tos.tsx
import type { PlasmoCSConfig } from 'plasmo'

export const config: PlasmoCSConfig = {
  matches: ['https://github.com/*'],
  run_at: 'document_end'
}
```

> å…¶ä¸­é…ç½®é¡¹è¯¦è§ [Inject with static declarations](https://developer.chrome.com/docs/extensions/develop/concepts/content-scripts#static-declarative)ã€‚

> å¦‚æœä½ çš„è„šæœ¬è¦ä¿®æ”¹ç½‘é¡µçš„ `window` å¯¹è±¡ï¼Œè¦æŒ‡å®š `world` é…ç½®é¡¹ä¸º `'MAIN'`ã€‚

#### æŒ‡å®šæ’å…¥é”šç‚¹

ä¹Ÿå°±æ˜¯æˆ‘ä»¬çš„ UI è„šæœ¬è¦æŒ‚è½½åˆ°ç½‘é¡µçš„å“ªä¸ªåœ°æ–¹ã€‚

```tsx
// tos.tsx
import type { PlasmoCSConfig, PlasmoGetInlineAnchor } from 'plasmo'

export const config: PlasmoCSConfig = {
  matches: ['https://github.com/*'],
  run_at: 'document_end'
}

// ğŸ†•
export const getInlineAnchor: PlasmoGetInlineAnchor = async () => ({
  element: document.querySelector('#partial-discussion-sidebar'),
  insertPosition: 'afterend'
})

export default function Toc() {
  return <div className="toc">Toc ç»„ä»¶</div>
}
```

> å¦‚æœéœ€è¦æŒ‚è½½å¤šä¸ªï¼Œå¯¼å‡º `getInlineAnchorList`ï¼Œè¯¦è§ [Inline Anchor](https://docs.plasmo.com/framework/content-scripts-ui/life-cycle#inline)ã€‚


![](https://cdn.jsdelivr.net/gh/toFrankie/blog@main/images/2024/6/1718531425354.png)

#### å¼•å…¥æ ·å¼æ–‡ä»¶

å‡è®¾å¼•å…¥ `toc.tsx` åŒçº§ç›®å½•ä¸‹çš„ `toc.css` æ–‡ä»¶ã€‚

```css
/* toc.css */
.toc {
  color: #0969da;
}
```

```tsx
// tos.tsx
import type { PlasmoCSConfig, PlasmoGetStyle } from 'plasmo'
import styleText from 'data-text:./toc.css'

// ğŸ†•
export const config: PlasmoCSConfig = {
  matches: ['https://github.com/*'],
  css: ['./toc.css'],
  run_at: 'document_end'
}

export const getStyle: PlasmoGetStyle = () => {
  const style = document.createElement('style')
  style.textContent = styleText
  return style
}

export default function Toc() {
  return <div className="toc">Toc ç»„ä»¶</div>
}
```

å¯¼å‡ºä¸€ä¸ª `getStyle` æ–¹æ³•ï¼Œè¯»å–æ–‡ä»¶çš„å†…å®¹ï¼Œç„¶åå¾€ç½‘é¡µæ’å…¥ä¸€ä¸ª `<style>` æ ‡ç­¾ã€‚

> å¯¹äº `data-text:./toc.css` çš„å†™æ³•ï¼Œè¯¦è§ [Import Resolution](https://docs.plasmo.com/framework/import#data-text)ã€‚

![](https://cdn.jsdelivr.net/gh/toFrankie/blog@main/images/2024/6/1718532184534.png)

#### è‡ªå®šä¹‰ Root Container

é»˜è®¤æƒ…å†µä¸‹ï¼ŒPlasmo ä¼šåˆ›å»º Shadow DOMï¼Œå†æŒ‚è½½åˆ°é¡µé¢ï¼Œè¿™æ ·åšçš„å¥½å¤„æ˜¯ä¸å¤–éƒ¨éš”ç¦»ï¼Œå¦‚ä¸Šå›¾æ‰€ç¤ºã€‚

æœ‰æ—¶ï¼Œæˆ‘ä»¬å¸Œæœ›å¯ä»¥ç”¨åŸç½‘é¡µçš„æ ·å¼ï¼Œæ¯”å¦‚ CSS å˜é‡ç­‰ã€‚

è¿™æ ·çš„è¯ï¼Œéœ€è¦å¯¼å‡ºä¸€ä¸ª `getRootContainer` æ–¹æ³•ã€‚

```tsx
// tos.tsx
import type { PlasmoCSConfig, PlasmoGetStyle, PlasmoGetInlineAnchor } from 'plasmo'
import styleText from 'data-text:./toc.css'

export const config: PlasmoCSConfig = {
  matches: ['https://github.com/*'],
  css: ['./toc.css'],
  run_at: 'document_end'
}

export const getStyle: PlasmoGetStyle = () => {
  const style = document.createElement('style')
  style.textContent = styleText
  return style
}

// ğŸ†• ç§»é™¤æ‰
// export const getInlineAnchor: PlasmoGetInlineAnchor = async () => ({
//   element: document.querySelector('#partial-discussion-sidebar'),
//   insertPosition: 'afterend'
// })

// ğŸ†•
export const getRootContainer = () => {
  return new Promise(resolve => {
    const timer = setInterval(() => {
      const rootContainer = document.querySelector('#plasmo-toc')
      if (rootContainer) {
        clearInterval(timer)
        resolve(rootContainer)
        return
      }

      const rootContainerParent = document.querySelector('.Layout-sidebar')
      if (rootContainerParent) {
        clearInterval(timer)

        const rootContainer = document.createElement('div')
        rootContainer.id = 'plasmo-toc'
        rootContainerParent.appendChild(rootContainer)

        resolve(rootContainer)
      }
    }, 200)
  })
}

export default function Toc() {
  return <div className="toc">Toc ç»„ä»¶</div>
}
```

> è¿™é‡Œç”¨åˆ° `setInterval()` æ˜¯ä¸ºäº†ç¡®ä¿æŒ‚è½½ç‚¹çš„çˆ¶çº§å·²åŠ è½½å®Œæ¯•ã€‚

ä»¥ä¸Šç¤ºä¾‹ï¼Œæˆ‘åœ¨ `.Layout-sidebar` ä¸‹æ·»åŠ äº† `#plasmo-toc` å…ƒç´ ï¼Œå¹¶å°† Toc ç»„ä»¶æŒ‚è½½åˆ°ä¸Šé¢ï¼Œä»¥å®ç°ä¸Šè¿° `getInlineAnchor` çš„ `insertPosition: 'afterend'` çš„æ•ˆæœã€‚åŸå› æ˜¯ ReactDOM çš„ `createRoot()` ä¼šè¦†ç›–æŒ‚è½½å…ƒç´ çš„å†…å®¹ï¼Œå®ƒä¼šåæ‰ `.Layout-sidebar` çš„æ‰€æœ‰å†…å®¹ï¼Œè¿™ä¸æ˜¯æˆ‘æƒ³è¦çš„ã€‚

#### è‡ªå®šä¹‰ render

å‰é¢ [`run_at`](https://developer.chrome.com/docs/extensions/reference/manifest/content-scripts?hl=zh-cn#world-timings) æŒ‡å®šä¸º `document_end`ï¼Œè¿˜æœ‰å…¶ä»–å€¼ï¼š

* `document_start`ï¼šåœ¨ css ä¸­çš„ä»»ä½•æ–‡ä»¶ä¹‹åã€æ„å»ºä»»ä½•å…¶ä»– DOM æˆ–è¿è¡Œä»»ä½•å…¶ä»–è„šæœ¬ä¹‹å‰æ³¨å…¥è„šæœ¬ã€‚

* `document_end`ï¼šåœ¨ DOM å®Œæˆä¹‹åï¼Œåœ¨å›¾ç‰‡å’Œæ¡†æ¶ç­‰å­èµ„æºåŠ è½½ä¹‹å‰ç«‹å³æ³¨å…¥è„šæœ¬ã€‚


* `document_idle`ï¼šæµè§ˆå™¨ä¼šé€‰æ‹©ä¸€ä¸ªæ—¶é—´ï¼Œåœ¨ `document_end` ä¹‹é—´ä»¥åŠ `window.onload` äº‹ä»¶è§¦å‘åç«‹å³æ³¨å…¥è„šæœ¬ã€‚æ³¨å…¥çš„ç¡®åˆ‡æ—¶åˆ»å–å†³äºæ–‡æ¡£çš„å¤æ‚ç¨‹åº¦å’ŒåŠ è½½ç”¨æ—¶ï¼Œå¹¶é’ˆå¯¹ç½‘é¡µåŠ è½½é€Ÿåº¦è¿›è¡Œäº†ä¼˜åŒ–ã€‚åœ¨ `document_idle` è¿è¡Œçš„å†…å®¹è„šæœ¬ä¸éœ€è¦ç›‘å¬ `window.onload` äº‹ä»¶ï¼›å®ƒä»¬ä¸€å®šä¼šåœ¨ DOM å®Œæˆåè¿è¡Œã€‚å¦‚æœè„šæœ¬ç¡®å®éœ€è¦åœ¨ `window.onload` ä¹‹åè¿è¡Œï¼Œè¯¥æ‰©å±•ç¨‹åºå¯ä»¥ä½¿ç”¨ `document.readyState` å±æ€§æ£€æŸ¥ `onload` æ˜¯å¦å·²è§¦å‘ã€‚è¿™æ˜¯é»˜è®¤å€¼ã€‚


ä»¥ TOC ç»„ä»¶ä¸ºä¾‹ï¼Œå½“è¿›å…¥é¡µé¢åï¼Œé¡µé¢åŠ è½½å®Œæ¯•ï¼Œç„¶åç”Ÿæˆäº†ç›®å½•ã€‚å¦‚æœåç»­ Markdown å†…å®¹é€šè¿‡ Ajax æ–¹å¼æ›´æ–°äº†ï¼Œé‚£ç›®å½•æœ‰å¯èƒ½è·Ÿæœ€æ–°å†…å®¹å¯¹ä¸ä¸Šäº†ã€‚è¿™é‡Œæœ‰ä¸¤ç§è§£å†³æ–¹æ³•ï¼š

* ä¸€æ˜¯ï¼Œåœ¨ TOC ç»„ä»¶å†…ç›‘å¬å†…å®¹å˜åŒ–ï¼Œè¿›è€Œè§¦å‘ç»„ä»¶æ›´æ–°ã€‚
* äºŒæ˜¯ï¼Œå½“å†…å®¹æ›´æ–°æ—¶ï¼Œå…ˆå¸è½½æ—§çš„ TOC ç»„ä»¶ï¼Œå†æŒ‚è½½æ–°çš„ TOC ç»„ä»¶ã€‚

æŒ‰éœ€é€‰æ‹©ã€‚åœ¨ GitHub Issue TOC çš„åœºæ™¯ï¼Œè¦ç”¨ç¬¬äºŒç§æ–¹å¼ã€‚åŸå› æ˜¯ï¼Œåœ¨ GitHub çš„é Issue é¡µé¢è·³è½¬åˆ° Issue é¡µé¢æ—¶ï¼Œåº”è¯¥æ˜¯ä½¿ç”¨äº† `history.pushState()` æ–¹å¼ï¼Œå®ƒä¸ä¼šé‡æ–°åŠ è½½é¡µé¢ï¼Œå¯¼è‡´ç›®å½•å°±ä¸ä¼šç”Ÿæˆäº†ã€‚è¿™ç§æƒ…å†µé  `document_end` æ˜¯æ— æ³•è§£å†³çš„ã€‚

```tsx
// tos.tsx
import type { PlasmoCSConfig, PlasmoGetStyle, PlasmoCSUIJSXContainer, PlasmoRender } from 'plasmo'
import styleText from 'data-text:./toc.css'

export const config: PlasmoCSConfig = {
  matches: ['https://github.com/*'],
  css: ['./toc.css'],
  run_at: 'document_end'
}

export const getStyle: PlasmoGetStyle = () => {
  const style = document.createElement('style')
  style.textContent = styleText
  return style
}

export const getRootContainer = () => {
  return new Promise(resolve => {
    const timer = setInterval(() => {
      const rootContainer = document.querySelector('#plasmo-toc')
      if (rootContainer) {
        clearInterval(timer)
        resolve(rootContainer)
        return
      }

      const rootContainerParent = document.querySelector('.Layout-sidebar')
      if (rootContainerParent) {
        clearInterval(timer)

        const rootContainer = document.createElement('div')
        rootContainer.id = 'plasmo-toc'
        rootContainerParent.appendChild(rootContainer)

        resolve(rootContainer)
      }
    }, 200)
  })
}

// ğŸ†•
export const render: PlasmoRender<PlasmoCSUIJSXContainer> = async ({ createRootContainer }) => {
  const url = document.location.href
  if (!isGitHubIssuePage(url)) return

  const rootContainer = await createRootContainer()
  const root = createRoot(rootContainer)
  window.__plasmoTocRoot = root
  root.render(<Toc />)
}

export default function Toc() {
  return <div className="toc">Toc ç»„ä»¶</div>
}
```

å…·ä½“é€»è¾‘ï¼ŒæŒ‰éœ€è°ƒæ•´ã€‚ç”±äºé‡æ–°æŒ‚è½½é¡µé¢æ—¶ï¼Œè¦å…ˆå°†æ—§çš„ React App å¸è½½ï¼Œæ‰€ä»¥è¿™é‡Œè®°å½•äº†`window.__plasmoTocRoot = root` ä¾›ä¸‹æ¬¡æŒ‚è½½ç”¨ã€‚æ¯”å¦‚ï¼š

```tsx
async function recreateRoot() {
  const rootContainer = await getRootContainer()

  if (window.__plasmoTocRoot) {
    window.__plasmoTocRoot.unmount()
  }

  const root = createRoot(rootContainer as Element)
  window.__plasmoTocRoot = root
  root.render(<Toc />)

  onIssueUpdate()
}
```

### Service Worker

è¿™æ˜¯å¯é€‰çš„ï¼Œå¦‚æœä½ ç”¨ä¸åˆ° Service Worker å¯ä»¥åœ¨åˆ æ‰ `background.ts` æ–‡ä»¶ï¼Œæˆ–è€…å¯¼å‡ºä¸€ä¸ª `export {}`ï¼ŒåŸå› åŒ Content Scriptsã€‚

å‰é¢æåˆ°ï¼Œä» GitHub Repo è·³è½¬åˆ° GitHub Issue é¡µé¢çš„åœºæ™¯ï¼Œæ— æ³•ç”Ÿæˆç›®å½•ã€‚æ‰€ä»¥è¿™é‡Œæˆ‘è¦å€ŸåŠ© Service Worker æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚å¤§è‡´æ€è·¯æ˜¯ï¼Œé€šè¿‡ `chrome.webNavigation` æ¥ç›‘å¬ç½‘é¡µ History å˜åŒ–ï¼Œå½“è·³è½¬åˆ° Issue é¡µé¢æ—¶ï¼Œå‘ Content Scripts ä¼ é€’æ¶ˆæ¯ï¼Œå‘Šè¯‰å®ƒè¯¥æŒ‚è½½ TOC ç»„ä»¶äº†ã€‚

> äº‹ä»¶é¡ºåºï¼šonBeforeNavigate â†’ onCommitted â†’ [onDOMContentLoaded] â†’ onCompleted

```ts
// background.ts
import { MESSAGE_TYPE } from '@/constants'
import { isGitHubIssuePage } from '@/utils'

chrome.webNavigation.onCompleted.addListener(() => {
  chrome.webNavigation.onHistoryStateUpdated.addListener(details => {
    const { url, tabId } = details
    if (!isGitHubIssuePage(url)) return
    sendMessageToContentScript(tabId, { type: MESSAGE_TYPE.PLASMO_TOC_MOUNT, payload: details })
  })
})

async function sendMessageToContentScript(tabId: number, message: any) {
  try {
    chrome.tabs.sendMessage(tabId, message)
  } catch (error) {
    console.error(`Failed to send message: ${error}`)
  }
}
```

> åœ¨ Service Worker å†…æ— æ³•è·å–ã€æ“ä½œ DOMã€‚

ç”±äº Service Worker ç”¨åˆ° [`webNavigation`](https://developer.chrome.com/docs/extensions/reference/api/webNavigation?hl=zh-cn)ï¼Œéœ€è¦åœ¨æ¸…å•ä¸­å£°æ˜æƒé™ã€‚åœ¨ Plasmo æ¡†æ¶æ˜¯åœ¨ `package.json` é‡ŒæŒ‡å®šå³å¯ï¼Œæ„å»ºæ—¶ä¼šè‡ªåŠ¨ç”Ÿæˆåˆ° `manifest.json` çš„ã€‚

```json
{
  "manifest": {
    "permissions": [
      "webNavigation"
    ]
  }
}
```

åŒæ—¶ï¼Œè¦åœ¨ Content Script é‡Œæ¥æ”¶ä¿¡æ¯ï¼š

```tsx
// toc.tsx
import { MESSAGE_TYPE } from '@/constants'

chrome.runtime.onMessage.addListener(throttle(onBackgroundMessage, 500))

let plasmoTocMounting = false

function onBackgroundMessage(message: { type: string; payload: any }) {
  try {
    if (message.type !== MESSAGE_TYPE.PLASMO_TOC_MOUNT) return

    if (plasmoTocMounting) return
    plasmoTocMounting = true

    const rootContainer = document.querySelector('#plasmo-toc')
    if (rootContainer) return

    recreateRoot()
  } finally {
    plasmoTocMounting = false
  }
}
```

### Popup

æˆ‘è¿™ä¸ªæ‰©å±•ï¼Œå…¶å® Popup çª—å£ï¼Œå…¶å®æ²¡ä»€ä¹ˆå†…å®¹ï¼Œå°±æ”¾äº†ä¸€ä¸ª Homepage å’Œ Report issue çš„é“¾æ¥ã€‚

```tsx
// popup/index.tsx
import './index.css'

export default function Popup() {
  return (
    <div className="popup">
      <div className="greeting"> Enjoy it. â¤ï¸</div>
      <div className="links">
        <a className="link" href="https://github.com/toFrankie/github-issue-toc" target="_blank">
          Homepage
        </a>
        <span className="separator">â€¢</span>
        <a
          className="link"
          href="https://github.com/toFrankie/github-issue-toc/issues"
          target="_blank">
          Report issue
        </a>
      </div>
    </div>
  )
}
```

æä¸€ä¸‹ï¼Œå¯¼å…¥æ ·å¼ä¸ç”¨åƒ Content Script é‚£æ ·ç”¨ `data-text:./index.css` æ¥å¯¼å…¥ï¼Œä¹Ÿä¸ç”¨å¯¼å‡º `getStyle` æ–¹æ³•ã€‚

## è°ƒè¯•

ä½¿ç”¨ `pnpm create plasmo` åˆ›å»ºçš„é¡¹ç›®ï¼ŒåŒ…å«äº†ï¼š

```json
{
  "scripts": {
    "dev": "plasmo dev",
    "build": "plasmo build",
    "package": "plasmo package"
  }
}
```

å°±å­—é¢æ„æ€ï¼Œä¸å¤šè¯´äº†ã€‚

* `pn dev` äº§å‡º `build/chrome-mv3-dev`
* `pn build` äº§å‡º `build/chrome-mv3-prod`
* `pn package` äº§å‡º `build/chrome-mv3-prod.zip`

> æ³¨æ„ï¼Œdev å’Œ build çš„äº§ç‰©æ˜¯ä¸¤ä¸ªä¸åŒçš„æ‰©å±•ï¼Œå‰è€…åœ¨æ‰©å±•åç§°åŠ äº† `DEV | ` å‰ç¼€ã€‚

### å¯¼å…¥æœ¬åœ°æ‰©å±•ç¨‹åº

1. æµè§ˆå™¨æ‰“å¼€ chrome://extensions
2. å¼€å¯ã€Œå¼€å‘è€…æ¨¡å¼ã€
3. åœ¨ã€ŒåŠ è½½å·²è§£å‹çš„æ‰©å±•ç¨‹åºã€é€‰æ‹©å¯¹åº”çš„äº§ç‰©ç›®å½•ï¼Œå¹¶å¯ç”¨è¯¥æ‰©å±•ã€‚

### è°ƒè¯• Content Scripts

åœ¨å¼€å‘æ—¶ï¼Œæºä»£ç å˜æ›´ä¼šè‡ªåŠ¨æ›´æ–°æ‰©å±•ï¼Œç”šè‡³ä¼šé‡æ–°åŠ è½½é¡µé¢ã€‚æœ‰æ—¶å¯èƒ½ä¼šçœ‹åˆ°ä»¥ä¸‹é”™è¯¯ä¿¡æ¯ï¼š

```txt
Error: Extension context invalidated.
```
æˆ–é¡µé¢ä¸Šå‡ºç° Plamso æç¤ºï¼š

```txt
Context Invalidated, Press to Reload
```

åŸå› æ˜¯ Plasmo é‡æ–°åŠ è½½æ‰©å±•ï¼Œä¼šä½¿å¾—æ—§çš„æ‰©å±•ä¸Šä¸‹æ–‡å¤±æ•ˆï¼Œæ•…è€ŒæŠ¥é”™ï¼Œè§£å†³æ–¹æ³•æ˜¯åˆ·æ–°é¡µé¢ã€‚

> åœ¨ DevTool çš„ Source - Content Scripts é¢æ¿ï¼Œå¯ä»¥æŸ¥çœ‹æ‰€æœ‰æ‰©å±•ç¨‹åºçš„è„šæœ¬ã€‚

### è°ƒè¯• Service Worker

åœ¨ chrome://extensions å¯¹åº”æ‰©å±•é‡Œï¼Œå¯ä»¥çœ‹åˆ° ã€Œæ£€æŸ¥è§†å›¾ Service Workerã€æˆ–ã€Œæ£€æŸ¥è§†å›¾ èƒŒæ™¯é¡µã€çš„å…¥å£ï¼Œç‚¹å‡»è¿›å…¥å¯è°ƒè¯•ã€‚

### è°ƒè¯• Popup

å¼€å‘æ—¶ï¼Œå¯ä»¥å°†æ‰©å±•å›ºå®šåœ¨ Chrome å·¥å…·æ ï¼Œä»¥ä¾¿äºè°ƒè¯•ã€‚ç‚¹å‡»æ‰©å±•å›¾æ ‡ï¼Œæ‰“å¼€ Popup å¼¹çª—ï¼Œç„¶ååƒç½‘é¡µé‚£æ ·å³é”®æ£€æŸ¥å…ƒç´ å³å¯ã€‚


## æäº¤æ‰©å±•

å‡†å¤‡å¥½ä»¥ä¸‹ä¸œè¥¿ï¼Œæ‰§è¡Œ `pn package` æ‰“åŒ…ï¼Œå‰å¾€[å¼€å‘è€…ä¿¡æ¯ä¸­å¿ƒ](https://chrome.google.com/webstore/devconsole/)ä¸Šä¼ ï¼Œå¡«å¥½ç›¸å…³ä¿¡æ¯æäº¤å®¡æ ¸å³å¯ã€‚

### åŸºç¡€ä¿¡æ¯

ä½¿ç”¨ Plasmo çš„è¯ï¼Œ`package.json` éƒ¨åˆ†å­—æ®µä¼šåœ¨æ„å»ºæ—¶ä¼ é€’åˆ° `manifest.json` é‡Œï¼ŒæŒ‰å®é™…æƒ…å†µå¡«å†™å°±å¥½ã€‚

* `packageJson.version` â†’ `manifest.version`
* `packageJson.displayName` â†’ `manifest.name`
* `packageJson.description` â†’ `manifest.description`
* `packageJson.author` â†’ `manifest.author`
* `packageJson.homepage` â†’ `manifest.homepage_url`

å…¶ä½™ä» `packageJson.manifest` è¯»å–ã€‚

### å›¾æ ‡

å»ºè®®æ ¼å¼ä¸º `.png`ï¼Œä¸æ”¯æŒ `.webp` å’Œ `.svg`ã€‚

æä¾› 16Ã—16ã€32Ã—32ã€48Ã—48ã€128Ã—128 å››ç§å°ºå¯¸çš„å›¾ç‰‡ï¼Œä»¥ `icon<size>.png` å½¢å¼å‘½åï¼Œç½®äº `assets` ç›®å½•å†…ã€‚

> è¯·æ³¨æ„ï¼ŒPlasmo é¡¹ç›®çš„ `assets` ç›®å½•ä½äºé¡¹ç›®æ ¹ç›®å½•ï¼Œä¸æ˜¯ `src` ç›®å½•å†…ï¼Œå³ä¾¿æ˜¯é€šè¿‡ [`--with-src`](https://docs.plasmo.com/framework/customization/src#--with-src) æ–¹å¼åˆ›å»ºçš„æ¨¡æ¿é¡¹ç›®ã€‚

> å›¾æ ‡è§†è§‰è®¾è®¡ï¼Œå‚è€ƒå®˜æ–¹[æŒ‡å—](https://developer.chrome.com/docs/webstore/images?hl=zh-cn#icons)ã€‚

### Chrome Web Store å›¾ç‰‡èµ„æº

* å•†åº—å›¾æ ‡ï¼š128Ã—128 çš„å›¾æ ‡
* å±å¹•æˆªå›¾ï¼š1280Ã—800 æˆ– 640Ã—400ï¼Œ1 ~ 5 å¼ 
* å°å‹å®£ä¼ å›¾ï¼š440Ã—280 ç”»å¸ƒï¼ˆå¯é€‰ï¼‰
* é¡¶éƒ¨å®£ä¼ å›¾ï¼š1400Ã—560 ç”»å¸ƒï¼ˆå¯é€‰ï¼‰

### éšç§ç›¸å…³è¯´æ˜

ä¸€æ˜¯ï¼Œè¦å‡†å¤‡æ‰©å±•ç¨‹åºçš„ç”¨é€”è¯´æ˜ã€‚
äºŒæ˜¯ï¼Œè¦å‡†å¤‡è¯·æ±‚æƒé™çš„ç†ç”±ï¼Œæ¯”å¦‚æˆ‘ç”¨åˆ°äº† `host_permissions` å’Œ `webNavigation` æƒé™ï¼Œéƒ½è¦åœ¨ä¸Šä¼ æ—¶è¯´æ˜æ¸…æ¥šã€‚

æ‰€ä»¥ï¼Œæ²¡ç”¨åˆ°çš„æƒé™å°±ä¸è¦åŠ ä¸Šå»äº†ã€‚
