---
title: å¼€å‘ä¸€ä¸ªç®€å•çš„ Chrome Extension ç¨‹åº
number: '#340'
link: 'https://github.com/toFrankie/blog/issues/340'
created_at: '2024-06-16 14:32:09'
updated_at: '2024-06-16 18:54:51'
labels:
  - ç”Ÿæ´»éšç¬”
  - å‰ç«¯
  - '2024'
---
> åœ¨æ­¤ä½œä¸€ä¸ªå¼€å‘è®°å½•ï¼Œç¬¬ä¸€æ¬¡å¼€å‘ Chrome Extension çš„åŒå­¦ä¹Ÿå¯ä»¥çœ‹çœ‹ã€‚

## èƒŒæ™¯

æˆ‘ç°åœ¨ä½¿ç”¨ [GitHub Blogger](https://github.com/toFrankie/github-blogger) ä½œä¸ºä¸ªäººåšå®¢å·¥å…·ï¼Œåœ¨ç¿»é˜…æ–‡ç« æ—¶ï¼Œæœ‰ä¸ªä½“éªŒç—›ç‚¹ï¼šæ— æ³•å¿«é€Ÿå®šä½åˆ°æŸä¸ªç« èŠ‚ã€‚

æ¯”å¦‚ï¼Œè¿™ç¯‡[æ–‡ç« ](https://github.com/toFrankie/blog/issues/317)æ¶‰åŠçš„äºŒçº§ã€ä¸‰çº§æ ‡é¢˜å¤šè¾¾ 25+ï¼Œç¯‡å¹…ä¹Ÿå¾ˆé•¿ã€‚

<details><summary>å±•å¼€çœ‹çœ‹ï¼š</summary>

- å¼€å§‹ä¹‹å‰
- ç®¡ç†çª—å£
- åˆ‡æ¢é¢æ¿
- åˆ‡æ¢ä¾§æ 
- æœç´¢ä¸æ›¿æ¢
    - æœç´¢å†…å®¹
    - æ›¿æ¢å†…å®¹
    - æœç´¢æ–‡ä»¶
- ç¼–è¾‘åŒº
    - ç§»åŠ¨å…‰æ ‡
    - é€‰æ‹©æ–‡æœ¬
    - ç§»åŠ¨è¡Œ
    - æ’å…¥è¡Œ
    - æ“ä½œè¡Œ
    - åˆ é™¤
    - æ³¨é‡Š
    - æ ¼å¼åŒ–
    - æŠ˜å ä¸å±•å¼€ä»£ç 
    - ä¿å­˜
    - æ’¤é”€ä¸æ¢å¤
- å‘½ä»¤é¢æ¿
    - å¸¸ç”¨å‘½ä»¤
    - é…ç½®å‘½ä»¤
    - æŸ¥çœ‹æ’ä»¶å‘½ä»¤
- é«˜é˜¶ç”¨æ³•
    - åœºæ™¯ä¸€
    - åœºæ™¯äºŒ
- References

</details>

ç›®å‰ GitHub åªæœ‰ä»“åº“ Markdown æ–‡ä»¶æ”¯æŒç›®å½•èƒ½åŠ›ï¼Œä½†æ˜¯ Issue è¿˜ä¸æ”¯æŒï¼Œæ‰€ä»¥å¼€å‘ä¸€ä¸ª Chrome æ‰©å±•ç¨‹åºæ¥è§£å†³ã€‚

> [github-issue-toc](https://github.com/toFrankie/github-issue-toc)

* æ”¯æŒ h1 ~ h6 æ ‡é¢˜ã€‚
* æ”¯æŒç²˜æ€§å¸ƒå±€ï¼Œæ»šåŠ¨æ—¶å§‹ç»ˆåœ¨å¯è§†åŒºåŸŸå†…ã€‚
* é£æ ¼ä¸ GitHub å¥‘åˆï¼Œæ”¯æŒæ·±è‰²æ¨¡å¼ã€‚

![image.png](https://cdn.jsdelivr.net/gh/toFrankie/blog@main/images/2024/6/1718520988032.png)

## å¼€å§‹ä¹‹å‰

é¡¹ç›®æ²¡å¿…è¦ä¸€æ­¥ä¸€æ­¥å»æ­ï¼Œé€‰æ‹©ç¤¾åŒºæµè¡Œæ–¹æ¡ˆå³å¯ï¼Œæˆ‘é€‰ [Plasmo](https://www.plasmo.com/)ï¼Œå¼€å‘ä½“éªŒè¿˜ä¸é”™ã€‚ç›®å½•æ ·å¼å‚è€ƒäº† [Github](https://github.blog/changelog/2021-04-13-table-of-contents-support-in-markdown-files/)ã€[ByteMD](https://github.com/bytedance/bytemd)ã€‚


ä¸€äº›åŸºç¡€æ¦‚å¿µï¼š

* [ä¸€ç¯‡æ–‡ç« æ•™ä½ é¡ºåˆ©å…¥é—¨å’Œå¼€å‘ chrome æ‰©å±•ç¨‹åºï¼ˆæ’ä»¶ï¼‰](https://github.com/pekonchan/Blog/issues/8)
* [Chrome æµè§ˆå™¨æ’ä»¶ä» Manifest V2 å‡çº§åˆ° V3 ç‰ˆæœ¬æ‰€éœ€è¦ä¿®æ”¹çš„ç‚¹](https://segmentfault.com/a/1190000044555740)
* [Manifest V3 migration checklist ](https://developer.chrome.com/docs/extensions/develop/migrate/checklist)
* [Chrome Extensions](https://developer.chrome.com/docs/extensions)
* [Plasmo Documentation](https://docs.plasmo.com/)

> ç¬¬ä¸€ç¯‡ä½œè€…æ€»ç»“å¾—æŒºå¥½ï¼Œä½†é‡Œé¢ä¸€äº›ä¸œè¥¿åœ¨ Manifest V3 å‘ç”Ÿäº†å˜åŒ–ï¼Œå¯ä»¥çœ‹çœ‹ç¬¬äºŒç¯‡æ–‡ç« ã€‚

## åŸºç¡€æ¦‚å¿µ

* [manifest.json](https://developer.chrome.com/docs/extensions/reference/manifest?hl=zh-cn)ï¼ˆæ¸…å•æ–‡ä»¶ï¼‰
* [Actions](https://developer.chrome.com/docs/extensions/develop/ui?hl=zh-cn#actions)ï¼ˆåŠ¨ä½œï¼‰
* [Content Scripts](https://developer.chrome.com/docs/extensions/develop/concepts/content-scripts?hl=zh-cn)ï¼ˆå†…å®¹è„šæœ¬ï¼‰
* [Extension Service Worker](https://developer.chrome.com/docs/extensions/develop/concepts/service-workers?hl=zh-cn)ï¼ˆåŸ V2 çš„ Background Scriptsï¼‰

æ¸…å•æ–‡ä»¶æ˜¯æ¯ä¸ªæ‰©å±•ç¨‹åºå¿…é¡»çš„ï¼Œå®ƒä¼šåˆ—å‡ºæ‰©å±•ç¨‹åºçš„ç»“æ„å’Œè¡Œä¸ºç­‰ä¿¡æ¯ã€‚

Actions æ˜¯ç‚¹å‡»æ‰©å±•ç¨‹åºå›¾æ ‡æ—¶å‘ç”Ÿçš„åŠ¨ä½œï¼Œå¯ä»¥æ˜¯æ‰“å¼€ä¸€ä¸ªå¼¹å‡ºå¼çª—å£ã€æ‰“å¼€ä¾§è¾¹æ é¢æ¿ã€å³é”®èœå•ç­‰ç­‰ã€‚

å†…å®¹è„šæœ¬ä¸»è¦ç”¨äºä¿®æ”¹ç½‘é¡µå†…å®¹ã€‚

Extension Service Worker æ˜¯è¿è¡Œåœ¨æµè§ˆå™¨é‡Œçš„åå°è„šæœ¬ã€‚

å®ƒä»¬ä¹‹é—´å¯ä»¥ç›¸äº’ä¼ é€’æ¶ˆæ¯ï¼Œè¯¦è§[æ¶ˆæ¯ä¼ é€’](https://developer.chrome.com/docs/extensions/develop/concepts/messaging?hl=zh-cn)ã€‚

## å¼€å§‹

åˆ›å»ºé¡¹ç›®ï¼š

```shell
$ pnpm create plasmo --with-src --entry=contents/inline,popup,background
```

> ä¼¼ä¹ [`--entry`](https://docs.plasmo.com/framework/workflows/new#with-specific-entry-files) æŒ‡å®šå…¥å£ç›®å½•æœ‰ç‚¹é—®é¢˜ï¼Œæˆ‘åªç”¨åˆ°å¼¹å‡ºå¼çª—å£ã€å†…å®¹è„šæœ¬ä»¥åŠ Service Workerï¼Œä½†ç”Ÿæˆçš„æ¨¡æ¿åŒ…æ‹¬äº† `newtab`ï¼Œéœ€æ‰‹åŠ¨åˆ æ‰ã€‚

### Content Scripts

å‰é¢æåˆ°ï¼Œå†…å®¹è„šæœ¬æ˜¯ç”¨æ¥ä¿®æ”¹ç½‘é¡µå†…å®¹çš„ï¼Œä½†å®ƒè·Ÿç½‘é¡µçš„ JavaScript ç¯å¢ƒæ˜¯éš”ç¦»çš„ã€‚

#### åˆ†ç±»

åœ¨ Plasmo é‡Œï¼Œå†…å®¹è„šæœ¬åˆ†ä¸ºä¸¤ç±»ï¼š

* content.ts
* content.tsx

`.ts` è¡¨ç¤ºæ²¡æœ‰ UI ç•Œé¢çš„çº¯è„šæœ¬ï¼Œåè€…åˆ™æ˜¯å¸¦ UI çš„ç»„ä»¶ï¼Œæ‰€ä»¥å®ƒè¦é»˜è®¤å¯¼å‡º Componentã€‚

> æ­¤å¤„ `.tsx` æ˜¯ä»¥ React ä¸ºä¾‹ï¼Œå…¶ä»–æ¡†æ¶åˆ™æ˜¯ `.vue`ã€`.svelte` æ‰©å±•åã€‚

> ç”±äº Plasmo å°†æ‰€æœ‰æ–‡ä»¶è§†ä¸ºæ¨¡å—ï¼Œå¦‚æœä½ çš„çº¯å†…å®¹è„šæœ¬æ²¡æœ‰ä»»ä½•å¯¼å‡ºï¼Œåˆ™å¿…è¦è¦åŠ ä¸Š `export {}`ã€‚

> å¦‚æœæœ‰å¤šä¸ªå†…å®¹è„šæœ¬ï¼Œåˆ™ç”¨ `contents` ç›®å½•ï¼Œæ¯”å¦‚ `contents/foo.tsx`ã€`contents/bar.tsx`ã€‚


#### å¯¼å‡ºé…ç½®

ä¸»è¦ç”¨äºå®šä¹‰è„šæœ¬ä½œç”¨çš„ç½‘é¡µåœ°å€ã€æ‰§è¡Œæ—¶æœºç­‰ã€‚

```ts
// tos.tsx
import type { PlasmoCSConfig } from 'plasmo'

export const config: PlasmoCSConfig = {
  matches: ['https://github.com/*'],
  run_at: 'document_end'
}
```

> å…¶ä¸­é…ç½®é¡¹è¯¦è§ [Inject with static declarations](https://developer.chrome.com/docs/extensions/develop/concepts/content-scripts#static-declarative)ã€‚

> å¦‚æœä½ çš„è„šæœ¬è¦ä¿®æ”¹ç½‘é¡µçš„ `window` å¯¹è±¡ï¼Œè¦æŒ‡å®š `world` é…ç½®é¡¹ä¸º `'MAIN'`ã€‚

#### æŒ‡å®šæ’å…¥é”šç‚¹

ä¹Ÿå°±æ˜¯æˆ‘ä»¬çš„ UI è„šæœ¬è¦æŒ‚è½½åˆ°ç½‘é¡µçš„å“ªä¸ªåœ°æ–¹ã€‚

```ts
// tos.tsx
import type { PlasmoCSConfig } from 'plasmo'

export const config: PlasmoCSConfig = {
  matches: ['https://github.com/*'],
  run_at: 'document_end'
}

export const getInlineAnchor: PlasmoGetInlineAnchor = async () => ({
  element: document.querySelector('#partial-discussion-sidebar'),
  insertPosition: 'afterend'
})

export default function Toc() {
  return <div className="toc">Toc ç»„ä»¶</div>
}
```

> å¦‚æœéœ€è¦æŒ‚è½½å¤šä¸ªï¼Œå¯¼å‡º `getInlineAnchorList`ï¼Œè¯¦è§ [Inline Anchor](https://docs.plasmo.com/framework/content-scripts-ui/life-cycle#inline)ã€‚


![](https://cdn.jsdelivr.net/gh/toFrankie/blog@main/images/2024/6/1718531425354.png)

#### å¼•å…¥æ ·å¼æ–‡ä»¶

å‡è®¾å¼•å…¥ `toc.tsx` åŒçº§ç›®å½•ä¸‹çš„ `toc.css` æ–‡ä»¶ã€‚

```css
/* toc.css */
.toc {
  color: #0969da;
}
```

```ts
// tos.tsx
import type { PlasmoCSConfig, PlasmoGetStyle } from 'plasmo'
import styleText from 'data-text:./toc.css'

// ğŸ†•
export const config: PlasmoCSConfig = {
  matches: ['https://github.com/*'],
  css: ['./toc.css'],
  run_at: 'document_end'
}

export const getStyle: PlasmoGetStyle = () => {
  const style = document.createElement('style')
  style.textContent = styleText
  return style
}

export default function Toc() {
  return <div className="toc">Toc ç»„ä»¶</div>
}
```

å¯¼å‡ºä¸€ä¸ª `getStyle` æ–¹æ³•ï¼Œè¯»å–æ–‡ä»¶çš„å†…å®¹ï¼Œç„¶åå¾€ç½‘é¡µæ’å…¥ä¸€ä¸ª `<style>` æ ‡ç­¾ã€‚

> å¯¹äº `data-text:./toc.css` çš„å†™æ³•ï¼Œè¯¦è§ [Import Resolution](https://docs.plasmo.com/framework/import#data-text)ã€‚

![](https://cdn.jsdelivr.net/gh/toFrankie/blog@main/images/2024/6/1718532184534.png)

#### è‡ªå®šä¹‰ Root Container

é»˜è®¤æƒ…å†µä¸‹ï¼ŒPlasmo ä¼šåˆ›å»º Shadow DOMï¼Œå†æŒ‚è½½åˆ°é¡µé¢ï¼Œè¿™æ ·åšçš„å¥½å¤„æ˜¯ä¸å¤–éƒ¨éš”ç¦»ï¼Œå¦‚ä¸Šå›¾æ‰€ç¤ºã€‚

æœ‰æ—¶ï¼Œæˆ‘ä»¬å¸Œæœ›å¯ä»¥ç”¨åŸç½‘é¡µçš„æ ·å¼ï¼Œæ¯”å¦‚ CSS å˜é‡ç­‰ã€‚

è¿™æ ·çš„è¯ï¼Œéœ€è¦å¯¼å‡ºä¸€ä¸ª `getRootContainer` æ–¹æ³•ã€‚

```ts
// tos.tsx
import type { PlasmoCSConfig, PlasmoGetStyle } from 'plasmo'
import styleText from 'data-text:./toc.css'

export const config: PlasmoCSConfig = {
  matches: ['https://github.com/*'],
  css: ['./toc.css'],
  run_at: 'document_end'
}

export const getStyle: PlasmoGetStyle = () => {
  const style = document.createElement('style')
  style.textContent = styleText
  return style
}

// ğŸ†•
export const getRootContainer = () => {
  return new Promise(resolve => {
    const timer = setInterval(() => {
      const rootContainer = document.querySelector('#plasmo-toc')
      if (rootContainer) {
        clearInterval(timer)
        resolve(rootContainer)
        return
      }

      const rootContainerParent = document.querySelector('.Layout-sidebar')
      if (rootContainerParent) {
        clearInterval(timer)

        const rootContainer = document.createElement('div')
        rootContainer.id = 'plasmo-toc'
        rootContainerParent.appendChild(rootContainer)

        resolve(rootContainer)
      }
    }, 200)
  })
}

export default function Toc() {
  return <div className="toc">Toc ç»„ä»¶</div>
}
```

> è¿™é‡Œç”¨åˆ° `setInterval()` æ˜¯ä¸ºäº†ç¡®ä¿æŒ‚è½½ç‚¹çš„çˆ¶çº§å·²åŠ è½½å®Œæ¯•ã€‚

ä»¥ä¸Šç¤ºä¾‹ï¼Œæˆ‘åœ¨ `.Layout-sidebar` ä¸‹æ·»åŠ äº† `#plasmo-toc` å…ƒç´ ï¼Œå¹¶å°† Toc ç»„ä»¶æŒ‚è½½åˆ°ä¸Šé¢ï¼Œä»¥å®ç°ä¸Šè¿° `getInlineAnchor` çš„ `insertPosition: 'afterend'` çš„æ•ˆæœã€‚åŸå› æ˜¯ ReactDOM çš„ `createRoot()` ä¼šè¦†ç›–æŒ‚è½½å…ƒç´ çš„å†…å®¹ï¼Œå®ƒä¼šåæ‰ `.Layout-sidebar` çš„æ‰€æœ‰å†…å®¹ï¼Œè¿™ä¸æ˜¯æˆ‘æƒ³è¦çš„ã€‚
