---
title: uni-app 开发记录
number: '#353'
link: 'https://github.com/toFrankie/blog/issues/353'
created_at: '2024-12-10 09:52:31'
updated_at: '2025-08-22 18:14:31'
labels:
  - 小程序
  - '2024'
---

![配图源自 Freepik](https://cdn.jsdelivr.net/gh/toFrankie/blog@main/images/2024/12/1733795779961.jpg)

有些东西隔一段时间不用就容易忘记，在此作下记录。

## 自定义组件选项配置

诸如 styleIsolation、virtualHost 等自定义组件[配置](https://uniapp.dcloud.net.cn/tutorial/vue3-api.html#%E5%85%B6%E4%BB%96%E9%85%8D%E7%BD%AE)，声明方式如下：

▼ Composition API

若是 Vue3.3+，可使用 [defineOptions()](https://vuejs.org/api/sfc-script-setup.html#defineoptions)。

```html
<script setup>
  defineOptions({
    options: {
      virtualHost: false,
      styleIsolation: 'shared',
    },
  })

  // your code...
</script>
```

若是 Vue3.3 以下，需要独立的 `<script>` 块。

```html
<script setup>
  // your code...
</script>

<script>
  export default {
    options: {
      virtualHost: false,
      styleIsolation: 'shared',
    },
  }
</script>
```

▼ Options API

```html
<script>
  export default {
    options: {
      virtualHost: false,
      styleIsolation: 'shared',
    },
  }
</script>
```

## 判断是否安装微信

利用 HTML5 Plus API：

```js
function checkWechatInstalled() {
  return plus.runtime.isApplicationExist({pname: 'com.tencent.mm', action: 'weixin://'})
}
```

- Android 平台通过 pname 属性（包名）进行查询。
- iOS 平台通过 action 属性（Scheme）进行查询。iOS9 以后需要添加白名单才可查询，在 manifest.json 配置 `urlschemewhitelist: ["weixin"]`（[参考](https://uniapp.dcloud.net.cn/tutorial/app-ios-schemewhitelist.html)）。其他 App 同理。

相关链接：

- [HTML5+ API Reference](https://www.html5plus.org/doc/zh_cn/runtime.html#plus.runtime.isApplicationExist)
- [设置应用访问白名单列表](https://uniapp.dcloud.net.cn/tutorial/app-ios-schemewhitelist.html)

## App 热更新

我们要知道，应用平台对 App 提供热更新服务其实是持排斥态度的，送审期间最好不要弹出热更新弹窗。

前端部分：

1. 通过 plus.runtime.getProperty() 获取当前 wgt 包的版本名称和版本号
2. 请求服务端检查是有更新的 wgt 包
3. 通过 uni.downloadFile() 下载 wgt 包
4. 通过 plus.runtime.install() 安装 wgt 包
5. 通过 plus.runtime.restart() 重启

打包部分：

1. 打包新版 wgt 时要更新 versionName 和 versionCode，且 versionCode 要比上一次大，否则安装完新包后退出，冷启动应用可能会重新加载旧包。
    - versionName 应用版本名称，如 1.2.3
    - versionCode 应用版本号，必须是整数，取值范围 1~2147483647，升级时必须高于上一次设置的值。

相关链接：

- [uni-app 资源在线升级/热更新](https://ask.dcloud.net.cn/article/35667)
- [manifest.json 配置项](https://doc.dcloud.net.cn/uni-app-x/collocation/manifest.html#%E9%85%8D%E7%BD%AE%E9%A1%B9%E5%88%97%E8%A1%A8)
- [plus.runtime.getProperty](https://www.html5plus.org/doc/zh_cn/runtime.html#plus.runtime.getProperty)
- [plus.runtime.install](https://www.html5plus.org/doc/zh_cn/runtime.html#plus.runtime.install)
- [plus.runtime.restart](https://www.html5plus.org/doc/zh_cn/runtime.html#plus.runtime.restart)

## 各端差异

> 主要讨论微信小程序端与 App、H5 等非小程序端的差异。

### 后代选择器

比如，在父组件查询子组件内的某个元素。

在微信小程序端有两种做法：

1. 拿到子组件实例，然后再父组件内使用 `uni.createSelectorQuery.in(subComponentInstance).select('.descendant')` 获取元素。
2. 使用 [>>>](https://developers.weixin.qq.com/miniprogram/dev/api/wxml/SelectorQuery.select.html#selector-%E8%AF%AD%E6%B3%95)（跨自定义组件的后代选择器），在父元素内使用 `uni.createSelectorQuery().select('.ancestor >>> .descendant')` 获取其子（子子...）组件内的元素。

而 App 端，编译后的 HTML 结构跟小程序不一样，小程序带有一个 ShadowRoot 节点隔离，而 App 端不会。因此使用 `uni.createSelectorQuery().select('.ancestor .descendant')` 直接查询到后代的元素。而且 [App 端不支持 >>> 语法](https://uniapp.dcloud.net.cn/api/ui/nodes-info.html#selectorquery-select)，它是小程序特有的。

### 布尔 dataset

在 HTML 中有一种[布尔类型的属性](https://developer.mozilla.org/en-US/docs/Web/API/Element/setAttribute)。

```html
<!-- attr is true -->
<div attr></div>
<div attr=""></div>
<div attr="false"></div>
<div attr="any value"></div>

<!-- attr is false -->
<div></div>
```

如果要将某个属性变为 false，只能 `removeAttribute('attr')`。对于 `setAttribute('attr', undefined)` 等均是无效的，内部会有 toString() 的处理，因为 HTML 的属性值只能是字符串。`data-*` 同理。

但使用 uniapp 时，不同端表现不一样。

```html
<view data-attr></div>
```

对于 `dataset.attr` 微信小程序是布尔值 `true`，而 App 端则是字符串 `''`，后者表现是符合 HTML 规范的。猜测是微信小程序内部做了 `dataset.attr !== undefined` 的处理。如果要用于条件判断，要注意各端值是不一样的。

未完待续...

