---
title: å¦‚ä½•å®ç°ä¸€ä¸ªå‡†ç¡®çš„å€’è®¡æ—¶åŠŸèƒ½
number: '#339'
link: 'https://github.com/toFrankie/blog/issues/339'
created_at: '2024-05-26 13:08:30'
updated_at: '2024-07-20 17:21:02'
labels:
  - å‰ç«¯
  - JS
  - '2024'
---
![é…å›¾æºè‡ª Freepik](https://cdn.jsdelivr.net/gh/toFrankie/blog@main/images/2024/7/1721452490274.jpg)

## å‰è¨€

å€’è®¡æ—¶ã€è®¡æ—¶å™¨æ˜¯ä¸€ä¸ªå¾ˆå¸¸è§çš„ä¸šåŠ¡åœºæ™¯ã€‚è¦æ±‚å¾ˆç®€å•ï¼Œä½†åšèµ·æ¥ä¹Ÿä¸å¤ªç®€å•ï¼š 

- å‡†ç¡®æ€§é«˜
- æ€§èƒ½å¥½

å¦‚æœä½ å°†è¦å®ç°çš„è®¡æ—¶è¦ä½“ç°åœ¨ DOM ä¸Šï¼Œå®ƒæ°¸è¿œä¸å¯èƒ½ç™¾åˆ†ç™¾å‡†ç¡®ã€‚

JavaScript æ˜¯å•çº¿ç¨‹çš„ï¼ˆæŒ‡ä¸»çº¿ç¨‹ï¼‰ï¼Œæ³¨å®šäº†æ— æ³•ä¸€è¾¹æ‰§è¡Œ JS ä»£ç ã€ä¸€è¾¹æ›´æ–° DOMã€‚å³ä¾¿æ˜¯ HTML5 æå‡ºçš„ Web Workerï¼Œå®ƒæ˜¯å¯ä»¥åœ¨ä¸»åŠ¨åˆ›å»ºä¸€äº›åå°æ‰§è¡Œçš„çº¿ç¨‹ï¼Œå¯å®ƒä¸èƒ½ç›´æ¥æ“ä½œ DOMï¼Œå®ƒä¼ é€’ä¿¡æ¯ç»™ä¸»çº¿ç¨‹ï¼Œä¹Ÿä¼šå—åˆ° Event Loop çš„å½±å“ï¼Œè¯¥æ’é˜Ÿè¿˜æ˜¯å¾—æ’é˜Ÿã€‚

ä½†å°±äººçœ¼æ¥è¯´ï¼Œå‡ æ¯«ç§’ã€å‡ åæ¯«ç±³çš„è¯¯å·®åŸºæœ¬æ˜¯æ— æ„Ÿçš„ï¼Œè¿™å°±å¯ä»¥ç®—æ˜¯ä¸€ä¸ªå‡†ç¡®ã€åˆæ ¼çš„å€’è®¡æ—¶ã€‚

## setTimeout å’Œ setInterval

æˆ‘è®¤ä¸ºè¿˜æ˜¯è¦å†èŠä¸€èŠ setTimeout å’Œ setIntervalã€‚

çœ‹ä¸ªä¾‹å­ï¼š

```js
setTimeout(() => {
  console.log('Hi~')
}, 1000)
```

ä¼—æ‰€å‘¨çŸ¥çš„åŸå› ï¼Œå®ƒ**è‡³å°‘** 1s ä¹‹åæ‰èƒ½æ‰“å° `Hi~`ã€‚

> `setTimeout(fn, delay)` çš„ `delay` æ˜¯æœ€å°å¼€å§‹æ‰§è¡Œæ—¶é—´ï¼Œè€Œä¸”åªä¼šå¤šä¸ä¼šå°‘ã€‚

å†çœ‹ï¼š

```js
setInterval(() => {
  console.log('Hi~')
}, 1000)
```

å®ƒè·Ÿ setTimeout ä¸€æ ·å— Event Loop å½±å“ï¼Œè‡ªç„¶ä¸å¯èƒ½å®Œç¾åœ°æ¯ç§’æ‰“å°ä¸€æ¬¡ `Hi~`ã€‚

ç”¨ setTimeout æ¨¡æ‹Ÿï¼š

```js
setTimeout(function tick() {
  console.log('Hi~')
  setTimeout(tick, 1000)
}, 1000)
```

ğŸ™‹ æé—®ï¼šå®ƒè·Ÿ setInterval ç‰ˆæœ¬åŠŸèƒ½ä¸Šç­‰æ•ˆçš„å—ï¼Ÿ

> ç­”æ¡ˆæ˜¯ä¸ä¸€æ ·çš„ï¼ŒsetInterval ä¼šäº§ç”Ÿä¸€ç§â€œæ¼‚ç§»â€ï¼ˆdriftï¼‰ç°è±¡ã€‚

åœ¨ Google ä¸Šæœç´¢ã€ŒsetInterval driftã€å…³é”®è¯ï¼Œå¯ä»¥çœ‹åˆ°å¾ˆå¤šç›¸å…³çš„è®¨è®ºå¸–å­ï¼Œæ¯”å¦‚ï¼š

- [Will setInterval drift?](https://stackoverflow.com/questions/985670/will-setinterval-drift)
- [setInterval keeps drifting over time](https://github.com/nodejs/node/issues/21822)
- [Should setInterval account for execution delays to prevent drift?](https://github.com/whatwg/html/issues/3151)

æ€ä¹ˆç†è§£æ¼‚ç§»å‘¢ï¼Ÿ

```html
<!DOCTYPE html>
<html lang="en">
  <body>
    <div id="time"></div>
    <script>
      window.onload = function () {
        const element = document.getElementById('time')
        const startTime = performance.now()
        let count = 0

        setInterval(() => {
          count++
          const currentTime = performance.now()
          const time = (currentTime - startTime) / 1000
          const rate = count / time
          element.innerHTML = `${count} call in ${time.toFixed(3)}s, or ${rate.toFixed(6)} calls per second.`
        }, 1000)
      }
    </script>
  </body>
</html>
```

> [CodePen Demo](https://codepen.io/tofrankie/pen/RwmEqwR)

å®ƒåœ¨ Chrome 126 è¡¨ç°å¾ˆå¥½ï¼Œå‡ ä¹æ˜¯æ¯ä¸€ç§’æ›´æ–°ä¸€æ¬¡ã€‚

```txt
34 call in 34.001s, or 0.999965 calls per second.
```

åœ¨ Firefox 127 ä¸Šï¼Œå½“æ‰§è¡Œäº†å¤§æ¦‚ 300 æ¬¡ä¹‹åï¼Œçº¦æ¼‚ç§»äº† 1s å·¦å³ã€‚Safari æ¼‚ç§»ä¹Ÿè¾ƒä¸ºæ˜æ˜¾ã€‚

```txt
317 call in 318.242s, or 0.996097 calls per second.
```

æ®æŸ¥ï¼ŒChrome æœ‰åšâ€œè‡ªåŠ¨ä¿®æ­£â€çš„å¤„ç†ï¼ˆ[æºç ](https://source.chromium.org/chromium/chromium/src/+/main:third_party/WebKit/Source/platform/Timer.cpp;drc=e6d900fb6ed08dbd3a048899f38962ee75f4d8d0;l=162)ï¼‰ï¼Œå³ä¾¿æ˜¯æ‰§è¡Œäº† 300 å¤šæ¬¡ï¼Œç”šè‡³æ›´å¤šæ—¶ï¼Œå…¶æ¼‚ç§»ä¹Ÿå¾ˆä½ï¼Œå‡ ä¹å¯ä»¥å¿½ç•¥ã€‚å°½ç®¡è¿™ç§ä¿®æ­£å¹¶ä¸æ˜¯è§„èŒƒæ‰€è¦æ±‚ï¼Œä½†åº”è¯¥æ˜¯å¼€å‘è€…æƒ³è¦çš„ç»“æœã€‚

é™¤æ­¤ä¹‹å¤–ï¼Œå½“é¡µé¢æŒ‚èµ·åå°ï¼Œä¸ºäº†çœç”µå’Œå‡å°‘ CPU å ç”¨ï¼Œä¸åŒæµè§ˆå™¨ä¼šé‡‡ç”¨ä¸€äº›[ç­–ç•¥](https://developer.chrome.com/blog/timer-throttling-in-chrome-88)ï¼Œæš‚åœæˆ–å»¶é•¿å®šæ—¶å™¨çš„ Delay Timeã€‚

> æŒ‚èµ·åå°çš„æƒ…å†µåŒ…å«ä½†ä¸é™äºï¼šæœ‰å…¶ä»–å¤„äºæ´»è·ƒçŠ¶æ€çš„æ ‡ç­¾ã€çª—å£æœ€å°åŒ–ã€ç½‘é¡µå†…å®¹å®Œå…¨ä¸å¯è§ã€å±å¹•é”å®šã€ç§»åŠ¨è®¾å¤‡å›åˆ°æ¡Œé¢ç­‰ã€‚

å°ç»“ï¼š

- `setTimeout(fn, delay)` çš„ delay æ˜¯æœ€å°å¼€å§‹æ‰§è¡Œæ—¶é—´ï¼Œè€Œä¸”åªä¼šå¤šä¸ä¼šå°‘ã€‚
- `setInterval(fn, delay)` çš„ delay ä¼šå·¦å³â€œæ¼‚ç§»â€ï¼Œç´¯è®¡æ‰§è¡Œæ¬¡æ•°è¶Šå¤šï¼Œæ¼‚ç§»è¶Šæ˜æ˜¾ã€‚åœ¨ Chrome æµè§ˆå™¨ä¸‹æœ‰â€œä¿®æ­£â€å¤„ç†ï¼Œæ¯æ¬¡å®é™…æ‰§è¡Œçš„ delay ä¸ä¼ å…¥çš„å€¼å¾ˆæ¥è¿‘ï¼Œå¯ä»¥å½“ä½œæ²¡æœ‰è¯¯å·®ã€‚
- åœ¨åå°æ—¶ï¼ŒsetTimeout å’Œ setInterval å›è°ƒä¼šé™ä½æ‰§è¡Œé¢‘ç‡ï¼Œç”šè‡³æš‚åœï¼Œè¿”å›å‰å°å†æ¢å¤ã€‚

å…³äº Event Loop æ¨èä¸¤ä¸ªä¸é”™çš„è§†é¢‘ï¼š

- [In The Loop](https://www.youtube.com/watch?v=cCOL7MC4Pl0&ab_channel=JSConf)ï¼ˆ[ä¸­æ–‡ç‰ˆ](https://www.bilibili.com/video/BV12K4y1f7js/?vd_source=7d9cc886b2d77a79704681f5e9759d23)ï¼‰
- [What the heck is the event loop anyway?](https://www.youtube.com/watch?v=8aGhZQkoFbQ&ab_channel=JSConf)ï¼ˆ[ä¸­æ–‡ç‰ˆ](https://www.bilibili.com/video/av456657611/?vd_source=7d9cc886b2d77a79704681f5e9759d23)ï¼‰

## ä¸é è°±ç‰ˆæœ¬

å°½ç®¡ setTimeout å’Œ setInterval å¾ˆå¤šé—®é¢˜ï¼Œä½†è¿˜æ˜¯è¦ç”¨åˆ°å®ƒï¼Œæˆ‘ä»¬è¦åšçš„æ˜¯å°½å¯èƒ½å‡å°‘è¯¯å·®ã€‚

å‡è®¾æœ‰ç¤ºä¾‹å¦‚ä¸‹ï¼š

```html
<div id="countdown">0 days, 0 hours, 0 minutes, 0 seconds</div>
```

```js
window.onload = function () {
  // å€’è®¡æ—¶æ—¶é•¿
  const seconds = 90
  countdown(seconds)
}

function countdown(seconds) {
  // TODO: å¾…å®ç°...
}

// å€’è®¡æ—¶å±•ç¤ºå½¢å¼
function updateUI(timeLeft) {
  const secondInMillisecond = 1000
  const minuteInMillisecond = secondInMillisecond * 60
  const hourInMillisecond = minuteInMillisecond * 60
  const dayInMillisecond = hourInMillisecond * 24

  const dayLeft = Math.floor(timeLeft / dayInMillisecond)
  const hourLeft = Math.floor((timeLeft % dayInMillisecond) / hourInMillisecond)
  const minuteLeft = Math.floor((timeLeft % hourInMillisecond) / minuteInMillisecond)
  const secondLeft = Math.floor((timeLeft % minuteInMillisecond) / secondInMillisecond)

  const html = `${dayLeft} days, ${hourLeft} hours, ${minuteLeft} minutes, ${secondLeft} seconds`
  document.getElementById('countdown').innerHTML = html
}
```

å…¶ä¸­ `countdown()` æ–¹æ³•æ¥æ”¶ä¸€ä¸ªå‰©ä½™çš„ç§’æ•° `seconds`ã€‚

> æˆ‘ä¸å…³å¿ƒæ˜¯ç”¨æœ¬åœ°æ—¶é—´ï¼Œè¿˜æ˜¯æœåŠ¡å™¨æ—¶é—´ç®—å‡ºæ¥çš„ï¼Œä½ åªéœ€å‘Šè¯‰æˆ‘å‰©ä½™å¤šå°‘ç§’å°±è¡Œã€‚

ç®€é™‹ç‰ˆæœ¬ï¼š

```js
function countdown(seconds) {
  const startTime = Date.now()
  const endTime = startTime + seconds * 1000

  let timeLeft = endTime - startTime

  const timer = setInterval(() => {
    timeLeft -= 1000 // å‡ 1s

    if (timeLeft <= 0) {
      clearInterval(timer)
      updateUI(0)
      return
    }

    updateUI(timeLeft)
  }, 1000)

  updateUI(timeLeft)
  // ğŸ™‹
}
```

å‡è®¾åœ¨ ğŸ™‹ å¤„æœ‰ä¸€ä¸ªè€—æ—¶çš„åŒæ­¥ä»»åŠ¡ï¼Œæ¯”å¦‚ï¼š

```js
function longRunningTask() {
  for (let i = 0; i < 1000000000; i++) {
    // do something...
  }
}
```

> å®é™…ä¸­ï¼Œè€—æ—¶ä»»åŠ¡ä¸åº”æ”¾åœ¨ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œï¼Œè¿™é‡Œåªç”¨äºè¡¨è¾¾ä¸Šè¿°ä¾‹å­çš„ç¼ºç‚¹ã€‚

é‚£ä¹ˆ setInterval ç¬¬ä¸€æ¬¡å›è°ƒçš„æ‰§è¡Œå°±å¯èƒ½å‘ç”Ÿåœ¨ N ç§’ä¹‹åï¼Œè¿™æ ·é¡µé¢ä¸Šçš„å€’è®¡æ—¶å°±æ›´ä¸å‡†äº†ã€‚ä¼šå‡ºç°è¿‡äº† 5s ä¹‹åï¼Œå€’è®¡æ—¶å¯èƒ½åªå‡å» 1s çš„æƒ…å†µï¼Œæ˜¾ç„¶è¿™ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ã€‚

å³ä¾¿æ²¡æœ‰è€—æ—¶ä»»åŠ¡ï¼Œå¦‚æœè¢«æŒ‚èµ·åå°ï¼Œæ‰§è¡Œé¢‘ç‡ä¼šå˜ä½ï¼Œç”šè‡³æš‚åœï¼Œé‡æ–°å›åˆ°å‰å°å‰©ä½™æ—¶é—´å°±ä¸å‡†äº†ã€‚

å› æ­¤ï¼ŒtimeLeftï¼ˆå‰©ä½™æ—¶é—´ï¼‰è¦åœ¨ setInterval å›è°ƒå‡½æ•°å†…é‡æ–°è®¡ç®—ï¼Œä¿®æ”¹å¦‚ä¸‹ï¼š

```js
function countdown(seconds) {
  const startTime = Date.now()
  const endTime = startTime + seconds * 1000
  
  const timer = setInterval(() => {
    const now = Date.now()
    const timeLeft = endTime - now

    if (timeLeft <= 0) {
      clearInterval(timer)
      updateUI(0)
      return
    }

    updateUI(timeLeft)
  }, 1000)
  
  updateUI(endTime - startTime)
}
```

è¿™æ ·ï¼Œè‡³å°‘å¯ä»¥ç¡®ä¿ä¸‹ä¸€æ¬¡æ›´æ–°çš„æ—¶å€™ï¼Œå‰©ä½™çš„æ—¶é—´æ˜¯â€œå‡†ç¡®â€çš„ã€‚

å‡è®¾åœ¨ç›¸å¯¹ç†æƒ³çš„ç¯å¢ƒä¸­ï¼Œé¡µé¢ä¸Šåªå‰©ä¸‹è¿™ä¸ªå€’è®¡æ—¶äº†ï¼Œä¹Ÿæ²¡æœ‰é˜»å¡ä¸»çº¿ç¨‹çš„ï¼ˆåŒæ­¥ï¼‰ä»»åŠ¡ï¼Œå®ƒå‡ ä¹å¯ä»¥æ¯ç§’æ‰§è¡Œä¸€æ¬¡ updateUIï¼Œæœ€èµ·ç äººçœ¼æ„ŸçŸ¥ä¸åˆ°å…¶ä¸­çš„è¯¯å·®ã€‚

ä½†ç°å®æ˜¯ï¼Œåœ¨ä¸åŒæµè§ˆä¸‹ï¼Œéšç€ setInterval ä¸åœåœ°æ‰§è¡Œï¼Œå…¶ Delay Time ä¼šäº§ç”Ÿåå·®ã€‚æ¯”å¦‚ Safari å’Œ Firefox å¯èƒ½ä¼šå¢åŠ å‡ æ¯«ç§’ï¼Œè€Œ Chrome ç”šè‡³ä¼šâ€œè‡ªåŠ¨ä¿®å¤â€è¿™ç§æ—¶é—´åå·®ï¼ˆè¿™åº”è¯¥æ˜¯å¼€å‘è€…æ‰€æœŸå¾…çš„ï¼‰ï¼Œä¹Ÿå°±æ˜¯è¯´ Delay Time ç”šè‡³ä¼šå‡å°‘ã€‚

æ‰€ä»¥ï¼Œé¡µé¢çœ‹åˆ°çš„æ•ˆæœæœ‰å¯èƒ½æ˜¯ï¼š

```
0 days, 0 hours, 1 minutes, 30 seconds
â†“
0 days, 0 hours, 1 minutes, 28 seconds
â†“
...
```

åŸå› æ˜¯ï¼šå‡è®¾åˆšå¥½åœ¨å‰©ä½™ 1m 30s çš„æ—¶å€™ `updateUI()`ï¼Œç”±äº Delay Time çš„åå·®ï¼ˆå‡è®¾å¤šäº† 10msï¼‰ï¼Œå¯¼è‡´ä¸‹ä¸€æ¬¡æ‰§è¡Œæ—¶å¾—åˆ° 1m 28s < timeLeft < 1m 29s çš„ç»“æœï¼Œå¯¼è‡´é¡µé¢è·³è¿‡ 29s æ˜¾ç¤ºäº† 28sï¼ˆå‰é¢ä½¿ç”¨äº† `Math.floor()` æ¥æ¢ç®—ï¼‰çš„é—®é¢˜ã€‚


> å¦‚æœé¡µé¢æœ‰å…¶ä»–è€—æ—¶ä»»åŠ¡æˆ–è€…æŒ‚èµ·åå°æ—¶ï¼Œè¿™ç§åå·®åªä¼šæ›´æ˜æ˜¾ã€‚

ç»¼ä¸Šï¼Œè¿™ä¸ªæ–¹æ¡ˆç¼ºç‚¹å¦‚ä¸‹ï¼š

1. æŒ‚èµ·åå°æ—¶ï¼Œ`setInterval()` ä»åœ¨æ‰§è¡Œï¼Œå ç”¨ CPU èµ„æºã€‚
2. å¯èƒ½ä¼šå‡ºç°è·³ç§’çš„æƒ…å†µï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå€’è®¡æ—¶ä¸æ˜¯ä¸€ç›´ `-1`ï¼Œå¶å°”ä¼š `-2`ã€‚
3. `Date.now()` å—ç³»ç»Ÿæ—¶é’Ÿå½±å“ã€‚

## æ”¹è¿›ç‰ˆæœ¬

å½“é¡µé¢æŒ‚èµ·æ—¶ï¼Œå¦‚æœä¸æƒ³è®©å®šæ—¶å™¨ä¸€ç›´åœ¨åå°æ‰§è¡Œï¼Œå¯ä»¥å€ŸåŠ© [visibilitychange](https://developer.mozilla.org/zh-CN/docs/Web/API/Document/visibilitychange_event) äº‹ä»¶æ¥å¤„ç†ã€‚

- é¡µé¢ä¸å¯è§æ—¶ï¼Œæ¸…é™¤å®šæ—¶å™¨
- é¡µé¢å¯è§æ—¶ï¼Œåˆ›å»ºæ–°çš„å®šæ—¶å™¨ã€‚

```js
function countdown(seconds) {
  const startTime = Date.now()
  const endTime = startTime + seconds * 1000

  const paint = () => {
    const now = Date.now()
    const timeLeft = endTime - now

    if (timeLeft <= 0) {
      clearInterval(timer)
      updateUI(0)
      return
    }

    updateUI(timeLeft)
  }

  let timer = setInterval(paint, 1000)
  
  handleVisibilityChange({
    hiddenFn: () => {
      clearInterval(timer)
    },
    visibleFn: () => {
      if (timer) clearInterval(timer)
      timer = setInterval(paint, 1000)
    },
  })
  
  updateUI(endTime - startTime)
}

function handleVisibilityChange({ hiddenFn = () => {}, visibleFn = () => {} }) {
  document.addEventListener('visibilitychange', event => {
    if (document.visibilityState === 'hidden') {
      hiddenFn(event)
      return
    }
    visibleFn(event)
  })
}
```

è¯¥æ–¹æ¡ˆçš„ç¼ºç‚¹ï¼š

1. å¤„ç†åå°æ‰§è¡Œçš„æ–¹å¼è¿‡äºå¤æ‚ã€‚
2. æœªè§£å†³è·³ç§’é—®é¢˜ã€‚
3. æœªè§£å†³ `Date.now()` å—ç³»ç»Ÿæ—¶é’Ÿå½±å“çš„é—®é¢˜ã€‚

## è¿›é˜¶ç‰ˆæœ¬

å¯ä»¥è€ƒè™‘ [requestAnimationFrame](https://developer.mozilla.org/zh-CN/docs/Web/API/Window/requestAnimationFrame)ï¼Œå®ƒä¼šåœ¨é¡µé¢é‡ç»˜ä¹‹å‰æ‰§è¡ŒæŒ‡å®šçš„å›è°ƒå‡½æ•°ã€‚

> å‡ºäºçœç”µå’Œæ€§èƒ½è€ƒè™‘ï¼Œå½“é¡µé¢æŒ‚èµ·æ—¶ï¼Œè¯¥ API ä¼šæš‚åœæ‰§è¡Œã€‚

å®ƒæ‰§è¡Œé¢‘ç‡è·Ÿå±å¹•åˆ·æ–°ç‡æœ‰å…³ã€‚æ¯”å¦‚å±å¹•åˆ·æ–°ç‡ä¸º 60Hzï¼Œè¡¨ç¤ºæ¯ç§’åˆ·æ–° 60 æ¬¡ï¼Œå³æ¯ 16.67ms åˆ·æ–°ä¸€æ¬¡ä»¥ç¡®ä¿ç”»é¢ä¸å¡é¡¿ã€‚å…¶ä»–å¸¸è§çš„ 90Hzã€120Hzã€144Hz çš„åˆ·æ–°ç‡åŒç†ã€‚

æ¯”å¦‚ï¼š

```js
function countdown(seconds) {
  const startTime = Date.now()
  const endTime = startTime + seconds * 1000
  updateUI(endTime - startTime)

  let rafId = requestAnimationFrame(function paint() {
    const now = Date.now()
    const timeLeft = endTime - now

    if (timeLeft <= 0) {
      updateUI(0)
      cancelAnimationFrame(rafId)
      return
    }

    updateUI(timeLeft)
    rafId = requestAnimationFrame(paint)
  })
}
```

åœ¨åˆ·æ–°ç‡ä¸º 60Hz çš„æ˜¾ç¤ºå™¨ä¸‹ï¼Œæ¯ç§’æ‰§è¡Œ 60 æ¬¡ï¼Œå€’è®¡æ—¶æ˜¯è¶³å¤Ÿå‡†ç¡®äº†ã€‚ä½†æ‰§è¡Œå¤ªé¢‘ç¹äº†ï¼Œä¹Ÿä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ï¼Œè¿˜ä¸å¦‚ `setInterval(() => {}, 333)` å‘¢ã€‚

å¯ä»¥ç»“åˆ setTimeout è§£å†³é¢‘ç¹æ‰§è¡Œçš„é—®é¢˜ï¼Œç„¶åè¦è§£å†³çš„æ˜¯ï¼š**å¦‚ä½•è·å–ä¸‹ä¸€æ¬¡æ›´æ–°çš„æ—¶é—´ï¼Ÿ**

å¼•å…¥ä¸€ä¸ª [Document Timeline](https://developer.mozilla.org/en-US/docs/Web/API/DocumentTimeline)ï¼Œæ­¤æ—¶é—´è½´å¯¹äºæ¯ä¸ªæ–‡æ¡£ï¼ˆdocumentï¼‰æ¥è¯´éƒ½æ˜¯å”¯ä¸€çš„ï¼Œå¹¶åœ¨æ–‡æ¡£çš„ç”Ÿå‘½å‘¨æœŸä¸­æŒç»­å­˜åœ¨ã€‚å…¶æ—¶é—´åŸç‚¹ï¼ˆTime Originï¼‰å¯é€šè¿‡ [`performance.timeOrigin`](https://developer.mozilla.org/zh-CN/docs/Web/API/Performance/timeOrigin) è·å–ã€‚

è¦è·å–å½“å‰æ–‡æ¡£è‡ªåˆ›å»ºä»¥æ¥ï¼ˆå³ç›¸å¯¹äºæ—¶é—´åŸç‚¹ï¼‰æ‰€ç»è¿‡çš„æ—¶é—´ï¼Œæœ‰ä¸¤ç§æ–¹å¼ï¼š

- [`document.timeline.currentTime`](https://developer.mozilla.org/en-US/docs/Web/API/AnimationTimeline/currentTime)
- [`performance.now()`](https://developer.mozilla.org/zh-CN/docs/Web/API/Performance/now)

å®ƒä»¬éƒ½è¿”å›ä¸€ä¸ªç›¸å¯¹é«˜ç²¾åº¦çš„æ¯«ç§’æ•°ï¼Œä½†åˆæœ‰ç‚¹åŒºåˆ«ã€‚

ä¸¾ä¸ªä¾‹å­ï¼šä»¥ 60Hz çš„å±å¹•ä¸ºä¾‹ï¼Œé¡µé¢æ¯ 16.67ms æ›´æ–°ä¸€æ¬¡ã€‚å‡è®¾ç¬¬ä¸‰æ¬¡æ›´æ–°å®Œï¼ˆå½“å‰æ—¶é—´è®°ä¸º 50msï¼‰ï¼Œæ¥ç€é©¬ä¸Šæ‰§è¡Œä¸‹ä¸€æ¬¡ Tickï¼Œè‹¥æ—¶é—´è¿‡äº† 5msï¼Œæ­¤æ—¶ `document.timeline.currentTime`ã€`performance.now()` åˆ†åˆ«ä¸º 50msã€55msã€‚ç­‰è¿™æ¬¡ Tick æ‰§è¡Œå®Œé‚£ä¸€åˆ»å®ƒä¿©çš„å€¼åˆå°†åŒæ­¥ï¼Œä»¥æ­¤ç±»æ¨ã€‚

> ç®€å•æ¥è¯´ï¼Œ`document.timeline.currentTime` æ˜¯å½“å‰å¸§èµ·å§‹é‚£ä¸€åˆ»ç›¸å¯¹äºæ—¶é—´åŸç‚¹ç»è¿‡çš„æ¯«ç§’æ•°ã€‚è€Œ `performance.now()` æ˜¯â€œçœŸæ­£â€å½“å‰æ—¶é—´ç›¸å½“äºæ—¶é—´åŸç‚¹ç»è¿‡çš„æ¯«ç§’æ•°ã€‚æ‰€ä»¥ï¼Œå®é™…è¡¨ç°åè€…æ€»æ˜¯æ¯”å‰è€…å¤§ä¸€ç‚¹ã€‚

æ¥ç€ï¼Œæˆ‘ä»¬å°è¯•ä¿®æ”¹ä¸‹ï¼š

```js
function countdown(seconds) {
  const startTime = document.timeline ? document.timeline.currentTime : performance.now()
  const endTime = startTime + seconds * 1000
  
  const paint = () => {
    const now = document.timeline ? document.timeline.currentTime : performance.now()
    const timeLeft = endTime - now

    if (timeLeft <= 0) {
      updateUI(0)
      return
    }

    const roundedTimeLeft = Math.round(timeLeft / 1000) * 1000
    updateUI(roundedTimeLeft)

    const nextTime = startTime + (seconds * 1000 - roundedTimeLeft) + 1000
    const nextDelay = nextTime - performance.now()

    setTimeout(() => requestAnimationFrame(paint), nextDelay)
  }

  paint()
}
```

> è€ƒè™‘ [Document API](https://caniuse.com/?search=document.timeline)ã€[High Resolution Time API](https://caniuse.com/?search=performance.now()) å…¼å®¹æ€§ã€‚

ä»¥ä¸‹è¿™è¡Œå¤„ç†ï¼Œç›®çš„æ˜¯é¿å…è·³ç§’ç°è±¡ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œå‡è®¾å½“å‰ `timeLeft` ä¸º 2988msï¼Œç”±äº `updateUI()` é‡Œç§’æ•°è½¬æ¢æ˜¯ä½¿ç”¨äº† `Math.floor()`ï¼Œå®ƒä¼šè¢«è½¬ä¸º 2sï¼Œä½†å®é™…ä¸Šå®ƒæ›´æ¥è¿‘ 3sï¼Œå› æ­¤åº”è¯¥ç”¨ `Math.round()` ä½œå–æ•´æ“ä½œã€‚

> æ³¨æ„ï¼Œè¿™é‡Œæ˜¯ç§’æ•°å–æ•´ï¼Œè€Œä¸æ˜¯æ¯«ç§’æ•°å–æ•´ã€‚

```js
const roundedTimeLeft = Math.round(timeLeft / 1000) * 1000
```

åœ¨ `updateUI()` ä¹‹å‰å¤„ç†ï¼Œä¹Ÿä¾¿äºå‡†ç¡®è®¡ç®—å‡ºä¸‹ä¸€ç§’çš„æ—¶é—´è½´æ—¶é—´ã€‚

```js
const nextTime = startTime + (seconds * 1000 - roundedTimeLeft) + 1000
```

æœ€åï¼Œé€šè¿‡ä¸‹ä¸€ç§’çš„æ—¶é—´ç‚¹å‡å»å½“å‰æ—¶é—´ç‚¹ï¼Œå¾—å‡ºå»¶è¿Ÿæ—¶é—´ã€‚

```js
const nextDelay = nextTime - performance.now()
```

è¿™ç§æ–¹æ¡ˆçš„ä¼˜ç‚¹ï¼š

- æ—¶é—´æ›´å‡†ç¡®ï¼Œå¯ä»¥è§£å†³ç”¨æˆ·ä¿®æ”¹ç³»ç»Ÿæ—¶é’Ÿå¯¼è‡´è®¡æ—¶å¯èƒ½ä¸å‡†ç¡®çš„é—®é¢˜ã€‚
    - ä½¿ç”¨ Date ä¼šå—åˆ°æ—¶é’Ÿåå·®å’Œç³»ç»Ÿæ—¶é’Ÿè°ƒæ•´çš„å½±å“ã€‚
    - ä½¿ç”¨ [High Resolution Time](https://www.w3.org/TR/hr-time-3/) ä¸å—ç³»ç»Ÿæ—¶é’Ÿå½±å“ã€‚
- å½“æµè§ˆå™¨æŒ‚èµ·æ—¶è‡ªåŠ¨æš‚åœï¼Œæ¢å¤å‰å°æ—¶ç»§ç»­ï¼Œä¸”å‡†ç¡®æ€§ä¸å—å½±å“ã€‚

ç”±äºè¿™ç§æ–¹æ¡ˆè¿˜ç”¨åˆ°äº† `setTimeout()`ï¼Œè·³ç§’é—®é¢˜è¿˜å­˜åœ¨ã€‚å‡è®¾ä¸»çº¿ç¨‹å­˜åœ¨è€—æ—¶ä»»åŠ¡ï¼Œæ²¡åŠæ³•åŠæ—¶æ‰§è¡Œå…¶å›è°ƒå‡½æ•°ï¼Œå› æ­¤å¯èƒ½ä¼šå‡ºç°ç±»ä¼¼ 4s ç›´æ¥è·³åˆ° 6sã€7s çš„æƒ…å†µã€‚

æœ‰äº›æ–‡ç« ä½¿ç”¨ [Web Worker](https://developer.mozilla.org/zh-CN/docs/Web/API/Web_Workers_API) æ¥å®ç°å€’è®¡æ—¶ï¼Œå› ä¸ºå®ƒæ˜¯ç‹¬ç«‹äºä¸»çº¿ç¨‹ï¼Œå¯ä»¥ä¸€ç›´åœ¨åå°çº¿ç¨‹è¿›è¡Œè®¡æ—¶ï¼Œè¿™æ ·è®¡æ—¶å€’æ˜¯å‡†ç¡®ã€‚å¦‚æœè®¡æ—¶è¦ä½“ç°åœ¨é¡µé¢ä¸Šï¼Œå¾—æ¯éš” 1s é€šçŸ¥ä¸»çº¿ç¨‹æ›´æ–° UIï¼ˆWorker æ— æ³•ç›´æ¥æ“ä½œ DOMï¼‰ã€‚ä½†æ˜¯ï¼Œå¦‚æœä¸»çº¿ç¨‹è¢«è€—æ—¶ä»»åŠ¡å ç€ï¼Œå³ä¾¿ä¸»çº¿ç¨‹æ¥åˆ°é€šçŸ¥äº†ï¼Œä½†ä½ è¿˜æ˜¯è¦æ’é˜Ÿç­‰ä¸»çº¿ç¨‹ç©ºé—²ä¸‹æ¥ã€‚

å› æ­¤ï¼Œæ ¹æœ¬çš„è§£å†³åŠæ³•åº”è¯¥æ˜¯å°†è€—æ—¶ä»»åŠ¡æ”¾åœ¨ Worker æ‰§è¡Œï¼Œæˆ–è€…ä½¿ç”¨æ—¶é—´åˆ†ç‰‡ï¼ˆTime Slicingï¼‰æ–¹æ¡ˆå°†è€—æ—¶ä»»åŠ¡åˆ†æˆè‹¥å¹²å°ä»»åŠ¡ï¼Œä»¥è®©å‡ºç©ºéš™ç»™ä¸»çº¿ç¨‹æ›´æ–° UIï¼Œé¿å…é€ æˆé¡µé¢å‡æ­»ç°è±¡ã€‚

## å¾®ä¿¡å°ç¨‹åºç‰ˆæœ¬

> å°ç¨‹åºæ¡†æ¶çš„é€»è¾‘å±‚å¹¶éè¿è¡Œåœ¨æµè§ˆå™¨ä¸­ï¼Œå› æ­¤ JavaScript åœ¨ web ä¸­ä¸€äº›èƒ½åŠ›éƒ½æ— æ³•ä½¿ç”¨ï¼Œå¦‚ windowï¼Œdocument ç­‰ã€‚

åœ¨å°ç¨‹åºé‡Œï¼Œå®ƒä»¬éƒ½ä¸èƒ½ç”¨ï¼š

- `document.timeline.currentTime`
- `window.performance.now()`
- `window.requestAnimationFrame()`

ä½†å¾®ä¿¡æä¾›äº† [`wx.getPerformance()`](https://developers.weixin.qq.com/miniprogram/dev/api/base/performance/wx.getPerformance.html) æ–¹æ³•ï¼Œé€šè¿‡ `wx.getPerformance().now()` å¯ä»¥å¾—åˆ°ä¸€ä¸ªç±»ä¼¼ `window.performance.now()` çš„ç»“æœï¼Œä½†ä¸å®Œå…¨ç›¸åŒï¼š

- `wx.getPerformance().now()` è¿”å›è‡ª 1970 å¹´ 1 æœˆ 1 æ—¥ 0 ç‚¹å¼€å§‹ä»¥æ¥çš„æ¯«ç§’æ•°ã€‚
- `window.performance.now()` è¿”å›è‡ª `performance.timeOrigin` å¼€å§‹ä»¥æ¥çš„æ¯«ç§’æ•°ã€‚

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ**æˆ‘ç›®å‰ä¸ç¡®å®š `wx.getPerformance().now()` æ—¥åæ˜¯å¦ä¼šæœ‰å˜åŠ¨ï¼Œå› ä¸º[å°ç¨‹åºæ–‡æ¡£](https://developers.weixin.qq.com/miniprogram/dev/api/base/performance/wx.getPerformance.html)å¹¶æœªæŒ‡å‡ºå…¶è¿”å›å€¼åŒ…å« `now` æ–¹æ³•ï¼Œä½†å®æµ‹å¼€å‘å·¥å…·å’ŒçœŸæœºæ˜¯å¯ç”¨çš„**ã€‚æœ‰ç‚¹ [`wx.onAppRoute()`](https://developers.weixin.qq.com/community/develop/doc/000800ea3d83984dafc6d476551000) çš„å‘³é“ï¼Œè™½ç„¶æ–‡æ¡£ä¸€ç›´æœªæåˆ°è¿‡ï¼Œä½†ä¸€ç›´å¯ç”¨ã€‚

![](https://cdn.jsdelivr.net/gh/toFrankie/blog@main/images/2024/7/1721466409884.png)

æ”¹é€ å¦‚ä¸‹ï¼š

```js
function countdown(seconds) {
  const startTime = wx.getPerformance().now()
  const endTime = startTime + seconds * 1000

  const paint = () => {
    const now = wx.getPerformance().now()
    const timeLeft = endTime - now

    if (timeLeft <= 0) {
      this.updateUI(0)
      return
    }

    const roundedTimeLeft = Math.round(timeLeft / 1000) * 1000
    this.updateUI(roundedTimeLeft)

    const nextTime = startTime + (seconds * 1000 - roundedTimeLeft) + 1000
    const nextDelay = nextTime - wx.getPerformance().now()

    setTimeout(() => paint(), nextDelay)
  }

  paint()
}
```

> TODO: ç¡®è®¤æ˜¯å¦å—ç³»ç»Ÿæ—¶é’Ÿè°ƒæ•´çš„å½±å“ï¼Ÿ

## References

- [WHATWG Standards - Timers](https://html.spec.whatwg.org/multipage/timers-and-user-prompts.html#timers)
- [Precise Timing With Web Animations API](https://www.smashingmagazine.com/2022/06/precise-timing-web-animations-api/)
- [How to create an accurate timer in javascript?](https://stackoverflow.com/questions/29971898/how-to-create-an-accurate-timer-in-javascript)
- [Is there a more accurate way to create a Javascript timer than setTimeout?](https://stackoverflow.com/questions/196027/is-there-a-more-accurate-way-to-create-a-javascript-timer-than-settimeout)


