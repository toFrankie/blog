---
title: å¦‚ä½•å®ç°ä¸€ä¸ªå‡†ç¡®çš„å€’è®¡æ—¶åŠŸèƒ½
number: '#339'
link: 'https://github.com/toFrankie/blog/issues/339'
created_at: '2024-05-26 13:08:30'
updated_at: '2024-05-26 17:42:50'
labels:
  - '2024'
  - JS/ES
  - å‰ç«¯
---
## èƒŒæ™¯

å€’è®¡æ—¶æ˜¯ä¸€ä¸ªå¾ˆå¸¸è§çš„ä¸šåŠ¡åœºæ™¯ã€‚åªæœ‰ä¸¤ä¸ªè¦æ±‚ï¼š

- å‡†ç¡®æ€§é«˜
- æ€§èƒ½å¥½

å‡è®¾æœ‰ç¤ºä¾‹å¦‚ä¸‹ï¼š

```html
<div id="countdown">0 days, 0 hours, 0 minutes, 0 seconds</div>
```

```js
window.onload = function () {
  // å€’è®¡æ—¶æ—¶é•¿
  const seconds = 90
  countdown(seconds)
}

function countdown(seconds) {
  // å¾…å®ç°...
}

// å€’è®¡æ—¶å±•ç¤ºå½¢å¼
function formatTimeLeft(timeLeft) {
  const secondInMillisecond = 1000
  const minuteInMillisecond = secondInMillisecond * 60
  const hourInMillisecond = minuteInMillisecond * 60
  const dayInMillisecond = hourInMillisecond * 24

  const dayLeft = Math.floor(timeLeft / dayInMillisecond)
  const hourLeft = Math.floor((timeLeft % dayInMillisecond) / hourInMillisecond)
  const minuteLeft = Math.floor((timeLeft % hourInMillisecond) / minuteInMillisecond)
  const secondLeft = Math.floor((timeLeft % minuteInMillisecond) / secondInMillisecond)

  const html = `${dayLeft} days, ${hourLeft} hours, ${minuteLeft} minutes, ${secondLeft} seconds`
  document.getElementById('countdown').innerHTML = html
}
```

æ€è·¯å¾ˆç®€å•ï¼Œå½“é¡µé¢åŠ è½½å®Œæˆï¼Œæ‰§è¡Œ `countdown()` å‡½æ•°ï¼Œé‡Œé¢æ¯ç§’æ›´æ–°ä¸€æ¬¡ DOM å°±è¡Œã€‚

## ç®€å•å®ç°

ç¬¬ä¸€ååº”æ˜¯ä½¿ç”¨æµè§ˆå™¨æä¾›çš„ setTimeout æˆ– setIntervalï¼Œæ¯”å¦‚ï¼š

```js
function countdown(seconds) {
  const startTime = Date.now()
  const endTime = startTime + seconds * 1000
  
  const timer = setInterval(() => {
    const now = Date.now()
    const timeLeft = endTime - now

    if (timeLeft <= 0) {
      clearInterval(timer)
      formatTimeLeft(0)
      return
    }

    formatTimeLeft(timeLeft)
  }, 1000)
  
  formatTimeLeft(endTime - startTime) // initialize the timer
  // ğŸ™‹
}
```

> æµè§ˆå™¨æ‰§è¡Œé¡ºåºï¼šåŒæ­¥ä»»åŠ¡ â†’ å¾®ä»»åŠ¡ â†’ é¡µé¢æ¸²æŸ“ â†’ ä¸‹ä¸€ä¸ªå®ä»»åŠ¡ â†’ å†ä¸‹ä¸€ä¸ªå®ä»»åŠ¡...

> ä»å®ä»»åŠ¡é˜Ÿåˆ—ã€å¾®ä»»åŠ¡é˜Ÿåˆ—å–å‡ºä»»åŠ¡æ—¶ï¼Œéµå¾ªã€Œå…ˆè¿›å…ˆå‡ºã€åŸåˆ™ã€‚

æ³¨æ„ï¼ŒsetTimeout æˆ– setInterval å®é™…æ˜¯åœ¨æŒ‡å®šæ—¶é—´åå°†å…¶åŠ å…¥åˆ°å¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ—ï¼ˆå®ƒå±äºå®ä»»åŠ¡ï¼‰ï¼Œå¹¶ä¸æ˜¯æŒ‡å®šæ—¶é—´åé©¬ä¸Šæ‰§è¡Œã€‚å®ƒè¿˜å¾—æ’é˜Ÿï¼Œä¹Ÿå°±æ˜¯ç­‰ä¸»çº¿ç¨‹ç©ºé—²äº†ä¹‹åï¼Œè¿™ä¸ªå®ä»»åŠ¡æ‰ä¼šè¢«æ‰§è¡Œã€‚

æ‰€ä»¥ï¼Œè¿™ä¸ªæ–¹æ¡ˆçš„ç¼ºç‚¹å¾ˆæ˜æ˜¾ï¼Œå®ƒä¿©æ— æ³•ç¡®ä¿æ¯ç§’æ‰§è¡Œä¸€æ¬¡ã€‚

é¡µé¢çœ‹åˆ°çš„æ•ˆæœæœ‰å¯èƒ½æ˜¯ï¼š

```
0 days, 0 hours, 1 minutes, 30 seconds
â†“
0 days, 0 hours, 1 minutes, 28 seconds
â†“
...
```

æ¯”å¦‚ï¼Œåœ¨ ğŸ™‹ å¤„æ‰§è¡Œä¸€ä¸ªè€—æ—¶çš„åŒæ­¥ä»»åŠ¡ ğŸ‘‡

```js
function longRunningTask() {
  for (let i = 0; i < 1000000000; i++) {
    // do something...
  }
}
```

é‚£ä¹ˆ setInterval ç¬¬ä¸€æ¬¡å›è°ƒçš„æ‰§è¡Œå°±å¯èƒ½å‘ç”Ÿåœ¨ N ç§’ä¹‹åï¼Œè¿™æ ·é¡µé¢ä¸Šçš„å€’è®¡æ—¶å°±æ›´ä¸å‡†äº†ã€‚

è¿˜æœ‰ï¼Œå½“é¡µé¢æŒ‚èµ·åå°æ—¶ï¼Œä¸ºäº†çœç”µå’Œå‡å°‘ CPU å ç”¨ï¼Œä¸åŒæµè§ˆå™¨ä¼šé‡‡ç”¨ä¸€äº›[ç­–ç•¥](https://developer.chrome.com/blog/timer-throttling-in-chrome-88)ï¼Œæš‚åœæˆ–å»¶é•¿å®šæ—¶å™¨çš„ Delay Timeã€‚ä¸Šé¢æ¯æ¬¡æ‰§è¡Œéƒ½é‡æ–°è·å– `now` ä¹Ÿæ˜¯ä¸ºäº†é¿å…è¿™ç§é—®é¢˜ã€‚

> æŒ‚èµ·åå°çš„æƒ…å†µåŒ…å«ä½†ä¸é™äºï¼šæœ‰å…¶ä»–å¤„äºæ´»è·ƒçŠ¶æ€çš„æ ‡ç­¾ã€çª—å£æœ€å°åŒ–ã€ç½‘é¡µå†…å®¹å®Œå…¨ä¸å¯è§ã€å±å¹•é”å®šã€ç§»åŠ¨è®¾å¤‡å›åˆ°æ¡Œé¢ç­‰ã€‚

## è¿›é˜¶ç‰ˆæœ¬

å¦‚æœç‰ºç‰²æ€§èƒ½ï¼Œä¹Ÿå¯ä»¥å°† Delay Time è®¾ç½® 333ms ç­‰ï¼Œå³ä¸€ç§’å†…æ‰§è¡Œå¤šæ¬¡ã€‚

ä¸‹é¢ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ [requestAnimationFrame](https://developer.mozilla.org/zh-CN/docs/Web/API/Window/requestAnimationFrame) æ¥æ”¹è¿›ï¼Œå®ƒä¼šåœ¨é¡µé¢é‡ç»˜ä¹‹å‰æ‰§è¡ŒæŒ‡å®šçš„å›è°ƒå‡½æ•°ã€‚

å®ƒæ‰§è¡Œé¢‘ç‡è·Ÿå±å¹•åˆ·æ–°ç‡æœ‰å…³ã€‚æ¯”å¦‚å±å¹•åˆ·æ–°ç‡ä¸º 60Hzï¼Œè¡¨ç¤ºæ¯ç§’åˆ·æ–° 60 æ¬¡ï¼Œå³æ¯ 16.67ms åˆ·æ–°ä¸€æ¬¡ä»¥ç¡®ä¿ç”»é¢ä¸å¡é¡¿ã€‚å…¶ä»–å¸¸è§çš„ 90Hzã€120Hzã€144Hz çš„åˆ·æ–°ç‡åŒç†ã€‚

> åŒæ ·åœ°ï¼Œå‡ºäºçœç”µå’Œæ€§èƒ½è€ƒè™‘ï¼Œè¯¥ API åœ¨è¢«æŒ‚èµ·æ—¶ä¼šè¢«æš‚åœã€‚


å¦‚æœä¸€ç§’æ‰§è¡Œ 60 æ¬¡ setTimeoutï¼Œå°±æ¯”å‰é¢ 333ms æ›´ç¦»è°±äº†ï¼Œæ‰€ä»¥è¦ requestAnimationFrame + setTimeout ç»“åˆã€‚


æœªå®Œå¾…ç»­...

## References

- [WHATWG Standards - Timers](https://html.spec.whatwg.org/multipage/timers-and-user-prompts.html#timers)



