---
title: è¶…è¯¦ç»†çš„ JavaScript æ·±æ‹·è´å®ç°
number: '#246'
link: 'https://github.com/toFrankie/blog/issues/246'
created_at: '2023-02-26 19:27:14'
updated_at: '2023-11-27 14:04:06'
labels:
  - JS/ES
  - '2021'
---
![é…å›¾æºè‡ª Feepik](https://upload-images.jianshu.io/upload_images/5128488-d1a19225ff7a1391.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

æ­¤å‰å†™è¿‡ä¸€ç¯‡æ–‡ç« ï¼š[JavaScript æ·±æµ…æ‹·è´ï¼Œå…¶å®æ²¡é‚£ä¹ˆéš¾ï¼](https://github.com/toFrankie/blog/issues/200)ï¼Œä½†é‡Œé¢çš„æ‹·è´å¤„ç†æ˜¾ç„¶ä¸å¤Ÿç†æƒ³ã€‚

ä»Šå¤©å†æ¥è¯¦ç»†çš„è®²è®²...

### ä¸€ã€JSON.stringify() çš„ç¼ºé™·

åˆ©ç”¨ JavaScript å†…ç½®çš„ JSON å¤„ç†å‡½æ•°ï¼Œå¯ä»¥å®ç°ç®€æ˜“çš„æ·±æ‹·è´ï¼š

```js
const obj = {
  // ...
}
JSON.parse(JSON.stringify(obj)) // åºåˆ—åŒ–ä¸ååºåˆ—åŒ–
```

è¿™ä¸ªæ–¹æ³•ï¼Œå…¶å®èƒ½é€‚ç”¨äº 90% ä»¥ä¸Šçš„åº”ç”¨åœºæ™¯ã€‚æ¯•ç«Ÿå¤šæ•°é¡¹ç›®ä¸‹ï¼Œå¾ˆå°‘ä¼šå»æ‹·è´ä¸€ä¸ªå‡½æ•°ä»€ä¹ˆçš„ã€‚

ä½†ä¸å¾—ä¸è¯´ï¼Œè¿™é‡Œé¢æœ‰â€œå‘â€ï¼Œè¿™äº›â€œå‘â€æ˜¯ `JSON.stringify()` æ–¹æ³•æœ¬èº«å®ç°é€»è¾‘äº§ç”Ÿçš„ï¼š

> JSON.stringify(value[, replacer[, space]])

è¯¥æ–¹æ³•æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š

* å¸ƒå°”å€¼ã€æ•°å€¼ã€å­—ç¬¦ä¸²å¯¹åº”çš„åŒ…è£…å¯¹è±¡ï¼Œåœ¨åºåˆ—åŒ–è¿‡ç¨‹ä¼šè‡ªåŠ¨è½¬æ¢æˆå…¶åŸå§‹å€¼ã€‚
* `undefined`ã€`ä»»æ„å‡½æ•°`ã€`Symbol å€¼`ï¼Œåœ¨åºåˆ—åŒ–è¿‡ç¨‹æœ‰ä¸¤ç§ä¸åŒçš„æƒ…å†µã€‚è‹¥å‡ºç°åœ¨éæ•°ç»„å¯¹è±¡çš„å±æ€§å€¼ä¸­ï¼Œä¼šè¢«å¿½ç•¥ï¼›è‹¥å‡ºç°åœ¨æ•°ç»„ä¸­ï¼Œä¼šè½¬æ¢æˆ `null`ã€‚
* `ä»»æ„å‡½æ•°`ã€`undefined` è¢«å•ç‹¬è½¬æ¢æ—¶ï¼Œä¼šè¿”å› `undefined`ã€‚
* æ‰€æœ‰`ä»¥ Symbol ä¸ºå±æ€§é”®çš„å±æ€§`éƒ½ä¼šè¢«å®Œå…¨å¿½ç•¥ï¼Œå³ä¾¿åœ¨è¯¥æ–¹æ³•ç¬¬äºŒä¸ªå‚æ•° `replacer` ä¸­æŒ‡å®šäº†è¯¥å±æ€§ã€‚
* `Date æ—¥æœŸ`è°ƒç”¨äº†å…¶å†…ç½®çš„ `toJSON()` æ–¹æ³•è½¬æ¢æˆå­—ç¬¦ä¸²ï¼Œå› æ­¤ä¼šè¢«å½“åˆå­—ç¬¦ä¸²å¤„ç†ã€‚
* `NaN` å’Œ `Infinity` çš„æ•°å€¼åŠ `null` éƒ½ä¼šå½“åš `null`ã€‚
* è¿™äº›å¯¹è±¡ `Map`ã€`Set`ã€`WeakMap`ã€`WeakSet` ä»…ä¼šåºåˆ—åŒ–å¯æšä¸¾çš„å±æ€§ã€‚
* è¢«è½¬æ¢å€¼å¦‚æœå«æœ‰ `toJSON()` æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å®šä¹‰ä»€ä¹ˆå€¼å°†è¢«åºåˆ—åŒ–ã€‚
* å¯¹åŒ…å« `å¾ªç¯å¼•ç”¨` çš„å¯¹è±¡è¿›è¡Œåºåˆ—åŒ–ï¼Œä¼šæŠ›å‡ºé”™è¯¯ã€‚

### äºŒã€æ·±æ‹·è´çš„è¾¹ç•Œ

å…¶å®ï¼Œé’ˆå¯¹ä»¥ä¸Šä¸¤ä¸ªå†…ç½®çš„å…¨å±€æ–¹æ³•ï¼Œè¿˜æœ‰è¿™ä¹ˆå¤šæƒ…å†µä¸èƒ½å¤„ç†ï¼Œæ˜¯ä¸æ˜¯å¾ˆæ°”äººã€‚å…¶å®ä¸ç„¶ï¼Œæˆ‘çŒœæµ‹ `JSON.parse()` å’Œ `JSON.stringify()` åªæ˜¯è®©æˆ‘ä»¬æ›´æ–¹ä¾¿åœ°æ“ä½œç¬¦åˆ JSON æ ¼å¼çš„ JavaScript å¯¹è±¡æˆ–ç¬¦åˆ JSON æ ¼å¼çš„å­—ç¬¦ä¸²ã€‚

è‡³äºä¸Šé¢æåˆ°çš„â€œå‘â€ï¼Œå¾ˆæ˜æ˜¾æ˜¯ä¸ç¬¦åˆä½œä¸ºè·¨å¹³å°æ•°æ®äº¤æ¢çš„æ ¼å¼è¦æ±‚çš„ã€‚åœ¨ JSON ä¸­ï¼Œå®ƒæœ‰ `null`ï¼Œæ˜¯æ²¡æœ‰ `undefined`ã€`Symbol` ç±»å‹ã€å‡½æ•°ç­‰ã€‚

JSON æ˜¯ä¸€ç§æ•°æ®æ ¼å¼ï¼Œä¹Ÿå¯ä»¥è¯´æ˜¯ä¸€ç§è§„èŒƒã€‚JSON æ˜¯ç”¨äºè·¨å¹³å°æ•°æ®äº¤æµçš„ï¼Œç‹¬ç«‹äºè¯­è¨€å’Œå¹³å°ã€‚è€Œ JavaScript å¯¹è±¡æ˜¯ä¸€ä¸ªå®ä¾‹ï¼Œå­˜åœ¨äºå†…å­˜ä¸­ã€‚JavaScript å¯¹è±¡æ˜¯æ²¡åŠæ³•ä¼ è¾“çš„ï¼Œåªæœ‰åœ¨è¢«åºåˆ—åŒ–ä¸º JSON å­—ç¬¦ä¸²åæ‰èƒ½ä¼ è¾“ã€‚

> æ­¤å‰å†™è¿‡ä¸€ç¯‡æ–‡ç« ï¼Œä»‹ç»äº† JSON å’Œ JavaScript çš„å…³ç³»ä»¥åŠä¸Šè¿°ä¸¤ä¸ªæ–¹æ³•çš„ä¸€äº›ç»†èŠ‚ã€‚å¯çœ‹ï¼š[è¯¦è°ˆ JSON ä¸ JavaScript](https://www.jianshu.com/p/a07e746fd9db)ã€‚

å¦‚æœè‡ªå·±å®ç°ä¸€ä¸ªæ·±æ‹·è´çš„æ–¹æ³•ï¼Œå…¶å®æ˜¯æœ‰å¾ˆå¤šè¾¹ç•Œé—®é¢˜è¦å¤„ç†çš„ï¼Œè‡³äºè¿™äº›ç§ç§çš„è¾¹ç•Œ Caseï¼Œè¦ä¸è¦å¤„ç†æœ€å¥½ä»å®é™…æƒ…å†µå‡ºå‘ã€‚

å¸¸è§çš„è¾¹ç•Œ Case æœ‰ä»€ä¹ˆå‘¢ï¼Ÿ

> ä¸»è¦æœ‰å¾ªç¯å¼•ç”¨ã€åŒ…è£…å¯¹è±¡ã€å‡½æ•°ã€åŸå‹é“¾ã€ä¸å¯æšä¸¾å±æ€§ã€Map/WeakMapã€Set/WeakSetã€RegExpã€Symbolã€Dateã€ArrayBufferã€åŸç”Ÿ DOM/BOM å¯¹è±¡ç­‰ã€‚

**å°±ç›®å‰è€Œè¨€ï¼Œç¬¬ä¸‰æ–¹æœ€å®Œå–„çš„æ·±æ‹·è´æ–¹æ³•æ˜¯ [Lodash](https://www.lodashjs.com/) åº“çš„ [`_.cloneDeep()`](https://www.lodashjs.com/docs/lodash.cloneDeep) æ–¹æ³•äº†ã€‚åœ¨å®é™…é¡¹ç›®ä¸­ï¼Œå¦‚éœ€å¤„ç† `JSON.stringify()` æ— æ³•è§£å†³çš„ Caseï¼Œæˆ‘ä¼šæ¨èä½¿ç”¨å®ƒã€‚**å¦åˆ™è¯·ä½¿ç”¨å†…ç½® JSON æ–¹æ³•å³å¯ï¼Œæ²¡å¿…è¦å¤æ‚åŒ–ã€‚

ä½†å¦‚æœä¸ºäº†å­¦ä¹ æ·±æ‹·è´ï¼Œé‚£åº”è¯¥è¦æ¯ç§æƒ…å†µéƒ½è¦å»å°è¯•å®ç°ä¸€ä¸‹ï¼Œæˆ‘æƒ³è¿™ä¹Ÿæ˜¯ä½ åœ¨çœ‹è¿™ç¯‡æ–‡ç« çš„åŸæ„ã€‚è¿™æ ·ï¼Œæ— è®ºæ˜¯å®ç°ç‰¹æ®Šè¦æ±‚çš„æ·±æ‹·è´ï¼Œè¿˜æ˜¯é¢è¯•ï¼Œéƒ½å¯ä»¥ä»å®¹åº”å¯¹ã€‚

ä¸‹é¢ä¸€èµ·æ¥å­¦ä¹ å§ï¼Œå¦‚æœ‰ä¸è¶³ï¼Œæ¬¢è¿æŒ‡å‡º ğŸ‘‹ ~

### ä¸‰ã€è‡ªå®ç°æ·±æ‹·è´æ–¹æ³•

ä¸»è¦è¿ç”¨åˆ°é€’å½’çš„æ€è·¯å»å®ç°ä¸€ä¸ªæ·±æ‹·è´æ–¹æ³•ã€‚

> PSï¼šå®Œæ•´çš„æ·±æ‹·è´æ–¹æ³•ä¼šåœ¨æ–‡ç« æœ€åæ”¾å‡ºã€‚

å…ˆå†™ä¸€ä¸ªç®€æ˜“ç‰ˆæœ¬ï¼š

```js
const deepCopy = source => {
  // åˆ¤æ–­æ˜¯å¦ä¸ºæ•°ç»„
  const isArray = arr => Object.prototype.toString.call(arr) === '[object Array]'

  // åˆ¤æ–­æ˜¯å¦ä¸ºå¼•ç”¨ç±»å‹
  const isObject = obj => obj !== null && (typeof obj === 'object' || typeof obj === 'function')

  // æ‹·è´ï¼ˆé€’å½’æ€è·¯ï¼‰
  const copy = input => {
    if (typeof input === 'function' || !isObject(input)) return input

    const output = isArray(input) ? [] : {}
    for (let key in input) {
      if (input.hasOwnProperty(key)) {
        const value = input[key]
        output[key] = copy(value)
      }
    }

    return output
  }

  return copy(source)
}
```
ä»¥ä¸Šç®€æ˜“ç‰ˆæœ¬è¿˜å­˜åœ¨å¾ˆå¤šæƒ…å†µè¦ç‰¹æ®Šå¤„ç†ï¼Œæ¥ä¸‹æ¥é’ˆå¯¹ `JSON.stringify()` çš„ç¼ºé™·ï¼Œä¸€ç‚¹ä¸€ç‚¹å»å®Œå–„å®ƒã€‚

##### 3.1 é’ˆå¯¹å¸ƒå°”å€¼ã€æ•°å€¼ã€å­—ç¬¦ä¸²çš„åŒ…è£…å¯¹è±¡çš„å¤„ç†

> éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä» ES6 å¼€å§‹å›´ç»•åŸå§‹æ•°æ®ç±»å‹åˆ›å»ºä¸€ä¸ªæ˜¾å¼åŒ…è£…å™¨å¯¹è±¡ä¸å†è¢«æ”¯æŒã€‚ä½†ç”±äºé—ç•™åŸå› ï¼Œç°æœ‰çš„åŸå§‹åŒ…è£…å™¨å¯¹è±¡ï¼ˆå¦‚ `new Boolean`ã€`new Number`ã€`new String`ï¼‰ä»å¯ä½¿ç”¨ã€‚è¿™ä¹Ÿæ˜¯ ES6+ æ–°å¢çš„ `Symbol`ã€`BigInt` æ•°æ®ç±»å‹æ— æ³•é€šè¿‡ `new` å…³é”®å­—åˆ›å»ºå®ä¾‹å¯¹è±¡çš„åŸå› ã€‚

ç”±äº [for...in](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Statements/for...in) æ— æ³•éå†**ä¸å¯æšä¸¾**çš„å±æ€§ã€‚ä¾‹å¦‚ï¼ŒåŒ…è£…å¯¹è±¡çš„ `[[PrimitiveValue]]` å†…éƒ¨å±æ€§ï¼Œå› æ­¤éœ€è¦æˆ‘ä»¬ç‰¹æ®Šå¤„ç†ä¸€ä¸‹ã€‚

![](https://upload-images.jianshu.io/upload_images/5128488-78fa536df61e8c06.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

ä»¥ä¸Šç»“æœï¼Œæ˜¾ç„¶ä¸æ˜¯é¢„æœŸç»“æœã€‚åŒ…è£…å¯¹è±¡çš„ `[[PrimitiveValue]]` å±æ€§å¯é€šè¿‡ `valueOf()` æ–¹æ³•è·å–ã€‚

```js
const deepCopy = source => {
  // è·å–æ•°æ®ç±»å‹ï¼ˆæœ¬æ¬¡æ–°å¢ï¼‰
  const getClass = x => Object.prototype.toString.call(x)

  // åˆ¤æ–­æ˜¯å¦ä¸ºæ•°ç»„
  const isArray = arr => getClass(arr) === '[object Array]'

  // åˆ¤æ–­æ˜¯å¦ä¸ºå¼•ç”¨ç±»å‹
  const isObject = obj => obj !== null && (typeof obj === 'object' || typeof obj === 'function')

  // åˆ¤æ–­æ˜¯å¦ä¸ºåŒ…è£…å¯¹è±¡ï¼ˆæœ¬æ¬¡æ–°å¢ï¼‰
  const isWrapperObject = obj => {
    const theClass = getClass(obj)
    const type = /^\[object (.*)\]$/.exec(theClass)[1]
    return ['Boolean', 'Number', 'String', 'Symbol', 'BigInt'].includes(type)
  }

  // å¤„ç†åŒ…è£…å¯¹è±¡ï¼ˆæœ¬æ¬¡æ–°å¢ï¼‰
  const handleWrapperObject = obj => {
    const type = getClass(obj)
    switch (type) {
      case '[object Boolean]':
        return Object(Boolean.prototype.valueOf.call(obj))
      case '[object Number]':
        return Object(Number.prototype.valueOf.call(obj))
      case '[object String]':
        return Object(String.prototype.valueOf.call(obj))
      case '[object Symbol]':
        return Object(Symbol.prototype.valueOf.call(obj))
      case '[object BigInt]':
        return Object(BigInt.prototype.valueOf.call(obj))
      default:
        return undefined
    }
  }

  // æ‹·è´ï¼ˆé€’å½’æ€è·¯ï¼‰
  const copy = input => {
    if (typeof input === 'function' || !isObject(input)) return input

    // å¤„ç†åŒ…è£…å¯¹è±¡ï¼ˆæœ¬æ¬¡æ–°å¢ï¼‰
    if (isWrapperObject(input)) {
      return handleWrapperObject(input)
    }

    // å…¶ä½™éƒ¨åˆ†æ²¡å˜ï¼Œä¸ºäº†å‡å°‘ç¯‡å¹…ï¼Œçœç•¥ä¸€ä¸‡å­—...
  }

  return copy(source)
}
```
æˆ‘ä»¬åœ¨æ§åˆ¶å°æ‰“å°ä¸€ä¸‹ç»“æœï¼Œå¯ä»¥çœ‹åˆ°æ˜¯ç¬¦åˆé¢„æœŸç»“æœçš„ã€‚

![](https://upload-images.jianshu.io/upload_images/5128488-5a779a6b1676347c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

##### 3.2 é’ˆå¯¹å‡½æ•°çš„å¤„ç†

ç›´æ¥è¿”å›å°±å¥½äº†ï¼Œä¸€èˆ¬ä¸ç”¨å¤„ç†ã€‚åœ¨å®é™…åº”ç”¨åœºæ™¯éœ€è¦æ‹·è´å‡½æ•°å¤ªå°‘äº†...

```js
const copy = input => {
  if (typeof input === 'function' || !isObject(input)) return input
}
```

##### 3.3 é’ˆå¯¹ä»¥ Symbol å€¼ä½œä¸ºå±æ€§é”®çš„å¤„ç†

ç”±äºä»¥ä¸Š `for...in` æ–¹æ³•æ— æ³•éå† `Symbol` çš„å±æ€§é”®ï¼Œå› æ­¤ï¼š

```js
const sym = Symbol('desc')
const obj = {
  [sym]: 'This is symbol value'
}
console.log(deepCopy(obj)) // {}ï¼Œæ‹·è´ç»“æœæ²¡æœ‰ [sym] å±æ€§
```

è¿™é‡Œï¼Œæˆ‘ä»¬éœ€è¦ç”¨åˆ°ä¸¤ä¸ªæ–¹æ³•ï¼š

* [Object.getOwnPropertySymbols()](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/getOwnPropertySymbols) 
  å®ƒè¿”å›ä¸€ä¸ªå¯¹è±¡è‡ªèº«çš„æ‰€æœ‰ Symbol å±æ€§çš„æ•°ç»„ï¼ŒåŒ…æ‹¬ä¸å¯æšä¸¾çš„å±æ€§ã€‚

* [Object.prototype.propertyIsEnumerable()](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/propertyIsEnumerable)
  å®ƒè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºæŒ‡å®šçš„å±æ€§æ˜¯å¦å¯æšä¸¾ã€‚

```js
const copy = input => {
  // å…¶å®ƒä¸å˜
  for (let key in input) {
    // ...
  }

  // å¤„ç†ä»¥ Symbol å€¼ä½œä¸ºå±æ€§é”®çš„å±æ€§ï¼ˆæœ¬æ¬¡æ–°å¢ï¼‰
  const symbolArr = Object.getOwnPropertySymbols(input)
  if (symbolArr.length) {
    for (let i = 0, len = symbolArr.length; i < len; i++) {
      if (input.propertyIsEnumerable(symbolArr[i])) {
        const value = input[symbolArr[i]]
        output[symbolArr[i]] = copy(value)
      }
    }
  }

  // ...
}
```

ä¸‹é¢æˆ‘ä»¬å¯¹ `source` å¯¹è±¡åšæ‹·è´æ“ä½œï¼š

```js
const source = {}
const sym1 = Symbol('1')
const sym2 = Symbol('2')
Object.defineProperties(source,
  {
    [sym1]: {
      value: 'This is symbol value.',
      enumerable: true
    },
    [sym2]: {
      value: 'This is a non-enumerable property.',
      enumerable: false
    }
  }
)
```
æ‰“å°ç»“æœï¼Œä¹Ÿç¬¦åˆé¢„æœŸç»“æœï¼š

![](https://upload-images.jianshu.io/upload_images/5128488-17ed4f9fd1744951.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)



##### 3.4 é’ˆå¯¹ Date å¯¹è±¡çš„å¤„ç†

å…¶å®ï¼Œå¤„ç† `Date` å¯¹è±¡ï¼Œè·Ÿä¸Šé¢æåˆ°çš„åŒ…è£…å¯¹è±¡çš„å¤„ç†æ˜¯å·®ä¸å¤šçš„ã€‚æš‚æ—¶å…ˆæ”¾åˆ° `isWrapperObject()` å’Œ `handleWrapperObject()` ä¸­å¤„ç†ã€‚

```js
const deepCopy = source => {
  // å…¶ä»–ä¸å˜...

  // åˆ¤æ–­æ˜¯å¦ä¸ºåŒ…è£…å¯¹è±¡ï¼ˆæœ¬æ¬¡æ›´æ–°ï¼‰
  const isWrapperObject = obj => {
    const theClass = getClass(obj)
    const type = /^\[object (.*)\]$/.exec(theClass)[1]
    return ['Boolean', 'Number', 'String', 'Symbol', 'BigInt', 'Date'].includes(type)
  }

  // å¤„ç†åŒ…è£…å¯¹è±¡
  const handleWrapperObject = obj => {
    const type = getClass(obj)
    switch (type) {
      // å…¶ä»– case ä¸å˜
      // ...
      case '[object Date]':
        return new Date(obj.valueOf()) // new Date(+obj)
      default:
        return undefined
    }
  }

  // å…¶ä»–ä¸å˜...
}
```

##### 3.5 é’ˆå¯¹  Mapã€Set å¯¹è±¡çš„å¤„ç†

åŒæ ·çš„ï¼Œæš‚æ—¶å…ˆæ”¾åˆ° `isWrapperObject()` å’Œ `handleWrapperObject()` ä¸­å¤„ç†ã€‚

åˆ©ç”¨ Mapã€Set å¯¹è±¡çš„ [Iterator](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Iteration_protocols) ç‰¹æ€§å’Œè‡ªèº«çš„æ–¹æ³•ï¼Œå¯ä»¥å¿«é€Ÿè§£å†³ã€‚

```js
const deepCopy = source => {
  // å…¶ä»–ä¸å˜...

  // åˆ¤æ–­æ˜¯å¦ä¸ºåŒ…è£…å¯¹è±¡ï¼ˆæœ¬æ¬¡æ›´æ–°ï¼‰
  const isWrapperObject = obj => {
    const theClass = getClass(obj)
    const type = /^\[object (.*)\]$/.exec(theClass)[1]
    return ['Boolean', 'Number', 'String', 'Symbol', 'BigInt', 'Date', 'Map', 'Set'].includes(type)
  }

  // å¤„ç†åŒ…è£…å¯¹è±¡
  const handleWrapperObject = obj => {
    const type = getClass(obj)
    switch (type) {
      // å…¶ä»– case ä¸å˜
      // ...
      case '[object Map]': {
        const map = new Map()
        obj.forEach((item, key) => {
          // éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œçš„ key ä¸èƒ½æ·±æ‹·è´ï¼Œå¦åˆ™å°±ä¼šå¤±å»å¼•ç”¨äº†
          // å…·ä½“åŸå› å¯ä»¥æ€è€ƒä¸€ä¸‹ï¼Œä¸éš¾ã€‚æƒ³ä¸æ˜ç™½å†è¯„è®ºåŒºå§
          map.set(key, copy(item))
        })
        return map
      }
      case '[object Set]': {
        const set = new Set()
        obj.forEach(item => {
          set.add(copy(item))
        })
        return set
      }
      default:
        return undefined
    }
  }

  // å…¶ä»–ä¸å˜...
}
```

æ‰“å°ä¸‹ç»“æœï¼š

![](https://upload-images.jianshu.io/upload_images/5128488-e419985b0e2a6f04.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)


##### 3.6 é’ˆå¯¹å¾ªç¯å¼•ç”¨çš„é—®é¢˜

ä»¥ä¸‹æ˜¯ä¸€ä¸ªå¾ªç¯å¼•ç”¨ï¼ˆcircular referenceï¼‰çš„å¯¹è±¡ï¼š

```js
const foo = { name: 'Frankie' }
foo.bar = foo
```

ä¸Šé¢æåˆ° `JSON.stringify()` æ— æ³•å¤„ç†å¾ªç¯å¼•ç”¨çš„é—®é¢˜ï¼Œæˆ‘ä»¬åœ¨æ§åˆ¶å°æ‰“å°ä¸€ä¸‹ï¼š

![](https://upload-images.jianshu.io/upload_images/5128488-d8445e9dd56ce04c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

ä»ç»“æœå¯ä»¥çœ‹åˆ°ï¼Œå½“å¯¹å¾ªç¯å¼•ç”¨çš„å¯¹è±¡è¿›è¡Œåºåˆ—åŒ–å¤„ç†æ—¶ï¼Œä¼šæŠ›å‡ºç±»å‹é”™è¯¯ï¼š`Uncaught TypeError: Converting circular structure to JSON`ã€‚

æ¥ç€ï¼Œä½¿ç”¨è‡ªè¡Œå®ç°çš„ `deepCopy()` æ–¹æ³•ï¼Œçœ‹ä¸‹ç»“æœæ˜¯ä»€ä¹ˆï¼š

![](https://upload-images.jianshu.io/upload_images/5128488-6ef50a132b4f42c8.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

æˆ‘ä»¬çœ‹åˆ°ï¼Œåœ¨æ‹·è´å¾ªç¯å¼•ç”¨çš„ `foo` å¯¹è±¡æ—¶ï¼Œå‘ç”Ÿæ ˆæº¢å‡ºäº†ã€‚

> åœ¨å¦ä¸€ç¯‡[æ–‡ç« ](https://www.jianshu.com/p/a07e746fd9db)ï¼Œæˆ‘æåˆ°è¿‡ä½¿ç”¨ [JSON-js](https://links.jianshu.com/go?to=https%3A%2F%2Fgithub.com%2Fdouglascrockford%2FJSON-js) å¯ä»¥å¤„ç†å¾ªç¯å¼•ç”¨çš„é—®é¢˜ï¼Œå…·ä½“ç”¨æ³•æ˜¯ï¼Œå…ˆå¼•å…¥å…¶ä¸­çš„Â `cycle.js`Â è„šæœ¬ï¼Œç„¶åÂ `JSON.stringify(JSON.decycle(foo))`Â å°± OK äº†ã€‚ä½†ç©¶å…¶æ ¹æœ¬ï¼Œå®ƒä½¿ç”¨äº† [WeakMap](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/WeakMap) å»å¤„ç†ã€‚

é‚£æˆ‘ä»¬å»å®ç°ä¸€ä¸‹ï¼š

```js
const deepCopy = source => {
  // åˆ›å»ºä¸€ä¸ª WeakMap å¯¹è±¡ï¼Œè®°å½•å·²æ‹·è´è¿‡çš„å¯¹è±¡ï¼ˆæœ¬æ¬¡æ–°å¢ï¼‰
  const weakmap = new WeakMap()

  // ä¸­é—´è¿™å—ä¸å˜ï¼Œçœç•¥ä¸€ä¸‡å­—...

  // æ‹·è´ï¼ˆé€’å½’æ€è·¯ï¼‰
  const copy = input => {
    if (typeof input === 'function' || !isObject(input)) return input

    // é’ˆå¯¹å·²æ‹·è´è¿‡çš„å¯¹è±¡ï¼Œç›´æ¥è¿”å›ï¼ˆæœ¬æ¬¡æ–°å¢ï¼Œä»¥è§£å†³å¾ªç¯å¼•ç”¨çš„é—®é¢˜ï¼‰
    if (weakmap.has(input)) {
      return weakmap.get(input)
    }

    // å¤„ç†åŒ…è£…å¯¹è±¡
    if (isWrapperObject(input)) {
      return handleWrapperObject(input)
    }

    const output = isArray(input) ? [] : {}

    // è®°å½•æ¯æ¬¡æ‹·è´çš„å¯¹è±¡
    weakmap.set(input, output)

    for (let key in input) {
      if (input.hasOwnProperty(key)) {
        const value = input[key]
        output[key] = copy(value)
      }
    }

    // å¤„ç†ä»¥ Symbol å€¼ä½œä¸ºå±æ€§é”®çš„å±æ€§
    const symbolArr = Object.getOwnPropertySymbols(input)
    if (symbolArr.length) {
      for (let i = 0, len = symbolArr.length; i < len; i++) {
        if (input.propertyIsEnumerable(symbolArr[i])) {
          output[symbolArr[i]] = input[symbolArr[i]]
        }
      }
    }

    return output
  }

  return copy(source)
}
```

å…ˆçœ‹çœ‹æ‰“å°ç»“æœï¼Œä¸ä¼šåƒä¹‹å‰ä¸€æ ·æº¢å‡ºäº†ã€‚

![](https://upload-images.jianshu.io/upload_images/5128488-abeca5a06a104739.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)


éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œä¸ä½¿ç”¨ [Map](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Map) è€Œæ˜¯ [WeakMap](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/WeakMap) çš„åŸå› ï¼š

é¦–å…ˆï¼ŒMap çš„é”®å±äºå¼ºå¼•ç”¨ï¼Œè€Œ WeakMap çš„é”®åˆ™å±äºå¼±å¼•ç”¨ã€‚ä¸” WeakMap çš„é”®å¿…é¡»æ˜¯å¯¹è±¡ï¼ŒWeakMap çš„å€¼åˆ™æ˜¯ä»»æ„çš„ã€‚

ç”±äºå®ƒä»¬çš„é”®ä¸å€¼çš„å¼•ç”¨å…³ç³»ï¼Œå†³å®šäº† Map ä¸èƒ½ç¡®ä¿å…¶å¼•ç”¨çš„å¯¹è±¡ä¸ä¼šè¢«åƒåœ¾å›æ”¶å™¨å›æ”¶çš„å¼•ç”¨ã€‚å‡è®¾æˆ‘ä»¬ä½¿ç”¨çš„ Mapï¼Œé‚£ä¹ˆå›¾ä¸­çš„ `foo` å¯¹è±¡å’Œæˆ‘ä»¬æ·±æ‹·è´å†…éƒ¨çš„ `const map = new Map()` åˆ›å»ºçš„ `map` å¯¹è±¡ä¸€ç›´éƒ½æ˜¯å¼ºå¼•ç”¨å…³ç³»ï¼Œé‚£ä¹ˆåœ¨ç¨‹åºç»“æŸä¹‹å‰ï¼Œ`foo` ä¸ä¼šè¢«å›æ”¶ï¼Œå…¶å ç”¨çš„å†…å­˜ç©ºé—´ä¸€ç›´ä¸ä¼šè¢«é‡Šæ”¾ã€‚

ç›¸æ¯”ä¹‹ä¸‹ï¼ŒåŸç”Ÿçš„ WeakMap æŒæœ‰çš„æ˜¯æ¯ä¸ªé”®å¯¹è±¡çš„â€œå¼±å¼•ç”¨â€ï¼Œè¿™æ„å‘³ç€åœ¨æ²¡æœ‰å…¶ä»–å¼•ç”¨å­˜åœ¨æ—¶åƒåœ¾å›æ”¶èƒ½æ­£ç¡®è¿›è¡Œã€‚åŸç”Ÿ WeakMap çš„ç»“æ„æ˜¯ç‰¹æ®Šä¸”æœ‰æ•ˆçš„ï¼Œå…¶ç”¨äºæ˜ å°„çš„ key åªæœ‰åœ¨å…¶æ²¡æœ‰è¢«å›æ”¶æ—¶æ‰æ˜¯æœ‰æ•ˆçš„ã€‚

åŸºæœ¬ä¸Šï¼Œå¦‚æœä½ è¦å¾€å¯¹è±¡ä¸Šæ·»åŠ æ•°æ®ï¼Œåˆä¸æƒ³å¹²æ‰°åƒåœ¾å›æ”¶æœºåˆ¶ï¼Œå°±å¯ä»¥ä½¿ç”¨ WeakMapã€‚

> å¯çœ‹ [Why WeakMap?](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/WeakMap#why_weakmap)

æˆ‘ä»¬ç†ŸçŸ¥çš„ Lodash åº“çš„æ·±æ‹·è´æ–¹æ³•ï¼Œè‡ªå®ç°äº†ä¸€ä¸ªç±»ä¼¼ WeakMap ç‰¹æ€§çš„æ„é€ å‡½æ•°å»å¤„ç†å¾ªç¯å¼•ç”¨çš„ã€‚ï¼ˆ[è¯¦çœ‹](https://github.com/lodash/lodash/blob/master/.internal/baseClone.js#L199-L205)ï¼‰

è¿™é‡Œæä¾›å¦ä¸€ä¸ªæ€è·¯ï¼Œä¹Ÿæ˜¯å¯ä»¥çš„ã€‚

```js
const deepCopy = source => {
  // å…¶ä»–ä¸€æ ·ï¼Œçœç•¥ä¸€ä¸‡å­—...

  // åˆ›å»ºä¸€ä¸ªæ•°ç»„ï¼Œå°†æ¯æ¬¡æ‹·è´çš„å¯¹è±¡æ”¾è¿›å»
  const copiedArr = []

  // æ‹·è´ï¼ˆé€’å½’æ€è·¯ï¼‰
  const copy = input => {
    if (typeof input === 'function' || !isObject(input)) return input

    // å¾ªç¯éå†ï¼Œè‹¥æœ‰å·²æ‹·è´è¿‡çš„å¯¹è±¡ï¼Œåˆ™ç›´æ¥æ”¾å›ï¼Œä»¥è§£å†³å¾ªç¯å¼•ç”¨çš„é—®é¢˜
    for (let i = 0, len = copiedArr.length; i < len; i++) {
      if (input === copiedArr[i].key) return copiedArr[i].value
    }

    // å¤„ç†åŒ…è£…å¯¹è±¡
    if (isWrapperObject(input)) {
      return handleWrapperObject(input)
    }

    const output = isArray(input) ? [] : {}

    // è®°å½•æ¯ä¸€æ¬¡çš„å¯¹è±¡
    copiedArr.push({ key: input, value: output })

    // åé¢çš„æµç¨‹ä¸å˜...
  }

  return copy(source)
}
```

> æ­¤å‰å®ç°æœ‰ä¸ª bugï¼Œæ„Ÿè°¢è™¾è™¾ç±³æŒ‡å‡ºï¼Œç°å·²æ›´æ­£ã€‚

è¯·åœ¨å®ç°æ·±æ‹·è´ä¹‹åæµ‹è¯•ä»¥ä¸‹ç¤ºä¾‹ï¼š

```js
const foo = { name: 'Frankie' }
foo.bar = foo

const cloneObj = deepCopy(foo) // è‡ªå®ç°æ·±æ‹·è´
const lodashObj = _.cloneDeep(foo) // Lodash æ·±æ‹·è´

// æ‰“å°ç»“æœå¦‚ä¸‹ï¼Œè¯´æ˜æ˜¯æ­£ç¡®çš„
console.log(lodashObj.bar === lodashObj) // true
console.log(lodashObj.bar === foo) // false
console.log(cloneObj.bar === cloneObj) // true
console.log(cloneObj.bar === foo) // false
```

##### 3.7 é’ˆå¯¹æ­£åˆ™è¡¨è¾¾å¼çš„å¤„ç†

æ­£åˆ™è¡¨è¾¾å¼é‡Œé¢ï¼Œæœ‰ä¸¤ä¸ªéå¸¸é‡è¦çš„å±æ€§ï¼š

* [RegExp.prototype.source](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/RegExp/source) 
  è¿”å›å½“å‰æ­£åˆ™è¡¨è¾¾å¼å¯¹è±¡çš„æ¨¡å¼æ–‡æœ¬çš„å­—ç¬¦ä¸²ã€‚æ³¨æ„ï¼Œè¿™æ˜¯ ES6 æ–°å¢çš„å±æ€§ã€‚
* [RegExp.prototype.flags](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/RegExp/flags) 
  è¿”å›å½“å‰æ­£åˆ™è¡¨è¾¾å¼å¯¹è±¡æ ‡å¿—ã€‚

```js
const { source, flags } = /\d/g
console.log(source) // "\\d"
console.log(flags) // "g"
```

æœ‰äº†ä»¥ä¸Šä¸¤ä¸ªå±æ€§ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨ `new RegExp(pattern, flags)` æ„é€ å‡½æ•°å»åˆ›å»ºä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼äº†ã€‚

```js
const { source, flags } = /\d/g
const newRegex = new RegExp(source, flags) // /\d/g
```

ä½†éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ­£åˆ™è¡¨è¾¾å¼æœ‰ä¸€ä¸ª [`lastIndex`](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/RegExp/lastIndex) å±æ€§ï¼Œè¯¥å±æ€§å¯è¯»å¯å†™ï¼Œå…¶å€¼ä¸ºæ•´å‹ï¼Œç”¨æ¥æŒ‡å®šä¸‹ä¸€æ¬¡åŒ¹é…çš„èµ·å§‹ç´¢å¼•ã€‚åœ¨è®¾ç½®äº†Â [`global`](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/RegExp/global)Â æˆ–Â [`sticky`](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/RegExp/sticky)Â æ ‡å¿—ä½çš„æƒ…å†µä¸‹ï¼ˆå¦‚Â `/foo/g`ã€`/foo/y`ï¼‰ï¼ŒJavaScriptÂ [`RegExp`](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/RegExp)Â å¯¹è±¡æ˜¯**æœ‰çŠ¶æ€**çš„ã€‚ä»–ä»¬ä¼šå°†ä¸Šæ¬¡æˆåŠŸåŒ¹é…åçš„ä½ç½®è®°å½•åœ¨Â `lastIndex`Â å±æ€§ä¸­ã€‚


å› æ­¤ï¼Œä¸Šè¿°æ‹·è´æ­£åˆ™è¡¨è¾¾å¼çš„æ–¹å¼æ˜¯æœ‰ç¼ºé™·çš„ã€‚çœ‹ç¤ºä¾‹ï¼š

```js
const re1 = /foo*/g
const str = 'table football, foosball'
let arr

while ((arr = re1.exec(str)) !== null) {
  console.log(`Found ${arr[0]}. Next starts at ${re1.lastIndex}.`)
}

// ä»¥ä¸Šè¯­å¥ä¼šè¾“å‡ºï¼Œä»¥ä¸‹ç»“æœï¼š
// "Found foo. Next starts at 9."
// "Found foo. Next starts at 19."


// å½“æˆ‘ä»¬ä¿®æ”¹ re1 çš„ lastIndex å±æ€§æ—¶ï¼Œè¾“å‡ºä»¥ä¸‹ç»“æœï¼š
re1.lastIndex = 9
while ((arr = re1.exec(str)) !== null) {
  console.log(`Found ${arr[0]}. Next starts at ${re1.lastIndex}.`)
}
// "Found foo. Next starts at 19."

// ä»¥ä¸Šè¿™äº›ç›¸ä¿¡ä½ ä»¬éƒ½éƒ½æ‡‚ã€‚
```

æ‰€ä»¥ï¼Œä½ å¯ä»¥å‘ç°ä»¥ä¸‹ç¤ºä¾‹ï¼Œæ‰“å°ç»“æœæ˜¯ä¸ä¸€è‡´çš„ï¼ŒåŸå› å°±æ˜¯ä½¿ç”¨ `RegExp` æ„é€ å‡½æ•°å»åˆ›å»ºä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼æ—¶ï¼Œ`lastIndex` ä¼šé»˜è®¤è®¾ä¸º `0`ã€‚

```js
const re1 = /foo*/g
const str = 'table football, foosball'
let arr

// ä¿®æ”¹ lastIndex å±æ€§
re1.lastIndex = 9

// åŸºäº re1 æ‹·è´ä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼
const re2 = new RegExp(re1.source, re1.flags)

console.log('re1:')
while ((arr = re1.exec(str)) !== null) {
  console.log(`Found ${arr[0]}. Next starts at ${re1.lastIndex}.`)
}

console.log('re2:')
while ((arr = re2.exec(str)) !== null) {
  console.log(`Found ${arr[0]}. Next starts at ${re2.lastIndex}.`)
}

// re1:
// expected output: "Found foo. Next starts at 19."
// re2:
// expected output: "Found foo. Next starts at 9."
// expected output: "Found foo. Next starts at 19."
```

å› æ­¤ï¼š

```js
const deepCopy = source => {
  // å…¶ä»–ä¸å˜ï¼Œçœç•¥...

  // å¤„ç†æ­£åˆ™è¡¨è¾¾å¼
  const handleRegExp = regex => {
    const { source, flags, lastIndex } = regex
    const re = new RegExp(source, flags)
    re.lastIndex = lastIndex
    return re
  }

  // æ‹·è´ï¼ˆé€’å½’æ€è·¯ï¼‰
  const copy = input => {
    if (typeof input === 'function' || !isObject(input)) return input

    // æ­£åˆ™è¡¨è¾¾å¼
    if (getClass(input) === '[object RegExp]') {
      return handleRegExp(input)
    }

    // åé¢ä¸å˜ï¼Œçœç•¥...
  }

  return copy(source)
}
```

æ‰“å°ç»“æœä¹Ÿæ˜¯ç¬¦åˆé¢„æœŸçš„ï¼š

![](https://upload-images.jianshu.io/upload_images/5128488-86b589529c2c4222.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

ç”±äº `RegExp.prototype.flags` æ˜¯ ES6 æ–°å¢å±æ€§ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹ä¸‹ ES5 æ˜¯å¦‚ä½•å®ç°çš„ï¼ˆæºè‡ª Lodashï¼‰ï¼š

```js
/** Used to match `RegExp` flags from their coerced string values. */
var reFlags = /\w*$/;

/**
 * Creates a clone of `regexp`.
 *
 * @private
 * @param {Object} regexp The regexp to clone.
 * @returns {Object} Returns the cloned regexp.
 */
function cloneRegExp(regexp) {
  var result = new regexp.constructor(regexp.source, reFlags.exec(regexp));
  result.lastIndex = regexp.lastIndex;
  return result;
}
```

ä½†è¿˜æ˜¯é‚£å¥è¯ï¼Œéƒ½ 2021 å¹´äº†ï¼Œå…¼å®¹ ES5 çš„é—®é¢˜å°±æ”¾å¿ƒäº¤ç»™ Babel å§ã€‚

##### 3.8 å¤„ç†åŸå‹

> æ³¨æ„ï¼Œè¿™é‡Œåªå®ç°ç±»å‹ä¸º `"[object Object]"` çš„å¯¹è±¡çš„åŸå‹æ‹·è´ã€‚ä¾‹å¦‚æ•°ç»„ç­‰ä¸å¤„ç†ï¼Œå› ä¸ºè¿™äº›æƒ…å†µå®é™…åœºæ™¯å¤ªå°‘äº†ã€‚

ä¸»è¦æ˜¯ä¿®æ”¹ä»¥ä¸‹è¿™ä¸€æ­¥éª¤ï¼š

```js
const output = isArray(input) ? [] : {}
```

ä¸»è¦åˆ©ç”¨ [`Object.create()`](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/create) æ¥åˆ›å»º `output` å¯¹è±¡ï¼Œæ”¹æˆè¿™æ ·ï¼š

```js
const initCloneObject = obj => {
  // å¤„ç†åŸºäº Object.create(null) æˆ– Object.create(Object.prototype.__proto__) çš„å®ä¾‹å¯¹è±¡
  // å…¶ä¸­ Object.prototype.__proto__ å°±æ˜¯ç«™åœ¨åŸå‹é¡¶ç«¯çš„ç”·äºº
  // ä½†æˆ‘ç•™æ„åˆ° Lodash åº“çš„ clone æ–¹æ³•å¯¹ä»¥ä¸Šä¸¤ç§æƒ…å†µæ˜¯ä¸å¤„ç†çš„
  if (obj.constructor === undefined) {
    return Object.create(null)
  }

  // å¤„ç†è‡ªå®šä¹‰æ„é€ å‡½æ•°çš„å®ä¾‹å¯¹è±¡
  if (typeof obj.constructor === 'function' && (obj !== obj.constructor || obj !== Object.prototype)) {
    const proto = Object.getPrototypeOf(obj)
    return Object.create(proto)
  }

  return {}
}

const output = isArray(input) ? [] : initCloneObject(input)
```

æ¥çœ‹ä¸‹æ‰“å°ç»“æœï¼Œå¯ä»¥çœ‹åˆ° `source` çš„åŸå‹å¯¹è±¡å·²ç»æ‹·è´è¿‡æ¥äº†ï¼š

![](https://upload-images.jianshu.io/upload_images/5128488-4734d18bf71b9eba.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

å†æ¥çœ‹ä¸‹ `Object.create(null)` çš„æƒ…å†µï¼Œä¹Ÿæ˜¯é¢„æœŸç»“æœã€‚
 
![](https://upload-images.jianshu.io/upload_images/5128488-22809d763baeb9e1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

æˆ‘ä»¬å¯ä»¥çœ‹åˆ° Lodash çš„ `_.cloneDeep(Object.create(null))` æ·±æ‹·è´æ–¹æ³•å¹¶æ²¡æœ‰å¤„ç†è¿™ç§æƒ…å†µã€‚å½“ç„¶äº†ï¼Œè¦æ‹·è´è¿™ç§æ•°æ®ç»“æ„åœ¨å®é™…åº”ç”¨åœºæ™¯ï¼ŒçœŸçš„å°‘ä¹‹åˆå°‘...

![](https://upload-images.jianshu.io/upload_images/5128488-ec6032b7655ee73e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

> å…³äº Lodash æ‹·è´æ–¹æ³•ä¸ºä»€ä¹ˆä¸å®ç°è¿™ç§æƒ…å†µï¼Œæˆ‘æ‰¾åˆ°äº†ä¸€ä¸ªç›¸å…³çš„ [Issue #588](https://github.com/lodash/lodash/issues/588)ï¼š
>
> A shallow clone won't do that as it's just `_.assign({}, object)` and a deep clone is loosely based on the structured cloning algorithm and doesn't attempt to clone inheritance or lack thereof.

### å››ã€ä¼˜åŒ–

ç»¼ä¸Šæ‰€è¿°ï¼Œå®Œæ•´ä½†**æœªä¼˜åŒ–**çš„æ·±æ‹·è´æ–¹æ³•å¦‚ä¸‹ï¼š

```js
const deepCopy = source => {
  // åˆ›å»ºä¸€ä¸ª WeakMap å¯¹è±¡ï¼Œè®°å½•å·²æ‹·è´è¿‡çš„å¯¹è±¡
  const weakmap = new WeakMap()

  // è·å–æ•°æ®ç±»å‹
  const getClass = x => Object.prototype.toString.call(x)

  // åˆ¤æ–­æ˜¯å¦ä¸ºæ•°ç»„
  const isArray = arr => getClass(arr) === '[object Array]'

  // åˆ¤æ–­æ˜¯å¦ä¸ºå¼•ç”¨ç±»å‹
  const isObject = obj => obj !== null && (typeof obj === 'object' || typeof obj === 'function')

  // åˆ¤æ–­æ˜¯å¦ä¸ºåŒ…è£…å¯¹è±¡
  const isWrapperObject = obj => {
    const theClass = getClass(obj)
    const type = /^\[object (.*)\]$/.exec(theClass)[1]
    return ['Boolean', 'Number', 'String', 'Symbol', 'BigInt', 'Date', 'Map', 'Set'].includes(type)
  }

  // å¤„ç†åŒ…è£…å¯¹è±¡
  const handleWrapperObject = obj => {
    const type = getClass(obj)
    switch (type) {
      case '[object Boolean]':
        return Object(Boolean.prototype.valueOf.call(obj))
      case '[object Number]':
        return Object(Number.prototype.valueOf.call(obj))
      case '[object String]':
        return Object(String.prototype.valueOf.call(obj))
      case '[object Symbol]':
        return Object(Symbol.prototype.valueOf.call(obj))
      case '[object BigInt]':
        return Object(BigInt.prototype.valueOf.call(obj))
      case '[object Date]':
        return new Date(obj.valueOf()) // new Date(+obj)
      case '[object Map]': {
        const map = new Map()
        obj.forEach((item, key) => {
          map.set(key, copy(item))
        })
        return map
      }
      case '[object Set]': {
        const set = new Set()
        obj.forEach(item => {
          set.add(copy(item))
        })
        return set
      }
      default:
        return undefined
    }
  }

  // å¤„ç†æ­£åˆ™è¡¨è¾¾å¼
  const handleRegExp = regex => {
    const { source, flags, lastIndex } = regex
    const re = new RegExp(source, flags)
    re.lastIndex = lastIndex
    return re
  }

  const initCloneObject = obj => {
    if (obj.constructor === undefined) {
      return Object.create(null)
    }

    if (typeof obj.constructor === 'function' && (obj !== obj.constructor || obj !== Object.prototype)) {
      const proto = Object.getPrototypeOf(obj)
      return Object.create(proto)
    }

    return {}
  }

  // æ‹·è´ï¼ˆé€’å½’æ€è·¯ï¼‰
  const copy = input => {
    if (typeof input === 'function' || !isObject(input)) return input

    // æ­£åˆ™è¡¨è¾¾å¼
    if (getClass(input) === '[object RegExp]') {
      return handleRegExp(input)
    }

    // é’ˆå¯¹å·²æ‹·è´è¿‡çš„å¯¹è±¡ï¼Œç›´æ¥è¿”å›ï¼ˆè§£å†³å¾ªç¯å¼•ç”¨çš„é—®é¢˜ï¼‰
    if (weakmap.has(input)) {
      return weakmap.get(input)
    }

    // å¤„ç†åŒ…è£…å¯¹è±¡
    if (isWrapperObject(input)) {
      return handleWrapperObject(input)
    }

    const output = isArray(input) ? [] : initCloneObject(input)

    // è®°å½•æ¯æ¬¡æ‹·è´çš„å¯¹è±¡
    weakmap.set(input, output)

    for (let key in input) {
      if (input.hasOwnProperty(key)) {
        const value = input[key]
        output[key] = copy(value)
      }
    }

    // å¤„ç†ä»¥ Symbol å€¼ä½œä¸ºå±æ€§é”®çš„å±æ€§
    const symbolArr = Object.getOwnPropertySymbols(input)
    if (symbolArr.length) {
      for (let i = 0, len = symbolArr.length; i < len; i++) {
        if (input.propertyIsEnumerable(symbolArr[i])) {
          const value = input[symbolArr[i]]
          output[symbolArr[i]] = copy(value)
        }
      }
    }

    return output
  }

  return copy(source)
}
```

æ¥ä¸‹æ¥å°±æ˜¯ä¼˜åŒ–å·¥ä½œäº†...

##### 4.1 ä¼˜åŒ–ä¸€

æˆ‘ä»¬ä¸Šé¢ä½¿ç”¨åˆ°äº† `for...in` å’Œ `Object.getOwnPropertySymbols()` æ–¹æ³•å»éå†å¯¹è±¡çš„å±æ€§ï¼ˆåŒ…æ‹¬å­—ç¬¦ä¸²å±æ€§å’Œ Symbol å±æ€§ï¼‰ï¼Œè¿˜æ¶‰åŠäº†å¯æšä¸¾å±æ€§å’Œä¸å¯æšä¸¾å±æ€§ã€‚

* [**for...in**]()ï¼šéå†**è‡ªèº«**å’Œ**ç»§æ‰¿è¿‡æ¥**çš„**å¯æšä¸¾**å±æ€§ï¼ˆä¸åŒ…æ‹¬ Symbol å±æ€§ï¼‰ã€‚
* [**Object.keys**](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/keys)ï¼šè¿”å›ä¸€ä¸ªæ•°ç»„ï¼ŒåŒ…å«**å¯¹è±¡è‡ªèº«**æ‰€æœ‰**å¯æšä¸¾**å±æ€§ï¼ˆä¸åŒ…æ‹¬ä¸å¯æšä¸¾å±æ€§å’Œ Symbol å±æ€§ï¼‰
* [**Object.getOwnPropertyNames**](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/getOwnPropertyNames)ï¼šè¿”å›ä¸€ä¸ªæ•°ç»„ï¼ŒåŒ…å«**å¯¹è±¡è‡ªèº«**çš„å±æ€§ï¼ˆåŒ…æ‹¬ä¸å¯æšä¸¾å±æ€§ï¼Œä½†ä¸åŒ…æ‹¬ Symbol å±æ€§ï¼‰
* [**Object.getOwnPropertySymbols**](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/getOwnPropertySymbols)ï¼šè¿”å›ä¸€ä¸ªæ•°ç»„ï¼ŒåŒ…å«**å¯¹è±¡è‡ªèº«**çš„æ‰€æœ‰ Symbol å±æ€§ï¼ˆåŒ…æ‹¬å¯æšä¸¾å’Œä¸å¯æšä¸¾å±æ€§ï¼‰
* [**Reflect.ownKeys**](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Reflect/ownKeys)ï¼šè¿”å›ä¸€ä¸ªæ•°ç»„ï¼ŒåŒ…å«**è‡ªèº«æ‰€æœ‰**çš„å±æ€§ï¼ˆåŒ…æ‹¬ Symbol å±æ€§ï¼Œä¸å¯æšä¸¾å±æ€§ä»¥åŠå¯æšä¸¾å±æ€§ï¼‰

> ç”±äºæˆ‘ä»¬ä»…æ‹·è´å¯æšä¸¾çš„å­—ç¬¦ä¸²å±æ€§å’Œå¯æšä¸¾çš„ Symbol å±æ€§ï¼Œå› æ­¤æˆ‘ä»¬å°† `Reflect.ownKeys()` å’Œ `Object.prototype.propertyIsEnumerable()` ç»“åˆä½¿ç”¨å³å¯ã€‚

æ‰€ä»¥ï¼Œæˆ‘ä»¬å°†ä»¥ä¸‹è¿™éƒ¨åˆ†ï¼š

```js
for (let key in input) {
  if (input.hasOwnProperty(key)) {
    const value = input[key]
    output[key] = copy(value)
  }
}

// å¤„ç†ä»¥ Symbol å€¼ä½œä¸ºå±æ€§é”®çš„å±æ€§
const symbolArr = Object.getOwnPropertySymbols(input)
if (symbolArr.length) {
  for (let i = 0, len = symbolArr.length; i < len; i++) {
    if (input.propertyIsEnumerable(symbolArr[i])) {
      const value = input[symbolArr[i]]
      output[symbolArr[i]] = copy(value)
    }
  }
}
```

ä¼˜åŒ–æˆï¼š

```js
// ä»…éå†å¯¹è±¡è‡ªèº«å¯æšä¸¾çš„å±æ€§ï¼ˆåŒ…æ‹¬å­—ç¬¦ä¸²å±æ€§å’Œ Symbol å±æ€§ï¼‰
Reflect.ownKeys(input).forEach(key => {
  if (input.propertyIsEnumerable(key)) {
    output[key] = copy(input[key])
  }
})
```

##### 4.2 ä¼˜åŒ–äºŒ

ä¼˜åŒ– `getClass()`ã€`isWrapperObject()`ã€`handleWrapperObject()`ã€`handleRegExp()` åŠå…¶ç›¸å…³çš„ç±»å‹åˆ¤æ–­æ–¹æ³•ã€‚

ç”±äº `handleWrapperObject()` åŸæ„æ˜¯å¤„ç†åŒ…è£…å¯¹è±¡ï¼Œä½†æ˜¯éšç€åé¢è¦å¤„ç†çš„ç‰¹æ®Šå¯¹è±¡è¶Šæ¥è¶Šå¤šï¼Œä¸ºäº†å‡å°‘æ–‡ç« ç¯‡å¹…ï¼Œæš‚æ—¶éƒ½å†™åœ¨é‡Œé¢äº†ï¼Œç¨å¾®æœ‰ç‚¹ä¹±ã€‚

å› æ­¤ä¸‹é¢æˆ‘ä»¬æ¥æ•´åˆä¸€ä¸‹ï¼Œéƒ¨åˆ†å¤„ç†å‡½æ•°å¯èƒ½ä¼šä¿®æ”¹å‡½æ•°åã€‚

### äº”ã€æœ€ç»ˆ

å…¶å®ï¼Œä¸Šé¢æåˆ°çš„ä¸€äº›è¾¹ç•Œ Caseã€æˆ–è€…å…¶ä»–ä¸€äº›ç‰¹æ®Šå¯¹è±¡ï¼ˆå¦‚ `ArrayBuffer` ç­‰ï¼‰ï¼Œè¿™é‡Œå¹¶æ²¡æœ‰å¤„ç†ï¼Œä½†æˆ‘è®¤ä¸ºè¯¥å®Œç»“äº†ï¼Œå› ä¸ºè¿™äº›åœ¨å®é™…åº”ç”¨åœºæ™¯çœŸçš„å¤ªå°‘äº†ã€‚

ä»£ç å·²ä¸¢åˆ° GitHub ğŸ‘‰ [toFrankie/Some-JavaScript-File](https://github.com/toFrankie/Some-JavaScript-File)ã€‚

è¿˜æ˜¯é‚£å¥è¯ï¼š

> **å¦‚æœç”Ÿäº§ç¯å¢ƒä½¿ç”¨ `JSON.stringify()` æ— æ³•è§£å†³ä½ çš„éœ€æ±‚ï¼Œè¯·ä½¿ç”¨ [Lodash](https://www.lodashjs.com/) åº“çš„ [`_.cloneDeep()`](https://www.lodashjs.com/docs/lodash.cloneDeep) æ–¹æ³•ï¼Œé‚£ä¸ªæ‰å«é¢é¢ä¿±åˆ°ã€‚åƒä¸‡åˆ«ç”¨æˆ‘è¿™æ–¹æ³•ï¼Œåˆ‡è®°ï¼**

è¿™ç¯‡æ–‡ç« ä¸»è¦é¢å‘å­¦ä¹ ã€é¢è¯•ï¼ˆæ‰‹åŠ¨ç‹—å¤´ï¼‰ï¼Œæˆ–è®¸ä¹Ÿå¯ä»¥å¸®åŠ©ä½ ç†Ÿæ‚‰ä¸€äº›å¯¹è±¡çš„ç‰¹æ€§ã€‚å¦‚æœ‰ä¸è¶³ï¼Œæ¬¢è¿æŒ‡å‡ºï¼Œä¸‡åˆ†æ„Ÿè°¢ ğŸ‘‹ ~

ç»ˆäºç»ˆäºç»ˆäº......è¦å†™å®Œäº†ï¼Œåäº†ä¸‰æ–¤è¡€...

æœ€ç»ˆç‰ˆæœ¬å¦‚ä¸‹ï¼š

```js
const deepCopy = source => {
  // åˆ›å»ºä¸€ä¸ª WeakMap å¯¹è±¡ï¼Œè®°å½•å·²æ‹·è´è¿‡çš„å¯¹è±¡
  const weakmap = new WeakMap()

  // è·å–æ•°æ®ç±»å‹ï¼Œè¿”å›å€¼å¦‚ï¼š"Object"ã€"Array"ã€"Symbol" ç­‰
  const getClass = x => {
    const type = Object.prototype.toString.call(x)
    return /^\[object (.*)\]$/.exec(type)[1]
  }

  // åˆ¤æ–­æ˜¯å¦ä¸ºæ•°ç»„
  const isArray = arr => getClass(arr) === 'Array'

  // åˆ¤æ–­æ˜¯å¦ä¸ºå¼•ç”¨ç±»å‹
  const isObject = obj => obj !== null && (typeof obj === 'object' || typeof obj === 'function')

  // åˆ¤æ–­æ˜¯å¦ä¸ºâ€œç‰¹æ®Šâ€å¯¹è±¡ï¼ˆéœ€è¦ç‰¹æ®Šå¤„ç†ï¼‰
  const isSepcialObject = obj => {
    const type = getClass(obj)
    return ['Boolean', 'Number', 'String', 'Symbol', 'BigInt', 'Date', 'Map', 'Set', 'RegExp'].includes(type)
  }

  // å¤„ç†ç‰¹æ®Šå¯¹è±¡
  const handleSepcialObject = obj => {
    const type = getClass(obj)
    const Ctor = obj.constructor // å¯¹è±¡çš„æ„é€ å‡½æ•°
    const primitiveValue = obj.valueOf() // è·å–å¯¹è±¡çš„åŸå§‹å€¼

    switch (type) {
      case 'Boolean':
      case 'Number':
      case 'String':
      case 'Symbol':
      case 'BigInt':
        // å¤„ç†åŒ…è£…å¯¹è±¡ Wrapper Object
        return Object(primitiveValue)
      case 'Date':
        return new Ctor(primitiveValue) // new Date(+obj)
      case 'RegExp': {
        const { source, flags, lastIndex } = obj
        const re = new RegExp(source, flags)
        re.lastIndex = lastIndex
        return re
      }
      case 'Map': {
        const map = new Ctor()
        obj.forEach((item, key) => {
          // æ³¨æ„ï¼Œå³ä½¿ Map å¯¹è±¡çš„ key ä¸ºå¼•ç”¨ç±»å‹ï¼Œè¿™é‡Œä¹Ÿä¸èƒ½ copy(key)ï¼Œå¦åˆ™ä¼šå¤±å»å¼•ç”¨ï¼Œå¯¼è‡´è¯¥å±æ€§æ— æ³•è®¿é—®å¾—åˆ°ã€‚
          map.set(key, copy(item))
        })
        return map
      }
      case 'Set': {
        const set = new Ctor()
        obj.forEach(item => {
          set.add(copy(item))
        })
        return set
      }
      default:
        return undefined
    }
  }

  // åˆ›å»ºè¾“å‡ºå¯¹è±¡ï¼ˆåŸå‹æ‹·è´å…³é”®å°±åœ¨è¿™ä¸€æ­¥ï¼‰
  const initCloneObject = obj => {
    if (obj.constructor === undefined) {
      return Object.create(null)
    }

    if (typeof obj.constructor === 'function' && (obj !== obj.constructor || obj !== Object.prototype)) {
      const proto = Object.getPrototypeOf(obj)
      return Object.create(proto)
    }

    return {}
  }

  // æ‹·è´æ–¹æ³•ï¼ˆé€’å½’æ€è·¯ï¼‰
  const copy = input => {
    if (typeof input === 'function' || !isObject(input)) return input

    // é’ˆå¯¹å·²æ‹·è´è¿‡çš„å¯¹è±¡ï¼Œç›´æ¥è¿”å›ï¼ˆè§£å†³å¾ªç¯å¼•ç”¨çš„é—®é¢˜ï¼‰
    if (weakmap.has(input)) {
      return weakmap.get(input)
    }

    // å¤„ç†åŒ…è£…å¯¹è±¡
    if (isSepcialObject(input)) {
      return handleSepcialObject(input)
    }

    // åˆ›å»ºè¾“å‡ºå¯¹è±¡
    const output = isArray(input) ? [] : initCloneObject(input)

    // è®°å½•æ¯æ¬¡æ‹·è´çš„å¯¹è±¡
    weakmap.set(input, output)

    // ä»…éå†å¯¹è±¡è‡ªèº«å¯æšä¸¾çš„å±æ€§ï¼ˆåŒ…æ‹¬å­—ç¬¦ä¸²å±æ€§å’Œ Symbol å±æ€§ï¼‰
    Reflect.ownKeys(input).forEach(key => {
      if (input.propertyIsEnumerable(key)) {
        output[key] = copy(input[key])
      }
    })

    return output
  }

  return copy(source)
}
```

### å…­ã€å‚è€ƒ

* [GitHub/lodash](https://github.com/lodash/lodash/blob/2f79053d7bc7c9c9561a30dda202b3dcd2b72b90/cloneDeep.js)
* [åŸç”Ÿ JS çµé­‚ä¹‹é—®(ä¸­)ï¼Œæ£€éªŒè‡ªå·±æ˜¯å¦çœŸçš„ç†Ÿæ‚‰ JavaScriptï¼Ÿ](https://juejin.cn/post/6844903986479251464)

The end.
