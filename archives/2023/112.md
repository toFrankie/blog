---
title: React æºç ä¹‹ createElement() è§£è¯»
number: '#112'
link: 'https://github.com/toFrankie/blog/issues/112'
created_at: '2023-02-25 21:01:01'
updated_at: '2023-04-26 22:10:05'
labels:
  - React
  - '2021'
---
![é…å›¾æºè‡ª Freepik](https://upload-images.jianshu.io/upload_images/5128488-704c65a797b0edaf.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)


ä»Šå¤©ä¸€èµ·æ¥çœ‹ä¸‹ `React.createElement()` æ–¹æ³•

### React.createElement

> ğŸ‘‰ [ä¸­æ–‡](https://zh-hans.reactjs.org/docs/react-api.html#createelement) or [è‹±æ–‡](https://reactjs.org/docs/react-api.html#createelement)æ–‡æ¡£

React ä¸å¼ºåˆ¶è¦æ±‚ä½¿ç”¨ JSXï¼Œæ¯ä¸ª JSX å…ƒç´ åªæ˜¯è°ƒç”¨ `React.createElement(type, [props], [...children])` çš„è¯­æ³•ç³–ã€‚å› æ­¤ï¼Œä½¿ç”¨ JSX å¯ä»¥å®Œæˆçš„ä»»ä½•äº‹æƒ…éƒ½å¯ä»¥é€šè¿‡çº¯ JavaScript å®Œæˆã€‚

è¯­æ³•ï¼š
```js
React.createElement(
  type,
  [props],
  [...children]
)
```

* `type` å¯ä»¥æ˜¯æ ‡ç­¾åå­—ç¬¦ä¸²ï¼ˆå¦‚ div æˆ– span ç­‰ï¼‰ï¼Œä¹Ÿå¯ä»¥æ˜¯ React ç»„ä»¶ç±»å‹ï¼ˆclass ç»„ä»¶æˆ–å‡½æ•°ç»„ä»¶ï¼‰ï¼Œæˆ–è€…æ˜¯ React fragment ç±»å‹ã€‚

* `props` å¯é€‰ï¼Œç»„ä»¶å±æ€§

* `children` å¯é€‰ï¼Œå­å…ƒç´ ã€‚å«æœ‰å¤šä¸ªå­å…ƒç´ æ—¶ï¼Œæœ€ç»ˆ React Element çš„ `props.children` ä¼šè¿”å›ä¸€ä¸ªæ•°ç»„ã€‚

ä¾‹å¦‚ï¼šä½¿ç”¨ JSX ç¼–å†™ä»£ç ï¼š

```jsx
class Hello extends React.Component {
  render() {
    return <div>Hello {this.props.toWhat}</div>
  }
}

ReactDOM.render(
  <Hello toWhat="World" />,
  document.getElementById('root')
)
```

ä¹Ÿå¯ä»¥ç¼–å†™ä¸ä½¿ç”¨ JSX çš„ä»£ç ï¼š

```js
class Hello extends React.Component {
  render() {
    return React.createElement(
      'div',
      null,
      `Hello ${this.prorps.toWhat}`
    )
  }
}

ReactDOM.render(
  React.createElement(Hello, { toWhat: 'World' }, null),
  document.getElementById('root')
)
```

å¦‚æœä½ æƒ³äº†è§£æ›´å¤š JSX è½¬æ¢ä¸º JavaScript çš„ç¤ºä¾‹ï¼Œå¯ä»¥å°è¯•ä½¿ç”¨[åœ¨çº¿ Babel ç¼–è¯‘å™¨](https://babeljs.io/repl/#?presets=react&code_lz=GYVwdgxgLglg9mABACwKYBt1wBQEpEDeAUIogE6pQhlIA8AJjAG4B8AEhlogO5xnr0AhLQD0jVgG4iAXyJA)ã€‚


### çœ‹æºç 

```js
function createElement(type, config, children) {
  var propName;

  // Reserved names are extracted
  var props = {};

  // ä¸€äº›ä¿ç•™çš„å±æ€§
  var key = null;
  var ref = null;
  var self = null;
  var source = null;

  // æå– keyã€refã€selfã€sourceã€prop
  if (config != null) {
    // å°†åˆæ³•çš„ ref èµ‹å€¼ç»™ ref å˜é‡
    if (hasValidRef(config)) {
      ref = config.ref;

      {
        warnIfStringRefCannotBeAutoConverted(config);
      }
    }

    // å°†åˆæ³•çš„ key è½¬æ¢ä¸ºå­—ç¬¦ä¸²ç±»å‹ï¼Œå¹¶èµ‹å€¼ç»™å˜é‡ key
    if (hasValidKey(config)) {
      key = '' + config.key;
    }

    self = config.__self === undefined ? null : config.__self;
    source = config.__source === undefined ? null : config.__source;

    // Remaining properties are added to a new props object
    // å°† config ä¸­é™¤ keyã€refã€__selfã€__source ä¹‹å¤–çš„ prop æå–å‡ºæ¥ï¼Œå¹¶æ”¾å…¥ props å˜é‡ä¸­
    for (propName in config) {
      if (hasOwnProperty$1.call(config, propName) && !RESERVED_PROPS.hasOwnProperty(propName)) {
        props[propName] = config[propName];
      }
    }
  }

  // Children can be more than one argument, and those are transferred onto
  // the newly allocated props object.
  // å…¥å‚çš„å‰ä¸¤ä¸ª type å’Œ configï¼Œå‰©ä½™çš„éƒ½æ˜¯ children å‚æ•°ã€‚æ‰€ä»¥å‡ 2
  var childrenLength = arguments.length - 2;

  if (childrenLength === 1) {
    // åªæœ‰ä¸€ä¸ªå­å…ƒç´ æ—¶ï¼Œç›´æ¥æŒ‚åˆ° props.children ä¸‹ï¼ˆéæ•°ç»„å½¢å¼ï¼‰
    props.children = children;
  } else if (childrenLength > 1) {
    // å­å…ƒç´ å¤šäºä¸€ä¸ªæ—¶ï¼Œå°†å®ƒä»¬éƒ½æ”¾å…¥æ•°ç»„ä¸­ï¼Œç„¶åæŒ‚åˆ° props.children ä¸‹ï¼ˆæ•°ç»„å½¢å¼ï¼‰
    var childArray = Array(childrenLength);

    for (var i = 0; i < childrenLength; i++) {
      childArray[i] = arguments[i + 2];
    }

    {
      // å†»ç»“å­å…ƒç´ åˆ—è¡¨
      if (Object.freeze) {
        Object.freeze(childArray);
      }
    }

    props.children = childArray;
  }

  // Resolve default props
  // å–å‡ºç»„ä»¶ç±»ï¼ˆå³ type ä¸ä¸ºå­—ç¬¦ä¸²çš„æƒ…å†µï¼‰ä¸­çš„é™æ€å±æ€§ defaultPropsï¼Œå¹¶ç»™æœªåœ¨ JSX ä¸­è®¾ç½®å€¼çš„å±æ€§è®¾ç½®é»˜è®¤å€¼ã€‚
  if (type && type.defaultProps) {
    var defaultProps = type.defaultProps;

    for (propName in defaultProps) {
      // æ³¨æ„ä¸‹ï¼Œè‹¥å±æ€§å€¼ä¸º null å¹¶ä¸ä¼šè§¦å‘è®¾ç½®é»˜è®¤å€¼çš„å¤„ç†ï¼Œä»… undefinedã€‚
      if (props[propName] === undefined) {
        props[propName] = defaultProps[propName];
      }
    }
  }

  {
    // ä»¥ä¸‹æ­¥éª¤ä¸»è¦æ˜¯é¿å…ä¸€äº›ä¿ç•™å±æ€§è¢«é”™è¯¯å–åˆ°ï¼Œæä¾›è­¦å‘Š
    if (key || ref) {
      var displayName = typeof type === 'function' ? type.displayName || type.name || 'Unknown' : type;

      if (key) {
        defineKeyPropWarningGetter(props, displayName);
      }

      if (ref) {
        defineRefPropWarningGetter(props, displayName);
      }
    }
  }

  // è°ƒç”¨ ReactElement æ„å»ºå…ƒç´ ï¼Œå¹¶è¿”å›
  // type æ˜¯ç›´æ¥é€ä¼ çš„ï¼Œ
  // keyã€ref ç­‰ç­‰éƒ½æ˜¯ä» config é‡Œé¢è§£æå‡ºæ¥çš„ï¼Œprops æ˜¯é™¤å»ä¸€äº›ä¿ç•™å±æ€§ä¹‹å¤–åœ¨ config ä¸Šè¯»å–çš„å±æ€§
  // children æ˜¯å­å…ƒç´ ï¼Œå¤šä¸ªæ—¶è¿”å›æ•°ç»„
  return ReactElement(type, key, ref, self, source, ReactCurrentOwner.current, props);
}
```

æ¥ç€çœ‹ ReactElement æºç ï¼š

```js
/**
 * Factory method to create a new React element. This no longer adheres to
 * the class pattern, so do not use new to call it. Also, instanceof check
 * will not work. Instead test $$typeof field against Symbol.for('react.element') to check
 * if something is a React Element.
 *
 * @param {*} type
 * @param {*} props
 * @param {*} key
 * @param {string|object} ref
 * @param {*} owner
 * @param {*} self A *temporary* helper to detect places where `this` is
 * different from the `owner` when React.createElement is called, so that we
 * can warn. We want to get rid of owner and replace string `ref`s with arrow
 * functions, and as long as `this` and owner are the same, there will be no
 * change in behavior.
 * @param {*} source An annotation object (added by a transpiler or otherwise)
 * indicating filename, line number, and/or other information.
 * @internal
 */
var ReactElement = function (type, key, ref, self, source, owner, props) {
  // æˆ‘ä»¬æš‚æ—¶æŠŠä¸‹é¢çš„ä»£ç æŠ˜å ï¼Œå¯ä»¥çœ‹åˆ° ReactElement æ–¹æ³•æœ€åè¿”å›çš„å°±æ˜¯ element å¯¹è±¡
  var element = {
    // This tag allows us to uniquely identify this as a React Element
    // é€šè¿‡è¿™ä¸ªæ ‡ç­¾æ¥è¯†åˆ«reactçš„å…ƒç´ ï¼ˆä¸€ä¸ª Symbolï¼‰
    $$typeof: REACT_ELEMENT_TYPE,

    // Built-in properties that belong on the element
    // å†…ç½®å±æ€§
    type: type,
    key: key,
    ref: ref,
    props: props,

    // Record the component responsible for creating this element.
    // è®°å½•åˆ›å»ºè¯¥ç»„ä»¶çš„ç»„ä»¶
    _owner: owner
  };

  {
    // The validation flag is currently mutative. We put it on
    // an external backing store so that we can freeze the whole object.
    // This can be replaced with a WeakMap once they are implemented in
    // commonly used development environments.
    // è¿™ä¸ªéªŒè¯æ ‡å¿—æ˜¯å¯å˜çš„ï¼Œæˆ‘ä»¬æŠŠè¿™ä¸ªæ”¾åœ¨å¤–éƒ¨æ”¯æŒå­˜å‚¨ï¼Œä»¥ä¾¿æˆ‘ä»¬èƒ½å¤Ÿå†»ç»“æ•´ä¸ªå¯¹è±¡ï¼Œ
    element._store = {};

    // To make comparing ReactElements easier for testing purposes, we make
    // the validation flag non-enumerable (where possible, which should
    // include every environment we run tests in), so the test framework
    // ignores it.
    // ä¸ºäº†æ›´åŠ æ–¹ä¾¿åœ°è¿›è¡Œæµ‹è¯•ï¼Œæˆ‘ä»¬è®¾ç½®äº†ä¸€ä¸ªä¸å¯æšä¸¾çš„éªŒè¯æ ‡å¿—ä½ï¼Œä»¥ä¾¿æµ‹è¯•æ¡†æ¶å¿½ç•¥å®ƒ
    // ç»™ _store è®¾ç½® validated å±æ€§ false
    Object.defineProperty(element._store, 'validated', {
      configurable: false,
      enumerable: false,
      writable: true,
      value: false
    });

    // self and source are DEV only properties.
    // self å’Œ source éƒ½æ˜¯å¼€å‘ç¯å¢ƒæ‰å­˜åœ¨çš„
    Object.defineProperty(element, '_self', {
      configurable: false,
      enumerable: false,
      writable: false,
      value: self
    });

    // Two elements created in two different places should be considered
    // equal for testing purposes and therefore we hide it from enumeration.
    // ä¸¤ä¸ªå†ä¸åŒåœ°æ–¹åˆ›å»ºçš„å…ƒç´ ä»æµ‹è¯•çš„è§’åº¦æ¥çœ‹æ˜¯ç›¸ç­‰çš„ï¼Œæˆ‘ä»¬åœ¨åˆ—ä¸¾çš„æ—¶å€™å¿½ç•¥ä»–ä»¬
    Object.defineProperty(element, '_source', {
      configurable: false,
      enumerable: false,
      writable: false,
      value: source
    });

    // å¦‚æœ Object æœ‰ freeze çš„å®ç°ï¼Œæˆ‘ä»¬å†»ç»“å…ƒç´ å’Œå®ƒçš„å±æ€§
    if (Object.freeze) {
      Object.freeze(element.props);
      Object.freeze(element);
    }
  }

  return element;
};
```

æ³¨æ„ï¼ŒReact å†…éƒ¨æ˜¯ä½¿ç”¨ `$$typeof` æ¥åˆ¤æ–­ react å…ƒç´ çš„ç±»å‹çš„ã€‚ä½¿ç”¨ `_store` æ¥è®°å½•å†…éƒ¨çš„çŠ¶æ€ï¼Œåé¢ä¼šæœ‰ç”¨åˆ°ã€‚ä¸ºäº†æ–¹ä¾¿æµ‹è¯•æ¡†æ¶ï¼Œ`_store` ä¸­å®šä¹‰äº†ä¸å¯é…ç½®ä¸å¯æšä¸¾çš„ `validated` å±æ€§ã€‚ç±»ä¼¼çš„ï¼Œæ¡†æ¶å†…éƒ¨å®šä¹‰äº† `self` å’Œ `source` çš„å‰¯æœ¬ `_self` å’Œ `_source`ï¼Œä»–ä»¬éƒ½æ˜¯ä¸å¯é…ç½®ä¸å¯æšä¸¾ä¸å¯å†™çš„ã€‚

æœ€è¿‘åœ¨é‡æ–°å­¦ä¹  Reactï¼Œä¹Ÿä¼šå»çœ‹ä¸€äº›æºç ä»€ä¹ˆçš„ï¼Œåœ¨ GitHub ä¸Šå»ºäº†ä¸ªä»“åº“ï¼ˆ[react-learn](https://github.com/toFrankie/react-learn)ï¼‰å»è®°å½•å­¦ä¹ çš„ä¸œè¥¿ï¼Œç„¶åæŠŠå…¶ä¸­çš„ä¸€äº›æŒ‘é€‰å‡ºæ¥å‘æ–‡äº†ã€‚
