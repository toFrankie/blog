---
title: ä»é›¶åˆ°ä¸€æ­å»º react é¡¹ç›®ç³»åˆ—ä¹‹ï¼ˆåä¸€ï¼‰
number: '#64'
link: 'https://github.com/toFrankie/blog/issues/64'
created_at: '2023-02-25 19:44:40'
updated_at: '2023-04-26 21:49:11'
labels:
  - React
  - '2020'
---
ä¹‹å‰æ–‡ç« æè¿‡ï¼ŒRedux æ˜¯ [Flux](http://www.ruanyifeng.com/blog/2016/01/flux.html) æ¶æ„ä¸å‡½æ•°å¼ç¼–ç¨‹ç»“åˆçš„äº§ç‰©ã€‚

### ä¸€ã€Redux Flow

Redux çš„æ•°æ®æµå¤§è‡´å¦‚ä¸‹ï¼š

> **UI Component** â†’ **Action** â†’ **Reducer** â†’ **State** â†’ **UI Component**

![Redux Flow](https://upload-images.jianshu.io/upload_images/5128488-06d050792f2be43c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

ç”¨æˆ·è®¿é—®é¡µé¢ï¼Œç„¶åé€šè¿‡ `View` å‘å‡º `Action`ï¼ˆä¸€ä¸ªåŸå§‹çš„ JavaScript å¯¹è±¡ï¼‰ï¼Œç”± `Dispatcher` è¿›è¡Œæ´¾å‘ï¼Œ`Reducer`ï¼ˆä¸€ä¸ªçº¯å‡½æ•°ï¼‰æ¥æ”¶åˆ°åè¿›è¡Œå¤„ç†å¹¶è¿”å›çŠ¶æ€ `State`ï¼ˆå­˜å‚¨ `State` çš„å®¹å™¨å«åš `Store`ï¼‰ï¼Œç„¶åé€šçŸ¥ `View` æ›´æ–°é¡µé¢ã€‚

å¯¹äº**åŒæ­¥ä¸”æ²¡æœ‰å‰¯ä½œç”¨**çš„æ“ä½œï¼Œä¸Šè¿°æ•°æ®æµå¯ä»¥èµ·åˆ°ç®¡ç†æ•°æ®ï¼Œä»è€Œæ§åˆ¶è§†å›¾æ›´æ–°çš„ç›®çš„ã€‚

**é‚£ä¹ˆé‡åˆ°å«æœ‰å‰¯ä½œç”¨çš„æ“ä½œæ—¶ï¼ˆæ¯”å¦‚ Ajax å¼‚æ­¥è¯·æ±‚ï¼‰ï¼Œæˆ‘ä»¬åº”è¯¥æ€ä¹ˆåšï¼Ÿ**

ç­”æ¡ˆæ˜¯ä½¿ç”¨ä¸­é—´ä»¶ã€‚


### äºŒã€ä¸­é—´ä»¶çš„æ¦‚å¿µ

å¯¹äºä¸­é—´ä»¶æˆ–è€…å¼‚æ­¥æ“ä½œçš„æ€æƒ³ï¼Œæˆ‘ä¸å±•å¼€èµ˜è¿°ï¼Œå¯ä»¥çœ‹ä¸€ä¸‹é˜®ä¸€å³°è€å¸ˆçš„è¿™ç¯‡[ä¸­é—´ä»¶ä¸å¼‚æ­¥æ“ä½œ](http://www.ruanyifeng.com/blog/2016/09/redux_tutorial_part_two_async_operations.html)çš„æ–‡ç« ã€‚æˆ‘å¯¹æ–‡ä¸­å†…å®¹æœ‰å¤šå°‘ç–‘æƒ‘ï¼Œä½†åˆä¸çŸ¥é“æ€ä¹ˆè¯´ï¼Œå¯èƒ½æ˜¯æˆ‘é€ è¯£ä¸å¤Ÿæ·±ã€‚

> æˆ‘æ˜¯è¿™æ ·ç†è§£çš„ï¼Œç±»ä¼¼ redux-thunkã€redux-promiseã€redux-saga ç­‰ä¸­é—´ä»¶æ˜¯å¸®åŠ©æˆ‘ä»¬åœ¨å¼‚æ­¥æ“ä½œç»“æŸåï¼Œä½¿å¾— Reducer è‡ªåŠ¨æ‰§è¡Œã€‚

å…¶å®ä¸­é—´ä»¶çš„å®ç°æ˜¯å¯¹ `store.dispatch()` çš„æ”¹é€ ï¼Œåœ¨å‘å‡º `Action` å’Œæ‰§è¡Œ `Reducer` ä¹‹é—´ï¼Œæ·»åŠ äº†å…¶ä»–åŠŸèƒ½ã€‚

ä¾‹å¦‚ï¼š
```jsx
let next = store.dispatch
store.dispatch = function dispatchAndLog(action) {
  console.log('dispatching', action)
  next(action)
  console.log('next state', store.getState())
}
```

ä¸Šé¢çš„ä»£ç ï¼Œå¯¹ `store.dispatch()` è¿›è¡Œäº†é‡å®šä¹‰ï¼Œåœ¨å‘é€ `Action` å‰åæ·»åŠ äº†æ‰“å°åŠŸèƒ½ï¼Œè¿™å°±æ˜¯ä¸­é—´ä»¶çš„é›å½¢ã€‚

åŠ å…¥ä¸­é—´ä»¶åï¼ŒRedux çš„æ•°æ®æµå¤§è‡´å¦‚ä¸‹ï¼š

![Redux Flow With Middleware](https://upload-images.jianshu.io/upload_images/5128488-b1758887e1637b9d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

åœ¨å«å‰¯ä½œç”¨çš„ `Action` ä¸åŸå§‹ `Action` ä¹‹é—´å¢åŠ äº†ä¸­é—´ä»¶çš„å¤„ç†ã€‚å…¶ä¸­ä¸­é—´ä»¶çš„ä½œç”¨è½¬æ¢å¼‚æ­¥æ“ä½œï¼Œç”ŸæˆåŸå§‹çš„ `Action` å¯¹è±¡ï¼Œåé¢çš„æµç¨‹ä¸å˜ã€‚

åœ¨æ­¤ä¹‹å‰ï¼Œå…¶å®æˆ‘ä»¬å·²ç»ä½¿ç”¨åˆ°äº†ä¸­é—´ä»¶ï¼Œé‚£å°±æ˜¯ `redux-logger`ã€‚

### ä¸‰ã€redux-thunk

æˆ‘ä»¬å…ˆçœ‹çœ‹ redux-thunk çš„[æºç ](https://github.com/reduxjs/redux-thunk/blob/master/src/index.js)ã€‚
```jsx
// redux-thunk æºç 
function createThunkMiddleware(extraArgument) {
  return ({ dispatch, getState }) => (next) => (action) => {
    if (typeof action === 'function') {
      return action(dispatch, getState, extraArgument);
    }

    return next(action);
  };
}

const thunk = createThunkMiddleware();
thunk.withExtraArgument = createThunkMiddleware;

export default thunk;
```
å¯¹å§ï¼Œçœ‹èµ·æ¥å¹¶ä¸éš¾ã€‚å½“ `action` ä¸ºå‡½æ•°æ—¶ï¼Œå°±è°ƒç”¨è¯¥å‡½æ•°ã€‚

ä¸‹é¢æˆ‘ä»¬å†™ä¸€ä¸ªæ¡ˆä¾‹å§ã€‚

1. å®‰è£… `redux-thunk`ã€‚
```shell
$ yarn add redux-thunk@2.3.0
```

2. è°ƒæ•´ `store/index.js`ï¼Œå¼•å…¥ `redux-thunk` ä¸­é—´ä»¶ã€‚è¿™é‡Œæˆ‘ä»¬æš‚æ—¶æŠŠæ­¤å‰ `redux-saga` çš„é…ç½®æ³¨é‡Šæ‰ï¼Œå¹¶æ”¹æˆ `redux-thunk` é…ç½®ã€‚
```jsx
// src/js/store/index.js
import { createStore, applyMiddleware, compose } from 'redux'
import thunkMiddleware from 'redux-thunk'
import logger from 'redux-logger'
import reducers from '../reducers'

const initialState = { count: 0, status: 'offline' }
const composeEnhancers = (typeof window !== 'undefined' && window.__REDUX_DEVTOOLS_EXTENSION_COMPOSE__) || compose
const store = createStore(reducers, initialState, composeEnhancers(applyMiddleware(thunkMiddleware, logger)))

export default store
```

3. æ–°å»ºä¸€ä¸ª `userHelper.js` æ–‡ä»¶ã€‚è¿™é‡Œæˆ‘ä»¬ä¸ç”¨ `fetch` æˆ–è€… `XHR` æ¥åˆ›å»ºä¸€ä¸ªå¼‚æ­¥è¯·æ±‚ï¼Œè€Œæ˜¯ä½¿ç”¨ `setTimeout` æ–¹æ³•æ¥å®ç°ä¸€ä¸ªå¼‚æ­¥è¯·æ±‚ç”¨æˆ·æ•°æ®çš„åœºæ™¯ã€‚
```jsx
// src/js/utils/userHelper.js
class UserHelper {
  // å»¶è¿Ÿå‡½æ•°
  delay(time) {
    return new Promise(resolve => setTimeout(resolve, time))
  }

  // è·å–æ•°æ®
  fetchData(status) {
    return new Promise((resolve, reject) => {
      const response = { status: 'success', response: { name: 'Frankie', age: 20 } }
      const error = { status: 'error', error: 'oops' }
      status ? resolve(response) : reject(error)
    })
  }

  // è¯·æ±‚ç”¨æˆ·æ•°æ®ï¼ˆå¼‚æ­¥åœºæ™¯ï¼‰
  async getUser(data) {
    try {
      const res = await this.fetchData(data)
      await this.delay(2000)
      return res
    } catch (e) {
      await this.delay(1000)
      throw e
    }
  }
}

export default new UserHelper()
```
4. æ–°å»ºä¸€ä¸ª `userActions.js`ï¼Œè¿™æ˜¯ `redux-thunk` çš„å…³é”®ã€‚
```jsx
// src/js/action/userActions.js
import userHelper from '../utils/userHelper'

export const getUser = (data, callback) => {
  return (dispatch, getState) => {
    dispatch({ type: 'FETCH_REQUEST', status: 'requesting' })
    userHelper.getUser(data).then(res => {
      dispatch({ type: 'FETCH_SUCCESS', ...res })
      callback && callback(res)
    }).catch(err => {
      dispatch({ type: 'FETCH_FAILURE', ...err })
    })
  }
}
```
5. ä¿®æ”¹ `About` ç»„ä»¶ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬ä¼ ç»™ `store.dispatch()` çš„ä¸æ˜¯ä¸€ä¸ªåŸå§‹å¯¹è±¡ï¼ˆ`plain object`ï¼‰ï¼Œè€Œæ˜¯ `getUser` å‡½æ•°ã€‚è¿™å°±æ˜¯ `redux-thunk` çš„ç‰¹ç‚¹ï¼Œå®ƒå¯è®© `store.dispatch()` æ¥å—ä¸€ä¸ªå‡½æ•°ä½œä¸ºå‚æ•°ï¼Œè€Œè¿™ä¸ªå‡½æ•°å«åš `Action Creator`ã€‚
```jsx
// src/js/pages/about/index.js
import React, { Component } from 'react'
import { connect } from 'react-redux'
import { getUser } from '../../actions/userActions'

class About extends Component {
  constructor(props) {
    super(props)
    this.state = {}
  }

  render() {
    return (
      <div>
        <h3>About Componentï¼</h3>
        <h5>Get User: {this.props.user.status || ''}</h5>
        {/* æˆ‘ä»¬å‘ç°è¿™é‡Œå¹¶ä¸æ˜¯ä¼ äº†ä¸€ä¸ªæ ‡å‡†çš„ Action å¯¹è±¡ï¼Œè€Œæ˜¯ä¸€ä¸ªå‡½æ•° */}
        <button onClick={() => { this.props.dispatch(getUser(false)) }}>Get User Fail</button>
        <button onClick={() => { this.props.dispatch(getUser(true)) }}>Get User Success</button>
      </div>
    )
  }
}

const mapStateToProps = state => {
  return { user: state.user }
}

export default connect(mapStateToProps)(About)
```
æˆ‘ä»¬ç‚¹å‡» **Get User Success** æŒ‰é’®ï¼Œå³å¯çœ‹åˆ°å¦‚ä¸‹æ•ˆæœã€‚
![ğŸ‰](https://upload-images.jianshu.io/upload_images/5128488-d555bf0f8508c189.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

##### redux-thunk çš„ç¼ºç‚¹

æ ¹æ®æºç æˆ‘ä»¬çŸ¥é“ï¼Œå®ƒä»…ä»…å¸®æˆ‘ä»¬æ‰§è¡Œäº†è¿™ä¸ªå‡½æ•°ï¼Œè€Œä¸åœ¨ä¹å‡½æ•°ä¸»ä½“å†…éƒ¨æ˜¯ä»€ä¹ˆã€‚å®é™…æƒ…å†µä¸‹ï¼Œå®ƒè¿™ä¸ªå‡½æ•°å¯èƒ½è¦å¤æ‚å¾—å¾ˆå¤šã€‚å†è€…ï¼Œå¦‚æœæ¯ä¸€ä¸ªå¼‚æ­¥æ“ä½œéƒ½éœ€è¦å¦‚æ­¤å®šä¹‰ä¸€ä¸ª `Action Creator`ï¼Œæ˜¾ç„¶å®ƒæ˜¯ä¸æ˜“ç»´æŠ¤çš„ã€‚

* `Action` çš„å½¢å¼ä¸ç»Ÿä¸€
* å¼‚æ­¥æ“ä½œå¤ªåˆ†æ•£ï¼Œåˆ†æ•£åœ¨å„ä¸ª `Action` å½“ä¸­

æ‰€ä»¥æœ¬é¡¹ç›®å°†ä¸ä¼šä½¿ç”¨å®ƒï¼Œåªæ˜¯å› ä¸º `redux-thunk` åœ¨ä¹‹å‰åšé¡¹ç›®çš„æ—¶å€™ç”¨è¿‡ï¼Œå°±æ‹¿å‡ºæ¥è®²ä¸€ä¸‹ã€‚


### å››ã€redux-saga

> å…³äºæ¥ä¸‹æ¥ redux-saga éƒ¨åˆ†çš„å†…å®¹ï¼Œæˆ‘è®¤ä¸ºæˆ‘å¯èƒ½è®²è§£å¾—ä¸å¤ªå¥½ï¼Œå»ºè®®çœ‹æ–‡ç« æœ€åçš„é“¾æ¥ã€‚
>

`redux-saga` æ˜¯ä¸€ä¸ªç”¨äºç®¡ç†å¼‚æ­¥æ“ä½œçš„ä¸­é—´ä»¶ã€‚å®ƒé€šè¿‡åˆ›å»º Saga å°†æ‰€æœ‰çš„å¼‚æ­¥æ“ä½œé€»è¾‘æ”¶é›†åœ¨ä¸€ä¸ªåœ°æ–¹é›†ä¸­å¤„ç†ï¼ŒSaga è´Ÿè´£åè°ƒé‚£äº›å¤æ‚æˆ–å¼‚æ­¥çš„æ“ä½œï¼ŒReducer è¿˜æ˜¯è´Ÿè´£å¤„ç† Action å’Œ State çš„æ›´æ–°ã€‚

Saga æ˜¯é€šè¿‡ `Generator` å‡½æ•°åˆ›å»ºçš„ï¼Œå¦‚æœè¿˜ä¸å¤ªç†Ÿæ‚‰ `Generator` å‡½æ•°ï¼Œè¯·çœ‹é˜®ä¸€å³°è€å¸ˆçš„ ES6 å…¥é—¨æ•™ç¨‹ä¸­å¯¹ [Generator å‡½æ•°](https://es6.ruanyifeng.com/#docs/generator)çš„ä»‹ç»ã€‚

Saga ä¸åŒäº Thunkï¼ŒThunk æ˜¯åœ¨ Action è¢«åˆ›å»ºæ—¶è°ƒç”¨ï¼Œè€Œ Saga åªä¼šåœ¨åº”ç”¨å¯åŠ¨æ—¶è°ƒç”¨ï¼ˆä½†åˆå§‹å¯åŠ¨çš„ Saga å¯èƒ½ä¼šåŠ¨æ€è°ƒç”¨å…¶ä»– Sagaï¼‰ï¼ŒSaga å¯ä»¥è¢«çœ‹ä½œæ˜¯åœ¨åå°è¿è¡Œçš„è¿›ç¨‹ï¼ŒSaga ç›‘å¬å‘èµ·çš„ Actionï¼Œç„¶åå†³å®šåŸºäºè¿™ä¸ª Action æ¥åšä»€ä¹ˆï¼šæ˜¯å‘èµ·ä¸€ä¸ªå¼‚æ­¥è°ƒç”¨ï¼ˆå¦‚ fetch è¯·æ±‚ï¼‰ï¼Œè¿˜æ˜¯å‘èµ·å…¶ä»–çš„ Actionï¼Œç”šè‡³æ˜¯è°ƒç”¨å…¶ä»–çš„ Sagaã€‚

åœ¨ `redux-saga` çš„ä¸–ç•Œé‡Œï¼Œæ‰€æœ‰çš„ä»»åŠ¡éƒ½é€šè¿‡ `yield Effects`  æ¥å®Œæˆï¼ˆ`Effect` å¯ä»¥çœ‹ä½œæ˜¯ `redux-saga` çš„ä»»åŠ¡å•å…ƒï¼‰ã€‚`Effects` æ˜¯ç®€å•çš„ JavaScript å¯¹è±¡ï¼ŒåŒ…å«äº†è¦è¢« Saga middleware æ‰§è¡Œçš„ä¿¡æ¯ï¼ˆæ¯”å¦‚ï¼Œæˆ‘ä»¬ Redux Action å…¶å®æ˜¯ä¸€ä¸ªåŒ…å«äº†æ‰§è¡Œä¿¡æ¯ï¼ˆ`{ type, ... }`ï¼‰çš„åŸå§‹çš„ JavaScript å¯¹è±¡ ï¼‰ï¼Œ`redux-saga` ä¸ºå„é¡¹ä»»åŠ¡æä¾›äº†å„ç§ `Effect` åˆ›å»ºå™¨ï¼Œæ¯”å¦‚è°ƒç”¨ä¸€ä¸ªå¼‚æ­¥å‡½æ•°ï¼Œå‘èµ·ä¸€ä¸ª Action åˆ° Storeï¼Œå¯åŠ¨ä¸€ä¸ªåå°ä»»åŠ¡æˆ–è€…ç­‰å¾…ä¸€ä¸ªæ»¡è¶³æŸäº›æ¡ä»¶çš„æœªæ¥çš„ Actionã€‚

##### redux-saga æ ¸å¿ƒ API

##### 1. Saga è¾…åŠ©å‡½æ•°
redux-saga æä¾›äº†ä¸€äº›è¾…åŠ©å‡½æ•°ï¼Œç”¨æ¥åœ¨ä¸€äº›ç‰¹å®šçš„ Action è¢«å‘èµ·åˆ° Store æ—¶æ´¾ç”Ÿä»»åŠ¡ï¼Œä¸‹é¢å…ˆè®²è§£ä¸¤ä¸ªè¾…åŠ©å‡½æ•°ï¼š`takeEvery` å’Œ `takeLatest`ã€‚

* takeEvery
ä¾‹å¦‚ï¼šæ¯æ¬¡ç‚¹å‡» Fetch æŒ‰é’®æ˜¯ï¼Œæˆ‘ä»¬å‘èµ·ä¸€ä¸ª `FETCH_REQUESTED` çš„ Actionã€‚æˆ‘ä»¬æƒ³é€šè¿‡å¯åŠ¨ä¸€ä¸ªä»»åŠ¡ä»æœåŠ¡å™¨è·å–ä¸€äº›æ•°æ®æ¥å¤„ç†è¿™ä¸ª Actionã€‚
```jsx
// src/
import { call, put, takeEvery } from 'redux-saga/effects'
import userHelper from '../utils/userHelper'

// åˆ›å»ºä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡
function* fetchData(action) {
  try {
    // call([context, fnName], ...args)
    const data = yield call([userHelper, userHelper.getUser], action.flag)
    yield put({ type: 'FETCH_SUCCESS', ...data })
  } catch (e) {
    yield put({ type: 'FETCH_FAILURE', ...e })
  }
}

// æ¯æ¬¡ FETCH_REQUESTED Action è¢«å‘èµ·æ—¶å¯åŠ¨ä¸Šé¢çš„ä»»åŠ¡
export function* watchFetchData(a) {
  yield takeEvery('FETCH_REQUEST', fetchData)

  // ç­‰åŒäº
  // while (true) {
  //   const action = yield take('FETCH_REQUEST')
  //   yield fork(fetchData, action)
  // }
}
```
* takeLatest
åœ¨ä¸Šé¢çš„ä¾‹å­ï¼ŒtakeEvery å…è®¸å¤šä¸ª fetchData å®ä¾‹åŒæ—¶å¯åŠ¨ï¼Œåœ¨æŸä¸ªç‰¹å®šçš„æ—¶åˆ»ï¼Œæˆ‘ä»¬å¯ä»¥å¯åŠ¨æ–°çš„ fetchData ä»»åŠ¡ï¼Œå°½ç®¡æ­¤å‰è¿˜æœ‰ä¸€ä¸ªæˆ–è€…å¤šä¸ª fetchData å°šæœªç»“æŸã€‚<br>
å¦‚æœåªæƒ³å¾—åˆ°æœ€æ–°çš„é‚£ä¸ªè¯·æ±‚çš„å“åº”ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ takeLatest è¾…åŠ©å‡½æ•°<br>
å’Œ takeEvery ä¸åŒçš„æ˜¯ï¼Œåœ¨ä»»ä½•æ—¶åˆ» takeLatest åªå…è®¸ä¸€ä¸ª fetchData ä»»åŠ¡ï¼Œå¹¶ä¸”è¿™ä¸ªä»»åŠ¡æ—¶æœ€åè¢«å¯åŠ¨çš„é‚£ä¸ªã€‚å¦‚æœæ­¤å‰å·²ç»æœ‰ä¸€ä¸ªä»»åŠ¡åœ¨æ‰§è¡Œï¼Œé‚£ä¹ˆæ­¤å‰è¿™ä¸ªä»»åŠ¡ä¼šè‡ªåŠ¨è¢«å–æ¶ˆã€‚
```jsx
import { takeLatest } from 'redux-saga/effects'

export function* watchFetchData(a) {
  yield takeLatest('FETCH_REQUEST', fetchData)
}
```

##### 2. Effect åˆ›å»ºå™¨
Saga æ˜¯ç”±ä¸€ä¸ªä¸ªçš„ effect ç»„æˆçš„ï¼Œé‚£ä¹ˆ effect æ˜¯ä»€ä¹ˆï¼Ÿ

> redux-saga å®˜ç½‘çš„è§£é‡Šï¼šä¸€ä¸ª effect å°±æ˜¯ä¸€ä¸ª Plain Object JavaScript å¯¹è±¡ï¼ŒåŒ…å«ä¸€äº›å°†è¢« saga middleware æ‰§è¡Œçš„æŒ‡ä»¤ã€‚redux-saga æä¾›äº†å¾ˆå¤š effect åˆ›å»ºå™¨ï¼Œå¦‚ `call`ã€`put`ã€`take` ç­‰ã€‚

æ¯”å¦‚ `call`ï¼š
```jsx
import { call } from 'redux-saga/effects'

function* fetchData() {
  yield call(fetch)
}
```
`call(userHelper.getUser)` ç”Ÿæˆçš„å°±æ˜¯ä¸€ä¸ª effectï¼Œç±»ä¼¼å¦‚ä¸‹ï¼š
```js
{
  isEffect: true,
  type: 'CALL',
  fn: fetch
}
```

å¸¸ç”¨çš„ effect æœ‰ï¼š
* [take(pattern)](https://redux-saga-in-chinese.js.org/docs/api/#takepattern)


* [put(action)](https://redux-saga-in-chinese.js.org/docs/api/#putaction)


* [call(fn, ...args)](https://redux-saga-in-chinese.js.org/docs/api/#callfn-args)


* [fork(fn, ...args)](https://redux-saga-in-chinese.js.org/docs/api/#forkfn-args)


* [select(selector, ...args)](https://redux-saga-in-chinese.js.org/docs/api/#selectselector-args)



### 3. å¸¸ç”¨ Effect æ–¹æ³•

##### ï¼ˆ1ï¼‰take
> **take** è¿™ä¸ªæ–¹æ³•æ˜¯ç”¨æ¥ç›‘å¬æœªæ¥çš„ Actionï¼Œå®ƒåˆ›å»ºä¸€ä¸ªå‘½ä»¤å¯¹è±¡ï¼Œå‘Šè¯‰ Middleware ç­‰å¾…ä¸€ä¸ªç‰¹å®šçš„ Actionï¼ŒGenerator å‡½æ•°ä¼šæš‚åœï¼Œç›´åˆ°ä¸€ä¸ªä¸ pattern åŒ¹é…çš„ action è¢«å‘èµ·ï¼Œæ‰ä¼šç»§ç»­æ‰§è¡Œä¸‹é¢çš„è¯­å¥ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œtake æ˜¯ä¸€ä¸ªé˜»å¡çš„ effectã€‚
```jsx
export function* watchFetchData(a) {
  while (true) {
    // ç›‘å¬ä¸€ä¸ª type ä¸º 'FETCH_REQUEST' çš„ Action çš„æ‰§è¡Œï¼Œç›´åˆ°è¿™ä¸ª Actionè¢«è§¦å‘ï¼Œ
    // æ‰ä¼šæ‰§è¡Œä¸‹é¢çš„ yield fork(fetchData) è¯­å¥ã€‚
    yield take('FETCH_REQUEST')
    yield fork(fetchData)
  }
}
```

##### ï¼ˆ2ï¼‰put
> å®ƒæ˜¯ç”¨æ¥å‘é€ Action çš„ effectï¼Œä½ å¯ä»¥ç®€å•åœ°ç†è§£æˆ redux æ¡†æ¶ä¸­çš„ dispatch å‡½æ•°ã€‚å½“ put ä¸€ä¸ª Action åï¼Œreducer å°±ä¼šè®¡ç®—æ–°çš„ state å¹¶è¿”å›ã€‚put ä¹Ÿæ˜¯é˜»å¡çš„ effectã€‚


ç»“åˆ take å’Œ put æ–¹æ³•ï¼Œä¸¾ä¸ªä¾‹å­ï¼š
```jsx
// *********************** è¾…åŠ©ç†è§£ ***********************

// åœ¨ redux ä¸­ï¼Œæˆ‘ä»¬å‘èµ·è¿™æ ·ä¸€ä¸ª Action
const fetchAction = { type: 'FETCH_REQUEST' }
store.dispatch(fetchAction)

// ä½¿ç”¨ Saga å¦‚ä½•å¤„ç†å‘¢ï¼Ÿ
// éœ€è¦æ³¨æ„çš„æ˜¯ï¼šä»¥ä¸‹ Saga æ–¹æ³•å®ç°ï¼Œå¹¶ä¸æ˜¯ä¸€ä¸ªå®Œæ•´å¯æ‰§è¡Œçš„é€»è¾‘ï¼Œä»…ç”¨ä»¥ä¸¾ä¾‹è¯´æ˜ï¼Œè¾…åŠ©ç†è§£è€Œå·²ã€‚
//
// 1. é¦–å…ˆï¼Œåœ¨æˆ‘ä»¬å¯åŠ¨ Saga æ—¶ï¼Œä½¿ç”¨ take æ¥ç›‘å¬ type ä¸º 'FETCH_REQUEST' çš„ Action
const fetchAction = yield take('FETCH_REQUEST')
// 2. ä» UI å‘ Saga ä¸­é—´ä»¶ä¼ é€’ä¸€ä¸ª Action
this.props.dispatch({ type: 'FETCH_REQUEST' })
// 3. æ­¤æ—¶æˆ‘ä»¬çš„ Saga ç›‘å¬åˆ° 'FETCH_REQUEST'ï¼Œæ¥ç€å¼€å§‹æ‰§è¡Œ take('FETCH_REQUEST') åé¢çš„é€»è¾‘
yield put(fetchAction)
// 4. put æ–¹æ³•ï¼Œå¯ä»¥å‘å‡º Actionï¼Œä¸”å‘å‡ºçš„ Action ä¼šè¢« Reducer ç›‘å¬åˆ°ã€‚ä»è€Œè¿”å›ä¸€ä¸ªæ–°çŠ¶æ€
```

##### ï¼ˆ3ï¼‰call/apply
```jsx
call(fn, ...args)

// æ”¯æŒä¼ é€’ this ä¸Šä¸‹æ–‡ç»™ fnã€‚åœ¨è°ƒç”¨å¯¹è±¡æ–¹æ³•æ—¶å¾ˆæœ‰ç”¨ã€‚
call([context, fn], ...args)

// æ”¯æŒç”¨å­—ç¬¦ä¸²ä¼ é€’ fnã€‚åœ¨è°ƒç”¨å¯¹è±¡çš„æ–¹æ³•æ—¶å¾ˆæœ‰ç”¨ã€‚
// ä¾‹å¦‚ yield call([localStorage, 'getItem'], 'redux-saga')ã€‚
call([context, fnName], ...args)

// call([context, fn], ...args) çš„å¦ä¸€ç§å†™æ³•
apply(context, fn, [args])
```
> è¯­æ³•ä¸ JS ä¸­çš„ call/apply ç›¸ä¼¼ã€‚
>
> å¯ä»¥æŠŠå®ƒç®€å•çš„ç†è§£ä¸ºè°ƒç”¨å…¶ä»–å‡½æ•°çš„å‡½æ•°ï¼Œå®ƒå‘½ä»¤ middleware ä»¥å‚æ•° `args` æ¥è°ƒç”¨ `fn` å‡½æ•°ã€‚
>
> æ³¨æ„ï¼š `fn` æ—¢å¯ä»¥æ˜¯ä¸€ä¸ª **Generator å‡½æ•°**, ä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªè¿”å› Promise æˆ–ä»»æ„å…¶å®ƒå€¼çš„**æ™®é€šå‡½æ•°**ã€‚
> 
> è¿˜æœ‰ï¼Œcall æ˜¯é˜»å¡çš„ effectã€‚

##### ï¼ˆ4ï¼‰fork
```jsx
fork(fn, ...args)
```
> fork ç±»ä¼¼äº callï¼Œå¯ä»¥ç”¨æ¥è°ƒç”¨æ™®é€šå‡½æ•°å’Œ Generator å‡½æ•°ã€‚ä¸è¿‡ï¼Œfork çš„è°ƒç”¨æ˜¯éé˜»å¡çš„ï¼ŒGenerator ä¸ä¼šåœ¨ç­‰å¾… `fn` è¿”å›ç»“æœçš„æ—¶å€™è¢« middleware æš‚åœï¼›æ°æ°ç›¸ååœ°ï¼Œå®ƒåœ¨ `fn` è¢«è°ƒç”¨æ—¶ä¾¿ä¼šç«‹å³æ¢å¤æ‰§è¡Œã€‚

##### ï¼ˆ5ï¼‰select
```jsx
select(selector, ...args)

// å¦‚æœ select çš„å‚æ•°ä¸ºç©ºä¼šå–å¾—å®Œæ•´çš„ stateï¼ˆä¸è°ƒç”¨ getState() çš„ç»“æœç›¸åŒï¼‰
// yield select()

// è¿”å› state çš„ä¸€éƒ¨åˆ†æ•°æ®å¯ä»¥è¿™æ ·è·å–
// yield select(state => state.user)
```
> select å‡½æ•°æ˜¯ç”¨æ¥æŒ‡ç¤º middleware è°ƒç”¨æä¾›çš„é€‰æ‹©å™¨è·å– Store ä¸Šçš„ state æ•°æ®ã€‚ä½ ä¹Ÿå¯ä»¥ç®€å•çš„æŠŠå®ƒç†è§£ä¸º redux æ¡†æ¶ä¸­è·å– store ä¸Šçš„ state æ•°æ®ä¸€æ ·çš„åŠŸèƒ½ï¼ˆ`store.getState()`ï¼‰

##### 4. Middleware API
* createSagaMiddleware()
åˆ›å»ºä¸€ä¸ª Redux middlewareï¼Œå¹¶å°† Sagas è¿æ¥åˆ° Redux Storeã€‚

* middleware.run(saga, ...args)
åŠ¨æ€åœ°è¿è¡Œ `saga`ï¼Œåªèƒ½ç”¨äºåœ¨ `applyMiddleware` é˜¶æ®µä¹‹åæ‰§è¡Œ Sagaã€‚<br>
`sagas` ä¸­çš„æ¯ä¸ªå‡½æ•°éƒ½å¿…é¡»è¿”å›ä¸€ä¸ª Generator å¯¹è±¡ï¼Œmiddleware ä¼šè¿­ä»£è¿™ä¸ª Generator å¹¶æ‰§è¡Œæ‰€æœ‰ yield åçš„ Effectã€‚ï¼ˆEffect å¯ä»¥çœ‹ä½œæ˜¯ redux-saga çš„ä»»åŠ¡å•å…ƒï¼‰

### äº”ã€Saga æ¡ˆä¾‹å®ç°

ä¸‹é¢å†™ä¸€ä¸ªå¤„ç† Fetch è¯·æ±‚çš„å¼‚æ­¥å¤„ç†åœºæ™¯ã€‚

é¦–å…ˆï¼Œå®ç° Saga å¤„ç†åœºæ™¯ï¼š
```jsx
import { call, fork, put, select, take, delay, race, takeEvery, takeLatest } from 'redux-saga/effects'

// fetch è¯·æ±‚
function fetch() {
  return new Promise((resolve, reject) => {
    window
      .fetch('http://192.168.1.124:7701/config')
      .then(response => response.json())
      .then(res => {
        // è¯·æ±‚æˆåŠŸï¼Œè¿”å›ä¸€ä¸ª JSON æ•°æ®ï¼š{"name":"Frankie","age":20}
        resolve(res)
      })
      .catch(err => {
        reject(err)
      })
  })
}

// saga å¤„ç†å¼‚æ­¥åœºæ™¯
function* fetchData() {
  try {
    // race ä¸ Promise.race ç±»ä¼¼ï¼Œè¿™é‡Œåšä¸€ä¸ªè¶…æ—¶å¤„ç†
    const { result, timeout } = yield race({
      result: call(fetch),
      timeout: delay(30000)
    })
    if (timeout) throw new Error('è¯·æ±‚è¶…æ—¶ï¼')
    yield put({ type: 'FETCH_SUCCESS', ...result })
  } catch (e) {
    console.warn(e)
    yield put({ type: 'FETCH_FAILURE', status: 'error', error: 'oops' })
  }
}

export function* watchFetchData() {
  // æ¯æ¬¡ Saga ç›‘å¬åˆ° 'FETCH_REQUEST' ç±»å‹çš„ Actionï¼Œéƒ½ä¼šè§¦å‘ fetchData å‡½æ•°
  yield takeEvery('FETCH_REQUEST', fetchData)
}
```
æ¥ç€ï¼Œæˆ‘ä»¬åœ¨ UI ä¸­æ´¾å‘ä¸€ä¸ª `FETCH_REQUEST ` çš„ Actionï¼Œç„¶å Saga ç›‘å¬åˆ°ä¹‹åï¼Œå°±ä¼šæ‰§è¡Œ `fetchData` çš„é€»è¾‘äº†ã€‚
```html
<div>
  <h3>About Componentï¼</h3>
  <h5>Get User: {this.props.user.name || ''}</h5>
  <button onClick={() => { this.props.dispatch({ type: 'FETCH_REQUEST', status: 'requesting' }) }}>Fetch Data</button>
</div>
```
çœ‹ç»“æœï¼š
![ğŸ‰](https://upload-images.jianshu.io/upload_images/5128488-0ee0f987918d5f89.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

### è‡³æ­¤
 Redux + Middleware åŸºæœ¬çš„å·²ç»ä»‹ç»å®Œäº†ï¼Œä½†æˆ‘ä¸è®¤ä¸ºæˆ‘è®²å¥½äº†ã€‚å»ºè®®å¤§å®¶çœ‹çœ‹ä»¥ä¸‹å‡ ç¯‡æ–‡ç« æ¥åŠ æ·±ç†è§£ã€‚

è¿˜æœ‰ Redux æ­é…ä¸­é—´ä»¶çš„æˆ‘è®¤ä¸ºè¦å­¦ä¹ çš„ API å¾ˆå¤šï¼Œæœ‰ç‚¹è´¹åŠ²ã€‚æœ‰ç©ºçœ‹ä¸‹å¦ä¸€ä¸ªè§£å†³æ–¹æ¡ˆï¼šğŸ‘‰ [MobX](https://cn.mobx.js.org/)

æ¥ä¸‹æ¥ç»ˆäºå¯ä»¥ä»‹ç» react-hot-loader çƒ­æ›´æ–°äº†ï¼Œå…³äº react-routerã€reduxã€react-reduxã€redux-saga ç­‰å†…å®¹èŠ±äº†å¥½å¤šç¯‡å¹…ã€‚

### å‚è€ƒ
* [redux-saga ä¸­æ–‡æ–‡æ¡£](https://redux-saga-in-chinese.js.org/)
* [å½»å½»åº•åº•æ•™ä¼šä½ ä½¿ç”¨ Redux-saga](https://github.com/forthealllight/blog/issues/14)
* [redux-saga æ¡†æ¶ä½¿ç”¨è¯¦è§£åŠ Demo æ•™ç¨‹](https://www.cnblogs.com/guangqiang/p/9602085.html)
