---
title: ä»é›¶åˆ°ä¸€æ­å»ºç§æœ‰ NPM æœåŠ¡å™¨
number: '#90'
link: 'https://github.com/toFrankie/blog/issues/90'
created_at: '2023-02-25 20:21:23'
updated_at: '2024-12-04 16:17:06'
labels:
  - Node.js
  - '2021'
---
![é…å›¾æºè‡ª Freepik](https://cdn.jsdelivr.net/gh/toFrankie/blog@main/images/2023/10/1696416482980.png)


å…¶å®ï¼Œæˆ‘ä»¬æ¯å¤©éƒ½åœ¨ä½¿ç”¨ `npm` æˆ– `yarn` åœ¨ [https://www.npmjs.com](https://www.npmjs.com/) å¹³å°ä¸‹è½½ä¸€äº›ç¬¬ä¸‰æ–¹çš„åŒ…ï¼Œå®ƒä»¬éƒ½å±äºå¼€æºçš„ï¼Œä»»ä½•äººéƒ½å¯ä»¥å…è´¹ä¸‹è½½å¹¶ä½¿ç”¨ã€‚

å‡è®¾å…¬å¸æˆ–è€…å›¢é˜Ÿé‡Œé¢ï¼Œæƒ³æŠŠä¸€äº›å¯å¤ç”¨çš„æ¨¡å—æŠ½ç¦»å¹¶å½¢æˆ NPM åŒ…ï¼Œå› æ¶‰åŠå…¬å¸ä¸šåŠ¡æˆ–å…¶ä»–åŸå› ï¼Œä¸èƒ½å‘å¸ƒåˆ° NPM å¹³å°ä¸Šã€‚è¿™æ—¶å€™æˆ‘ä»¬å¯ä»¥åœ¨å…¬å¸å†…éƒ¨å»ºç«‹ä¸€ä¸ªç±»ä¼¼ [https://www.npmjs.com](https://www.npmjs.com/) çš„ç§æœ‰çš„ NPM å¹³å°ï¼Œæ€ä¹ˆåšå‘¢ï¼Ÿ

ä¸‹é¢ï¼Œæˆ‘ä»¬ä»é›¶åˆ°ä¸€æ­å»ºä¸ªäººçš„ NPM ç§æœ‰æœåŠ¡å™¨ã€‚

## ä¸€ã€é€‰æ‹©

é€‰æ‹© [Verdaccio](https://github.com/verdaccio/verdaccio) ä½œä¸ºæˆ‘ä»¬ç§æœ‰ NPM ä»“åº“çš„å¹³å°ï¼Œä¸»è¦åŸå› æ˜¯å…è´¹ã€é›¶é…ç½®ï¼Œå¼€ç®±å³ç”¨ã€‚

> å¦‚æœæ˜¯å…¬å¸å±‚é¢ï¼Œå¯èƒ½è¦æ·±å…¥å¯é ã€ç¨³å®šæ€§ç­‰å› ç´ ã€‚

## äºŒã€NPM å¹³å°æ­å»º

å®‰è£…ã€å¯åŠ¨éƒ½éå¸¸ç®€å•~

```shell
# install
$ npm i -g verdaccio

# run
$ verdaccio
```

Verdaccio è·‘èµ·æ¥ä¹‹åï¼Œå¯ä»¥çœ‹åˆ°ä»“åº“åœ°å€å°±æ˜¯ï¼š`http://localhost:4873/`ã€‚

è¿™æ˜¯åŸºäºé»˜è®¤é…ç½®ï¼Œæš‚æ—¶ä¸ä½œä¿®æ”¹ï¼Œé…ç½®æ–‡ä»¶åœ¨ `~/.config/verdaccio/config.yaml`ã€‚

```shell
$ verdaccio

 warn --- config file  - /Users/frankie/.config/verdaccio/config.yaml
 warn --- Plugin successfully loaded: verdaccio-htpasswd
 warn --- Plugin successfully loaded: verdaccio-audit
 warn --- http address - http://localhost:4873/ - verdaccio/5.1.1
 http --- 127.0.0.1 requested 'GET /'
 http --- 304, user: null(127.0.0.1), req: 'GET /', bytes: 0/0
 http --- 127.0.0.1 requested 'GET /-/verdaccio/packages'
 http --- 304, user: null(127.0.0.1), req: 'GET /-/verdaccio/packages', bytes: 0/0
```

ç›®å‰æ²¡æœ‰å‘åŒ…ä¸Šæ¥ï¼Œå°±é•¿è¿™æ ·...

![](https://upload-images.jianshu.io/upload_images/5128488-df0fd715ec40e714.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)


æˆ‘ä»¬ä¿®æ”¹ä»¥ä¸‹ `npm` æˆ– `yarn` çš„é•œåƒæº `http://localhost:4873/`ã€‚

```shell
# æ·»åŠ ç§æœ‰æºï¼ˆæˆ‘ä½¿ç”¨äº† nrm æ¥ç®¡ç† npm æºï¼‰
$ nrm add local http://localhost:4873/

# åˆ‡æ¢æº
$ nrm use local

# or
# npm set registry http://localhost:4873/

# æ³¨å†Œç”¨æˆ·ï¼Œå¯¹åº”ä½  NPM è´¦å·å¯†ç ï¼ˆè‹¥æ²¡æœ‰ï¼Œç”¨é‚®ç®±æ³¨å†Œä¸€ä¸ªå³å¯ï¼‰
$ npm adduser

# æŸ¥çœ‹å½“å‰ç”¨æˆ·æ˜¯å¦æ˜¯æ³¨å†Œç”¨æˆ·
$ npm who am i
```
> å…³äº nrm å®‰è£…ä½¿ç”¨ï¼Œçœ‹[è¿™é‡Œ](https://github.com/toFrankie/blog/issues/89)ã€‚

## ä¸‰ã€å‘åŒ…

### 3.1 åˆ›å»º NPM é¡¹ç›®

æˆ‘ä»¬æ¥åˆ›å»ºä¸€ä¸ªæœ€ç®€å•çš„ NPM åŒ…é¡¹ç›®ï¼Œç›®å½•å¦‚ä¸‹ï¼š

```text
privative-npm
    â”œâ”€â”€ .gitignore                // ç›¸åº”ç›®å½•ï¼Œå‘å¸ƒæ—¶ä¼šå¿½ç•¥ä¸Šä¼ 
    â”œâ”€â”€ .npmignore                // åŒç†ï¼Œä¼šå¿½ç•¥ä¸Šä¼ 
    â”œâ”€â”€ index.js                  // ä½œä¸ºå…¥å£
    â”œâ”€â”€ package.json              // åŒ…æè¿°æ–‡ä»¶
    â””â”€â”€ README.md                 // é¡¹ç›®è¯´æ˜
```

ä¸€ä¸ª NPM åŒ…ï¼Œå…¶ä¸­ `name` å’Œ `version` æ˜¯å¿…éœ€çš„ï¼Œå…¶ä»–éƒ½å¯ä»¥çœç•¥ï¼Œè€Œä¸” name ä¸èƒ½ä¸å¹³å°ä¸Šå·²æœ‰åŒ…é‡åã€‚

```json5
// package.json
{
  "name": "privative-npm", // å¿…éœ€ï¼Œä¸èƒ½æœ‰å¤§å†™å­—æ¯ã€ç©ºæ ¼ã€ä¸‹åˆ’çº¿
  "version": "1.0.0", // å¿…éœ€ï¼Œè¯·ä¸¥æ ¼éµå¾ªè¯­ä¹‰åŒ–
  "description": "Test only, not published to NPM.",
  "author": "Frankie <1426203851@qq.com>",
  "license": "MIT",
  "type": "module",
  "main": "./index.js"
}
```
ç”±äºæ¼”ç¤ºè€Œå·²ï¼Œæˆ‘ä»¬å°±åªå¯¼å‡ºä¸€ä¸ªæ–¹æ³•å§ã€‚æ³¨æ„ï¼Œè‹¥åœ¨ node ä¸‹è¿è¡Œæ­¤åŒ…ï¼Œæˆ‘ä»¬ä½¿ç”¨äº† ESMï¼Œå› æ­¤éœ€è¦åœ¨ `package.json` è®¾ç½® `"type": "module"`ã€‚

```js
// index.js
export default function log(str) {
  console.log(str)
}
```

### 3.2 å‘å¸ƒ NPM åŒ…

åœ¨å‘åŒ…ä¹‹å‰ï¼Œä½ éœ€è¦å» [NPM å¹³å°å®˜ç½‘](https://www.npmjs.com/)æ³¨å†Œä¸€ä¸ªè´¦å·ã€‚å¾ˆç®€å•çœç•¥...

å®Œäº†ä¹‹åï¼Œç™»å½•ä½ çš„ NPM è´¦å·ï¼š

```shell
# add
$ npm set registry http://localhost:4873/

# switch registry
$ npm config set registry http://localhost:4873/

# login npm account
$ npm adduser

# ç™»å½•è¿‡ç”¨ loginï¼Œç¬¬ä¸€æ¬¡åˆ™ç”¨ adduserï¼Œå®ƒåŒ…æ‹¬äº†ç™»å½•æ“ä½œã€‚
$ npm login
```

ç™»å½•æˆåŠŸï¼Œé•¿è¿™æ ·ï¼š

```shell
$ npm login

Username: xxx
Password: 
Email: (this IS public) 1426203851@qq.com
Logged in as xxx on http://localhost:4873/.
```

åœ¨æ ¹ç›®å½•ä¸‹ï¼Œæ‰§è¡Œå‘½ä»¤ `npm publish` å³å¯ã€‚æˆ–å¯åœ¨ `package.json` è„šæœ¬å‘½ä»¤ä¸­å®šä¹‰ã€‚

```shell
$ npm publish

npm notice 
npm notice ğŸ“¦  privative-npm@1.0.0
npm notice === Tarball Contents === 
npm notice 54B  index.js    
npm notice 212B package.json
npm notice 36B  README.md   
npm notice === Tarball Details === 
npm notice name:          privative-npm                           
npm notice version:       1.0.0                                   
npm notice package size:  416 B                                   
npm notice unpacked size: 302 B                                   
npm notice shasum:        887836aa4a154902faf31b13e60b8adcdd07b924
npm notice integrity:     sha512-fyzitNqmif188[...]hFY+zmcIW6qTg==
npm notice total files:   3                                       
npm notice 
+ privative-npm@1.0.0
```

çœ‹åˆ°å·²ç»ä¸Šä¼ æˆåŠŸäº†ï¼Œåˆ·æ–°é¡µé¢å°±èƒ½çœ‹åˆ°ï¼š

![](https://upload-images.jianshu.io/upload_images/5128488-736331358755a9f1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)


### 3.3 æ›´æ–°åŒ…

å¦‚æœæˆ‘ä»¬è¦æ›´æ–°åŒ…ï¼Œå…¶ä¸­ç‰ˆæœ¬å· `version` ä¸€å®šè¦ä¿®æ”¹ï¼Œå¦åˆ™ä¼šæ›´æ–°å¤±è´¥ï¼Œå¦‚ä¸‹ï¼š

```shell
$ npm publish

...
npm ERR! code EPUBLISHCONFLICT
npm ERR! publish fail Cannot publish over existing version.
npm ERR! publish fail Update the 'version' field in package.json and try again.
npm ERR! publish fail 
npm ERR! publish fail To automatically increment version numbers, see:
npm ERR! publish fail     npm help version

npm ERR! A complete log of this run can be found in:
npm ERR!     /Users/frankie/.npm/_logs/2021-07-14T06_16_31_553Z-debug.log
```

è¿™é‡Œæˆ‘å°±åªæ”¹ä¸ªç‰ˆæœ¬å·å§ï¼Œæ›´æ–°åŒ…çš„å‘½ä»¤ä»ç„¶æ˜¯ `npm publish`ï¼Œä¸Šä¼ æˆåŠŸåï¼Œåˆ·æ–°é¡µé¢å¯ä»¥çœ‹åˆ°æ–°ç‰ˆæœ¬äº†ã€‚

![](https://upload-images.jianshu.io/upload_images/5128488-365702dc44ae1ae0.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)


> **å‡è®¾ä½ å¼€å‘äº†ä¸€ä¸ª NPM åŒ…ï¼Œè¦å‘å¸ƒåˆ° NPM å¼€æºä¾›å…¶ä»–å¼€å‘è€…ä½¿ç”¨ï¼Œåº”è¯¥éµå¾ª[è¯­ä¹‰åŒ–ç‰ˆæœ¬](https://github.com/toFrankie/blog/issues/83)åŸåˆ™è¿›è¡Œæ›´æ–°**ã€‚å¦‚æœåƒæœ¬æ–‡åœ¨æœ¬åœ°æˆ–ä¸ªäººæœåŠ¡å™¨æ­å»ºç€ç©ï¼Œå°±çˆ±å’‹å’‹åœ°ï¼

### 3.4 æ’¤é”€åŒ…

> éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨ NPM å¹³å°æ’¤é”€åŒ…ï¼Œæ˜¯æœ‰éå¸¸ä¸¥æ ¼é™åˆ¶çš„ï¼Œä¸æ˜¯éšæ„å°±èƒ½æ’¤é”€å·²å‘å¸ƒåˆ°å¹³å°çš„åŒ…çš„ï¼Œè¯¦æƒ…å¯çœ‹ï¼š[NPM Unpublish Policy](https://www.npmjs.com/policies/unpublish)ã€‚

```shell
# æ’¤é”€åŒ…çš„æŸä¸ªç‰ˆæœ¬
$ npm unpublish [<@scope>/]<pkg>@<version>

# æ’¤é”€åŒ…
$ npm unpublish [<@scope>/]<pkg>
```

å¦‚æœä½ çš„ç›®çš„æ˜¯é¼“åŠ±ç”¨æˆ·å‡çº§ï¼Œæˆ–è€…æ‚¨ä¸æƒ³å†ç»´æŠ¤è½¯ä»¶åŒ…ï¼Œè¯·è€ƒè™‘æ”¹ç”¨ `deprecate` å‘½ä»¤ã€‚

```shell
$ npm deprecate <pkg>[@<version>] <message>
```

æˆ‘ä»¬åœ¨å®‰è£…ä¸€äº›ä¾èµ–åŒ…çš„æ—¶å€™ï¼Œä¸æ˜¯ç»å¸¸çœ‹å¾—åˆ°ç±»ä¼¼çš„ä¸œè¥¿å—ï¼Œå°±æ˜¯ `deprecate` æçš„é¬¼~

```shell
npm WARN deprecated core-js@1.2.7: core-js@<3.3 is no longer maintained and not recommended for usage due to the number of issues.
```

## å››ã€ä½¿ç”¨åŒ…

æˆ‘ä»¬å°† NPM å‘å¸ƒåˆ°ç§æœ‰æˆ–å…¬å¼€çš„ NPM å¹³å°åï¼Œéƒ½å¯ä»¥é€šè¿‡ `npm`ã€`yarn` ç­‰åŒ…ç®¡ç†å·¥å…·å»å®‰è£…åˆ°æˆ‘ä»¬çš„é¡¹ç›®ä¸­ã€‚

ç”±äºæˆ‘ä»¬ä¸Šé¢ç¤ºä¾‹ï¼Œæ˜¯å°† `privative-npm` åŒ…å‘å¸ƒåˆ°æˆ‘ä»¬ç§æœ‰çš„ NPM æœåŠ¡å™¨ä¸‹ï¼Œå› æ­¤éœ€è¦å°† npm é•œåƒæºåˆ‡æ¢è‡³ `http://localhost:4873/` å³å¯ï¼š

```shell
# use npm
$ npm config set registry http://localhost:4873/

# use yarn
$ yarn config set registry http://localhost:4873/
```

éšä¾¿åˆ›å»ºä¸€ä¸ªé¡¹ç›®ï¼Œå¹¶å®‰è£… `privative-npm` ä¾èµ–åŒ…ï¼Œåœ¨ node ç¯å¢ƒè¿è¡Œä¸€ä¸‹ `index.js` å¯ä»¥çœ‹åˆ°æ‰“å°å‡º `OK!`ï¼Œé‚£è¯´æ˜æˆåŠŸäº†ï¼

![](https://upload-images.jianshu.io/upload_images/5128488-08c94d5a4db76b97.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

## äº”ã€å…¶ä»–

å‡è®¾æˆ‘ä»¬åœ¨ä½¿ç”¨ `http://localhost:4873/` é•œåƒæºï¼Œå»å®‰è£… `react`ã€`vue` ç­‰åŒ…ï¼Œå®ƒæ˜¯æ€ä¹ˆå¤„ç†çš„å‘¢ï¼Ÿ

é¦–å…ˆï¼Œæˆ‘ä»¬äº†è§£ä¸€ä¸‹æ­£å¸¸ä½¿ç”¨ NPM å®‰è£…ã€å…±äº«ã€å‘åŒ…çš„æµç¨‹ï¼š

![å›¾ç‰‡æºè‡ªâ€œåä¸‰æœˆâ€](https://upload-images.jianshu.io/upload_images/5128488-a1f56efef3addbe8.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

å½“æˆ‘ä»¬ä½¿ç”¨ `npm` æˆ– `yarn` å»å®‰è£…ä¸€ä¸ªæ¨¡å—ï¼ˆåŒ…ï¼‰æ—¶ï¼Œå…ˆæ£€æŸ¥ `node_modules` ç›®å½•æ˜¯å¦å·²ç»ç¼“å­˜äº†è¯¥æ¨¡å—ï¼Œå¦‚æœæ²¡æœ‰ä¾¿ä¼šå‘ NPM å¹³å°æŸ¥è¯¢ã€‚

NPM æä¾›äº†ä¸€ä¸ªæ¨¡å—ä¿¡æ¯æŸ¥è¯¢æœåŠ¡ï¼Œé€šè¿‡è®¿é—®ï¼š

```
registry.npmjs.org/packaename/version
```

å°±å¯ä»¥æŸ¥åˆ°æŸä¸ªå‘å¸ƒåœ¨ NPM å¹³å°ä¸Šæ¨¡å—çš„å…·ä½“ä¿¡æ¯ï¼Œä»¥åŠä¸‹è½½åœ°å€ã€‚ç„¶åä¸‹è½½å¹¶è§£å‹åˆ°æœ¬åœ°å®Œæˆå®‰è£…ã€‚

**å¦‚æœæˆ‘ä»¬å¯ç”¨äº†ç§æœ‰ NPM æœåŠ¡å™¨ï¼Œæµç¨‹åˆæœ‰ä»€ä¹ˆå˜åŒ–å‘¢ï¼Ÿ**

![å›¾ç‰‡æºè‡ªâ€œåä¸‰æœˆâ€](https://upload-images.jianshu.io/upload_images/5128488-705906644e16e575.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)


å½“æˆ‘ä»¬å¯åŠ¨ Verdaccio æ—¶ï¼Œå¯ä»¥çœ‹åˆ°é…ç½®æ–‡ä»¶æ˜¯åœ¨ç”¨æˆ·æ ¹ç›®å½•ä¸‹çš„ï¼š`~/.config/verdaccio/config.yaml`ã€‚

```yaml
#
# é…ç½®æ–‡ä»¶ï¼ˆè¿™é‡Œæˆ‘åˆ é™¤äº†ä¸€äº›é»˜è®¤æ³¨è§£ï¼‰
# æ›´å¤šè¯·çœ‹: https://github.com/verdaccio/verdaccio/blob/master/packages/config/src/conf/default.yaml
#

# ä¸Šä¼ çš„æ‰€æœ‰åŒ…å­˜æ”¾ç›®å½•
storage: ./storage
# æ’ä»¶ç›®å½•
plugins: ./plugins

# web æœåŠ¡ï¼Œå³æˆ‘ä»¬å¯ä»¥é€šè¿‡ web æŸ¥çœ‹æˆ‘ä»¬ä¸Šä¼ çš„åŒ…ã€‚
web:
  title: Verdaccio
  # ä¸€äº›å…³äº web é¡µé¢çš„é…ç½®é¡¹ï¼Œæˆ‘åˆ æ‰äº†

# éªŒè¯ä¿¡æ¯
auth:
  htpasswd:
    # ç”¨æˆ·ä¿¡æ¯å­˜å‚¨ç›®å½•
    file: ./htpasswd

# å…¬æœ‰ä»“åº“é…ç½®
uplinks:
  npmjs:
    # é»˜è®¤
    # url: https://registry.npmjs.org/
    # æˆ‘ä»¬å¯ä»¥æ”¹æˆæ·˜å®é•œåƒæº
    url: https://registry.npm.taobao.org/

packages:
  '@*/*':
    # scoped packages
    access: $all
    publish: $authenticated
    unpublish: $authenticated
    # ä»£ç†ã€‚å½“æˆ‘ä»¬å®‰è£…ä¸€äº›ç§æœ‰æœåŠ¡å™¨ä¸Šæ²¡æœ‰çš„åŒ…æ—¶ï¼Œå®ƒå°±ä¼šå¾€è¿™é‡Œæ‰¾ï¼Œå³ä¸Šé¢çš„ uplinks é…ç½®
    proxy: npmjs

  '**':
    # ä¸‰ç§è§’è‰²ï¼šæ‰€æœ‰äººã€åŒ¿åç”¨æˆ·ã€è®¤è¯ï¼ˆç™»å½•ï¼‰ç”¨æˆ·
    # "$all", "$anonymous", "$authenticated"

    # å¯è®¿é—®åŒ…è§’è‰²
    access: $all

    # å¯å‘åŒ…ã€æ’¤åŒ…è§’è‰²
    publish: $authenticated
    unpublish: $authenticated

    # if package is not available locally, proxy requests to 'npmjs' registry
    proxy: npmjs

# æœåŠ¡è¿æ¥æ´»è·ƒæ—¶é—´
server:
  keepAliveTimeout: 60

middlewares:
  audit:
    enabled: true
```

## å…­ã€å‚è€ƒ

* [å‰ç«¯è¿ç»´éƒ¨ç½²é‚£äº›äº‹](https://zhuanlan.zhihu.com/p/368784910)
* [å¦‚ä½•æ­å»ºä¸€ä¸ªç§æœ‰ npm æœåŠ¡å™¨](http://auan.cn/internet/2010.html)
* [å†™ç»™å‰ç«¯å·¥ç¨‹å¸ˆçœ‹çš„è¿ç»´å’Œæ¶æ„](https://www.cnblogs.com/scoluo/p/7453485.html)
* [ä½ çœŸçš„æ‡‚ npm publish ï¼Ÿ](https://juejin.cn/post/6844904037377114119)
