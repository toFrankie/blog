---
title: ä»é›¶åˆ°ä¸€æ­å»º react é¡¹ç›®ç³»åˆ—ä¹‹ï¼ˆåäºŒï¼‰
number: '#65'
link: 'https://github.com/toFrankie/blog/issues/65'
created_at: '2023-02-25 19:47:01'
updated_at: '2024-04-17 15:10:43'
labels:
  - React
  - '2020'
---
æ­¤å‰è®²è§£ react-routerã€reduxã€react-reduxã€redux-saga æ‰€æ¶‰åŠçš„å†…å®¹è¾ƒå¤šï¼Œç¯‡å¹…ä¹Ÿè¾ƒé•¿ã€‚ç»ˆäºå¯ä»¥ä»‹ç» HMR æ¨¡å—çƒ­æ›´æ–°ã€‚

å…¶å®æ­¤å‰å·²ç»ä»‹ç»è¿‡äº†ï¼Œä½†ä»Šå¤©å°±ç»“åˆ React æ­å»ºæ›´å‹å¥½çš„çƒ­æ›´æ–°æ•ˆæœã€‚

### ä¸€ã€HMR å®ç°

æ­¤å‰æ˜¯æ€ä¹ˆåšçš„å‘¢ï¼Ÿ

> å½“ç„¶è¿™ç§æ–¹å¼æ˜¯æ²¡æœ‰é’ˆå¯¹ä½¿ç”¨ React åšä¼˜åŒ–å¤„ç†çš„ã€‚

```js
// webpack.config.js
modules.exports = {
  mode: 'develop',
  devServer: {
    // éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¦å®Œå…¨å¯ç”¨ HMRï¼Œéœ€è¦ webpack.HotModuleReplacementPlugin
    hot: true
  },
  optimization: {
    // å‘ŠçŸ¥ webpack ä½¿ç”¨å¯è¯»å–æ¨¡å—æ ‡è¯†ç¬¦ï¼Œæ¥å¸®åŠ©æ›´å¥½åœ°è°ƒè¯•ã€‚å¼€å‘æ¨¡å¼é»˜è®¤å¼€å¯ã€‚ç®€å•æ¥è¯´ï¼Œå¼€å¯æ—¶ä½ çœ‹åˆ°çš„æ˜¯ä¸€ä¸ªå…·ä½“çš„æ¨¡å—åç§°ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªæ•°å­— idã€‚
    namedModules: true
  },
  plugins: [
    // é€šè¿‡å®ƒå¯ç”¨ HMRï¼Œé‚£ä¹ˆå®ƒçš„æ¥å£å°†è¢«æš´éœ²åœ¨ module.hot å±æ€§ä¸‹é¢ã€‚
    new webpack.HotModuleReplacementPlugin()
  ],
  module: {
    rules: [
      {
        // æ ·å¼çƒ­æ›´æ–°ï¼Œå€ŸåŠ©äº style-loaderï¼Œå…¶å®å¹•åä½¿ç”¨äº† module.hot.accept
        test: /\.css/,
        use: ['style-loader', 'css-loader']
      }
    ]
  }
}
```
æˆ‘ä»¬è¿˜éœ€åœ¨å…¥å£æ–‡ä»¶æ·»åŠ  `module.hot.accpet()` æ–¹æ³•ã€‚
```jsx
// index.js
import React from 'react'
import { render } from 'react-dom'
import '../styles/style.css'
import Root from './Root'

// æœ€ç®€å•çš„ React ç¤ºä¾‹
const rootElem = document.getElementById('app')
render(<Root />, rootElem)

// é€šå¸¸ï¼Œå…ˆæ£€æŸ¥ HotModuleReplacementPlugin æš´éœ²çš„æ¥å£æ˜¯å¦å¯è®¿é—®ï¼Œç„¶åå†å¼€å§‹ä½¿ç”¨å®ƒã€‚
if (module.hot) {
  // accept æ–¹æ³•æ¥å—ç»™å®šçš„ä¾èµ–æ¨¡å—çš„æ›´æ–°ï¼Œå¹¶è§¦å‘ä¸€ä¸ªå›è°ƒå‡½æ•°æ¥å¯¹è¿™äº›æ›´æ–°åšå‡ºå“åº”ã€‚
  module.hot.accept('./Root', () => {
    import('./Root.js').then(module => {
      const NextRoot = module.default
      render(<NextRoot/>, rootElem)
    })
  })
}
```
> éœ€è¦æ³¨æ„çš„æ˜¯ï¼š
> åŸå…ˆçš„ ~~`new webpack.NameModulesPlugin()`~~ åœ¨ webpack 4 ä¸­å·²åºŸå¼ƒï¼Œå–ä»£å®ƒçš„æ˜¯ `optimization.nameModules`ã€‚å¼€å‘æ¨¡å¼ä¸‹é»˜è®¤å¼€å¯ï¼Œç”Ÿäº§æ¨¡å¼ä¸‹ï¼Œé»˜è®¤å…³é—­ã€‚å…³äºå¼€å¯ä¸ç¦ç”¨ï¼Œæœ€ç›´è§‚çš„åŒºåˆ«å¦‚ä¸‹å›¾ã€‚

å°è¯•éšä¾¿ä¿®æ”¹ä¸€ä¸‹ Home ç»„ä»¶ï¼Œçœ‹åˆ°æ§åˆ¶å°çš„è¾“å‡ºï¼ˆå¦‚ä¸‹å›¾ï¼‰ï¼Œä¸¤è€…åŒºåˆ«ä¸åŒã€‚å¼€å¯æ—¶ï¼Œèƒ½çœ‹åˆ°å…·ä½“æ¶‰åŠæ›´æ–°çš„æ¨¡å—æœ‰å“ªäº›ï¼Œè€Œå…³é—­çŠ¶æ€åˆ™æ˜¯åªèƒ½çœ‹åˆ°ä¸€ä¸ªæ•°å­— idã€‚
![å…³é—­çŠ¶æ€](https://upload-images.jianshu.io/upload_images/5128488-4e4b45bc3f9290e0.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

![å¼€å¯çŠ¶æ€](https://upload-images.jianshu.io/upload_images/5128488-9b5a63d1cf3759cf.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

### äºŒã€HMR æ­é… React çš„ä¸è¶³

ä¸Šé¢çš„æ–¹å¼ï¼Œå¦‚æœæ­é… React ä½¿ç”¨çš„è¯ï¼Œå…¶å®è¿˜ä¸å¤Ÿå‹å¥½ã€‚

> ç”¨ä¸€ä¸ªæœ€ç®€å•çš„ä¾‹å­è¯´æ˜é—®é¢˜


```jsx
// ä¸€ä¸ªéå¸¸ç®€å•çš„æœ‰çŠ¶æ€ç»„ä»¶
import React, { Component } from 'react'

class HMRDemo extends Component {
  constructor(props) {
    super(props)
    this.state = {
      count: 0
    }
  }

  render() {
    return (
      <div>
        <h3>HMR Demo Component!</h3>
        <h5>è®¡æ•°å™¨ï¼š{this.state.count}</h5>
        <button onClick={() => { this.setState({ count: ++this.state.count }) }}>add</button>
      </div>
    )
  }
}

export default HMRDemo
```
è¿™æ—¶å€™æˆ‘ä»¬ç‚¹å‡»æŒ‰é’®ï¼Œç„¶åç»„ä»¶çŠ¶æ€ `count` è‡ªç„¶å˜æˆäº† `1`ï¼Œè¿™ä¸ªæ²¡é—®é¢˜ã€‚æ¥ç€ï¼Œæˆ‘ä»¬éšæ„å¢åŠ ä¸€ä¸ªæ ‡ç­¾å…ƒç´ ï¼Œç„¶åé¡µé¢è‡ªç„¶ä¼šçƒ­æ›´æ–°ï¼Œä½†æ˜¯æˆ‘ä»¬çœ‹åˆ°ï¼Œ`count` åˆå˜æˆäº† `0`ï¼Œç»„ä»¶çŠ¶æ€ä¸¢å¤±äº†ï¼Œå¦‚ä¸‹å›¾ï¼š
![](https://upload-images.jianshu.io/upload_images/5128488-9dee05e9af81faa4.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)


æˆ‘ä»¬äº«å—ç€ HMR ç»™æˆ‘ä»¬å¼€å‘å¸¦æ¥çš„ä¾¿åˆ©ï¼Œä½†åŒæ—¶æˆ‘ä»¬åˆä¸æƒ³ä¸¢å¤± Component State ç»„ä»¶çŠ¶æ€ï¼Œæ€ä¹ˆåšå‘¢ï¼Ÿ

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œ[React Hot Loader](https://github.com/gaearon/react-hot-loader) å‡ºç°äº†ã€‚

### ä¸‰ã€React Hot Loader

å…ˆçœ‹ä¸€ä¸‹å®˜æ–¹æŒ‡å—çš„ä¸€æ®µ[åŸè¯](https://github.com/gaearon/react-hot-loader)ï¼š
> **React-Hot-Loader is expected to be replaced byÂ React Fast Refresh**. Please remove React-Hot-Loader if Fast Refresh is currently supported on your environment.

å¤§æ¦‚çš„æ„æ€æ˜¯ï¼Œreact-hot-loader å°†ä¼šè¢« [React Fast Refresh](https://github.com/facebook/react/issues/16604) å–ä»£ã€‚å¦‚æœæ‚¨å½“å‰çš„ç¯å¢ƒæ”¯æŒçš„è¯ï¼Œè¯·ç§»é™¤ react-hot-loaderã€‚

*è‡³äº React Fast Refresh æ˜¯ä»€ä¹ˆï¼Ÿå¦‚ä½•ä½¿ç”¨ï¼Ÿè¿™é‡Œä¸å±•å¼€è¿°è¯´ï¼Œå¯ä»¥çœ‹ä¸€ä¸‹å…¶ä»–äººå†™çš„ä¸€ç¯‡[æ–‡ç« ](https://segmentfault.com/a/1190000023534941)ã€‚

**ç»§ç»­ä»‹ç» react-hot-loaderï¼Œè¿˜éœ€è¦åœ¨ä¸Šé¢çš„åŸºç¡€ä¸Šï¼Œæ·»åŠ ä»¥ä¸‹é…ç½®ã€‚**

1. å®‰è£…ä¾èµ–åŒ…
```shell
$ yarn add --dev react-hot-loader@4.12.19
# ä¸‹é¢æ­¥éª¤ç”¨åˆ°
$ yarn add --dev @hot-loader@react-dom@16.12.0
```
> `@hot-loader/react-dom` æ˜¯åœ¨ `react-dom` ç›¸åŒç‰ˆæœ¬çš„åŸºç¡€ä¸Šï¼Œæ·»åŠ äº†ä¸€äº›æ”¯æŒçƒ­æ›´æ–°çš„è¡¥ä¸ã€‚æ‰€ä»¥éœ€è¦å®‰è£…ä¸ `react-dom` ä¸€è‡´çš„ç‰ˆæœ¬ã€‚
2. æ·»åŠ  `react-hot-loader/babel` åˆ° `.babelrc` é…ç½®ä¸­ã€‚
```json5
// .babelrc
{
  "plugins": [
    "react-hot-loader/babel"
  ]
}
```

3. å°†æ ¹ç»„ä»¶æ ‡è®°ä¸ºçƒ­å¯¼å‡ºï¼ˆ**hot-exported**ï¼‰
```jsx
import React from 'react'
import { Provider } from 'react-redux'
import { hot } from 'react-hot-loader/root'
import App from './pages/App'
import store from './store'

const Root = () => {
  return (
    <Provider store={store}>
      <App />
    </Provider>
  )
}

export default hot(Root)

// æ¸©é¦¨æç¤º
// å…³äºæ–° API ğŸ‘‰ hot æ˜¯ä½äº '/root' ä¸‹é¢çš„ï¼Œä½†å¹¶ä¸æ˜¯æ‰€æœ‰çš„æ‰“åŒ…å·¥å…·éƒ½æ”¯æŒè¯¥æ–° APIã€‚æ¯”å¦‚ parcel å°±ä¸æ”¯æŒã€‚
// æ­¤æ—¶ react-hot-loader å°±ä¼šæŠ›å‡ºé”™è¯¯ï¼Œå¹¶è¦æ±‚ä½ ä½¿ç”¨æ—§çš„ APIï¼Œæ–¹æ³•å¦‚ä¸‹ï¼š
// 
// import { hot } from 'react-hot-loader'
// export default hot(module)(App)
```

4. ç¡®ä¿åœ¨  `react` å’Œ `react-dom` ä¹‹å‰å¯¼å…¥ `react-hot-loader`ï¼Œä¸¤ç§æ–¹å¼å¯é€‰æ‹©ï¼š
* åœ¨å…¥å£æ–‡ä»¶å¯¼å…¥ `import react-hot-loader`ï¼ˆè¦åœ¨ React ä¹‹å‰ï¼‰
* åœ¨ webpack é…ç½®æ–‡ä»¶çš„ `entry` é…ç½® `react-hot-loader/patch`ã€‚

```js
// webpack.config.js
{
  entry: [
    'react-hot-loader/patch',
    './src/js/index.js'
  ]
}
```
> éœ€è¦æ³¨æ„çš„æ˜¯ï¼š`react-hot-loader/patch` ä¸€å®šè¦å†™åœ¨ `entry` çš„æœ€å‰é¢ã€‚å¦‚æœæœ‰ `babel-polyfill` å°±å†™åœ¨ `babel-polyfill` çš„åé¢ã€‚

5. ä½¿ç”¨ React Hooks éœ€è¦ç”¨åˆ° `@hot-loader/react-dom`ã€‚åŒæ—¶ï¼Œå°±ä»¥ä¸Šé…ç½®é‡æ–°å¯åŠ¨ï¼Œæ­¤æ—¶æ§åˆ¶å°ä¼šæ‰“å°ä¸€ä¸ª WARNINGï¼Œå¦‚ä¸‹ï¼š
> React-Hot-Loader: react-ğŸ”¥-dom patch is not detected. React 16.6+ features may not work. ([Issue #1227](https://github.com/gaearon/react-hot-loader/issues/1227)ï¼‰

è§£å†³æ–¹æ¡ˆä¹‹ä¸€ï¼Œå¦ä¸€ç§å¯ä»¥çœ‹ä¸‹ [ISSUE #1227](https://github.com/gaearon/react-hot-loader/issues/1227)ã€‚
```js
// webpack.config.js
{
  resolve: {
    alias: {
      'react-dom': '@hot-loader/react-dom'
    }
  }
}
```


æµ‹è¯•ä¸€ä¸‹ï¼Œåˆ†åˆ«ä¸¤æ¬¡ç‚¹å‡» add åï¼Œå†æ·»åŠ ä¸€ä¸ªèŠ‚ç‚¹å…ƒç´ ï¼Œå‘ç° Component State æ˜¯åœ¨æˆ‘ä»¬é¢„æœŸä¹‹å†…çš„ï¼Œå¹¶æ²¡æœ‰åƒä¹‹å‰ä¸€æ ·å› ä¸ºçƒ­æ›´æ–°è€Œä¸¢å¤±çŠ¶æ€ã€‚

![ğŸ‰](https://upload-images.jianshu.io/upload_images/5128488-a054411625690610.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

### å››ã€è‡³æ­¤

å…³äº **Hot Module Replacement** æ¨¡å—çƒ­æ›¿æ¢ï¼ˆçƒ­æ›´æ–°ï¼‰åŸºæœ¬å°±ä»‹ç»å®Œäº†ã€‚

å‰é¢æˆ‘ä»¬æåˆ°ä¸€ä¸ª [React Fast Refresh](https://github.com/facebook/react/issues/16604) æ¦‚å¿µï¼Œå®ƒç”±å®˜æ–¹ç»´æŠ¤ï¼Œç¨³å®šæ€§ä¸æ€§èƒ½æœ‰ä¿éšœï¼Œå¯¹ React Hooks æœ‰æ›´å®Œå–„çš„æ”¯æŒã€‚å®˜æ–¹å®ç°æ˜¯ `react-refresh`ã€‚

åé¢æœ‰æ—¶é—´çš„è¯ï¼Œåº”è¯¥ä¼šå†™ä¸€ç¯‡å…³äºå®ƒçš„æ–‡ç« ã€‚ä½†æ˜¯ï¼Œå®ƒæœ€ä½æ”¯æŒç‰ˆæœ¬æ˜¯ `react-dom@16.9+`ã€‚

The end.
