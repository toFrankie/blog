---
title: ä»é›¶åˆ°ä¸€æ­å»º react é¡¹ç›®ç³»åˆ—ä¹‹ï¼ˆå…«ï¼‰
number: '#61'
link: 'https://github.com/toFrankie/blog/issues/61'
created_at: '2023-02-25 19:39:36'
updated_at: '2023-04-26 21:49:09'
labels:
  - React
  - '2020'
---
ä¸ºäº†æ–¹ä¾¿ä½¿ç”¨ï¼Œ Redux çš„ä½œè€…å°è£…äº†ä¸€ä¸ª React ä¸“ç”¨çš„ [React-Redux](https://github.com/reactjs/react-redux) åº“ã€‚

æœ¬ç¯‡å†…å®¹ä¸»è¦å‚è€ƒè‡ªé˜®ä¸€å³°è€å¸ˆçš„[æ–‡ç« ](http://www.ruanyifeng.com/blog/2016/09/redux_tutorial_part_three_react-redux.html)ã€‚

### React-Redux

å®ƒå°†ç»„ä»¶åˆ†æˆä¸¤ç±»ï¼šUI ç»„ä»¶ï¼ˆpresentational componentï¼‰å’Œå®¹å™¨ç»„ä»¶ï¼ˆcontainer componentï¼‰ã€‚

##### 1. UI ç»„ä»¶
```jsx
const Title = <h3>Title</h3>
```
ä¸»è¦æœ‰ä»¥ä¸‹å‡ ä¸ªç‰¹å¾ï¼š
>* åªè´Ÿè´£ UI çš„å‘ˆç°ï¼Œä¸å¸¦æœ‰ä»»ä½•ä¸šåŠ¡é€»è¾‘ã€‚
>* æ²¡æœ‰çŠ¶æ€ã€‚ï¼ˆå³æ²¡æœ‰ this.state è¿™ä¸ªå˜é‡ï¼‰
>* æ‰€æœ‰æ•°æ®ç”±å‚èµ›ï¼ˆthis.propsï¼‰æä¾›ã€‚
>* ä¸ä½¿ç”¨ä»»ä½• Redux çš„ APIã€‚

##### 2. å®¹å™¨ç»„ä»¶
ä¸ UI ç»„ä»¶ç›¸åï¼Œå®ƒçš„ç‰¹å¾ä¸»è¦æœ‰ï¼š

>* è´Ÿè´£ç®¡ç†æ•°æ®å’Œä¸šåŠ¡é€»è¾‘ï¼Œä¸è´Ÿè´£ UI çš„å‘ˆç°ã€‚
>* å¸¦æœ‰å†…éƒ¨çŠ¶æ€ã€‚
>* ä½¿ç”¨ Redux çš„ APIã€‚

##### 3. æˆ‘ä»¬å¸¸è§çš„æ˜¯å®¹å™¨ç»„ä»¶ + UI ç»„ä»¶
è®°ä½å°±å¥½äº†ï¼šUI ç»„ä»¶è´Ÿè´£ UI çš„å‘ˆç°ï¼Œå®¹å™¨ç»„ä»¶è´Ÿè´£ç®¡ç†æ•°æ®å’Œé€»è¾‘ã€‚

å½“åŒæ—¶å­˜åœ¨ UI ç»„ä»¶å’Œå®¹å™¨ç»„ä»¶æ—¶ï¼Œæˆ‘ä»¬å°†é‡‡ç”¨å®¹å™¨ç»„ä»¶åŒ…è£¹ UI ç»„ä»¶çš„ç­–ç•¥ï¼Œå‰è€…è´Ÿè´£ä¸å¤–éƒ¨é€šä¿¡ï¼Œå°†æ•°æ®ä¼ é€’ç»™åè€…ï¼Œç”±åè€…æ¸²æŸ“å‡ºè§†å›¾ã€‚

React-Redux è§„å®šï¼Œæ‰€æœ‰çš„ UI ç»„ä»¶éƒ½ç”±ç”¨æˆ·æä¾›ï¼Œå®¹å™¨ç»„ä»¶åˆ™æ˜¯ç”± React-Redux è‡ªåŠ¨ç”Ÿæˆã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œç”¨æˆ·è´Ÿè´£è§†è§‰å±‚ï¼ŒçŠ¶æ€ç®¡ç†åˆ™æ˜¯å…¨éƒ¨äº¤ç»™å®ƒã€‚

### React-Redux API

##### 1. connect()
React-Redux æä¾›çš„ `connect()` æ–¹æ³•ï¼Œç”¨äºä» UI ç»„ä»¶ç”Ÿæˆå®¹å™¨ç»„ä»¶ã€‚ä»å­—é¢ç†è§£çš„è¯ï¼Œå°±æ˜¯å°†ä¸¤ç§ç»„ä»¶è¿èµ·æ¥ã€‚
```jsx
import { connect } from 'react-redux'
const VisibleTodoList = connect()(TodoList)

// TodoList æ˜¯ UI ç»„ä»¶
// VisibleTodoList æ˜¯ç”± React-Redux é€šè¿‡ `connect` æ–¹æ³•ç”Ÿæˆçš„å®¹å™¨ç»„ä»¶
```
ä¸Šè¿°æ¡ˆä¾‹ï¼Œå¹¶æ²¡æœ‰å®šä¹‰ä¸šåŠ¡é€»è¾‘ï¼Œå®ƒæ²¡æœ‰ä»»ä½•æ„ä¹‰ã€‚

ä¸ºäº†å®šä¹‰ä¸šåŠ¡é€»è¾‘ï¼Œéœ€è¦ç»™å‡ºä¸¤æ–¹é¢çš„ä¿¡æ¯
> (1) è¾“å…¥é€»è¾‘ï¼š å¤–éƒ¨çš„æ•°æ®ï¼ˆå³ `state` å¯¹è±¡ï¼‰å¦‚ä½•è½¬æ¢ä¸º UI ç»„ä»¶çš„å‚æ•°ã€‚
> (2) è¾“å‡ºé€»è¾‘ï¼š ç”¨æˆ·å‘å‡ºçš„åŠ¨ä½œå¦‚ä½•å˜ä¸º `Action` å¯¹è±¡ï¼Œä» UI ç»„ä»¶ä¼ å‡ºå»ã€‚

`connect()` å®Œæ•´ API å¦‚ä¸‹ï¼š
```jsx
import { connect } from 'react-redux'
const VisibleTodoList = connect(mapStateToProps, mapDispatchToProps)(TodoList)

// connect æ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼šmapStateToProps å’Œ mapDispatchToPropsã€‚
// å‰è€…è´Ÿè´£è¾“å…¥é€»è¾‘ï¼Œå³å°† state æ˜ å°„åˆ° UI ç»„ä»¶çš„å‚æ•°ï¼ˆpropsï¼‰ã€‚
// åè€…è´Ÿè´£è¾“å‡ºé€»è¾‘ï¼Œå³å°†ç”¨æˆ·å¯¹ UI ç»„ä»¶çš„æ“ä½œæ˜ å°„æˆ Actionã€‚
```

##### 2. mapStateToProps

å®ƒæ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œä½œç”¨æ˜¯å»ºç«‹ä¸€ä¸ªä»ï¼ˆå¤–éƒ¨çš„ï¼‰ `state` å¯¹è±¡åˆ°ï¼ˆUI ç»„ä»¶çš„ï¼‰ `props` å¯¹è±¡çš„æ˜ å°„å…³ç³»ã€‚

ä½œä¸ºå‡½æ•°ï¼Œ`mapStateToProps` æ‰§è¡Œååº”è¯¥è¿”å›ä¸€ä¸ªå¯¹è±¡ï¼Œé‡Œé¢çš„æ¯ä¸€ä¸ªé”®å€¼å¯¹å°±æ˜¯ä¸€ä¸ªæ˜ å°„ã€‚

```jsx
const mapStateToProps = (state, ownProps) => {
  return {
    // ...
  }
}

// mapStateToProps æ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼Œå¹¶ä¸”è¿”å›ä¸€ä¸ªå¯¹è±¡
// state å°±æ˜¯æˆ‘ä»¬ store çš„å…¨å±€çŠ¶æ€
// ownProps æ˜¯å®¹å™¨ç»„ä»¶çš„ props å¯¹è±¡ã€‚ä½¿ç”¨å®ƒä¹‹åï¼Œå¦‚æœå®¹å™¨ç»„ä»¶çš„å‚æ•°å‘é€å˜åŒ–ï¼Œä¹Ÿä¼šå¼•å‘ UI ç»„ä»¶é‡æ–°æ¸²æŸ“ã€‚
```
`mapStateToProps` ä¼šè®¢é˜… `Store`ï¼Œæ¯å½“ `state` æ›´æ–°æ—¶ï¼Œå°±ä¼šè‡ªåŠ¨æ‰§è¡Œï¼Œé‡æ–°è®¡ç®— UI ç»„ä»¶çš„å‚æ•°ï¼Œä»è€Œè§¦å‘ UI ç»„ä»¶çš„é‡æ–°æ¸²æŸ“ã€‚

`connect` æ–¹æ³•å¯ä»¥çœç•¥ `mapStateToProps` å‚æ•°ï¼Œè¿™æ ·çš„è¯ï¼ŒUI ç»„ä»¶å°±ä¸ä¼šè®¢é˜… `Store`ï¼Œå³ `Store` çš„æ›´æ–°ä¸ä¼šå¼•å‘ UI ç»„ä»¶çš„æ›´æ–°ã€‚

##### 3. mapDispatchToProps

å®ƒæ˜¯ `connect` æ–¹æ³•çš„ç¬¬äºŒä¸ªå‚æ•°ï¼Œç”¨äºå»ºç«‹ UI ç»„ä»¶çš„å‚æ•°åˆ° `store.dispatch` æ–¹æ³•çš„æ˜ å°„ã€‚å³å°† `Action` ç»‘å®šåˆ° UI ç»„ä»¶çš„ `props` å¯¹è±¡ä¸Šã€‚

ï¼ˆ1ï¼‰`mapDispatchToProps` æ˜¯å‡½æ•°æ—¶ï¼Œä¼šå¾—åˆ° `dispatch` å’Œ `ownProps` ä¸¤ä¸ªå‚æ•°ã€‚
ï¼ˆ2ï¼‰`mapDispatchToProps` æ˜¯å¯¹è±¡æ—¶ï¼Œå®ƒæ¯ä¸ªé”®åå¯¹åº” UI ç»„ä»¶çš„åŒåå‚æ•°ï¼Œé”®å€¼åº”è¯¥æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œä¼šè¢«å½“åš `Action Creator`ï¼Œè¿”å›çš„ `Action` ä¼šç”± `Redux` å­—æ®µå‘å‡ºã€‚

```jsx
// å‡½æ•°
const mapDispatchToProps = (
  dispatch,
  ownProps
) => {
  return {
    onClick: () => {
      dispatch({
        type: 'SET_VISIBILITY_FILTER',
        filter: ownProps.filter
      })
    }
  }
}

// å¯¹è±¡
const mapDispatchToProps = {
  onClick: (filter) => {
    type: 'SET_VISIBILITY_FILTER',
    filter: filter
  }
}
```
### <Provider> ç»„ä»¶

`connect()` æ–¹æ³•ç”Ÿæˆå®¹å™¨ç»„ä»¶ä»¥åï¼Œéœ€è¦è®©å®¹å™¨ç»„ä»¶æ‹¿åˆ° `state` å¯¹è±¡ï¼Œæ‰èƒ½ç”Ÿæˆ UI ç»„ä»¶çš„å‚æ•°ã€‚

ä¸€ç§è§£å†³æ–¹æ³•æ˜¯å°† `state` å¯¹è±¡ä½œä¸ºå‚æ•°ï¼Œä¼ å…¥å®¹å™¨ç»„ä»¶ã€‚ä½†æ˜¯ï¼Œè¿™æ ·åšæ¯”è¾ƒéº»çƒ¦ï¼Œå°¤å…¶æ˜¯å®¹å™¨ç»„ä»¶å¯èƒ½åœ¨å¾ˆæ·±çš„å±‚çº§ï¼Œä¸€çº§ä¸€çº§å°† `state` ä¼ ä¸‹å»å°±å¾ˆéº»çƒ¦ã€‚

React-Redux æä¾›äº† `Provider` ç»„ä»¶ï¼Œå¯ä»¥è®©å®¹å™¨ç»„ä»¶æ‹¿åˆ° `state`ã€‚

```jsx
import { Provider } from 'react-redux'
import { createStore } from 'redux'
import todoApp from './reducers'
import App from './components/App'

let store = createStore(todoApp)

render(
  <Provider store={store}>
    <App />
  </Provider>,
  document.getElementById('root')
)
```

ä¸Šè¿°ä»£ç ä¸­ï¼Œ`Provider` åœ¨æ ¹ç»„ä»¶å¤–é¢åŒ…äº†ä¸€å±‚ï¼Œè¿™æ ·ä¸€æ¥ï¼Œ`App` çš„æ‰€æœ‰å­ç»„ä»¶å°±é»˜è®¤éƒ½å¯ä»¥æ‹¿åˆ° `state` äº†ã€‚

å®ƒçš„åŸç†æ˜¯ React ç»„ä»¶çš„ [context](https://facebook.github.io/react/docs/context.html) å±æ€§ï¼Œè¯·çœ‹æºç ï¼š
```jsx
class Provider extends Component {
  getChildContext() {
    return {
      store: this.props.store
    }
  }
  render() {
    return this.props.children
  }
}

Provider.childContextTypes = {
  store: React.PropTypes.object
}
```
ä¸Šé¢çš„ä»£ç ä¸­ï¼Œ`store` æ”¾åœ¨äº†ä¸Šä¸‹æ–‡å¯¹è±¡ `context` ä¸Šé¢ã€‚ç„¶åï¼Œå­ç»„ä»¶å°±å¯ä»¥ä» `context` æ‹¿åˆ°  `store`ï¼Œä»£ç å¤§è‡´å¦‚ä¸‹ï¼š
```jsx
class VisibleTodoList extends Component {
  componentDidMount() {
    const { store } = this.context
    this.unsubscribe = store.subscribe(() =>
      this.forceUpdate()
    )
  }

  render() {
    const props = this.props
    const { store } = this.context
    const state = store.getState()
    // ...
  }
}

VisibleTodoList.contextTypes = {
  store: React.PropTypes.object
}
```
React-Redux è‡ªåŠ¨ç”Ÿæˆçš„å®¹å™¨ç»„ä»¶çš„ä»£ç ï¼Œå°±ç±»ä¼¼ä¸Šé¢è¿™æ ·ï¼Œä»è€Œæ‹¿åˆ° `store`ã€‚

### React-Redux ç®€å•æ¡ˆä¾‹

é¦–å…ˆï¼Œä¸Šè¿°çš„ä»£ç ä¸æœ¬é¡¹ç›®æ²¡æœ‰å…³è”ï¼Œå…¶å®åªæ˜¯ä¸ºäº†è®²è§£ React-Redux ç›¸å…³ API çš„ä½¿ç”¨ã€‚

ä¸‹é¢æˆ‘ä»¬å°†ç»“åˆæˆ‘ä»¬é¡¹ç›®æ¥å®ç°ä¸€ä¸ªç®€å•çš„æ¡ˆä¾‹ã€‚
##### 1. å®‰è£… react-redux
```shell
$ yarn add react-redux@7.1.3
```
##### 2. ä½¿ç”¨ Provider åŒ…è£¹æˆ‘ä»¬çš„æ ¹ç»„ä»¶ App
```jsx
// pages/Root.js
import React from 'react'
import { Provider } from 'react-redux'
import App from './pages/App'
import store from './store'

const Root = () => {
  return (
    <Provider store={store}>
      <App />
    </Provider>
  )
}

export default Root
```
##### 3. è°ƒæ•´æˆ‘ä»¬çš„ store ä»¥åŠ reducer
å®é™…æƒ…å†µä¸‹ï¼Œ`store` åº”è¯¥æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå› ä¸ºå®ƒå­˜å‚¨çš„æ•°æ®å¯èƒ½ä¼šå¾ˆå¤šå¾ˆå¤æ‚ã€‚æ­¤å‰ä¸ºäº†ç”¨æœ€ç®€å•æ¡ˆä¾‹æ¥è®²è§£ storeï¼Œæ‰€ä»¥æˆ‘ä»¬å°†å®ƒè®¾ç½®ä¸ºä¸€ä¸ª `Number` ç±»å‹çš„å€¼ã€‚

ä¸‹é¢æˆ‘ä»¬ä¿®æ”¹ä¸€ä¸‹ï¼Œåˆå§‹å€¼è®¾ç½®ä¸º `{ count: 0 }`ï¼Œå¹¶ä¿®æ”¹ `reducer` å¤„ç†å‡½æ•°ã€‚
```jsx
// store/index.js
import { createStore } from 'redux'

// Reducer å¤„ç†å‡½æ•°
const reducer = (prevState, action) => {
  const { type, payload } = action
  switch (type) {
    case 'ADD':
      // ä¸€å®šè¦ä¸èƒ½ä¿®æ”¹ stateï¼Œè€Œæ˜¯è¿”å›ä¸€ä¸ªæ–°çš„å‰¯æœ¬
      // å€˜è‹¥ state æ˜¯å¼•ç”¨æ•°æ®ç±»å‹ï¼Œä¸€å®šè¦å€ŸåŠ© Object.assignã€å¯¹è±¡å±•å¼€è¿ç®—ç¬¦(...)ã€å…¶ä»–åº“çš„æ‹·è´æ–¹æ³•æˆ–è€…è‡ªå·±å®ç°æ·±æ‹·è´æ–¹æ³•ï¼Œè¿”å›ä¸€ä¸ªæ–°å‰¯æœ¬
      return { ...prevState, count: prevState.count + payload }
    case 'SUB':
      return { ...prevState, count: prevState.count - payload }
    default:
      // default æˆ–è€…æœªçŸ¥ action æ—¶ï¼Œè¿”å›æ—§çš„ state
      return prevState
  }
}

// åˆå§‹åŒ–å€¼
const initialState = { count: 0 }

// åˆ›å»º Storeï¼ˆä¹Ÿå¯ä»¥ä¸ä¼ å…¥ initialState å‚æ•°ï¼Œè€Œå°† reducer ä¸­çš„ state è®¾ç½®ä¸€ä¸ªåˆå§‹å€¼ï¼‰
const store = createStore(reducer, initialState)

// ç›‘å¬ state å˜åŒ–
// const unsubscribe = store.subscribe(() => {
//   console.log('ç›‘å¬ state å˜åŒ–', store.getState())
// })

// è§£é™¤ç›‘å¬
// unsubscribe()

export default store
```

##### 4. æˆ‘ä»¬åœ¨ Home ç»„ä»¶å¼•å…¥ connect æ–¹æ³•
```jsx
// pages/home/index.js
import React, { Component } from 'react'
import { connect } from 'react-redux';
import store from '../../store'

class Home extends Component {
  constructor(props) {
    super(props)
    this.state = {}
  }

  handle(type, val) {
    this.props.simpleDispatch(type, val)
    // è·å– State å¿«ç…§
    console.log(`å½“å‰æ“ä½œæ˜¯ ${type}ï¼Œcount ä¸ºï¼š${store.getState().count}`)
  }

  render() {
    return (
      <div>
        <h3>Home Component!</h3>
        {/* å°† state å±•ç¤ºåˆ°é¡µé¢ä¸Š */}
        <h5>countï¼š{this.props.count}</h5>
        <button onClick={this.handle.bind(this, 'ADD', 1)}>åŠ ä¸€</button>
        <button onClick={this.handle.bind(this, 'SUB', 1)}>å‡ä¸€</button>
      </div>
    )
  }
}

// å°† count æ˜ å°„åˆ° Home ç»„ä»¶çš„ props å±æ€§ä¸Šï¼Œé€šè¿‡ this.props.count å³å¯è®¿é—®åˆ°å®ƒã€‚
const mapStateToProps = (state, ownProps) => {
  return { count: state.count }
}

// åŒç†ï¼Œå®ƒå°† simpleDispatch æ˜ å°„åˆ°ç»„ä»¶çš„ props å±æ€§ä¸Šï¼Œé€šè¿‡ this.props.simpleDispatch è®¿é—®å¹¶ç”± Redux å‘å‡ºä¸€ä¸ª Actionã€‚
const mapDispatchToProps = (dispatch, ownProps) => {
  return {
    simpleDispatch: (type, payload) => {
      dispatch({ type, payload })
    }
  }
}

// è‹¥å¿½ç•¥ mapStateToProps å‚æ•°ï¼Œstore çš„æ›´æ–°å°†ä¸ä¼šè§¦å‘ç»„ä»¶é‡æ–°æ¸²æŸ“
// è‹¥å¿½ç•¥ mapDispatchToProps å‚æ•°ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œstore.dispatch ä¼šæ³¨å…¥ç»„ä»¶ props ä¸­ã€‚
// è‹¥æŒ‡å®šäº†ï¼Œä½ å°±ä¸èƒ½é€šè¿‡ this.props.dispatch æ¥å‘å‡º Action äº†ã€‚
export default connect(mapStateToProps, mapDispatchToProps)(Home)
```
##### 5. æ•ˆæœ
æˆ‘ä»¬çœ‹åˆ°äº† `store` çš„å˜åŒ–ï¼Œå°†ä¼šåæ˜ åˆ°é¡µé¢ä¸Šã€‚
![ğŸ‰](https://upload-images.jianshu.io/upload_images/5128488-339485faff8348e5.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

### è‡³æ­¤

æˆ‘ä»¬çš„ Redux æœ€ç®€å•çš„ç¯å¢ƒå·²ç»æ­å»ºå¥½äº†ï¼Œä½ å­¦ä¼šäº†å—ï¼Ÿä½†æ˜¯ï¼Œå®é™…é¡¹ç›®ä¸­ï¼Œè¿™å¯èƒ½è¿œè¿œä¸å¤Ÿ...

è¿™é‡ŒæŠ›å‡ºå‡ ä¸ªé—®é¢˜ï¼š

* å¤§å‹åº”ç”¨çš„ Reducer ä¸ä¼šé‚£ä¹ˆç®€å•ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¦‚ä½•æ‹†åˆ†å‘¢ï¼Ÿ
* å¦‚ä½•è®© Reducer åœ¨å¼‚æ­¥æ“ä½œç»“æŸä¹‹åï¼Œè‡ªåŠ¨æ‰§è¡Œå‘¢ï¼Ÿ
* å¦‚ä½•åˆ©ç”¨ä¸€äº›ç¬¬ä¸‰æ–¹åº“æˆ–è€…æ’ä»¶æ¥è§‚å¯Ÿ store çš„å˜åŒ–ï¼Ÿ

1. æ‹†åˆ† Reducer æˆ‘ä»¬ä½¿ç”¨ Redux æä¾›çš„ `combineReducers` æ¥å¤„ç†ã€‚

2. è§£å†³å¼‚æ­¥æ“ä½œè‡ªåŠ¨æ‰§è¡Œ Reducer çš„ä¸­é—´ä»¶å¸¸ç”¨çš„ç”¨ `redux-thunk`ã€`redux-promise`ã€`redux-saga` ç­‰ã€‚æˆ‘ä»¬é¡¹ç›®å°†ä¼šé‡‡ç”¨ `redux-sage`ï¼Œåç»­æ–‡ç« ä¼šè®²è§£ã€‚

3. è§‚å¯Ÿ store å¯ä»¥åˆ©ç”¨ `redux-logger` ä¸­é—´ä»¶æˆ–è€… Redux DevTools æµè§ˆå™¨æ’ä»¶ï¼ˆGoogle Chrome æµè§ˆå™¨çš„è¯éœ€è¦ç§‘å­¦ä¸Šç½‘ä¸‹è½½ï¼‰ã€‚

ç”±äºæœ¬æ–‡ç¯‡å¹…ä»¥åŠå¾ˆé•¿äº†ï¼Œå°±ä¸‹ä¸€ç¯‡æ¥ä»‹ç»å§ã€‚
