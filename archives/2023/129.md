---
title: å°† CSScomb é›†æˆåˆ° Git Hook ä¸­
number: '#129'
link: 'https://github.com/toFrankie/blog/issues/129'
created_at: '2023-02-25 21:30:24'
updated_at: '2023-04-26 22:11:28'
labels:
  - ç¼–ç è§„èŒƒ
  - '2021'
---
åœ¨æ­¤å‰æ–‡ç« ä»‹ç»äº†å¦‚ä½•åœ¨å¾®ä¿¡å°ç¨‹åºä¸­ä½¿ç”¨ CSScomb æ¥å¤„ç†æˆ‘ä»¬çš„å°ç¨‹åºæ ·å¼æ–‡ä»¶ã€‚

> æ–‡ç« æœ‰ä¸¤ç¯‡ï¼š
> 1. [å°† CSScomb é›†æˆåˆ°å¾®ä¿¡å°ç¨‹åºé¡¹ç›®ä¸­](https://github.com/toFrankie/blog/issues/128)
> 2. [å°† CSScomb é›†æˆåˆ° Git Hook ä¸­](https://github.com/toFrankie/blog/issues/129)ï¼ˆæœ¬æ–‡ï¼‰
>
> é¡¹ç›®æ”¾åœ¨ GitHub ä¸Š ğŸ‘‰ [csscomb-mini](https://github.com/toFrankie/csscomb-mini) æ¬¢è¿ Star ğŸ‘‹ã€‚


ä½†æ˜¯æ­¤å‰å®ç°æœ‰ä¸ªä¸è¶³çš„åœ°æ–¹ï¼š**æ²¡æœ‰å®ç°åœ¨æäº¤ä»£ç ä¹‹å‰å»æ‰§è¡Œæˆ‘ä»¬çš„è„šæ­¥å‘½ä»¤ã€‚**

### ä¸€ã€è®¾æƒ³
å‡è®¾æˆ‘ä»¬å¯ä»¥åœ¨ `pre-commit` é˜¶æ®µåšä¸€äº›ç±»ä¼¼ ESLintã€Prettier çš„æ“ä½œï¼Œå²‚ä¸ç¾å“‰ï¼

ä¾‹å¦‚ï¼Œå¦‚ä¸‹é…ç½®æ–‡ä»¶æ˜¯åˆ©ç”¨ huskyã€lint-staged åšäº†ä¸€äº›å¤„ç†ï¼Œåœ¨ä»£ç  commit ä¹‹å‰å¯¹ä»£ç è¿›è¡Œæ£€æŸ¥å’Œæ ¼å¼åŒ–ã€‚

```json5
{
  "husky": {
    "hooks": {
      "pre-commit": "lint-staged"
    }
  },
  "lint-staged": {
    "*.{js}": "eslint --fix --ext .js",
    "*.{css,wxss,acss}": "prettier --config .prettierrc.js --write"
  }
}
```

é‚£æˆ‘ä»¬ä½¿ç”¨ CSScomb ä¹Ÿæƒ³è¿™ä¹ˆåšçš„è¯ï¼Œè¦æ€æ ·å®ç°å‘¢ï¼Ÿ

### äºŒã€è¯•å›¾å®ç°


å…³äºå‰ä¸€ç¯‡æ–‡ç« çš„å…·ä½“æ€è·¯å°±ä¸å†èµ˜è¿°äº†ï¼ˆéœ€è¦çš„è¯ï¼Œè¯·çœ‹[å®ç°ä¸€ä¸ª CSScomb çš„ Gulp æ’ä»¶å¹¶åº”ç”¨äºå¾®ä¿¡å°ç¨‹åº](https://www.jianshu.com/p/7c3ce9be7341) ï¼‰ã€‚

1. é¦–å…ˆå®‰è£… huskyã€lint-stagedã€‚

å¦‚æœå¯¹ä¸¤è€…ä¸å¤ªäº†è§£çš„è¯ï¼Œå¯ä»¥å»çœ‹æˆ‘å†™çš„å¦å¤–ä¸€ç¯‡[æ–‡ç« ](https://github.com/toFrankie/blog/issues/124)ã€‚

```
# è¿™é‡Œæˆ‘ä¸å®‰è£…æœ€æ–°ç‰ˆ husky çš„åŸå› æ˜¯ husky 5.x åœ¨ä½¿ç”¨ä¸Šæœ‰å¾ˆå¤§å˜åŒ–
# æˆ‘æš‚æ—¶è¿˜æ²¡æ—¶é—´å»äº†è§£å®ƒï¼Œæ‰€ä»¥å…ˆç”¨ç€å·²ç»ä¹ æƒ¯çš„ 4.x ç‰ˆæœ¬ï¼Œé—®é¢˜ä¸å¤§
$ yarn add --dev husky@4.3.8 lint-staged
```

2. åœ¨ `package.json` æ·»åŠ é…ç½®ï¼Œå¦‚ä¸‹ï¼š

```json5
{
  "scripts": {
    "csscomb": "gulp wxssTask",
    "csscomb:mini": "gulp csscombTask --path './**/*.wxss'"
  },
  "husky": {
    "hooks": {
      "pre-commit": "lint-staged"
    }
  },
  "lint-staged": {
    "*.wxss": "gulp csscombTask"
  }
}
```

3. æ¥ç€ï¼Œæˆ‘ä»¬å°è¯•å»ä¿®æ”¹ä¸€ä¸ªæ ·å¼æ–‡ä»¶ï¼Œå¹¶æäº¤ä»£ç ã€‚

```shell
$ git commit -m 'test'
                                                                                                          
husky > pre-commit (node v14.16.0)
âœ” Preparing...
âš  Running tasks...
  â¯ Running tasks for *.wxss
    âœ– gulp csscombTask [FAILED]
â†“ Skipped because of errors from tasks. [SKIPPED]
âœ” Reverting to original state because of errors...
âœ” Cleaning up...

âœ– gulp csscombTask:
[14:30:14] Task never defined: /Users/frankie/Desktop/Web/Git/csscomb-mini/app.wxss
[14:30:14] To list available tasks, try running: gulp --tasks
[14:30:14] Using gulpfile ~/Desktop/Web/Git/csscomb-mini/gulpfile.js
husky > pre-commit hook failed (add --no-verify to bypass)
```

éå¸¸çš„é—æ†¾ï¼Œå®ƒå¤±è´¥äº†ï¼Œå¹¶æç¤ºï¼š`Task never defined: /Users/frankie/Desktop/Web/Git/csscomb-mini/app.wxss`ã€‚

æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼Œæ˜æ˜æ˜¯æ‰¾å¾—åˆ° `csscombTask` ä»»åŠ¡çš„å•Šï¼

```shell
$ npx gulp --tasks

[14:35:09] Tasks for ~/Desktop/Web/Git/csscomb-mini/gulpfile.js
[14:35:09] â”œâ”€â”€ wxssTask
[14:35:09] â””â”€â”€ csscombTask
```

ä¸ºä»€ä¹ˆä¼šè¿™æ ·å‘¢ï¼Ÿä»€ä¹ˆåŸå› å‘¢ï¼Ÿè¿™ä¹Ÿæ˜¯æˆ‘çš„è¸©å‘çš„åœ°æ–¹ã€‚

### ä¸‰ã€å¯»æ‰¾å¤±è´¥åŸå› 

é¦–å…ˆï¼Œæˆ‘å…ˆç¿»é˜…äº† lint-staged çš„[æ–‡æ¡£](https://github.com/okonet/lint-staged#lintstagedrc-example) ï¼Œé‡Œé¢æœ‰ä¸€æ®µè¯ï¼š

```json
{
  "*": "your-cmd"
}
```

This config will execute `your-cmd` with the list of currently staged files passed as arguments.

So, considering you did `git add file1.ext file2.ext`, lint-staged will run the following command: `your-cmd file1.ext file2.ext`.

å‡è®¾æˆ‘ä»¬æš‚å­˜çš„æ–‡ä»¶æ˜¯ `/Users/frankie/Desktop/Web/Git/csscomb-mini/app.wxss`ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ‰§è¡Œï¼š

```json
{
  "*.wxss": "gulp csscombTask"
}
```

å°±ç­‰äºæ‰§è¡Œäº† `gulp csscombTask /Users/frankie/Desktop/Web/Git/csscomb-mini/app.wxss` è¿™æ¡æŒ‡ä»¤ã€‚

ä½†å¦‚æœç†Ÿæ‚‰ [Gulp](https://www.gulpjs.com.cn/docs/getting-started/quick-start/#æµ‹è¯•) çš„è¯ï¼Œå½¢å¼å¦‚ï¼š`gulp <task> <othertask>` å…¶å®æ˜¯æ‰§è¡Œäº†å¤šä¸ªä»»åŠ¡ã€‚ æ‰€ä»¥ï¼Œä¸Šé¢å®é™…ä¸Šæ‰§è¡Œäº†ä¸¤ä¸ªä»»åŠ¡ `csscombTask`ã€`/Users/frankie/Desktop/Web/Git/csscomb-mini/app.wxss`ï¼Œå®ƒæŠŠåè€…ä¹Ÿå½“æˆæ˜¯ä¸€ä¸ªä»»åŠ¡äº†ã€‚

é‚£ä¹ˆæˆ‘ä»¬æ¥éªŒè¯ä¸€ä¸‹ï¼Œæ·»åŠ ä¸€ä¸ª Gulp ä»»åŠ¡ï¼š

```js
const test = cb => {
  // éœ€è¦æ³¨æ„çš„æ˜¯ï¼š
  // ç”±äº node ç‰¹æ€§ï¼Œéä¸»è¿›ç¨‹ä¸‹æ‰§è¡Œè¯¥å‘½ä»¤ï¼Œæ— æ³•å°† test log æ‰“å°å‡ºæ¥ï¼Œ
  // ä¾‹å¦‚åœ¨ lint-staged ä¸‹æ‰§è¡Œè¯¥ gulp ä»»åŠ¡ï¼Œå°±æ— æ³•æ‰“å°ï¼Œ
  // å¦‚æœé€šè¿‡ npx gulp xxx æ‰§è¡Œä»»åŠ¡ï¼Œå±äºä¸»è¿›ç¨‹ï¼Œå°±èƒ½æ‰“å°å‡ºæ¥ã€‚
  console.log('test log')
  cb()
}

module.exports = {
  csscombTask,
  '/Users/frankie/Desktop/Web/Git/csscomb-mini/app.wxss': test
}
```

æ¥ç€é‡æ–°æäº¤ä¸€ä¸‹ä»£ç ï¼š

```shell
$ git commit -m 'test'

husky > pre-commit (node v14.16.0)
âœ” Preparing...
âœ” Running tasks...
âœ” Applying modifications...
âœ” Cleaning up...
[master a2ba057] test
 1 file changed, 3 insertions(+), 3 deletions(-)
```

å®ƒæˆåŠŸäº†ï¼Œè¯´æ˜æˆ‘ä»¬çš„çŒœæƒ³æ˜¯æ­£ç¡®çš„ã€‚

æ—¢ç„¶æ‰¾åˆ°äº†ç¼˜ç”±ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¼€å§‹ç€æ‰‹è§£å†³é—®é¢˜å§ã€‚

### å››ã€è§£å†³é—®é¢˜

å…¶å® `/Users/frankie/Desktop/Web/Git/csscomb-mini/app.wxss` åº”è¯¥æ˜¯æˆ‘ä»¬ Gulp ä»»åŠ¡çš„å‚æ•°æ‰å¯¹ã€‚

æŒ‰ç…§æ­¤å‰çš„çº¦å®šï¼š

```shell
gulp csscombTask --path '<filepath>' --ext <extension>
```

æ‰€ä»¥åªè¦æˆ‘ä»¬æ‰§è¡Œçš„å‘½ä»¤å½¢å¼å¦‚ï¼š`gulp csscombTask --path '/Users/frankie/Desktop/Web/Git/csscomb-mini/app.wxss'` å³å¯ã€‚

æˆ‘ä»¬æ¥ä¿®æ”¹ä¸€ä¸‹ lint-staged çš„é…ç½®æ–‡ä»¶ï¼Œæ­¤å‰åœ¨ `package.json` çš„é…ç½®æ–¹å¼å±€é™æ€§å¤ªå¤§äº†ï¼Œä¸‹é¢æˆ‘ä»¬ä½¿ç”¨ JavaScript å½¢å¼çš„é…ç½®æ–¹å¼ï¼š

> Writing the configuration file in JavaScript is the most powerful way to configureÂ *lint-staged*Â (`lint-staged.config.js`,Â [similar](https://github.com/okonet/lint-staged#configuration), or passed viaÂ `--config`).

å…¶å® lint-staged æä¾›äº†å¾ˆå¤šçš„é…ç½®ç¤ºä¾‹ï¼Œæˆ‘ä»¬ä½¿ç”¨ [Example: Wrap filenames in single quotes and run once per file](https://github.com/okonet/lint-staged#example-wrap-filenames-in-single-quotes-and-run-once-per-file) å³å¯ã€‚

ç§»é™¤ `package.json` çš„é…ç½®é¡¹ï¼Œå¹¶åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹ï¼Œæ–°å»º `.lintstagedrc.js` é…ç½®æ–‡ä»¶ï¼š

```js
// .lintstagedrc.js
module.exports = {
  '*.wxss': filenames => filenames.map(filename => `gulp csscombTask --path ${filename}`)
}

// å…¶å®è¿™é‡Œå¯é…ç½®çš„æ–¹å¼å¾ˆå¤šï¼Œ
// ä¾‹å¦‚ï¼šè¶…è¿‡ 10 ä¸ªæš‚å­˜æ–‡ä»¶æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æ•´ä¸ªé¡¹ç›®ä¸‹æ‰§è¡Œä¸€é csscombTask æ“ä½œï¼š
// module.exports = {
//   '*.wxss': filenames => {
//     if (filenames.length > 10) {
//       return 'gulp csscombTask --path './**/*.wxss''
//     }
//     return `gulp csscombTask --path '${filenames.join(',')'}`
//   }
// }
```

æ¥ä¸‹æ¥æˆ‘ä»¬ä¿®æ”¹ä¸¤ä¸ªæ ·å¼æ–‡ä»¶ï¼Œå†æäº¤ä¸€ä¸‹ï¼š

```shell
$ git commit -m 'test'

husky > pre-commit (node v14.16.0)
âœ” Preparing...
âœ” Running tasks...
âœ” Applying modifications...
âœ” Cleaning up...
[master 7b84b9c] test
 2 files changed, 7 insertions(+), 3 deletions(-)
```
å¯ä»¥æ­£å¸¸è¿è¡Œï¼Œè€Œä¸”æˆ‘ä»¬æ‰€æäº¤çš„æ–‡ä»¶éƒ½ç»è¿‡äº† CSScomb æ ¼å¼åŒ–äº†ï¼ŒğŸ‰ğŸ‰ğŸ‰ã€‚

The end.


