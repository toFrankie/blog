---
title: JavaScript çš„è¿·æƒ‘è¡Œä¸ºå¤§èµ
number: '#234'
link: 'https://github.com/toFrankie/blog/issues/234'
created_at: '2023-02-26 19:00:53'
updated_at: '2024-04-14 19:44:11'
labels:
  - JS
  - '2021'
---
ä»Šå¤©æ¥èŠä¸€èŠ JavaScript ä¸­è®©äººæ‘¸ä¸ç€å¤´çš„è®¾è®¡å¤±è¯¯ã€‚

Brendan Eich åœ¨ 1995 å¹´åŠ å…¥ Netscape å…¬å¸ï¼Œå½“æ—¶ Netscape å’Œ Sun åˆä½œå¼€å‘ä¸€ä¸ªå¯è¿è¡Œåœ¨æµè§ˆå™¨ä¸Šçš„ç¼–ç¨‹è¯­è¨€ï¼Œå½“æ—¶ JavaScript çš„å¼€å‘ä»£å·æ˜¯ Mochaã€‚Brendan Eich èŠ±äº† 10 å¤©å®Œæˆäº†ç¬¬ä¸€ç‰ˆçš„ JavaScriptã€‚

ç”±äºè®¾è®¡æ—¶é—´å¤ªçŸ­ï¼Œè¯­è¨€çš„ä¸€äº›ç»†èŠ‚è€ƒè™‘å¾—ä¸å¤Ÿä¸¥è°¨ï¼Œä¸€äº›å› ä¸å¯æŠ—å› ç´ è€Œæ— æ³•ä¿®å¤çš„ bugï¼ŒåŠ ä¹‹åæ¥å¡«å‘è¿‡ç¨‹ä¸­æ–°æŒ–çš„å‘ï¼Œæ€»ä¹‹å¼€å‘è€…è¡¨ç¤ºå¾ˆçƒ¦...

ä¸€èµ·çœ‹ä¸‹ JavaScript è®¾è®¡çš„ã€Œå‘ã€æœ‰å“ªäº›ï¼Ÿ

## ä¸€ã€typeof null === 'object'

è¿™æ˜¯ä¸€ä¸ªä¼—æ‰€å‘¨çŸ¥çš„å¤±è¯¯ã€‚

å¯¹äºåˆšæ¥è§¦ JavaScript çš„æœ‹å‹ï¼Œæœ‰å¯èƒ½ä¼šç›´è§‰æ€§åœ°ã€é”™è¯¯åœ°è®¤ä¸º `typeof null === 'null'`ï¼Œè¿™æ˜¯ä¸å¯¹çš„ã€‚

> `typeof null === 'object'` çš„ â€œbugâ€ å…¶å®æ˜¯ç¬¬ä¸€ç‰ˆ JavaScript å°±å­˜åœ¨äº†ï¼Œéšç€ JavaScript çš„æµè¡Œï¼Œå¾ˆå¤šäººæè®®ä¿®å¤è¿™ä¸ª bugï¼Œä½†è¢«æ‹’ç»äº†ï¼Œå› ä¸ºä¿®æ”¹å®ƒæ„å‘³ç€ä¼šç ´åç°æœ‰çš„ä»£ç ã€‚å†å²åŸå› å¯ä»¥çœ‹ä¸‹è¿™ç¯‡æ–‡ç« ï¼š[The history of â€œtypeof nullâ€](https://2ality.com/2013/10/typeof-null.html)ã€‚

åœ¨ JavaScript ä¸­ï¼Œæ•°æ®ç±»å‹åœ¨åº•å±‚éƒ½æ˜¯ä»¥äºŒè¿›åˆ¶å½¢å¼è¡¨ç¤ºçš„ã€‚åœ¨åˆç‰ˆ JavaScript ä¸­ï¼Œä»¥ 32 ä½ä¸ºå•ä½å­˜å‚¨ä¸€ä¸ªå€¼ï¼Œå…¶ä¸­åŒ…æ‹¬ä¸€ä¸ªç±»å‹æ ‡è®°ï¼ˆ1-3 ä½ï¼‰å’Œè¯¥å€¼çš„å®é™…æ•°æ®ã€‚ç±»å‹æ ‡è®°å­˜å‚¨åœ¨å•å…ƒçš„ä½ä½ã€‚å…¶ä¸­æœ‰äº”ä¸ªï¼š

* `000`ï¼šobjectï¼Œæ•°æ®æ˜¯ä¸€ä¸ªå¯¹è±¡çš„å¼•ç”¨ã€‚
* `1`ï¼šintï¼Œæ•°æ®æ˜¯ä¸€ä¸ª 31 ä½æœ‰ç¬¦å·æ•´æ•°ã€‚
* `010`ï¼šdoubleï¼Œæ•°æ®æ˜¯ä¸€ä¸ªåŒç²¾åº¦æµ®ç‚¹æ•°ã€‚
* `100`ï¼šstringï¼Œæ•°æ®æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²
* `110`ï¼šbooleanï¼Œæ•°æ®æ˜¯ä¸€ä¸ªå¸ƒå°”å€¼ã€‚

ä¹Ÿå°±æ˜¯è¯´ï¼Œæœ€ä½ä½å¦‚æœæ˜¯ 1ï¼Œé‚£ä¹ˆç±»å‹æ ‡è®°é•¿åº¦åªæœ‰ 1 ä½ï¼›å¦‚æœæœ€ä½ä½æ˜¯ 0ï¼Œé‚£ä¹ˆç±»å‹æ ‡è®°é•¿åº¦ä¸º 3 ä½ï¼Œä¸ºå››ç§ç±»å‹æä¾›ä¸¤ä¸ªé™„åŠ ä½ã€‚

æœ‰ä¸¤ä¸ªç‰¹æ®Šçš„å€¼ï¼š

* `undefined`ï¼ˆJSVAL_VOIDï¼‰æ˜¯æ•´æ•° âˆ’2^30^ï¼ˆæ•´æ•°èŒƒå›´ä¹‹å¤–çš„æ•°å­—ï¼‰
* `null`ï¼ˆJSVAL_NULLï¼‰æ˜¯æœºå™¨ç ç©ºæŒ‡é’ˆã€‚æˆ–ï¼šä¸€ä¸ªå¯¹è±¡ç±»å‹æ ‡è®°åŠ ä¸Šä¸€ä¸ªé›¶çš„å¼•ç”¨ã€‚(`null` äºŒè¿›åˆ¶è¡¨ç¤ºå…¨æ˜¯ 0)

ç°åœ¨æˆ‘ä»¬çŸ¥é“ä¸ºä»€ä¹ˆ `typeof` ä¼šè®¤ä¸º `null` æ˜¯ä¸€ä¸ªå¯¹è±¡äº†ï¼Œå®ƒæ£€æŸ¥äº† `null` çš„ç±»å‹æ ‡è®°ï¼Œä¸”ç±»å‹æ ‡è®°è¡¨ç¤º `object`ã€‚ä»¥ä¸‹æ˜¯è¯¥å¼•æ“çš„ `typeof` ä»£ç ã€‚

```c
JS_PUBLIC_API(JSType)
JS_TypeOfValue(JSContext *cx, jsval v)
{
  JSType type = JSTYPE_VOID;
  JSObject *obj;
  JSObjectOps *ops;
  JSClass *clasp;

  CHECK_REQUEST(cx);
  if (JSVAL_IS_VOID(v)) { // (1)
    type = JSTYPE_VOID;
  } else if (JSVAL_IS_OBJECT(v)) { // (2)
    obj = JSVAL_TO_OBJECT(v);
    if (obj &&
      (ops = obj -> map -> ops,
        ops == & js_ObjectOps
          ? (clasp = OBJ_GET_CLASS(cx, obj),
            clasp -> call || clasp == & js_FunctionClass) // (3,4)
          : ops -> call != 0)) { // (3)
      type = JSTYPE_FUNCTION;
    } else {
      type = JSTYPE_OBJECT;
    }
  } else if (JSVAL_IS_NUMBER(v)) {
    type = JSTYPE_NUMBER;
  } else if (JSVAL_IS_STRING(v)) {
    type = JSTYPE_STRING;
  } else if (JSVAL_IS_BOOLEAN(v)) {
    type = JSTYPE_BOOLEAN;
  }
  return type;
}
```
ä¸Šé¢çš„ä»£ç æ‰§è¡Œçš„æ­¥éª¤æ˜¯ï¼š

* åœ¨ï¼ˆ1ï¼‰é¦–å…ˆæ£€æŸ¥å€¼ `v` æ˜¯å¦ `undefined`ï¼ˆVOIDï¼‰ã€‚é€šè¿‡ `==` æ¯”è¾ƒå€¼æ˜¯å¦ç›¸åŒï¼š

```c
#define JSVAL_IS_VOID(v)  ((v) == JSVAL_VOID)
```
* ä¸‹ä¸€ä¸ªæ£€æŸ¥ï¼ˆ2ï¼‰æ˜¯è¯¥å€¼æ˜¯å¦å…·æœ‰å¯¹è±¡æ ‡è®°ã€‚å¦‚æœå®ƒå¦å¤–å¯ä»¥è°ƒç”¨ï¼ˆ3ï¼‰æˆ–å®ƒçš„å†…éƒ¨å±æ€§ `[[Class]]` å°†å…¶æ ‡è®°ä¸ºä¸€ä¸ªå‡½æ•°ï¼ˆ4ï¼‰ï¼Œåˆ™ `v` æ˜¯ä¸€ä¸ªå‡½æ•°ã€‚å¦åˆ™ï¼Œå®ƒæ˜¯ä¸€ä¸ªå¯¹è±¡ã€‚è¿™æ˜¯ç”± `typeof null` äº§ç”Ÿçš„ç»“æœã€‚
* éšåçš„æ£€æŸ¥æ˜¯æ•°å­—ï¼Œå­—ç¬¦ä¸²å’Œå¸ƒå°”å€¼ã€‚ç”šè‡³æ²¡æœ‰æ˜¾å¼çš„ `null` æ£€æŸ¥ï¼Œå¯ä»¥ç”±ä»¥ä¸‹ C å®æ‰§è¡Œã€‚

```c
#define JSVAL_IS_NULL(v)  ((v) == JSVAL_NULL)
```
è¿™ä¼¼ä¹æ˜¯ä¸€ä¸ªéå¸¸æ˜æ˜¾çš„é”™è¯¯ï¼Œä½†è¯·ä¸è¦å¿˜è®°ï¼Œåªæœ‰å¾ˆå°‘çš„æ—¶é—´æ¥å®Œæˆ JavaScript çš„ç¬¬ä¸€ä¸ªç‰ˆæœ¬ã€‚

> Brendan Eich åœ¨ Twitter è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ª [abstraction leak](https://twitter.com/BrendanEich/status/617450289889607681)ï¼Œå¯ç†è§£ä¸ºå˜ç›¸æ‰¿è®¤è¿™æ˜¯ä»£ç çš„ bugã€‚
> 
> null means "no object", undefined =>"no value". Really it's an abstraction leak: null and objects shared a Mocha type tag.

ä¸‹é¢åˆ—å‡ºå„ç§æ•°æ®ç±»å‹ `typeof` å¯¹åº”çš„ç»“æœï¼š

| Operand | Result |
| :---: | :---: |
| undefinded | "undefined" |
| null | "object" |
| Boolean value | "boolean" |
| Number value | "number" |
| BigInt value (ES11) | "bigint" |
| String value | "string" |
| Symbol value (ES6) | "symbol" |
| å®¿ä¸»å¯¹è±¡ï¼ˆç”± JS ç¯å¢ƒæä¾›ï¼‰| å–å†³äºå…·ä½“å®ç° |
| Function | "function" |
| All other values | "object" |

> typeof returning "object" for null is a bug. It canâ€™t be fixed, because that would break existing code. Note that a function is also an object, but typeof makes a distinction. Arrays, on the other hand, are considered objects by it.

[æŸæ–‡ç« ](https://zhuanlan.zhihu.com/p/143590829)è¡¨ç¤ºï¼š

åœ¨ JavaScript V8 å¼•æ“ä¸­ï¼Œé’ˆå¯¹ `typeof null === 'object'` è¿™ç§â€œä¸è§„èŒƒâ€æƒ…å†µï¼Œå¯¹ `null` æå‰åšäº†ä¸€å±‚åˆ¤æ–­ã€‚å‡è®¾åœ¨ V8 ä¸­æŠŠè¿™è¡Œä»£ç åˆ æ‰ï¼Œ `typeof null` ä¼šè¿”å› `undefined`ã€‚

```
GotoIf(InstanceTypeEqual(instance_type, ODDBALL_TYPE), &if_oddball);
```

å¥½äº†ï¼Œå…³äº `typeof null === 'object'` çš„è¯é¢˜å‘Šä¸€æ®µè½ã€‚

## äºŒã€typeof NaN === 'number'

ä¸ç¡®å®šè¿™ä¸ªç®—ä¸ç®—ä¸€ä¸ªè®¾è®¡å¤±è¯¯ï¼Œä½†æ¯«æ— ç–‘é—®è¿™æ˜¯åç›´è§‰çš„ã€‚

> å…³äº NaNï¼Œè¿˜æœ‰ä¸€äº›å¾ˆæœ‰è¶£çš„çŸ¥è¯†ç‚¹ï¼Œæ¨èä¸€ä¸ª Slideï¼Œéå¸¸å€¼å¾—ä¸€çœ‹ï¼š[Idiosyncrasies of NaN v2](https://speakerdeck.com/lewisjellis/idiosyncrasies-of-nan-v2)ã€‚

## ä¸‰ã€NaNã€isNaN()ã€Number.isNaN()

åœ¨ JavaScript ä¸­ï¼ŒNaN æ˜¯ä¸€ä¸ªçœ‹èµ·æ¥å¾ˆè«åå…¶å¦™çš„å­˜åœ¨ã€‚å½“ç„¶ NaN ä¸æ˜¯åªæœ‰ JavaScript æ‰å­˜åœ¨çš„ã€‚å…¶ä»–è¯­è¨€ä¹Ÿæ˜¯æœ‰çš„ã€‚

> æˆ‘è§‰å¾—åº”è¯¥æ˜¯è¿™æ ·ï¼š"NaN" actually stands for "Not a NaN".

### 1. NaN

`NaN` æ˜¯ä¸€ä¸ªå…¨å±€å¯¹è±¡å±æ€§ï¼Œå…¶å±æ€§çš„åˆå§‹å€¼å°±æ˜¯ `NaN`ï¼Œå’ŒÂ `Number.NaN`çš„å€¼ä¸€æ ·ã€‚


**`NaN` æ˜¯ JavaScript ä¸­å”¯ä¸€ä¸€ä¸ªä¸ç­‰äºè‡ªèº«çš„å€¼**ã€‚è™½ç„¶è¿™ä¸ªè®¾è®¡å…¶å®ç†ç”±å¾ˆå……åˆ†ï¼ˆå‚ç…§å‰é¢æ¨èçš„é‚£ä¸ª Slideï¼Œåœ¨ IEEE 754 è§„èŒƒä¸­æœ‰éå¸¸å¤šçš„äºŒè¿›åˆ¶åºåˆ—éƒ½å¯ä»¥è¢«å½“åš `NaN`ï¼Œæ‰€ä»¥ä»»æ„è®¡ç®—å‡ºä¸¤ä¸ª `NaN`ï¼Œå®ƒä»¬åœ¨äºŒè¿›åˆ¶è¡¨ç¤ºä¸Šå¾ˆå¯èƒ½ä¸åŒï¼‰ï¼Œä½†ä¸ç®¡æ€æ ·ï¼Œè¿™ä¸ªè¿˜æ˜¯éå¸¸å€¼å¾—åæ§½...

```js
NaN == NaN // false
NaN === NaN // false
Number.NaN === NaN // false
```

### 2. isNaN()

`isNaN()` æ˜¯å…¨å±€å¯¹è±¡æä¾›çš„ä¸€ä¸ªæ–¹æ³•ï¼Œå®ƒçš„å‘½åå’Œè¡Œä¸ºéå¸¸è®©äººè´¹è§£ï¼š 
* å®ƒå¹¶ä¸åªæ˜¯ç”¨æ¥åˆ¤æ–­ä¸€ä¸ªå€¼æ˜¯å¦ä¸º `NaN`ï¼Œå› ä¸ºæ‰€æœ‰å¯¹äºæ‰€æœ‰éæ•°å­—ç±»å‹çš„å€¼å®ƒä¹Ÿè¿”å› `true`ï¼›
* ä½†ä¹Ÿä¸èƒ½è¯´å®ƒæ˜¯ç”¨æ¥åˆ¤æ–­ä¸€ä¸ªå€¼æ˜¯å¦ä¸ºæ•°å€¼çš„ï¼Œå› ä¸ºæ ¹æ®å‰æ–‡ï¼Œ`NaN` çš„ç±»å‹æ˜¯ `number`ï¼Œåº”å½“è¢«è®¤ä¸ºæ˜¯ä¸€ä¸ªæ•°å€¼ã€‚

`isNaN()` æ–¹æ³•ï¼Œå½“å‚æ•°å€¼æ˜¯ `NaN` æˆ–è€…å°†å‚æ•°è½¬æ¢ä¸ºæ•°å­—çš„ç»“æœä¸º `NaN`ï¼Œåˆ™è¿”å› `true`ï¼Œå¦åˆ™è¿”å› `false`ã€‚å› æ­¤ï¼Œå®ƒä¸èƒ½ç”¨æ¥åˆ¤æ–­æ˜¯å¦ä¸¥æ ¼ç­‰äº `NaN`ã€‚

```js
isNaN(NaN) // true
isNaN('hello world') // true
```

### 3. Number.isNaN()

ES6 æä¾›äº† `Number.isNaN()` æ–¹æ³•ï¼Œç”¨äºåˆ¤æ–­ä¸€ä¸ªå€¼æ˜¯å¦ä¸¥æ ¼ç­‰äº `NaN`ï¼Œç»ˆäºæ˜¯æ‹¨ä¹±åæ­£äº†ã€‚

å’Œå…¨å±€å‡½æ•° `isNaN()` ç›¸æ¯”ï¼Œ`Number.isNaN()` ä¸ä¼šè‡ªè¡Œå°†å‚æ•°è½¬æ¢æˆæ•°ç»„ï¼Œå®ƒä¼šå…ˆåˆ¤æ–­å‚æ•°æ˜¯å¦ä¸ºæ•°å­—ç±»å‹ï¼Œå¦‚ä¸æ˜¯æ•°å­—ç±»å‹åˆ™ç›´æ¥è¿”å› `false`ï¼Œæ¥ç€åˆ¤æ–­å‚æ•°å€¼æ˜¯å¦ä¸º `NaN`ï¼Œè‹¥æ˜¯åˆ™è¿”å› `true`ã€‚

```js
Number.isNaN(NaN) // true
Number.isNaN(Number.NaN) // true
Number.isNaN(0 / 0) // true
Number.isNaN('hello world') // false
Number.isNaN(undefined) // false
```

### 4. æ€»ç»“å‡ ç§åˆ¤æ–­å€¼æ˜¯å¦ä¸º NaN çš„æ–¹æ³•

```js
// 1. åˆ©ç”¨ NaN çš„ç‰¹æ€§ï¼ŒJavaScript ä¸­å”¯ä¸€ä¸€ä¸ªä¸ç­‰äºè‡ªèº«çš„å€¼
function myIsNaN(v) {
  return v !== v
}

// 2. åˆ©ç”¨ ES5 çš„ isNaN() å…¨å±€æ–¹æ³•
function myIsNaN(v) {
  return typeof v === 'number' && isNaN(v)
}

// 3. åˆ©ç”¨ ES6 çš„ Number.isNaN() æ–¹æ³•
function myIsNaN(v) {
  return Number.isNaN(v)
}

// 4. åˆ©ç”¨ ES6 çš„ Object.is() æ–¹æ³•
function myIsNaN(v) {
  return Object.is(v, NaN)
}
```


## å››ã€==ã€=== ä¸ Object.is()

JavaScript æ˜¯ä¸€ç§å¼±ç±»å‹è¯­è¨€ï¼Œå­˜åœ¨éšå¼ç±»å‹è½¬æ¢ã€‚å› æ­¤ï¼Œ`==` çš„è¡Œä¸ºéå¸¸ä»¤äººè´¹è§£ã€‚

```js
[] == ![] // true
2 == '2' // true
```

æ‰€ä»¥ï¼Œå„ç§ JavaScript ä¹¦ç±éƒ½æ¨èä½¿ç”¨ `===` æ›¿ä»£ `==`ï¼ˆä»…åœ¨ null checking ä¹‹ç±»çš„æƒ…å†µé™¤å¤–ï¼‰ã€‚

ä½†äº‹å®ä¸Šï¼Œ `===` ä¹Ÿå¹¶ä¸æ€»æ˜¯é è°±ï¼Œå®ƒè‡³å°‘å­˜åœ¨ä¸¤ç±»ä¾‹å¤–æƒ…å†µã€‚ï¼ˆ[Stricter equality in JavaScript](https://2ality.com/2012/03/stricter-equality.html)ï¼‰

```js
// 1. å‰æ–‡æåˆ°çš„ NaN
NaN === NaN // false

// 2. +0 ä¸ -0 ä¸¤è€…å…¶å®æ˜¯ä¸ç›¸ç­‰çš„å€¼ ğŸ‘‡
+0 === -0 // true
// å› ä¸º
1 / +0 === Infinity // true
1 / -0 === -Infinity // true
Infinity === -Infinity // false


// ES6 æ˜¯æä¾›çš„æ–¹æ³•
Object.is(NaN, NaN) // true
Object.is(+0, -0) // false
```

ç›´åˆ° ES6 æ‰æœ‰ä¸€ä¸ªå¯ä»¥æ¯”è¾ƒä¸¤ä¸ªå€¼æ˜¯å¦ä¸¥æ ¼ç›¸ç­‰çš„æ–¹æ³•ï¼š`Object.is()`ï¼Œå®ƒå¯¹äº `===` çš„è¿™ä¸¤è€…ä¾‹å¤–éƒ½åšäº†æ­£ç¡®çš„å¤„ç†ã€‚

å¦‚æœ ES6 ä»¥ä¸‹ï¼Œè¿™æ ·å®ç° `Object.is()`ï¼š
```js
function myObjectIs (x, y) {
  if (x === y) {
    // x === 0 => compare via infinity trick
    return x !== 0 || (1 / x === 1 / y)
  }

  // x !== y => return true only if both x and y are NaN
  return x !== x && y !== y
}
```

> å…³äº `==` å’Œ `===` éƒ¨åˆ†å€¼çš„æ¯”è¾ƒï¼Œå¯ä»¥çœ‹ä¸‹ [JavaScript-Equality-Table](https://dorey.github.io/JavaScript-Equality-Table/)ã€‚
>
> Always use 3 equals unless you have a good reason to use 2.ï¼ˆé™¤éæ‚¨æœ‰å……åˆ†çš„ç†ç”± `==`ï¼Œå¦åˆ™å§‹ç»ˆä½¿ç”¨ `===`ï¼‰


## äº”ã€åˆ†å·è‡ªåŠ¨æ’å…¥æœºåˆ¶ï¼ˆASIï¼‰

> æ­¤å‰è¿˜ä¸“é—¨é’ˆå¯¹ ASI å†…å®¹å†™äº†ä¸€ç¯‡æ–‡ç« ï¼š[JavaScript ASI æœºåˆ¶è¯¦è§£ï¼Œä¸ç”¨å†çº ç»“åˆ†å·é—®é¢˜](https://www.jianshu.com/p/05cd9981dc56)ã€‚

### 1. Restricted Productions

æ® Brendan Eich ç§°ï¼ŒJavaScript æœ€åˆè¢«è®¾è®¡å‡ºæ¥æ—¶ï¼Œ[ä¸Šçº§è¦æ±‚è¿™ä¸ªè¯­è¨€çš„è¯­æ³•å¿…é¡»åƒ Java](https://brendaneich.com/2008/04/popularity/)ã€‚æ‰€ä»¥è·Ÿ Java ä¸€æ ·ï¼ŒJavaScript çš„è¯­å¥åœ¨è§£ææ—¶ï¼Œæ˜¯**éœ€è¦åˆ†å·**åˆ†éš”çš„ã€‚ä½†æ˜¯åæ¥å‡ºäºé™ä½å­¦ä¹ æˆæœ¬ï¼Œæˆ–è€…æé«˜è¯­è¨€çš„å®¹é”™æ€§çš„è€ƒè™‘ï¼Œä»–åœ¨è¯­æ³•è§£æä¸­åŠ å…¥äº†åˆ†å·è‡ªåŠ¨æ’å…¥çš„çº æ­£æœºåˆ¶ã€‚

è¿™ä¸ªåšæ³•çš„æœ¬æ„å½“ç„¶æ˜¯å¥½çš„ï¼Œæœ‰ä¸å°‘å…¶ä»–è¯­è¨€ä¹Ÿæ˜¯è¿™ä¹ˆå¤„ç†çš„ï¼ˆæ¯”å¦‚ Swiftï¼‰ã€‚ä½†æ˜¯é—®é¢˜åœ¨äºï¼ŒJavaScript çš„è¯­æ³•è®¾è®¡å¾—ä¸å¤Ÿå®‰å…¨ï¼Œå¯¼è‡´ ASI æœ‰ä¸å°‘ç‰¹æ®Šæƒ…å†µæ— æ³•å¤„ç†åˆ°ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ä¼šé”™è¯¯åœ°åŠ ä¸Šåˆ†å·ï¼ˆåœ¨æ ‡å‡†æ–‡æ¡£é‡Œè¿™äº›è¢«ç§°ä¸ºÂ [Restricted Productions](https://tc39.github.io/ecma262/#sec-rules-of-automatic-semicolon-insertion)ï¼‰ã€‚ 

æœ€å…¸å‹çš„æ˜¯ `return` è¯­å¥ï¼š

```js
// returns undefined
return
{
  name: 'Frankie'
}

// returns { name: 'Frankie' }
return {
  name: 'Frankie'
}
```
è¿™å¯¼è‡´äº† JavaScript ç¤¾åŒºå†™ä»£ç æ—¶èŠ±æ‹¬å·éƒ½ä¸æ¢è¡Œï¼Œè¿™åœ¨å…¶ä»–ç¼–ç¨‹è¯­è¨€ç¤¾åŒºæ˜¯æ— æ³•æƒ³è±¡çš„ã€‚

### 2. æ¼åŠ åˆ†å·çš„é—®é¢˜

æœ‰å¥½å‡ ç§æƒ…å†µè¦æ³¨æ„ï¼ˆæ›´å¤š ASI è¯¦æƒ…çœ‹ä¸Šé¢æ¨èçš„æ–‡ç« ï¼‰ï¼Œæ¯”å¦‚ï¼š
```js
// å‡è®¾æºç æ˜¯è¿™æ ·çš„
var a = function (x) { console.log(x) }
(function () {
  console.log('do something')
})()

// åœ¨ JS è§£æå™¨çš„çœ¼é‡Œå´æ˜¯è¿™æ ·çš„ï¼Œæ‰€ä»¥è¿™æ®µä»£ç ä¼šæŠ¥é”™
var a = function (x) { console.log(x) }(function () {
  console.log('do something')
})()
```

### 3. semicolon-less

ç”±äºä»¥ä¸Šè¿™äº›å·²ç»æ˜¯è¯­è¨€ç‰¹æ€§äº†ï¼Œå¹¶ä¸”æ— æ³•ç»•å¼€ï¼Œæ— è®ºæ€æ ·æˆ‘ä»¬éƒ½éœ€è¦å»å­¦ä¹ æŒæ¡ã€‚

> å¯¹äºä½¿ç”¨ semicolon-less é£æ ¼çš„æœ‹å‹ï¼Œæ³¨æ„ä¸€ä¸‹ 5 ç§æƒ…å†µå°±å¯ä»¥äº†ï¼š
>
> å¦‚æœä¸€æ¡è¯­å¥æ˜¯ä»¥ `(`ã€`[`ã€`/`ã€`+`ã€`-` å¼€å¤´ï¼Œé‚£ä¹ˆå°±è¦æ³¨æ„äº†ã€‚æ ¹æ® JavaScript è§£æå™¨çš„è§„åˆ™ï¼Œå°½å¯èƒ½è¯»å–æ›´å¤š `token` æ¥æ„æˆä¸€ä¸ªå®Œæ•´çš„è¯­å¥ï¼Œè€Œä»¥ä¸Šè¿™äº› `token` ææœ‰å¯èƒ½ä¸å‰ä¸€ä¸ª `token` å¯ç»„æˆä¸€ä¸ªåˆæ³•çš„è¯­å¥ï¼Œæ‰€ä»¥å®ƒä¸ä¼šè‡ªåŠ¨æ’å…¥åˆ†å·ã€‚
>
> å®é™…é¡¹ç›®ä¸­ï¼Œä»¥ `/`ã€`+`ã€`- `ä½œä¸ºè¡Œé¦–çš„ä»£ç å…¶å®æ˜¯å¾ˆå°‘çš„ï¼Œ`(`ã€`[` ä¹Ÿæ˜¯è¾ƒå°‘çš„ã€‚**å½“é‡åˆ°è¿™äº›æƒ…å†µæ—¶ï¼Œé€šè¿‡åœ¨è¡Œé¦–æ‰‹åŠ¨é”®å…¥åˆ†å· `;` æ¥é¿å… ASI è§„åˆ™äº§ç”Ÿçš„éé¢„æœŸç»“æœæˆ–æŠ¥é”™ã€‚**è¿™æ ·çš„è®°å¿†æˆæœ¬å’Œå‡ºé”™æ¦‚ç‡è¿œä½äºå¼ºåˆ¶åˆ†å·é£æ ¼ã€‚
>
> è¿˜æœ‰ï¼ŒESLint ä¸­æœ‰ä¸€æ¡è§„åˆ™ `no-unexpected-multiline` å“¦ï¼Œè¿™æ ·å°±å‡ ä¹æ²¡æœ‰ä»€ä¹ˆè´Ÿæ‹…äº†ã€‚

## å…­ã€Falsy values

åœ¨ JavaScript ä¸­è‡³å°‘æœ‰ä¸ƒç§å‡å€¼ï¼ˆåœ¨æ¡ä»¶è¡¨è¾¾å¼ä¸­ä¸ `false` ç­‰ä»·ï¼‰ï¼š`0`ã€`0n`ã€`null`ã€`undefined`ã€`false`ã€`''` ä»¥åŠ `NaN`ã€‚ï¼ˆå…¶ä¸­ `0n` æ˜¯ BigInt ç±»å‹çš„å€¼ï¼‰

> ä»¥ä¸Šå…­ç§å‡å€¼å‡å¯é€šè¿‡ Double Not è¿ç®—ç¬¦ï¼ˆ`!!`ï¼‰æ¥æ˜¾ç¤ºè½¬æ¢æˆ `Boolean` ç±»å‹çš„ `false` å€¼ã€‚

## ä¸ƒã€+ã€- æ“ä½œç¬¦ç›¸å…³çš„éšå¼ç±»å‹è½¬æ¢
å¤§è‡´å¯ä»¥è¿™æ ·è®°ï¼šä½œä¸ºäºŒå…ƒæ“ä½œç¬¦çš„ `+` ä¼šå°½å¯èƒ½åœ°æŠŠä¸¤è¾¹çš„å€¼è½¬ä¸ºå­—ç¬¦ä¸²ï¼Œè€Œ `-` å’Œä½œä¸ºä¸€å…ƒæ“ä½œç¬¦çš„ `+` åˆ™ä¼šå°½å¯èƒ½åœ°æŠŠå€¼è½¬ä¸ºæ•°å­—ã€‚

```js
('foo' + + 'bar') === 'fooNaN' // true
'3' + 1 // '31'
'3' - 1 // 2
'222' - - '111' // 333
```

> æ³¨æ„: `+` ä¸¤ä¾§åªè¦æœ‰ä¸€ä¾§æ˜¯å­—ç¬¦ä¸²ï¼Œå¦ä¸€ä¾§çš„æ•°å­—åˆ™ä¼šè‡ªåŠ¨è½¬æ¢æˆå­—ç¬¦ä¸²ï¼Œå› ä¸ºå…¶ä¸­å­˜åœ¨éšå¼è½¬æ¢ã€‚

## å…«ã€nullã€undefined ä»¥åŠæ•°ç»„çš„ â€œholesâ€

åœ¨ä¸€ä¸ªè¯­è¨€ä¸­åŒæ—¶æœ‰Â `null`Â å’ŒÂ `undefined`Â ä¸¤ä¸ªè¡¨ç¤ºç©ºå€¼çš„åŸç”Ÿç±»å‹ï¼Œä¹çœ‹èµ·æ¥å¾ˆéš¾ç†è§£ï¼Œä¸è¿‡è¿™é‡Œæœ‰ä¸€äº›è®¨è®ºå¯ä»¥ä¸€çœ‹ï¼š 

- [Java has null but only for reference types. With untyped JS, the uninitialized value should not be reference-y or convert to 0](https://twitter.com/BrendanEich/status/330775086208524288). 
- [GitHub ä¸Šçš„ä¸€äº›è®¨è®º](https://github.com/DavidBruant/ECMAScript-regrets/issues/26#issue-13943504)Â -Â [Null for Objects and undefined for primitives](https://twitter.com/BrendanEich/status/652442934151938048)

ä¸è¿‡æ•°ç»„é‡Œçš„ "holes" å°±éå¸¸éš¾ä»¥ç†è§£äº†ã€‚

äº§ç”Ÿ holes çš„æ–¹æ³•æœ‰ä¸¤ç§ï¼šä¸€æ˜¯å®šä¹‰æ•°ç»„å­—é¢é‡æ—¶å†™ä¸¤ä¸ªè¿ç»­çš„é€—å·ï¼š`var a = [1, , 2]`ï¼›äºŒæ˜¯ä½¿ç”¨Â `Array`Â å¯¹è±¡çš„æ„é€ å™¨ï¼š`new Array(3)`ã€‚

æ•°ç»„çš„å„ç§æ–¹æ³•å¯¹äº holes çš„å¤„ç†éå¸¸éå¸¸éå¸¸ä¸ä¸€è‡´ï¼Œæœ‰çš„ä¼šè·³è¿‡ï¼ˆ`forEach`ï¼‰ï¼Œæœ‰çš„ä¸å¤„ç†ä½†æ˜¯ä¿ç•™ï¼ˆ`map`ï¼‰ï¼Œæœ‰çš„ä¼šæ¶ˆé™¤æ‰ holesï¼ˆ`filter`ï¼‰ï¼Œè¿˜æœ‰çš„ä¼šå½“æˆ `undefined` æ¥å¤„ç†ï¼ˆ`join`ï¼‰ã€‚è¿™å¯ä»¥è¯´æ˜¯ JavaScript ä¸­æœ€å¤§çš„å‘ä¹‹ä¸€ï¼Œä¸çœ‹æ–‡æ¡£å¾ˆéš¾è‡ªå·±ç†æ¸…æ¥šã€‚

å…·ä½“å¯ä»¥å‚è€ƒè¿™ä¸¤ç¯‡æ–‡ç« ï¼š 
*Â [Array iteration and holes in JavaScript](http://www.2ality.com/2013/07/array-iteration-holes.html)Â 
*Â [ECMAScript 6: holes in Arrays](http://www.2ality.com/2015/09/holes-arrays-es6.html)

## ä¹ã€ Array-like objects

åœ¨ JavaScript ä¸­ï¼Œç±»æ•°ç»„ä½†ä¸æ˜¯æ•°ç»„çš„å¯¹è±¡ä¸å°‘ï¼Œè¿™ç±»å¯¹è±¡å¾€å¾€æœ‰ `length` å±æ€§ã€å¯ä»¥è¢«éå†ï¼Œä½†ç¼ºä¹ä¸€äº›æ•°ç»„åŸå‹ä¸Šçš„æ–¹æ³•ï¼Œç”¨èµ·æ¥éå¸¸ä¸ä¾¿ã€‚æ¯”å¦‚åœ¨ä¸ºäº†èƒ½è®© `arguments` å¯¹è±¡ç”¨ä¸Š `Array.prototype.shift()` æ–¹æ³•ï¼Œæˆ‘ä»¬å¾€å¾€éœ€è¦å…ˆå†™è¿™æ ·ä¸€æ¡è¯­å¥ï¼Œéå¸¸ä¸ä¾¿ã€‚

```js
var args = Array.prototype.slice.apply(arguments)
```

åœ¨ ES6 ä¸­ï¼Œarguments å¯¹è±¡ä¸å†è¢«å»ºè®®ä½¿ç”¨ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨  [Rest parameters](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Functions/Rest_parameters)ï¼ˆ`const fn = (...args) => {}`ï¼‰ï¼Œè¿™æ ·æ‹¿åˆ°çš„å¯¹è±¡ï¼ˆ`args`ï¼‰å°±ç›´æ¥æ˜¯æ•°ç»„äº†ã€‚

ä¸è¿‡åœ¨è¯­è¨€æ ‡å‡†ä¹‹å¤–ï¼ŒDOM æ ‡å‡†ä¸­ä¹Ÿå®šä¹‰äº†ä¸å°‘ Array-like çš„å¯¹è±¡ï¼Œæ¯”å¦‚ NodeList å’Œ HTMLCollectionã€‚å¯¹äºè¿™äº›å¯¹è±¡ï¼Œåœ¨ ES6 ä¸­æˆ‘ä»¬å¯ä»¥ç”¨ spread operator å¤„ç†ï¼š

```js
const nodeList = document.querySelectorAll('div')
const nodeArray = [...nodeList]

console.log(Object.prototype.toString.call(nodeList))   // [object NodeList]
console.log(Object.prototype.toString.call(nodeArray))   // [object Array]
```

### arguments

åœ¨éä¸¥æ ¼æ¨¡å¼ä¸‹ï¼ˆsloppy modeï¼‰ä¸‹ï¼Œå¯¹ argument èµ‹å€¼ä¼šæ”¹å˜å¯¹åº”çš„**å½¢å‚**ã€‚

> å¯ä»¥çœ‹ä¸‹è¿™ç¯‡æ–‡ç« ï¼š[JavaScript ä¸¥æ ¼æ¨¡å¼è¯¦è§£ï¼ˆ8-2 å°èŠ‚ï¼‰](https://www.jianshu.com/p/55e369a811b7)

```js
function foo(x) {
  console.log(x === 1) // true
  arguments[0] = 2
  console.log(x === 2) // true
}

function bar(x) {
  'use strict'
  console.log(x === 1) // true
  arguments[0] = 2
  console.log(x === 2) // false
}

foo(1)
bar(1)
```

## åã€å‡½æ•°ä½œç”¨åŸŸä¸å˜é‡æå‡ï¼ˆVariable hoistingï¼‰

### å‡½æ•°ä½œç”¨åŸŸ

è´è¶ä¹¦ä¸Šçš„ä¾‹å­æƒ³å¿…å¤§å®¶éƒ½çœ‹è¿‡ï¼š

```js
// The closure in loop problem
for (var i = 0; i !== 10; ++i) {
  setTimeout(function() { console.log(i) }, 0)
}
```

å‡½æ•°çº§ä½œç”¨åŸŸæœ¬èº«æ²¡æœ‰é—®é¢˜ï¼Œä½†æ˜¯å¦‚æœåªèƒ½ä½¿ç”¨å‡½æ•°çº§ä½œç”¨åŸŸçš„è¯ï¼Œåœ¨å¾ˆå¤šä»£ç ä¸­å®ƒä¼šæ˜¾å¾—éå¸¸**åç›´è§‰**ã€‚æ¯”å¦‚ä¸Šé¢çš„è¿™ä¸ªå¾ªç¯ä¾‹å­ï¼Œå¯¹äºç¨‹åºå‘˜æ¥è¯´ï¼Œæ ¹æ®èŠ±æ‹¬å·çš„è¿ç« ç¡®å®šå˜é‡ä½œç”¨åŸŸè¿œæ¯”æ‰¾åˆ°å¤–å±‚å‡½æ•°å®¹æ˜“å¾—å¤šã€‚

åœ¨ä»¥å‰ï¼Œè¦è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬åªèƒ½ä½¿ç”¨é—­åŒ… + IIFE äº§ç”Ÿä¸€ä¸ªæ–°ä½œç”¨åŸŸï¼Œä»£ç éå¸¸éš¾çœ‹ï¼ˆå…¶å® `with` ä»¥åŠ `catch` è¯­å¥åé¢è·Ÿçš„ä»£ç å—ä¹Ÿç®—æ˜¯å—çº§ä½œç”¨åŸŸï¼Œä½†è¿™å¹¶ä¸é€šç”¨ï¼‰ã€‚

å¹¸è€Œç°åœ¨ ES2015 å¼•å…¥äº† `let` / `const`ï¼Œè®©æˆ‘ä»¬ç»ˆäºå¯ä»¥ç”¨ä¸ŠçœŸæ­£çš„å—çº§ä½œç”¨åŸŸã€‚

### å˜é‡æå‡

JavaScript å¼•æ“åœ¨æ‰§è¡Œä»£ç çš„æ—¶å€™ï¼Œä¼šå…ˆå¤„ç†ä½œç”¨åŸŸå†…æ‰€æœ‰çš„å˜é‡å£°æ˜ï¼Œç»™å˜é‡åˆ†é…ç©ºé—´ï¼ˆåœ¨æ ‡å‡†é‡Œå« bindingï¼‰ï¼Œç„¶ååœ¨å†æ‰§è¡Œä»£ç ã€‚

è¿™æœ¬æ¥æ²¡ä»€ä¹ˆé—®é¢˜ï¼Œä½†æ˜¯ `var` å£°æ˜åœ¨è¢«åˆ†é…ç©ºé—´çš„åŒæ—¶ä¹Ÿä¼šè¢«åˆå§‹åŒ–æˆ `undefined`ï¼ˆES5 ä¸­çš„ [CreateMutableBinding](https://es5.github.io/#x10.2.1.1.2)ï¼‰ï¼Œè¿™å°±ç›¸å½“äºæŠŠ var å£°æ˜çš„å˜é‡æå‡åˆ°äº†å‡½æ•°ä½œç”¨åŸŸçš„å¼€å¤´ï¼Œä¹Ÿå°±æ˜¯æ‰€è°“çš„ â€œhoistingâ€ã€‚

ES6 ä¸­å¼•å…¥çš„ `let`ã€`const` åˆ™å®ç°äº† temporal dead zoneï¼Œè™½ç„¶è¿›å…¥ä½œç”¨åŸŸæ—¶ç”¨ `let` å’Œ `const` å£°æ˜çš„å˜é‡ä¹Ÿä¼šè¢«åˆ†é…ç©ºé—´ï¼Œä½†ä¸ä¼šè¢«åˆå§‹åŒ–ã€‚åœ¨åˆå§‹åŒ–è¯­å¥ä¹‹å‰ï¼Œå¦‚æœå‡ºç°å¯¹å˜é‡çš„å¼•ç”¨ï¼Œä¼šæŠ›å‡º `ReferenceError` é”™è¯¯ã€‚

```js
// without TDZ
console.log(a) // undefined
var a = 1

// with TDZ
console.log(b) // ReferenceError
let b = 2
```
åœ¨æ ‡å‡†å±‚é¢ï¼Œè¿™æ˜¯é€šè¿‡æŠŠ CreateMutableBing å†…éƒ¨æ–¹æ³•åˆ†æ‹†æˆ CreateMutableBinding å’Œ InitializeBinding ä¸¤æ­¥å®ç°çš„ï¼Œåªæœ‰ VarDeclaredNames æ‰ä¼šæ‰§è¡Œ InitializeBinding æ–¹æ³•ã€‚

### letã€const

ç„¶è€Œï¼Œ`let` å’Œ `const` çš„å¼•å…¥ä¹Ÿå¸¦æ¥äº†ä¸€ä¸ªå‘ã€‚ä¸»è¦æ˜¯è¿™ä¸¤ä¸ªå…³é”®è¯çš„å‘½åä¸å¤Ÿç²¾ç¡®åˆç†ã€‚

`const` å…³é”®è¯æ‰€å®šä¹‰çš„æ˜¯ä¸€ä¸ª immutable bindingï¼ˆç±»ä¼¼äº Java çš„ `final` å…³é”®è¯ï¼‰ï¼Œè€ŒéçœŸæ­£çš„å¸¸é‡ï¼ˆconstantï¼‰ï¼Œè¿™ä¸€ç‚¹å¯¹äºå¾ˆå¤šäººæ¥è¯´ä¹Ÿæ˜¯åç›´è§‰çš„ã€‚

ES6 è§„èŒƒçš„ä¸»ç¬” Allen Wirfs-Brock åœ¨ ESDiscuss çš„ä¸€ä¸ª[å¸–å­](https://esdiscuss.org/topic/should-const-be-favored-over-let#content-6)é‡Œè¡¨ç¤ºï¼Œå¦‚æœå¯ä»¥ä»å¤´å†æ¥çš„è¯ï¼Œä»–ä¼šæ›´å€¾å‘äºé€‰æ‹© `let var` / `let` æˆ–è€… `mut` / `let` æ›¿ä»£ç°åœ¨çš„è¿™ä¸¤ä¸ªå…³é”®è¯ï¼Œå¯æƒœè¿™åªèƒ½æ˜¯ä¸€ä¸ªç¾å¥½çš„ç©ºæƒ³äº†ã€‚

### for...in

`for...in` çš„é—®é¢˜åœ¨äºå®ƒä¼šéå†åˆ°åŸå‹é“¾ä¸Šçš„å±æ€§ï¼Œè¿™ä¸ªå¤§å®¶åº”è¯¥éƒ½çŸ¥é“çš„ï¼Œä½¿ç”¨æ—¶éœ€è¦åŠ ä¸Š `obj.hasOwnProperty(key)` åˆ¤æ–­æ‰å®‰å…¨ã€‚

åœ¨ ES6+ ä¸­ï¼Œä½¿ç”¨ `for(const key of Object.keys(obj))` æˆ–è€… `for(const [key, value] of Object.entries())` å¯ä»¥ç»•å¼€è¿™ä¸ªé—®é¢˜ã€‚

> é¡ºä¾¿æä¸€ä¸‹ `Object.keys()`ã€`Object.getOwnPropertyNames()`ã€`Reflect.ownKeys()` çš„åŒºåˆ«ï¼šæˆ‘ä»¬æœ€å¸¸ç”¨çš„ä¸€èˆ¬æ˜¯ `Object.keys()` æ–¹æ³•ï¼Œ`Object.getOwnPropertyNames()` ä¼šæŠŠ `enumerable: false` çš„å±æ€§åä¹Ÿä¼šåŠ è¿›æ¥ï¼Œè€Œ `Reflect.ownKeys()` åœ¨æ­¤åŸºç¡€ä¸Šè¿˜ä¼šåŠ ä¸Š `Symbol` ç±»å‹çš„é”®ã€‚

### with

æœ€ä¸»è¦çš„é—®é¢˜åœ¨äºå®ƒä¾èµ–è¿è¡Œæ—¶è¯­ä¹‰ï¼Œå½±å“ä¼˜åŒ–ã€‚

æ­¤å¤–è¿˜ä¼šé™ä½ç¨‹åºå¯è¯»æ€§ã€æ˜“å‡ºé”™ã€æ˜“æ³„éœ²å…¨å±€å˜é‡ã€‚

```js
function fn(foo, length) {
  with(foo) {
    console.log(length)
  }
}
fn([1, 2, 3], 222) // 3
```

### eval

`eval` çš„é—®é¢˜ä¸åœ¨äºå¯ä»¥åŠ¨æ€æ‰§è¡Œä»£ç ï¼Œè¿™ç§èƒ½åŠ›æ— è®ºå¦‚ä½•ä¹Ÿä¸èƒ½ç®—æ˜¯è¯­è¨€çš„ç¼ºé™·ã€‚

### Scope

å®ƒçš„ç¬¬ä¸€ä¸ªå‘åœ¨äºä¼ ç»™ eval ä½œä¸ºå‚æ•°çš„ä»£ç æ®µèƒ½å¤Ÿæ¥è§¦åˆ°å½“å‰è¯­å¥æ‰€åœ¨çš„é—­åŒ…ã€‚

è€Œç”¨ `new Function` åŠ¨æ€æ‰§è¡Œçš„ä»£ç å°±ä¸ä¼šæœ‰è¿™ä¸ªé—®é¢˜ã€‚å› ä¸º `new Function` æ‰€ç”Ÿæˆçš„å‡½æ•°æ˜¯ç¡®ä¿æ‰§è¡Œåœ¨æœ€å¤–å±‚ä½œç”¨åŸŸä¸‹çš„ï¼ˆ[ä¸¥æ ¼æ¥è¯´æ ‡å‡†é‡Œä¸æ˜¯è¿™æ ·å®šä¹‰çš„ï¼Œä½†å®é™…æ•ˆæœåŸºæœ¬å¯ä»¥çœ‹ä½œç­‰åŒï¼Œé™¤äº†Â `new Function`Â ä¸­å¯ä»¥è·å–åˆ°Â `arguments`Â å¯¹è±¡](http://perfectionkills.com/global-eval-what-are-the-options/#new_function)ï¼‰ã€‚

```js
function test1() {
  var a = 11
  eval('(a = 22)')
  console.log(a) // 22
}

function test2() {
  var a = 11
  new Function('return (a = 22)')()
  console.log(a) // 11
}
```

### ç›´æ¥è°ƒç”¨ vs é—´æ¥è°ƒç”¨ï¼ˆDirect Call vs Indirect Callï¼‰

ç¬¬äºŒä¸ªå‘æ˜¯ç›´æ¥è°ƒç”¨Â `eval`Â å’Œé—´æ¥è°ƒç”¨çš„åŒºåˆ«ã€‚

äº‹å®ä¸Šï¼Œä½†æ˜¯ã€Œç›´æ¥è°ƒç”¨ã€çš„æ¦‚å¿µå°±è¶³ä»¥è®©äººè¿·ç³Šäº†ã€‚

é¦–å…ˆï¼Œ[`eval`Â æ˜¯å…¨å±€å¯¹è±¡ä¸Šçš„ä¸€ä¸ªæˆå‘˜å‡½æ•°](https://es5.github.io/#x15.1.2)ï¼›

ä½†æ˜¯ï¼Œ[`window.eval()`Â è¿™æ ·çš„è°ƒç”¨Â **ä¸ç®—æ˜¯**Â ç›´æ¥è°ƒç”¨ï¼Œå› ä¸ºè¿™ä¸ªè°ƒç”¨çš„ base æ˜¯å…¨å±€å¯¹è±¡è€Œä¸æ˜¯ä¸€ä¸ª "environment record"](https://esdiscuss.org/topic/double-checking-if-window-eval-is-an-indirect-call-to-eval#content-1)ã€‚

æ¥ä¸‹æ¥çš„å°±æ˜¯å†å²é—®é¢˜äº†ã€‚

*   åœ¨ ES1 æ—¶ä»£ï¼Œ`eval`Â è°ƒç”¨å¹¶æ²¡æœ‰ç›´æ¥å’Œé—´æ¥çš„åŒºåˆ†ï¼›
*   ç„¶ååœ¨ ES2 ä¸­ï¼ŒåŠ å…¥äº†ç›´æ¥è°ƒç”¨ï¼ˆdirect callï¼‰çš„æ¦‚å¿µã€‚æ ¹æ®Â [Dmitry Soshnikov åæ¥çš„è¯´æ³•](http://dmitrysoshnikov.com/ecmascript/es5-chapter-2-strict-mode/#indirect-eval-call)ï¼ŒåŒºåˆ†è¿™ä¸¤ç§è°ƒç”¨å¯èƒ½æ˜¯å¤„äºå®‰å…¨è€ƒè™‘ã€‚æ­¤æ—¶å”¯ä¸€åˆæ³•çš„Â `eval`Â ä½¿ç”¨æ–¹å¼æ˜¯Â **ç›´æ¥è°ƒç”¨**ï¼Œå¦‚æœÂ `eval`Â è¢«é—´æ¥è°ƒç”¨äº†æˆ–è€…è¢«èµ‹å€¼ç»™å…¶ä»–å˜é‡äº†ï¼ŒJavaScript å¼•æ“Â **å¯ä»¥é€‰æ‹©**Â æŠ¥ä¸€ä¸ª Runtime Errorï¼ˆ[ECMA-262 2nd Edition](https://www.ecma-international.org/publications/files/ECMA-ST-ARCH/ECMA-262,%202nd%20edition,%20August%201998.pdf), p.63ï¼‰ã€‚
*   ä½†æ˜¯æµè§ˆå™¨å‚å•†ä»¬åœ¨è¯•å›¾å®ç°è¿™ä¸ªç‰¹æ€§æ—¶ï¼Œå‘ç°è¿™ä¼šè®©ä¸€äº›æ—§ç½‘ç«™ä¸å…¼å®¹ã€‚
*   è€ƒè™‘åˆ°è¿™æ¯•ç«Ÿæ˜¯å¯é€‰çš„ç‰¹æ€§ï¼Œä»–ä»¬æœ€åå°±é€‰æ‹©äº†ä¸æŠ¥é”™ï¼Œè½¬è€Œè®©æ‰€æœ‰é—´æ¥è°ƒç”¨çš„Â `eval`Â éƒ½åœ¨å…¨å±€ä½œç”¨åŸŸä¸‹æ‰§è¡Œã€‚ è¿™æ ·ä¸€æ¥ï¼Œæ—¢ä¿æŒäº†å¯¹æ—§ç½‘ç«™çš„å…¼å®¹æ€§ï¼Œä¹Ÿä¿è¯äº†ä¸€å®šç¨‹åº¦çš„å®‰å…¨æ€§ã€‚
*   [åˆ°äº† ES5 æ—¶æœŸï¼Œæ ‡å‡†åˆ¶å®šè€…ä»¬å¸Œæœ›èƒ½å¤Ÿå’Œå½“å‰çº¦å®šä¿—æˆçš„å®ç°ä¿æŒä¸€ç›´å¹¶è§„èŒƒåŒ–ï¼Œæ‰€ä»¥å»æ‰äº†ä¹‹å‰æ ‡å‡†é‡Œçš„å¯é€‰å®ç°ï¼Œè½¬è€Œè§„å®šäº†é—´æ¥è°ƒç”¨Â `eval`Â æ—¶çš„è¡Œä¸º](https://mail.mozilla.org/pipermail/es-discuss/2011-February/012852.html)

ç›´æ¥è°ƒç”¨å’Œé—´æ¥è°ƒç”¨æœ€å¤§çš„åŒºåˆ«åœ¨äºä»–ä»¬çš„ä½œç”¨åŸŸä¸åŒï¼š`javascript function test() { var x = 2, y = 4 console.log(eval("x + y")) // Direct call, uses local scope, result is 6 var geval = eval; console.log(eval("x + y")) // Indirect call, uses global scope, throws ReferenceError because `x` is undefined }`

é—´æ¥è°ƒç”¨Â `eval`Â æœ€å¤§çš„ç”¨å¤„ï¼ˆå¯èƒ½ä¹Ÿæ˜¯å”¯ä¸€çš„å®é™…ç”¨å¤„ï¼‰æ˜¯åœ¨ä»»æ„åœ°æ–¹è·å–åˆ°å…¨å±€å¯¹è±¡ï¼ˆç„¶è€Œ Function('return this')() ä¹Ÿèƒ½åšåˆ°è¿™ä¸€ç‚¹ï¼‰ï¼šÂ `javascript // å³ä½¿æ˜¯åœ¨ä¸¥æ ¼æ¨¡å¼ä¸‹ä¹Ÿèƒ½èµ·ä½œç”¨ var global = ("indirect", eval)("this");`

æœªæ¥ï¼Œå¦‚æœ Jordan Harband çš„Â [`System.global`Â ææ¡ˆ](https://github.com/tc39/proposal-global)èƒ½è¿›å…¥åˆ°æ ‡å‡†çš„è¯ï¼Œè¿™æœ€åä¸€ç‚¹ç”¨å¤„ä¹Ÿç”¨ä¸åˆ°äº†â€¦â€¦

## åä¸€ã€éä¸¥æ ¼æ¨¡å¼ä¸‹ï¼Œèµ‹å€¼ç»™æœªå£°æ˜çš„å˜é‡ä¼šå¯¼è‡´äº§ç”Ÿä¸€ä¸ªæ–°çš„å…¨å±€å˜é‡

### Value Properties of the Global Object

å¹³å¸¸æˆ‘ä»¬ä½¿ç”¨åˆ°çš„ [NaN](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/NaN)ï¼Œ[Infinity](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Infinity)ã€[undefined](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/undefined) å¹¶ä¸æ˜¯ä½œä¸ºåŸå§‹å€¼è¢«ä½¿ç”¨çš„ï¼Œ[è€Œæ˜¯å®šä¹‰åœ¨å…¨å±€å¯¹è±¡ä¸Šçš„å±æ€§å](https://es5.github.io/#x15.1.1)ã€‚

åœ¨ ES5 ä¹‹å‰ï¼Œè¿™å‡ ä¸ªå±æ€§ç”šè‡³å¯ä»¥è¢«è¦†ç›–ï¼Œç›´åˆ° ES5 ä¹‹åå®ƒä»¬æ‰è¢«æ”¹æˆ non-configurableã€non-writableã€‚

ç„¶è€Œï¼Œå› ä¸ºè¿™å‡ ä¸ªå±æ€§åéƒ½ä¸æ˜¯ JavaScript çš„ä¿ç•™å­—ï¼Œæ‰€ä»¥å¯ä»¥è¢«ç”¨æ¥å½“åšå˜é‡åä½¿ç”¨ã€‚å³ä½¿å…¨å±€å˜é‡ä¸Šçš„è¿™å‡ ä¸ªå±æ€§ä¸å¯è¢«æ›´æ”¹ï¼Œæˆ‘ä»¬ä»å¯ä»¥åœ¨è‡ªå·±çš„ä½œç”¨åŸŸé‡Œé¢å¯¹è¿™å‡ ä¸ªåå­—è¿›è¡Œè¦†ç›–ã€‚

```js
(function () {
  var undefined = 'foo'
  console.log(undefined, typeof undefined) // "foo" "string"
})()
```

### Stateful RegExps

JavaScript ä¸­ï¼Œæ­£åˆ™å¯¹è±¡ä¸Šçš„å‡½æ•°æ˜¯æœ‰çŠ¶æ€çš„ï¼š

```js
const re = /foo/g
console.log(re.test('foo bar')) // true
console.log(re.test('foo bar')) // false
```

è¿™ä½¿å¾—è¿™äº›æ–¹æ³•éš¾ä»¥è°ƒè¯•ï¼Œæ— æ³•åšåˆ°çº¿ç¨‹å®‰å…¨ã€‚

Brendan Eich çš„è¯´æ³•æ˜¯[è¿™äº›æ–¹æ³•æ¥è‡ªäº 90 å¹´ä»£çš„ Perl 4ï¼Œé‚£æ—¶å€™å¹¶æ²¡æœ‰æƒ³åˆ°è¿™ä¹ˆå¤š](https://twitter.com/BrendanEich/status/231066800304046080)ã€‚

æœªå®Œå¾…ç»­...

## References

* [JavaScript çš„è®¾è®¡å¤±è¯¯](https://sodatea.blog/zh/2016/javascript-design-regrets)
* [The history of â€œtypeof nullâ€](https://2ality.com/2013/10/typeof-null.html)
* [typeof MDN](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Operators/typeof)
* [Stricter equality in JavaScript](https://2ality.com/2012/03/stricter-equality.html)
