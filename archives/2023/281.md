---
title: ç»†è¯» JS | JavaScript æ¨¡å—åŒ–ä¹‹è·¯
number: '#281'
link: 'https://github.com/toFrankie/blog/issues/281'
created_at: '2023-02-26 20:47:42'
updated_at: '2023-04-26 22:15:17'
labels:
  - å‰ç«¯
  - å°šæœªå®Œç»“
  - JS
  - '2022'
---
![é…å›¾æºè‡ª Freepik](https://upload-images.jianshu.io/upload_images/5128488-8cb6821ff4fdc2a0.jpeg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)


å­¦ä¹ ä¸èƒ½åœï¼Œéƒ½ç»™æˆ‘å·èµ·æ¥...

## ä¸€ã€å‰ä¸–ä»Šç”Ÿ

åœ¨ ES6 ä¹‹å‰ï¼ŒJavaScript ä¸€ç›´æ²¡æœ‰å®˜æ–¹çš„æ¨¡å—ï¼ˆModuleï¼‰ä½“ç³»ï¼Œå¯¹äºå¼€å‘å¤§å‹ã€å¤æ‚çš„é¡¹ç›®å½¢æˆäº†å·¨å¤§çš„éšœç¢ã€‚å¹¸å¥½ç¤¾åŒºä¸Šæœ‰ä¸€äº›æ¨¡å—åŠ è½½æ–¹æ¡ˆï¼Œæœ€ä¸»è¦çš„æœ‰ CommonJSï¼ˆCommonJS Modulesï¼‰å’Œ AMDï¼ˆAsynchronous Module Definitionï¼‰ä¸¤ç§æ¨¡å—è§„èŒƒï¼Œå‰è€…ç”¨äºæœåŠ¡å™¨ï¼Œåè€…ç”¨äºæµè§ˆå™¨ã€‚

éšç€ ES6 çš„æ­£å¼å‘å¸ƒï¼Œå…¨æ–°çš„æ¨¡å—å°†é€æ­¥å–ä»£ CommonJS å’Œ AMD è§„èŒƒï¼Œæˆä¸ºæµè§ˆå™¨å’ŒæœåŠ¡å™¨é€šç”¨çš„æ¨¡å—è§£å†³æ–¹æ¡ˆã€‚

ES6 æ¨¡å—çš„è®¾è®¡æ€æƒ³å°½é‡çš„é™æ€åŒ–ï¼Œæ˜¯çš„ç¼–è¯‘æ—¶å°±èƒ½ç¡®å®šæ¨¡å—çš„ä¾èµ–å…³ç³»ï¼Œä»¥åŠè¾“å…¥å’Œè¾“å‡ºçš„å˜é‡ã€‚

> åœ¨ [rollup](https://rollupjs.org/guide/en/#tree-shaking)ã€ [webpack](https://webpack.docschina.org/guides/tree-shaking/#root) ç­‰æ„å»ºå·¥å…·ä¸­å¸¸è§çš„ **Tree Shaking** èƒ½åŠ›ï¼Œå°±æ˜¯ä¾èµ–äº ES6 æ¨¡å—çš„[é™æ€ç‰¹æ€§](https://exploringjs.com/es6/ch_modules.html#static-module-structure)å®ç°çš„ã€‚

è€Œ CommonJS å’Œ AMD æ¨¡å—éƒ½åªèƒ½åœ¨è¿è¡Œæ—¶ç¡®å®šè¿™äº›ä¸œè¥¿ã€‚æ¯”å¦‚ï¼ŒCommonJS æ¨¡å—å°±æ˜¯å¯¹è±¡ï¼Œè¾“å…¥æ—¶å¿…é¡»æŸ¥æ‰¾å¯¹è±¡å±æ€§ã€‚

```js
// CommonJS æ¨¡å—
const { stat, exists, readFile } = require('fs')

// ç›¸å½“äº
const _fs = require('fs')
const stat = _fs.stat
const exists = _fs.exists
const readFile = _fs.readFile
```

ä»¥ä¸Šç¤ºä¾‹ï¼Œå®é™…ä¸Šæ˜¯æ•´ä½“åŠ è½½äº† `fs` æ¨¡å—ï¼ˆå³åŠ è½½ `fs` çš„æ‰€æœ‰æ–¹æ³•ï¼‰ï¼Œç”Ÿæˆäº†ä¸€ä¸ªå¯¹è±¡ `_fs`ï¼Œç„¶åå†ä»è¿™ä¸ªå¯¹è±¡ä¸Šè¯»å–äº† 3 ä¸ªæ–¹æ³•ã€‚è¿™ç§æ–¹å¼ç§°ä¸ºâ€œ**è¿è¡Œæ—¶åŠ è½½**â€ï¼ŒåŸå› æ˜¯åªæœ‰è¿è¡Œæ—¶æ‰èƒ½å¾—åˆ°è¿™ä¸ªå¯¹è±¡ï¼Œå¯¼è‡´å®Œå…¨æ²¡æœ‰åŠæ³•åœ¨ç¼–è¯‘æ—¶åšâ€œé™æ€ä¼˜åŒ–â€ã€‚

ES6 æ¨¡å—ä¸æ˜¯å¯¹è±¡ï¼Œè€Œæ˜¯é€šè¿‡ `export` å‘½ä»¤æ˜¾å¼æŒ‡å®šè¾“å‡ºçš„ä»£ç ï¼Œå†é€šè¿‡ `import` å‘½ä»¤è¾“å…¥ã€‚

```js
import { stat, exists, readFile } from 'fs'
```

ä»¥ä¸Šç¤ºä¾‹ï¼Œå®é™…ä¸Šæ˜¯ä» `fs` æ¨¡å—ä¸­åŠ è½½äº† 3 ä¸ªæ–¹æ³•ï¼Œå…¶ä»–æ–¹æ³•ä¸åŠ è½½ã€‚è¿™ç§æ–¹å¼ç§°ä¸ºâ€œ**ç¼–è¯‘æ—¶åŠ è½½**â€æˆ–â€œ**é™æ€åŠ è½½**â€ï¼Œå³ ES6 æ¨¡å—å¯ä»¥åœ¨ç¼–è¯‘æ—¶å°±å®Œæˆæ¨¡å—åŠ è½½ï¼Œæ•ˆç‡è¦é«˜äº CommonJS æ¨¡å—çš„åŠ è½½æ–¹å¼ã€‚è¿™ä¹Ÿå¯¼è‡´äº†æ²¡æ³•å¼•ç”¨ ES6 æ¨¡å—æœ¬èº«ï¼Œå› ä¸ºå®ƒä¸æ˜¯å¯¹è±¡ã€‚

ç”±äº ES6 æ¨¡å—æ˜¯ç¼–è¯‘æ—¶åŠ è½½ï¼Œä½¿å¾—é™æ€åˆ†ææˆä¸ºå¯èƒ½ã€‚æœ‰äº†å®ƒï¼Œå°±èƒ½è¿›ä¸€æ­¥æ‹“å®½ JavaScript çš„è¯­æ³•ï¼Œæ¯”å¦‚å¼•å…¥å®ï¼ˆmacroï¼‰å’Œç±»å‹æ£€éªŒï¼ˆtype systemï¼‰è¿™äº›åªèƒ½é é™æ€åˆ†æå®ç°çš„åŠŸèƒ½ã€‚

é™¤äº†é™æ€åŠ è½½å¸¦æ¥çš„å„ç§å¥½å¤„ï¼ŒES6 æ¨¡å—è¿˜æœ‰ä»¥ä¸‹å¥½å¤„ï¼š

* ä¸å†éœ€è¦ UMD æ¨¡å—æ ¼å¼äº†ï¼Œå°†æ¥æœåŠ¡å™¨å’Œæµè§ˆå™¨éƒ½ä¼šæ”¯æŒ ES6 æ¨¡å—æ ¼å¼ã€‚
* å°†æ¥æµè§ˆå™¨çš„æ–° API å°±èƒ½ç”¨æ¨¡å—æ ¼å¼æä¾›ï¼Œä¸å†å¿…é¡»åšæˆå…¨å±€å˜é‡æˆ–è€… navigator å¯¹è±¡çš„å±æ€§ã€‚
* ä¸å†éœ€è¦å¯¹è±¡ä½œä¸ºå‘½åç©ºé—´ï¼ˆæ¯”å¦‚ Math å¯¹è±¡ï¼‰ï¼Œæœªæ¥è¿™äº›åŠŸèƒ½å¯ä»¥é€šè¿‡æ¨¡å—æä¾›ã€‚

## äºŒã€ä¸ºä»€ä¹ˆéœ€è¦æ¨¡å—åŒ–ï¼Ÿ

ä¸¾ä¸ª ğŸŒ°

```html
<!DOCTYPE html>
<html lang="en">
  <body>
    <script src="module-a.js"></script>
    <script src="module-b.js"></script>
  </body>
</html>
```

```js
// module-a.js
var person = { name: 'Frankie', age: 20 }
```

```js
// module-b.js
console.log(person.name) // å°†ä¼šæ‰“å°ä»€ä¹ˆå‘¢ï¼Ÿ
```

æˆ‘ä»¬å¯ä»¥è½»è€Œæ˜“ä¸¾å°±çŸ¥é“ `module-b.js` é‡Œå°†ä¼šæ‰“å°å‡º `Frankie`ï¼ŒåŸå› å¾ˆç®€å•ï¼Œå®ƒä»¬éƒ½æ˜¯å¤„äºå…¨å±€ä½œç”¨åŸŸä¸‹ï¼Œå› æ­¤ `module-b.js` ä¸­çš„ `person.name` å°±èƒ½è¯»å–åˆ°åœ¨ `module-a.js` ä¸­å®šä¹‰çš„ person å˜é‡ã€‚

å¦‚æœå°† `module-a.js` å’Œ `module-b.js` åœ¨ HTML ä¸­çš„é¡ºåºæ¢è¿‡æ¥ï¼Œå°±ä¼šæŠ›å‡ºé”™è¯¯ã€‚åŸå› æ˜¯`<script>` æ˜¯æŒ‰å—åŠ è½½çš„ï¼ŒåŒ…æ‹¬ä¸‹è½½ã€ï¼ˆé¢„ï¼‰ç¼–è¯‘å’Œæ‰§è¡Œã€‚å”¯æœ‰å½“å‰å—æ‰§è¡Œå®Œæ¯•ï¼Œæˆ–è€…æŠ›å‡ºé”™è¯¯ï¼Œæ‰ä¼šæ¥ç€åŠ è½½ä¸‹ä¸€ä¸ª `<script>`ã€‚

> æ³¨æ„ï¼Œè¿™é‡Œæåˆ°çš„æŒ‰é¡ºåºåŠ è½½ï¼Œæ˜¯æŒ‡æ²¡æœ‰ `defer` å’Œ `async` å±æ€§çš„å“ˆã€‚å®ƒä¿©å¯¹å¤–éƒ¨è„šæœ¬çš„åŠ è½½æ–¹å¼æ˜¯æœ‰å½±å“çš„ã€‚ä½†éæœ¬æ–‡è¯é¢˜ï¼Œå› æ­¤ä¸å±•å¼€è®²è¿°ã€‚

é‚£é—®é¢˜å°±æ¥äº†ï¼Œè¿™å¾ˆå®¹æ˜“é€ æˆ**å…¨å±€æ±¡æŸ“**ï¼Œå¯¹äºå¤§å‹ã€å¤æ‚çš„é¡¹ç›®æ¥è¯´ä¼šéå¸¸æ£˜æ‰‹ã€‚

#### å‡è®¾æ²¡æœ‰è¯¸å¦‚ CommonJS ç­‰æ¨¡å—åŒ–è§£å†³æ–¹æ¡ˆå¯ç”¨ï¼Œè¦æ€æ ·è§£å†³è¿™ç§é—®é¢˜å‘¢ï¼Ÿ

**1. å¯¹è±¡å­—é¢é‡ï¼ˆObject Literalï¼‰**

```js
// å£°æ˜
var namespace = {
  prop: 123,
  method: function () {},
  // ...
}

// è°ƒç”¨
namespace.prop
namespace.method()
```
ç¼ºç‚¹ï¼š

ä½œä¸ºä¸€ä¸ªå•ä¸€çš„ã€æœ‰æ—¶å¾ˆé•¿çš„å¥æ³•ç»“æ„ï¼Œå®ƒå¯¹å…¶å†…å®¹æ–½åŠ äº†é™åˆ¶ã€‚å†…å®¹å¿…é¡»åœ¨ `{}` ä¹‹é—´ï¼Œå¹¶ä¸”å±æ€§æˆ–æ–¹æ³•ä¹‹é—´å¿…é¡»æ·»åŠ é€—å·ã€‚å½“æ¨¡å—å†…å®¹å¤æ‚èµ·æ¥ä¹‹åï¼Œç»´æŠ¤æˆæœ¬é«˜ï¼Œç§»åŠ¨å†…å®¹å˜å¾—æ›´åŠ å›°éš¾ã€‚

åœ¨å¤šä¸ªæ–‡ä»¶ä¸­ä½¿ç”¨ç›¸åŒçš„å‘½åç©ºé—´ï¼šå¯ä»¥å°†æ¨¡å—å®šä¹‰åˆ†æ•£åˆ°å¤šä¸ªæ–‡ä»¶ä¸­ï¼Œå¹¶æŒ‰å¦‚ä¸‹æ–¹å¼åˆ›å»ºå‘½åç©ºé—´å˜é‡ï¼Œåˆ™å¯å¿½è§†åŠ è½½æ–‡ä»¶çš„é¡ºåºã€‚

```js
var namespace = namespace || {}
```

ä½¿ç”¨å¤šä¸ªæ¨¡å—ï¼Œå¯ä»¥é€šè¿‡åˆ›å»ºå•ä¸ªå…¨å±€å‘½åç©ºé—´å¹¶å‘å…¶æ·»åŠ å­æ¨¡å—æ¥é¿å…å…¨å±€åç§°çš„æ‰©æ•£ã€‚ä¸å»ºè®®è¿›ä¸€æ­¥åµŒå¥—ï¼Œå¦‚æœåç§°å†²çªæ˜¯ä¸€ä¸ªé—®é¢˜ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨æ›´é•¿çš„åç§°ã€‚è¿™ç§æ–¹å¼ç§°ä¸ºï¼šåµŒå¥—å‘½åç©ºé—´ã€‚

```js
// å…¨å±€å‘½åç©ºé—´
var globalns = globalns || {}

// æ·»åŠ  A å­æ¨¡å—
globalns.moduleA = {
  // module content
}

// æ·»åŠ  B å­æ¨¡å—
globalns.moduleB = {
  // module content
}
```

å°½ç®¡ä½¿ç”¨å‘½åç©ºé—´å¯ä»¥åœ¨ä¸€å®šç¨‹åº¦ä¸Šè§£å†³äº†å‘½åå†²çªçš„é—®é¢˜ï¼Œä½†æ˜¯å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼šåœ¨ `moduleB` ä¸­å¯ä»¥ä¿®æ”¹ `moduleA` çš„å†…å®¹ï¼Œè€Œä¸” `moduleA` å¯èƒ½è¿˜è’™åœ¨é¼“é‡Œï¼Œä¸çŸ¥æƒ…ã€‚


> ä»¥ä¸Šå‘½åç©ºé—´å†…çš„æ‰€æœ‰æˆå‘˜å’Œæ–¹æ³•ï¼Œæ— è®ºæ˜¯å¦ç§æœ‰ï¼Œå¯¹å¤–éƒ½æ˜¯å¯è®¿é—®çš„ã€‚è¿™æ˜¯ä¸€ä¸ªæ˜æ˜¾çš„ç¼ºç‚¹ï¼Œæ¨¡å—åŒ–ä¸åº”è¯¥å¦‚æ­¤è®¾è®¡ã€‚

Yahoo å…¬å¸çš„ [YUI 2](https://clarle.github.io/yui2/) å°±æ˜¯é‡‡ç”¨äº†è¿™ç§æ–¹æ¡ˆã€‚

**2. ç«‹å³æ‰§è¡Œå‡½æ•°è¡¨è¾¾å¼ï¼ˆImmediately-Invoked Function Expressionï¼Œç®€ç§° IIFEï¼‰**

åœ¨æ¨¡å—æ¨¡å¼ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ IIFE å°†ç¯å¢ƒé™„åŠ åˆ°æ¨¡å—æ•°æ®ã€‚å¯ä»¥ä»æ¨¡å—è®¿é—®è¯¥ç¯å¢ƒå†…çš„ç»‘å®šï¼Œä½†ä¸èƒ½ä»å¤–éƒ¨è®¿é—®ã€‚å¦ä¸€ä¸ªä¼˜ç‚¹æ˜¯ IIFE ä¸ºæˆ‘ä»¬æä¾›äº†æ‰§è¡Œåˆå§‹åŒ–çš„åœ°æ–¹ã€‚

```js
var namespace = (function () {
  // private data
  var _prop = 123
  var _method = function () {}

  return {
    // read-only
    get prop() {
      return _prop
    },
    get method() {
      return _method
    }
  }
})()
```

è¿™æ ·çš„è¯ï¼Œæˆ‘ä»¬å°±ä¸ç”¨æ‹…å¿ƒï¼Œåœ¨å¤–éƒ¨ç›´æ¥ä¿®æ”¹  `namespace` å†…éƒ¨çš„æˆå‘˜æˆ–è€…æ–¹æ³•äº†ã€‚

```js
// è¯»å–
namespace.prop // 123
namespace.method() 

// å†™å…¥
namespace.prop = 456 // æ— æ•ˆ
namespace.method = function foo() {} // æ— æ•ˆ
```

å› æ­¤ï¼Œç»“åˆå‰é¢çš„å†…å®¹ï¼Œå°±å¯ä»¥è¿™æ ·å»å¤„ç†ï¼š

```js
// å…¨å±€å‘½åç©ºé—´
var globalns = globalns || {}

// æ·»åŠ  A å­æ¨¡å—
globalns.moduleA = (function () {
  // ...

  return {
    // ...
  }
})()

// æ·»åŠ  B å­æ¨¡å—
globalns.moduleB = (function () {
  // ...

  return {
    // ...
  }
})()
```

åˆ°ç°åœ¨ï¼Œæœ‰äº†å‘½åç©ºé—´è§£å†³äº†å‘½åå†²çªé—®é¢˜ï¼ŒåŒæ—¶ä½¿ç”¨ IIFE æ¥ç»´æŠ¤å„æ¨¡å—çš„ç§æœ‰æˆå‘˜å’Œæ–¹æ³•ï¼Œå¯¼å‡ºå¯¹å¤–çš„å¼€æ”¾æ¥å£å³å¯ã€‚è¿™ä¼¼ä¹æœ‰äº†æ¨¡å—åŒ–è¯¥æœ‰çš„æ ·å­ã€‚

ä½†æ˜¯ï¼Œè¿˜æœ‰ä¸€ä¸ªé—®é¢˜ã€‚å‰é¢æåˆ°è¿‡ `<script>` æ˜¯æŒ‰ä¹¦å†™é¡ºåºåŠ è½½çš„ï¼ˆå³ä½¿ä¸‹è½½é¡ºåºå¯èƒ½å¹¶è¡Œçš„ï¼‰ï¼Œä¸»è¦åŒ…æ‹¬ï¼š

* è„šæœ¬ä¸‹è½½
* è„šæœ¬è§£æï¼ˆç¼–è¯‘å’Œæ‰§è¡Œï¼‰

å‡è®¾æˆ‘ä»¬çš„è„šæœ¬å¦‚ä¸‹ï¼š

```html
<!DOCTYPE html>
<html lang="en">
  <body>
    <script src="module-a.js"></script>
    <script src="module-b.js"></script>
  </body>
</html>
```

é‚£ä¹ˆæˆ‘ä»¬çš„ `modueA` åœ¨ï¼ˆé¦–æ¬¡ï¼‰è§£æçš„æ—¶å€™ï¼Œå°±æ²¡åŠæ³•è°ƒç”¨ `moduleB` çš„å†…å®¹ï¼Œå› ä¸ºå®ƒå‹æ ¹è¿˜æ²¡è§£ææ‰§è¡Œã€‚ä¸€æ—¦é¡¹ç›®å¤æ‚åº¦ã€æ¨¡å—æ•°é‡ä¸Šæ¥ä¹‹åï¼Œæ¨¡å—ä¹‹é—´çš„ä¾èµ–å…³ç³»å°±å¾ˆéš¾ç»´æŠ¤äº†ã€‚

## ä¸‰ã€ç¤¾åŒºæ¨¡å—åŒ–æ–¹æ¡ˆ

åœ¨ ES2015 ä¹‹å‰ï¼Œç¤¾åŒºä¸Šå·²ç»æœ‰äº†å¾ˆå¤šæ¨¡å—åŒ–æ–¹æ¡ˆï¼Œæµè¡Œçš„ä¸»è¦æœ‰ä»¥ä¸‹å‡ ä¸ªï¼šï¼š

> * **CommonJS**
> * **AMD**ï¼ˆAsynchronous Module Definitionï¼‰
> * **CMD**ï¼ˆCommon Module Definitionï¼‰
> * **UMD**ï¼ˆUniversal Module Definitionï¼‰

å…¶ä¸­ CommonJS è§„èŒƒåœ¨ Node.js ç¯å¢ƒä¸‹å–å¾—äº†å¾ˆä¸é”™çš„å®è·µï¼Œå®ƒåªèƒ½åº”ç”¨äºæœåŠ¡å™¨ç«¯ï¼Œè€Œä¸æ”¯æŒæµè§ˆå™¨ç¯å¢ƒã€‚CommonJS è§„èŒƒçš„æ¨¡å—æ˜¯åŒæ­¥åŠ è½½çš„ï¼Œç”±äºæœåŠ¡å™¨çš„æ¨¡å—æ–‡ä»¶å­˜åœ¨äºæœ¬åœ°ç¡¬ç›˜ï¼Œåªæœ‰ç£ç›˜ I/O çš„ï¼Œå› æ­¤åŒæ­¥åŠ è½½æœºåˆ¶æ²¡ä»€ä¹ˆé—®é¢˜ã€‚

ä½†åœ¨æµè§ˆå™¨ç¯å¢ƒï¼Œä¸€æ˜¯ä¼šäº§ç”Ÿå¼€é”€æ›´å¤§çš„ç½‘ç»œ I/Oï¼ŒäºŒæ˜¯å¤©ç„¶å¼‚æ­¥ï¼Œå°±ä¼šäº§ç”Ÿæ—¶åºä¸Šçš„é”™è¯¯ã€‚åæ¥ç¤¾åŒºä¸Šæ¨å‡ºäº†å¼‚æ­¥åŠ è½½ã€å¯åœ¨æµè§ˆå™¨ç¯å¢ƒè¿è¡Œçš„ RequireJS æ¨¡å—åŠ è½½å™¨ï¼Œä¸ä¹…ä¹‹åï¼Œèµ·è‰å¹¶å‘å¸ƒäº† AMD æ¨¡å—åŒ–æ ‡å‡†è§„èŒƒã€‚

ç”±äº AMD ä¼šæå‰åŠ è½½ï¼Œå¾ˆå¤šå¼€å‘è€…æ‹…å¿ƒæœ‰æ€§èƒ½é—®é¢˜ã€‚å‡è®¾ä¸€ä¸ªæ¨¡å—ä¾èµ–äº†å¦å¤– 5 ä¸ªæ¨¡å—ï¼Œä¸ç®¡è¿™äº›æ¨¡å—æ˜¯å¦é©¬ä¸Šè¢«ç”¨åˆ°ï¼Œéƒ½ä¼šæ‰§è¡Œä¸€éï¼Œè¿™äº›æ€§èƒ½æ¶ˆè€—æ˜¯ä¸å®¹å¿½è§†çš„ã€‚ä¸ºäº†é¿å…è¿™ä¸ªé—®é¢˜ï¼Œæœ‰éƒ¨åˆ†äººè¯•å›¾ä¿ç•™ CommonJS ä¹¦å†™æ–¹å¼å’Œå»¶è¿ŸåŠ è½½ã€å°±è¿‘å£°æ˜ï¼ˆå°±è¿‘ä¾èµ–ï¼‰ç­‰ç‰¹æ€§ï¼Œå¹¶å¼•å…¥å¼‚æ­¥åŠ è½½æœºåˆ¶ï¼Œä»¥é€‚é…æµè§ˆå™¨ç‰¹æ€§ã€‚æ¯”å¦‚ï¼Œå·²ç»å‡‰å‡‰çš„ BravoJSã€FlyScript ç­‰æ–¹æ¡ˆã€‚

åœ¨ 2011 å¹´ï¼Œå›½å†…çš„å‰ç«¯å¤§ä½¬ç‰ä¼¯æå‡ºäº† SeaJSï¼Œå®ƒå€Ÿé‰´äº† CommonJSã€AMDï¼Œå¹¶æå‡ºäº† CMD æ¨¡å—åŒ–æ ‡å‡†è§„èŒƒã€‚ä½†å¹¶æ²¡æœ‰å¤§èŒƒå›´çš„æ¨å¹¿å’Œä½¿ç”¨ã€‚

åœ¨ 2014 å¹´ï¼Œç¾ç±åè£” Homa Wong æå‡ºäº† UMD æ–¹æ¡ˆï¼šå°† CommonJS å’Œ AMD ç›¸ç»“åˆã€‚æœ¬è´¨ä¸Šè¿™ä¸ç®—æ˜¯ä¸€ç§æ¨¡å—åŒ–æ–¹æ¡ˆã€‚

åˆ°äº† 2015 å¹´ 6 æœˆï¼Œéšç€ ECMAScript 2015 çš„æ­£å¼å‘å¸ƒï¼ŒJavaScript ç»ˆäºåŸç”Ÿæ”¯æŒæ¨¡å—åŒ–ï¼Œè¢«ç§°ä¸º ES Moduleã€‚åŒæ—¶æ”¯æŒæœåŠ¡å™¨ç«¯å’Œæµè§ˆå™¨ç«¯ã€‚

å°½ç®¡åˆ°äº† 2022 å¹´ï¼Œç°çŠ¶ä»ç„¶æ˜¯å¤šç§æ¨¡å—åŒ–æ–¹æ¡ˆå…±å­˜ï¼Œä½†æœªæ¥è‚¯å®šæ˜¯ ES Module ä¸€ç»Ÿæ±Ÿæ¹–...

> å…³äº JavaScript æ¨¡å—åŒ–å†å²çº¿ï¼Œå¯ä»¥çœ‹ä¸‹è¿™ç¯‡[æ–‡ç« ](https://segmentfault.com/a/1190000023017398)ã€‚

## å››ã€CommonJS

[Node.js](https://nodejs.org/en/) çš„æ¨¡å—ç³»ç»Ÿæ˜¯åŸºäº [CommonJS](http://www.commonjs.org/specs/modules/1.0/) è§„èŒƒçš„å®ç°çš„ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œåƒ [CouchDB](https://couchdb.apache.org/) ç­‰ä¹Ÿæ˜¯ CommonJS çš„ä¸€ç§å®ç°ã€‚è€Œä¸”å®ƒä»¬æœ‰ä¸€äº›æ˜¯æ²¡æœ‰å®Œå…¨æŒ‰ç…§ CommonJS è§„èŒƒå»å®ç°çš„ï¼Œç”šè‡³é¢å¤–æ·»åŠ äº†ç‰¹æœ‰çš„åŠŸèƒ½ã€‚

ç”±äºæˆ‘ä»¬æ¥è§¦åˆ°çš„ CommonJS é€šå¸¸æŒ‡ Node.js ä¸­çš„æ¨¡å—åŒ–è§£å†³æ–¹æ³•ï¼Œå› æ­¤ï¼Œæ¥ä¸‹æ¥æåˆ°çš„ CommonJS å‡æŒ‡ Node.js çš„æ¨¡å—ç³»ç»Ÿã€‚

å…ˆç…ä¸€ä¸‹ï¼Œä¸€ä¸ª CommonJS æ¨¡å—é‡Œé¢éƒ½åŒ…æ‹¬ä¸€äº›ä»€ä¹ˆä¿¡æ¯ï¼š

![](https://upload-images.jianshu.io/upload_images/5128488-00c9aa6d08914919.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

å¦‚æœæœ‰ä¸€äº›çœ‹ä¸æ‡‚æˆ–ä¸äº†è§£å…¶ç”¨å¤„çš„ï¼Œå…ˆä¸æ€¥ï¼Œä¸‹é¢å¨“å¨“é“æ¥ã€‚

CommonJS çš„æ¨¡å—ç‰¹ç‚¹ï¼š

> * æ¯ä¸€ä¸ª JavaScript æ–‡ä»¶å°±æ˜¯ä¸€ä¸ªç‹¬ç«‹æ¨¡å—ï¼Œå…¶ä½œç”¨åŸŸä»…åœ¨æ¨¡å—å†…ï¼Œä¸ä¼šæ±¡æŸ“å…¨å±€ä½œç”¨åŸŸã€‚
> * ä¸€ä¸ªæ¨¡å—åŒ…æ‹¬ `require`ã€`module`ã€`exports` ä¸‰ä¸ªæ ¸å¿ƒå˜é‡ã€‚
> * å…¶ä¸­ `module.exports`ã€`exports` è´Ÿè´£æ¨¡å—çš„å†…å®¹å¯¼å‡ºã€‚åè€…åªæ˜¯å‰è€…çš„â€œåˆ«åâ€ï¼Œè‹¥ä½¿ç”¨ä¸å½“ï¼Œè¿˜å¯èƒ½ä¼šå¯¼è‡´æ— æ³•å¯¼å‡ºé¢„æœŸå†…å®¹ã€‚å…¶ä¸­ `require` è´Ÿè´£å…¶ä»–æ¨¡å—å†…å®¹çš„å¯¼å…¥ï¼Œè€Œä¸”å…¶å¯¼å…¥çš„æ˜¯å…¶ä»–æ¨¡å—çš„ `module.exports` å¯¹è±¡ã€‚
> * æ¨¡å—å¯ä»¥åŠ è½½å¤šæ¬¡ï¼Œä½†åªä¼šåœ¨ç¬¬ä¸€æ¬¡åŠ è½½æ—¶è¿è¡Œä¸€æ¬¡ï¼Œç„¶åè¿è¡Œç»“æœå°±ä¼šè¢«ç¼“å­˜èµ·æ¥ã€‚ä¸‹æ¬¡å†åŠ è½½æ˜¯ç›´æ¥è¯»å–ç¼“å­˜ç»“æœã€‚æ¨¡å—ç¼“å­˜æ˜¯å¯ä»¥è¢«æ¸…é™¤çš„ã€‚
> * æ¨¡å—çš„åŠ è½½æ˜¯åŒæ­¥çš„ï¼Œè€Œä¸”æ˜¯æŒ‰ç¼–å†™é¡ºåºè¿›è¡ŒåŠ è½½ã€‚


#### 4.1 Module å¯¹è±¡

å‰é¢æ‰“å°çš„ `module` å°±æ˜¯ `Module` çš„å®ä¾‹å¯¹è±¡ã€‚æ¯ä¸ªæ¨¡å—å†…éƒ¨ï¼Œéƒ½æœ‰ä¸€ä¸ª `module` å¯¹è±¡ï¼Œè¡¨ç¤ºå½“å‰æ¨¡å—ã€‚å®ƒæœ‰ä»¥ä¸‹å±æ€§ï¼š

```js
// Module æ„é€ å‡½æ•°
function Module(id = '', parent) {
  this.id = id
  this.path = path.dirname(id)
  this.exports = {}
  moduleParentCache.set(this, parent)
  updateChildren(parent, this, false)
  this.filename = null
  this.loaded = false
  this.children = []
}
```
æºç  ğŸ‘‰ [node/lib/internal/modules/cjs/loader.jsï¼ˆNode.js v17.xï¼‰](https://github.com/nodejs/node/blob/34be1af5e17195dd9ce127e1daa7ab2bafd2df84/lib/internal/modules/cjs/loader.js#L172-L181)

> `module.id`ï¼šè¿”å›å­—ç¬¦ä¸²ï¼Œè¡¨ç¤ºæ¨¡å—çš„æ ‡è¯†ç¬¦ï¼Œé€šå¸¸è¿™æ˜¯å®Œå…¨è§£æçš„æ–‡ä»¶åã€‚
> `module.path`ï¼šè¿”å›å­—ç¬¦ä¸²ï¼Œè¡¨ç¤ºæ¨¡å—çš„ç›®å½•åç§°ï¼Œé€šå¸¸ä¸Â `module.id`Â çš„Â `path.dirname()`Â ç›¸åŒã€‚
> `module.exports`ï¼šæ¨¡å—å¯¹å¤–è¾“å‡ºçš„æ¥å£ï¼Œé»˜è®¤å€¼ä¸º `{}`ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œ`module.exports` ä¸ `exports` æ˜¯ç›¸ç­‰çš„ã€‚
> `module.filename`ï¼šè¿”å›å­—ç¬¦ä¸²ï¼Œè¡¨ç¤ºæ¨¡å—çš„å®Œå…¨è§£ææ–‡ä»¶åï¼ˆå«ç»å¯¹è·¯å¾„ï¼‰ã€‚
> `module.loaded`ï¼šè¿”å›å¸ƒå°”å€¼ï¼Œè¡¨ç¤ºæ¨¡å—æ˜¯å¦å·²å®ŒæˆåŠ è½½æˆ–æ­£åœ¨åŠ è½½ã€‚
> `module.children`ï¼šè¿”å›æ•°ç»„ï¼Œè¡¨ç¤ºå½“å‰æ¨¡å—å¼•ç”¨çš„å…¶ä»–æ¨¡å—çš„å®ä¾‹å¯¹è±¡ã€‚
> `module.parent`ï¼šè¿”å› `null` æˆ–æ•°ç»„ã€‚è‹¥è¿”å›å€¼ä¸ºæ•°ç»„æ—¶ï¼Œè¡¨ç¤ºå½“å‰æ¨¡å—è¢«å…¶ä»–æ¨¡å—å¼•ç”¨äº†ï¼Œè€Œä¸”æ¯ä¸ªæ•°ç»„å…ƒç´ è¡¨ç¤ºè¢«å¼•ç”¨æ¨¡å—å¯¹åº”çš„å®ä¾‹å¯¹è±¡ã€‚
> `module.paths`ï¼šè¿”å›æ•°ç»„ï¼Œè¡¨ç¤ºæ¨¡å—çš„æœç´¢è·¯å¾„ï¼ˆå«ç»å¯¹è·¯å¾„ï¼‰ã€‚
> `module.isPreloading`ï¼šè¿”å›å¸ƒå°”å€¼ï¼Œå¦‚æœæ¨¡å—åœ¨ Node.js é¢„åŠ è½½é˜¶æ®µè¿è¡Œï¼Œåˆ™ä¸º trueã€‚

**æ³¨æ„ç‚¹**

* èµ‹å€¼ç»™ `module.exports` å¿…é¡»ç«‹å³å®Œæˆï¼Œä¸èƒ½åœ¨ä»»ä½•å›è°ƒä¸­å®Œæˆï¼ˆåº”åœ¨åŒæ­¥ä»»åŠ¡ä¸­å®Œæˆï¼‰ã€‚
æ¯”å¦‚ï¼Œåœ¨ `setTimeout` å›è°ƒä¸­å¯¹ `module.exports` è¿›è¡Œèµ‹å€¼æ˜¯â€œä¸èµ·ä½œç”¨â€çš„ï¼ŒåŸå› æ˜¯ CommonJS æ¨¡å—åŒ–æ˜¯åŒæ­¥åŠ è½½çš„ã€‚

è¯·çœ‹ç¤ºä¾‹ï¼š

```js
// module-a.js
setTimeout(() => {
  module.exports = { welcome: 'Hello World' }
}, 0)

// module-b.js
const a = require('./a')
console.log(a.welcome) // undefined

// âŒ é”™è¯¯ç¤ºä¾‹
```

å†çœ‹ä¸ªç¤ºä¾‹ï¼š

```js
// module-a.js
const EventEmitter = require('events')
module.exports = new EventEmitter() // åŒæ­¥ä»»åŠ¡ä¸­å®Œæˆå¯¹ module.exports çš„èµ‹å€¼

setTimeout(() => {
  module.exports.emit('ready') // â“ è¿™ä¸ªä¼šç”Ÿæ•ˆå—ï¼Ÿ
}, 1000)

// module-b.js
const a = require('./module-a')
a.on('ready', () => {
  console.log('module a is ready')
})

// âš ï¸ æ‰§è¡Œ `node module-b.js` å‘½ä»¤è¿è¡Œè„šæœ¬ï¼Œä»¥ä¸Š ready äº‹ä»¶å¯ä»¥æ­£å¸¸å“åº”ï¼Œ
// åŸå›  require() ä¼šå¯¹æ¨¡å—è¾“å‡ºå€¼è¿›è¡Œâ€œæµ…æ‹·è´â€ï¼Œå› æ­¤ module-a.js ä¸­çš„ setTimeout æ˜¯å¯ä»¥æ›´æ–° EventEmitter å®ä¾‹å¯¹è±¡çš„ã€‚
```

* å½“ `module.exports` å±æ€§è¢«æ–°å¯¹è±¡å®Œå…¨æ›¿æ¢æ—¶ï¼Œé€šå¸¸ä¹Ÿä¼šâ€œè‡ªåŠ¨â€é‡æ–°åˆ†é… `exports`ï¼ˆè‡ªåŠ¨æ˜¯æŒ‡ä¸æ˜¾å¼åˆ†é…æ–°å¯¹è±¡ç»™ `exports` å˜é‡çš„å‰æä¸‹ï¼‰ã€‚ä½†æ˜¯ï¼Œå¦‚æœä½¿ç”¨ `exports` å˜é‡å¯¼å‡ºæ–°å¯¹è±¡ï¼Œåˆ™å¿…é¡»â€œæ‰‹åŠ¨â€å…³è” `module.exprots` å’Œ `exports`ï¼Œå¦åˆ™æ— æ³•æŒ‰é¢„æœŸè¾“å‡ºæ¨¡å—å€¼ã€‚

è¯·çœ‹ç¤ºä¾‹ï¼š

```js
// 1ï¸âƒ£ ä»¥è¿™ç§æ–¹å¼è¿›è¡Œæ¨¡å—çš„è¾“å‡ºï¼Œmodule.exports ä¸ exports ä¼šè‡ªåŠ¨åˆ†é…ï¼Œå³ module.exports === exports
module.exports = {
  // ...
}

// 2ï¸âƒ£ ä»¥è¿™ç§æ–¹å¼å¯¼å‡ºçš„å€¼ï¼Œå°†ä¼šæ˜¯ç©ºå¯¹è±¡ {}ï¼Œè€Œä¸æ˜¯ { sayHi: <Function> }
// æ­¤æ—¶ module.exports !== exports
exports = { sayHi: function () {} } // âŒ

// 3ï¸âƒ£ è§£å†³ä»¥ä¸Šé—®é¢˜ï¼Œéœ€è¦æ‰‹åŠ¨å…³è” module.exprots å’Œ exportsï¼Œä½¿å¾—äºŒè€…ç›¸ç­‰
module.exports = exports = { sayHi: function () {} } // âœ…
```

* ç”±ä»¥ä¸Šç¤ºä¾‹ä¹Ÿå¯ä»¥çœ‹å‡ºï¼Œ`require()` æ–¹æ³•å¼•ç”¨çš„æ˜¯ `module.exports` å¯¹è±¡ï¼Œè€Œä¸æ˜¯ `exports` å˜é‡ã€‚
* åˆ©ç”¨ `module.parent` è¿”å› `null` æˆ–æ•°å€¼çš„ç‰¹æ€§ï¼Œå¯ä»¥åˆ¤æ–­å½“å‰æ¨¡å—æ˜¯å¦ä¸ºå…¥å£è„šæœ¬ã€‚å¦å¤–ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ `require.main` æ¥è·å–å…¥å£è„šæœ¬çš„å®ä¾‹å¯¹è±¡ã€‚

**module.exports ä¸ exports çš„æ³¨æ„ç‚¹**

æ­¤å‰å·²å†™è¿‡ä¸€ç¯‡[æ–‡ç« ](https://github.com/toFrankie/blog/issues/218)å»ä»‹ç»å®ƒä¿©çš„åŒºåˆ«äº†ã€‚

> ä¸€å¥è¯æ€»ç»“ï¼š**`exports` å˜é‡åªæ˜¯ `module.exports` å±æ€§çš„ä¸€ä¸ªåˆ«åï¼Œä»…æ­¤è€Œå·²ã€‚**

æˆ‘ä»¬å¯ä»¥è¿™æ ·å¯¹æ¨¡å—è¿›è¡Œè¾“å‡ºï¼š

```js
module.exports = {
  name: 'Frankie',
  age: 20,
  sayHi: () => console.log('Hi~')
}

// ç›¸å½“äº
exports.name = 'Frankie'
exports.age = 20
exports.sayHi = () => console.log('Hi~')
```

ä½†è¯·æ³¨æ„ï¼Œè‹¥æ¨¡å—åªå¯¹å¤–è¾“å‡ºä¸€ä¸ªæ¥å£ï¼Œä½¿ç”¨ä¸å½“ï¼Œå¯èƒ½ä¼šæ— æ³•æŒ‰é¢„æœŸå·¥ä½œã€‚æ¯”å¦‚ï¼š

```js
// âŒ ä»¥ä¸‹æ¨¡å—çš„è¾“å‡ºæ˜¯â€œæ— æ•ˆâ€çš„ï¼Œæœ€ç»ˆè¾“å‡ºå€¼ä»æ˜¯ {}
exports = function () { console.log('Hi~') }
```

åŸå› å¾ˆç®€å•ï¼Œåœ¨é»˜è®¤æƒ…å†µä¸‹ `module.exports` å±æ€§å’Œ `exports` å˜é‡éƒ½æ˜¯åŒä¸€ä¸ªç©ºå¯¹è±¡ `{}`ï¼ˆé»˜è®¤å€¼ï¼‰çš„**å¼•ç”¨**ï¼ˆreferenceï¼‰ï¼Œå³ `module.exports === exports`ã€‚

å½“å¯¹ `exports` å˜é‡é‡æ–°èµ‹äºˆä¸€ä¸ªåŸºæœ¬å€¼æˆ–å¼•ç”¨å€¼çš„æ—¶å€™ï¼Œ `module.exports` å’Œ `exports` ä¹‹é—´çš„è”ç³»è¢«åˆ‡æ–­äº†ï¼Œæ­¤æ—¶  `module.exports !== exports`ï¼Œåœ¨å½“å‰æ¨¡å—ä¸‹ `module.exports` çš„å€¼ä»ä¸º `{}`ï¼Œè€Œ `exports` å˜é‡çš„å€¼å˜ä¸ºå‡½æ•°ã€‚è€Œ `require()` æ–¹æ³•çš„è¿”å›å€¼æ˜¯æ‰€å¼•ç”¨æ¨¡å—çš„ `module.exports` çš„æµ…æ‹·è´ç»“æœã€‚

æ­£ç¡®å§¿åŠ¿åº”è¯¥æ˜¯ï¼š

```js
module.exports = export = function () { console.log('Hi~') } // âœ…
```

ä½¿ç”¨ç±»ä¼¼å¤„ç†ï¼Œä½¿å¾— `module.exports` ä¸ `exports` é‡æ–°å»ºç«‹å…³è”å…³ç³»ã€‚

è¿™é‡Œå¹¶ä¸å­˜åœ¨ä»»ä½•éš¾ç‚¹ï¼Œä»…ä»…æ˜¯ JavaScript åŸºæœ¬æ•°æ®ç±»å‹å’Œå¼•ç”¨æ•°æ®ç±»å‹çš„ç‰¹æ€§ç½¢äº†ã€‚å¦‚æœä½ è¿˜æ˜¯åˆ†ä¸æ¸…æ¥šçš„è¯ï¼Œå»ºè®®åªä½¿ç”¨ `module.exports` è¿›è¡Œå¯¼å‡ºï¼Œè¿™æ ·çš„è¯ï¼Œå°±ä¸ä¼šæœ‰é—®é¢˜äº†ã€‚

#### 4.2 require æŸ¥æ‰¾ç®—æ³•

`require()` å‚æ•°å¾ˆç®€å•ï¼Œé‚£ä¹ˆ `require()` å†…éƒ¨æ˜¯å¦‚ä½•æŸ¥æ‰¾æ¨¡å—çš„å‘¢ï¼Ÿ

ç®€å•å¯ä»¥åˆ†ä¸ºå‡ ç±»ï¼š

- åŠ è½½ Node å†…ç½®æ¨¡å—
  å½¢å¼å¦‚ï¼š`require('fs')`ã€`require('http')` ç­‰ã€‚

- ç›¸å¯¹è·¯å¾„ã€ç»å¯¹è·¯å¾„åŠ è½½æ¨¡å—
  å½¢å¼å¦‚ï¼š`require('./file')`ã€`require('../file')`ã€`require('/file')`ã€‚

- åŠ è½½ç¬¬ä¸‰æ–¹æ¨¡å—ï¼ˆå³éå†…ç½®æ¨¡å—ï¼‰
  å½¢å¼å¦‚ï¼š`require('react')`ã€`require('lodash/debounce')`ã€`require('some-library')`ã€`require('#some-library')` ç­‰ã€‚

å…¶ä¸­ï¼Œç»å¯¹è·¯å¾„å½¢å¼åœ¨å®é™…é¡¹ç›®ä¸­å‡ ä¹ä¸ä¼šä½¿ç”¨ï¼ˆåæ­£æˆ‘æ˜¯æ²¡ç”¨è¿‡ï¼‰ã€è€Œ `require('#some-library')` å½¢å¼ç›®å‰ä»åœ¨è¯•éªŒé˜¶æ®µ...

ä»¥ä¸‹åŸºäº [Node.js å®˜ç½‘](https://nodejs.org/api/modules.html#all-together) ç›¸å…³å†…å®¹ç¿»è¯‘å¹¶æ•´ç†çš„ç‰ˆæœ¬ï¼ˆ[å­˜æ¡£](https://codesandbox.io/s/interesting-agnesi-46jjzl?file=/README.md)ï¼‰

```txt
åœºæ™¯ï¼šåœ¨ `Y.js` æ–‡ä»¶ä¸‹ï¼Œ`require(X)`ï¼ŒNode.js å†…éƒ¨æ¨¡å—æŸ¥æ‰¾ç®—æ³•ï¼š

1. å¦‚æœ `X` ä¸ºå†…ç½®æ¨¡å—çš„è¯ï¼Œç«‹å³è¿”å›è¯¥æ¨¡å—ï¼›

   å› æ­¤ï¼Œå¾€ NPM å¹³å°ä¸Šå‘åŒ…çš„è¯ï¼Œ`package.json` ä¸­çš„ `name` å­—æ®µä¸èƒ½ä¸ Node.js å†…ç½®æ¨¡å—åŒåã€‚

2. å¦‚æœ `X` æ˜¯ä»¥ç»å¯¹è·¯å¾„æˆ–ç›¸å¯¹è·¯å¾„å½¢å¼ï¼Œæ ¹æ® `Y` æ‰€åœ¨ç›®å½•ä»¥åŠ `X` çš„å€¼ä»¥ç¡®å®šæ‰€è¦æŸ¥æ‰¾çš„æ¨¡å—è·¯å¾„ï¼ˆç§°ä¸º `Z`ï¼‰ã€‚

  a. å°† `Z` å½“ä½œã€Œæ–‡ä»¶ã€ï¼ŒæŒ‰ `Z`ã€`Z.js`ã€`Z.json`ã€`Z.node` é¡ºåºæŸ¥æ‰¾æ–‡ä»¶ï¼Œè‹¥æ‰¾åˆ°ç«‹å³è¿”å›æ–‡ä»¶ï¼Œå¦åˆ™ç»§ç»­å¾€ä¸‹æŸ¥æ‰¾ï¼›
  b. å°† `Z` å½“ä½œã€Œç›®å½•ã€ï¼Œ
     1ï¼‰æŸ¥æ‰¾ `Z/package.json` æ˜¯å¦å­˜åœ¨ï¼Œè‹¥ `package.json` å­˜åœ¨ä¸”å…¶ `main` å­—æ®µå€¼ä¸ä¸ºè™šå€¼ï¼Œå°†ä¼šæŒ‰ç…§å…¶å€¼ç¡®å®šæ¨¡å—ä½ç½®ï¼Œå¦åˆ™ç»§ç»­å¾€ä¸‹ï¼›
     2ï¼‰æŒ‰ `Z/index.js`ã€`Z/index.json`ã€`Z/index.node` é¡ºåºæŸ¥æ‰¾æ–‡ä»¶ï¼Œè‹¥æ‰¾åˆ°ç«‹å³è¿”å›æ–‡ä»¶ï¼Œå¦åˆ™ä¼šæŠ›å‡ºå¼‚å¸¸ "not found"ã€‚

3. è‹¥ `X` æ˜¯ä»¥ `#` å·å¼€å¤´çš„ï¼Œå°†ä¼šæŸ¥æ‰¾æœ€é è¿‘ `Y` çš„ `package.json` ä¸­çš„ `imports` å­—æ®µä¸­ `node`ã€`require` å­—æ®µçš„å€¼ç¡®è®¤æ¨¡å—çš„å…·ä½“ä½ç½®ã€‚
  ï¼ˆè¿™ä¸€ç±»ç°é˜¶æ®µç”¨å¾—æ¯”è¾ƒå°‘ï¼Œåé¢å†å±•å¼€ä»‹ç»ä¸€ä¸‹ï¼‰
   // https://github.com/nodejs/node/pull/34117

4. åŠ è½½è‡ªèº«å¼•ç”¨ `LOAD_PACKAGE_SELF(X, dirname(Y))`

    a. å¦‚æœå½“å‰æ‰€åœ¨ç›®å½•å­˜åœ¨ `package.json` æ–‡ä»¶ï¼Œè€Œä¸” `package.json` ä¸­å­˜åœ¨ `exports` å­—æ®µï¼Œ
       å…¶ä¸­ `name` å­—æ®µçš„å€¼è¿˜è¦æ˜¯ `X` å¼€å¤´ä¸€éƒ¨åˆ†ï¼Œ
       æ»¡è¶³å‰ç½®æ¡ä»¶ä¸‹ï¼Œå°±ä¼šåŒ¹é… subpath å¯¹åº”çš„æ¨¡å—ï¼ˆæ— åŒ¹é…é¡¹ä¼šæŠ›å‡ºå¼‚å¸¸ï¼‰ã€‚
      ï¼ˆè¿™é‡Œæåˆ°çš„ subpath ä¸ 5.b.1).1.1 ç±»ä¼¼ï¼‰
    b. è‹¥ä¸æ»¡è¶³ a ä¸­ä»»æ„ä¸€ä¸ªæ¡ä»¶å‡ä¸æ»¡è¶³ï¼Œæ­¥éª¤ 4 æ‰§è¡Œå®Œæ¯•ï¼Œç»§ç»­å¾€ä¸‹æŸ¥æ‰¾ã€‚

5. åŠ è½½ node_modules `LOAD_NODE_MODULES(X, dirname(Y))`
   a. ä»å½“å‰æ¨¡å—æ‰€åœ¨ç›®å½•ï¼ˆå³ `dirname(Y)`ï¼‰å¼€å§‹ï¼Œé€å±‚æŸ¥æ‰¾æ˜¯å¦ `node_modules/X` æ˜¯å¦å­˜åœ¨ï¼Œ
      è‹¥æ‰¾åˆ°å°±è¿”å›ï¼Œå¦åˆ™ç»§ç»­å¾€çˆ¶çº§ç›®å½•æŸ¥æ‰¾ `node_modules/X` ï¼Œä¾æ¬¡ç±»æ¨ï¼Œç›´åˆ°æ–‡ä»¶ç³»ç»Ÿæ ¹ç›®å½•ã€‚
   b. ä»å…¨å±€ç›®å½•ï¼ˆæŒ‡ `NODE_PATH` ç¯å¢ƒå˜é‡ç›¸å…³çš„ç›®å½•ï¼‰ç»§ç»­æŸ¥æ‰¾ã€‚
  
   è‹¥ `LOAD_NODE_MODULES` è¿‡ç¨‹æŸ¥æ‰¾åˆ°æ¨¡å— Xï¼ˆå¯å¾—åˆ° X å¯¹åº”çš„ç»å¯¹è·¯å¾„ï¼Œå‡å®šä¸º Mï¼‰ï¼Œå°†æŒ‰ä»¥ä¸‹æ­¥éª¤æŸ¥æ‰¾æŸ¥æ‰¾ï¼š
      1) è‹¥ Node.js ç‰ˆæœ¬æ”¯æŒ `exports` å­—æ®µï¼ˆNode.js 12+ï¼‰ï¼Œ
          1.1 å°è¯•å°† `M` æ‹†åˆ†ä¸º name å’Œ subpath å½¢å¼ï¼ˆä¸‹ç§° name ä¸º `NAME`ï¼‰

              æ¯”å¦‚ `my-pkg` æ‹†åˆ†åï¼Œname ä¸º `my-pkg`ï¼Œsubpath åˆ™ä¸ºç©ºï¼ˆä¸ºç©ºçš„è¯ï¼Œå¯¹åº”  `exports` çš„ "." å¯¼å‡ºï¼‰ã€‚
              æ¯”å¦‚ `my-pkg/sub-module` æ‹†åˆ†åï¼Œname ä¸º `my-pkg`ï¼Œsubpath ä¸º `sub-module`ã€‚
              è¯·æ³¨æ„å¸¦ Scope çš„åŒ…ï¼Œæ¯”å¦‚ `@myorg/my-pkg/sub-module` æ‹†åˆ†å name åº”ä¸º `@myorg/my-pkg`ï¼Œsubpath ä¸º `sub-module`ã€‚

          1.2 å¦‚æœåœ¨ M ç›®å½•ä¸‹å­˜åœ¨ `NAME/package.json` æ–‡ä»¶ï¼Œè€Œä¸” `package.json` çš„ `exports` å­—æ®µæ˜¯çœŸå€¼ï¼Œ
              ç„¶åæ ¹æ® subpath åŒ¹é… `exports` å­—æ®µé…ç½®ï¼Œæ‰¾åˆ°å¯¹åº”çš„æ¨¡å—ï¼ˆè‹¥ subpath åŒ¹é…ä¸ä¸Šçš„å°†ä¼šæŠ›å‡ºå¼‚å¸¸ï¼‰ã€‚
              è¯·æ³¨æ„ï¼Œç”±äº `exports` æ”¯æŒæ¡ä»¶å¯¼å‡ºï¼Œè€Œä¸”è¿™é‡ŒæŸ¥æ‰¾çš„æ˜¯ CommonJS æ¨¡å—ï¼Œ
              å› æ­¤ `exports` çš„ `node`ã€`require`ã€`default` å­—æ®µéƒ½æ˜¯æ”¯æŒçš„ï¼Œé”®é¡ºåºæ›´æ—©å®šä¹‰çš„ä¼˜å…ˆçº§æ›´é«˜ã€‚

          1.3 å¦‚æœä»¥ä¸Šä»»æ„ä¸€ä¸ªæ¡ä»¶ä¸æ»¡è¶³çš„è¯ï¼Œå°†ç»§ç»­æ‰§è¡Œ 2) æ­¥éª¤

      2) å°† X ä»¥ç»å¯¹è·¯å¾„çš„å½¢å¼æŸ¥æ‰¾æ¨¡å—ï¼ˆå³å‰é¢çš„æ­¥éª¤ 2ï¼‰ï¼Œè‹¥æ‰¾ä¸åˆ°æ­¥éª¤ 5 æ‰§è¡Œå®Œæ¯•ï¼Œå°†ä¼šè·‘åˆ°æ­¥éª¤ 6ã€‚

6. æŠ›å‡ºå¼‚å¸¸ "not found"
```

å¦‚æœä¸æ˜¯å¼€å‘ NPM åŒ…ï¼Œåœ¨å®é™…ä½¿ç”¨ä¸­çš„è¯ï¼Œå¹¶æ²¡æœ‰ä»¥ä¸Šé‚£ä¹ˆå¤šå¤æ‚çš„æ­¥éª¤ï¼Œå¾ˆå®¹æ˜“ç†è§£ã€‚ä½†æ·±å…¥äº†è§£ä¹‹åæœ‰åŠ©äºå¹³å¸¸é‡åˆ°é—®é¢˜æ›´å¿«æ’æŸ¥å‡ºåŸå› å¹¶å¤„ç†æ‰ã€‚å¦‚æœä½ æ˜¯å‘åŒ…çš„è¯ï¼Œå¯ä»¥åˆ©ç”¨ `exports` ç­‰åšæ¡ä»¶å¯¼å‡ºæ¨¡å—ã€‚

æƒ³äº†è§£ Node.js package.json çš„ä¸¤ä¸ªå­—æ®µçš„æ„ä¹‰ï¼Œè¯·çœ‹ï¼š

* [exports](http://nodejs.cn/api/packages.html#exports)ï¼ˆNode.js 12 èµ·æ”¯æŒï¼‰
* [imports](http://nodejs.cn/api/packages.html#imports)


#### 4.3 require æºç 

æºç  ğŸ‘‰ [node/lib/internal/modules/cjs/loader.jsï¼ˆNode.js v17.xï¼‰](https://github.com/nodejs/node/blob/34be1af5e17195dd9ce127e1daa7ab2bafd2df84/lib/internal/modules/cjs/loader.js#L989-L1003)

```js
// Loads a module at the given file path. Returns that module's `exports` property.
Module.prototype.require = function (id) {
  validateString(id, 'id')
  if (id === '') {
    throw new ERR_INVALID_ARG_VALUE('id', id, 'must be a non-empty string')
  }
  requireDepth++
  try {
    return Module._load(id, this, /* isMain */ false)
  } finally {
    requireDepth--
  }
}
```


æºç  ğŸ‘‰ [node/lib/internal/modules/cjs/loader.jsï¼ˆNode.js v17.xï¼‰](https://github.com/nodejs/node/blob/34be1af5e17195dd9ce127e1daa7ab2bafd2df84/lib/internal/modules/cjs/loader.js#L750-L846)

```js
/**
 * æ£€æŸ¥æ‰€è¯·æ±‚æ–‡ä»¶çš„ç¼“å­˜
 * 1. å¦‚æœç¼“å­˜ä¸­å·²å­˜åœ¨è¯·æ±‚çš„æ–‡ä»¶ï¼Œè¿”å›å…¶å¯¼å‡ºå¯¹è±¡ï¼ˆmodule.exportsï¼‰
 * 2. å¦‚æœè¯·æ±‚çš„æ˜¯åŸç”Ÿæ¨¡å—ï¼Œè°ƒç”¨ `NativeModule.prototype.compileForPublicLoader()` å¹¶è¿”å›å…¶å¯¼å‡ºå¯¹è±¡
 * 3. å¦åˆ™ï¼Œä¸ºè¯¥æ–‡ä»¶åˆ›å»ºä¸€ä¸ªæ–°æ¨¡å—å¹¶å°†å…¶ä¿å­˜åˆ°ç¼“å­˜ä¸­ã€‚ ç„¶åè®©å®ƒåœ¨è¿”å›å…¶å¯¼å‡ºå¯¹è±¡ä¹‹å‰åŠ è½½æ–‡ä»¶å†…å®¹ã€‚
 */
Module._load = function (request, parent, isMain) {
  let relResolveCacheIdentifier
  if (parent) {
    debug('Module._load REQUEST %s parent: %s', request, parent.id)
    // Fast path for (lazy loaded) modules in the same directory. The indirect
    // caching is required to allow cache invalidation without changing the old
    // cache key names.
    relResolveCacheIdentifier = `${parent.path}\x00${request}`
    const filename = relativeResolveCache[relResolveCacheIdentifier]
    if (filename !== undefined) {
      const cachedModule = Module._cache[filename]
      if (cachedModule !== undefined) {
        updateChildren(parent, cachedModule, true)
        if (!cachedModule.loaded) return getExportsForCircularRequire(cachedModule)
        return cachedModule.exports
      }
      delete relativeResolveCache[relResolveCacheIdentifier]
    }
  }

  // 1ï¸âƒ£ è·å– require(id) ä¸­ id çš„ç»å¯¹è·¯å¾„ï¼ˆfilename ä½œä¸ºæ¨¡å—çš„æ ‡è¯†ç¬¦ï¼‰
  const filename = Module._resolveFilename(request, parent, isMain)

  if (StringPrototypeStartsWith(filename, 'node:')) {
    // Slice 'node:' prefix
    const id = StringPrototypeSlice(filename, 5)

    const module = loadNativeModule(id, request)
    if (!module?.canBeRequiredByUsers) {
      throw new ERR_UNKNOWN_BUILTIN_MODULE(filename)
    }

    return module.exports
  }

  // 2ï¸âƒ£ ç¼“åŠ¨æ˜¯å¦å­˜åœ¨ç¼“å­˜
  // æ‰€æœ‰åŠ è½½è¿‡çš„æ¨¡å—éƒ½ç¼“å­˜äº Module._cache ä¸­ï¼Œä»¥æ¨¡å—çš„ç»å¯¹è·¯å¾„ä½œä¸ºé”®å€¼ï¼ˆcache keyï¼‰
  const cachedModule = Module._cache[filename]

  if (cachedModule !== undefined) {
    updateChildren(parent, cachedModule, true)
    if (!cachedModule.loaded) {
      const parseCachedModule = cjsParseCache.get(cachedModule)
      if (!parseCachedModule || parseCachedModule.loaded) return getExportsForCircularRequire(cachedModule)
      parseCachedModule.loaded = true
    } else {
      // è‹¥è¯¥æ¨¡å—ç¼“å­˜è¿‡ï¼Œåˆ™ç›´æ¥è¿”å›è¯¥æ¨¡å—çš„ module.exports å±æ€§
      return cachedModule.exports
    }
  }

  // 3ï¸âƒ£ åŠ è½½ Node.js åŸç”Ÿæ¨¡å—ï¼ˆå†…ç½®æ¨¡å—ï¼‰
  const mod = loadNativeModule(filename, request)
  if (mod?.canBeRequiredByUsers) return mod.exports

  // 4ï¸âƒ£ è‹¥è¯·æ±‚æ¨¡å—æ— ç¼“å­˜ï¼Œè°ƒç”¨ Module æ„é€ å‡½æ•°ç”Ÿæˆæ¨¡å—å®ä¾‹ module
  const module = cachedModule || new Module(filename, parent)

  // å¦‚æœæ˜¯å…¥å£è„šæœ¬ï¼Œå°†å…¥å£æ¨¡å—çš„ id ç½®ä¸º "."
  if (isMain) {
    process.mainModule = module
    module.id = '.'
  }

  // 5ï¸âƒ£ å°†æ¨¡å—å­˜å…¥ç¼“å­˜ä¸­
  // âš ï¸âš ï¸âš ï¸ åœ¨æ¨¡å—æ‰§è¡Œä¹‹å‰ï¼Œæå‰æ”¾å…¥ç¼“å­˜ï¼Œä»¥å¤„ç†ã€Œå¾ªç¯å¼•ç”¨ã€çš„é—®é¢˜
  // See, http://nodejs.cn/api/modules.html#cycles
  Module._cache[filename] = module
  if (parent !== undefined) {
    relativeResolveCache[relResolveCacheIdentifier] = filename
  }

  let threw = true
  try {
    // 6ï¸âƒ£ æ‰§è¡Œæ¨¡å—
    module.load(filename)
    threw = false
  } finally {
    if (threw) {
      delete Module._cache[filename]
      if (parent !== undefined) {
        delete relativeResolveCache[relResolveCacheIdentifier]
        const children = parent?.children
        if (ArrayIsArray(children)) {
          const index = ArrayPrototypeIndexOf(children, module)
          if (index !== -1) {
            ArrayPrototypeSplice(children, index, 1)
          }
        }
      }
    } else if (
      module.exports &&
      !isProxy(module.exports) &&
      ObjectGetPrototypeOf(module.exports) === CircularRequirePrototypeWarningProxy
    ) {
      ObjectSetPrototypeOf(module.exports, ObjectPrototype)
    }
  }

  // 7ï¸âƒ£ è¿”å›æ¨¡å—çš„è¾“å‡ºæ¥å£
  return module.exports
}
```

#### 4.4 require ä¸­å‡ ä¸ªå¸¸è§çš„é—®é¢˜

Q: Node.js æ˜¯å¦‚ä½•å®ç°åŒæ­¥åŠ è½½æœºåˆ¶çš„ï¼Ÿ
A: 

<!--

## å¾…æ•´ç†

1. CommonJSè§„èŒƒåŠ è½½æ¨¡å—æ˜¯åŒæ­¥çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåªæœ‰åŠ è½½å®Œæˆï¼Œæ‰èƒ½æ‰§è¡Œåé¢çš„æ“ä½œã€‚AMDè§„èŒƒåˆ™æ˜¯éåŒæ­¥åŠ è½½æ¨¡å—ï¼Œå…è®¸æŒ‡å®šå›è°ƒå‡½æ•°ã€‚ç”±äºNode.jsä¸»è¦ç”¨äºæœåŠ¡å™¨ç¼–ç¨‹ï¼Œæ¨¡å—æ–‡ä»¶ä¸€èˆ¬éƒ½å·²ç»å­˜åœ¨äºæœ¬åœ°ç¡¬ç›˜ï¼Œæ‰€ä»¥åŠ è½½èµ·æ¥æ¯”è¾ƒå¿«ï¼Œä¸ç”¨è€ƒè™‘éåŒæ­¥åŠ è½½çš„æ–¹å¼ï¼Œæ‰€ä»¥CommonJSè§„èŒƒæ¯”è¾ƒé€‚ç”¨ã€‚ä½†æ˜¯ï¼Œå¦‚æœæ˜¯æµè§ˆå™¨ç¯å¢ƒï¼Œè¦ä»æœåŠ¡å™¨ç«¯åŠ è½½æ¨¡å—ï¼Œè¿™æ—¶å°±å¿…é¡»é‡‡ç”¨éåŒæ­¥æ¨¡å¼ï¼Œå› æ­¤æµè§ˆå™¨ç«¯ä¸€èˆ¬é‡‡ç”¨AMDè§„èŒƒã€‚

2. å…³äº Node.js ä¸­çš„ this

* [Meaning of "this" in node.js modules and functions](https://stackoverflow.com/questions/22770299/meaning-of-this-in-node-js-modules-and-functions)
* [What is "this"?](http://howtonode.org/what-is-this)


-->

æœªå®Œå¾…ç»­...

## References

* [ECMAScript 6 Modules](https://exploringjs.com/es6/ch_modules.html#ch_modules)
* [Writing Modular JavaScript With AMD, CommonJS & ES Harmony](https://addyosmani.com/writing-modular-js/)
* [Learning JavaScript Design Patterns by Addy Osmani](https://www.oreilly.com/library/view/learning-javascript-design/9781449334840/ch09s02.html)
* [Patterns for modules and namespaces in JavaScript](https://2ality.com/2011/04/modules-and-namespaces-in-javascript.html)
